// ==UserScript==
// @name         Facturier (alpha)
// @namespace    http://tampermonkey.net/
// @version      0.9.0003
// @description  try to take over the world!
// @author       You
// @author       Stéphane TORCHY
// @updateURL    https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/billing.js
// @downloadURL  https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/billing.js
// @match        https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history*
// @grant        unsafeWindow
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @grant        GM_registerMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        GM.xmlHttpRequest

// STT scripts
// @require      https://raw.githubusercontent.com/StephaneTy-Pro/userscripts/master/docready.js

// @require      https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/low.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/LocalStorage.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/dayjs.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/locale/fr.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isBetween.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrBefore.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrAfter.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/customParseFormat.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/localeData.min.js


// GM_Config
// @require      https://openuserjs.org/src/libs/sizzle/GM_config.js

// sweetalert 2
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.all.min.js

// draggabilly
// @require      https://cdnjs.cloudflare.com/ajax/libs/draggabilly/2.2.0/draggabilly.pkgd.min.js

// toastify
// @require     https://cdn.jsdelivr.net/npm/toastify-js@1.8.0/src/toastify.min.js
// @resource    toastifycss https://raw.githubusercontent.com/apvarun/toastify-js/master/src/toastify.css

//
// @require     https://raw.githubusercontent.com/uzairfarooq/arrive/master/minified/arrive.min.js

// simple-datatables
// @require     https://cdn.jsdelivr.net/npm/simple-datatables@latest
// @resource    simpledatatablecss https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css

//spectreCSS - dommage fonctionne mal avec le thème OC
// @resource    spectrecss https://unpkg.com/spectre.css/dist/spectre.min.css

// require https://raw.githubusercontent.com/anywhichway/nano-memoize/master/dist/nano-memoize.min.js
// @require https://cdn.jsdelivr.net/npm/moize@5.4.7/dist/moize.min.js

// @require https://raw.githubusercontent.com/StephaneTy-Pro/userscripts/master/fetch-inject.umd.min.js
// require https://cdn.jsdelivr.net/npm/fetch-inject

// PARSER MKDOWN
// @require 	 https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js

// PDF https://pdf-lib.js.org/docs/api/
// @require      https://unpkg.com/pdf-lib@1.9.0/dist/pdf-lib.min.js
// @require      https://unpkg.com/downloadjs@1.4.7/download.js

// @require      /media/pwyll/USB120Go/DevStt/UserScripts/SttAddon/src/students-addons.js

/*
 * History
 * 0.3 Première version publique
 * 0.3.0001 Correction d"un bug sur les dates
 * 0.4 ajout de la mention dont X soutenances plutot que X soutenances
 *         + ajout de la fonctionnalité sur les périodes
 *         + le popup de selection de date incrémente automatiquement la date de fin de 1 mois si on change la date de début
 *         + nettoyage de code
 *         BUG sur la facturation prise en compte des noshow sur tous les étudiants
 *         BUG sur la prise en compte des dates
 * 0.4.0001 Correction des libellés de boutons (menu)
 * 0.4.0002 Oubli d'une trace deboggage
 * 0.5 correction de la matrice de calcul après juin
 *     intégration du calcul du bonus af
 *     corrections diverses de texte (changements de mots principalement)
 *     nettoyage de quelques dépendances
 *     travail sur la fonction fetch history pour la simplifier
 *     UI changement de texte de la facture
 *     UI la case à cocher est renommée en "in DB"
 *     la fonctionn addCbox ne recrée pas toute les cbox à chaque fois on peut donc l'appeller apres la collecte automatique
 *     en création d'étudiant la liste des parcours (incomplète est proposée dans l'autocompletion
 *     correction d'un bug dans la facturation avant 06/2020 (mauvaise affectation de la catégorie des noshow : annulé tardivement qui étaient visuellement avec les sessions)
 *
 *
 * 0.6
 *      Travail sur la pré facture : changement du code pour une meilleure performance et pour permettre la réalisation de stat mensuselle : créattion d'un module spécifique
 *      GROS BUG A CORRIGER le statut étudiante absente existe !!!!!!
 *      debut du travail sur le module de statistique
 * 0.7
 *      Suite module de statistiques
 *      Utilisation de memoize pour mettre en cache le tableau
 *      UI Suppression du bouton getstudents qui ne sert plus à rien car lancé en automatique si l'étudiant n'est pas trouvé dans la liste
 *      Correction du bug pour Antony (document.arrive non disponible... mise en place provisioire d'un event alternatif)
 * 0.7.0001
 *      Version pour corriger le bug d'antony (deuxieme essai)
 * 0.8
 *      Correction d'un bug sur l'affichage des prix unitaires
 *      Ajout de la possibilité en configuration de régler le temps de mise en cache dans le menu de configuration du "plugin"
 *      Ajout du read.me dans le about
 *      Correction du bug sur le mois dans les stat
 *      Corrections de bugs divers
 *      Nettoyage du code, mises en commentaires de console
 *      Ajout de la notion de canceled dans les statistiques
 *      Ajout du paramétrage du nombre d'heure nécessaire par type de session pour les stats
 *
 * 0.9
 *      Ajout du TJM en fonction du nombre de jours ouvrés (sans tenir compte de jours fériés)
 *      Début de l'archivage des données financières (pour accélérer les stat)
 *      Ajout de la possibilité de filtrer les données supprimées (financière pour le moment)
 *      Intégration du niveau X de données financières
 *      Ajout d'un "temoin d'inactivité"
 *      Optimisation
 *      Intégration d'un selecteur de date pour la RAZ
 *      Début de travail sur le PDF
 * 0.9.0001
 *      Correction d'un bug dans le décompte des sessions annulées
 *      Passage en mode compilation + compression
 *      Correction du calcul du forfait
 * 0.9.0002
 *      Ajout de l'export manquant pour les archives
* 0.9.0003
 *      BUG Oubli d'ajouter un import en création d'étudiant 
 *      Début de la fonctionnalité pour avoir plusieurs étudiants avec le meme id en base
 * 1.00
 *

 ********* BUG visiblement j'ai du mal avec le fetch pour les pages historiques .... probleme de requetes trop nombreuses ?
 * TODO
 * BUG hugo a diagnostiqué un bug en mise à jour des étudiants sur le financement dans le popup orange ... note STT je présume qu'il s'agit d'un probleme dû à l'async car le console.log est bon lui et l'entrée en BDD également
 * popup qui vient dire que tout c'est bien passé suite à la collecte des données de session ( A FAIRE)
 * toaster .... passer sur une seule et unique librairie
 * paramètres de l'application à nettoyer
 *
 */



// ==/UserScript==

(function() {
    'use strict';
const Ea="#OCAddonsCfg {background-color: lightblue;} #OCAddonsCfg .reset_holder {float: left; position: relative; bottom: -1em;} #OCAddonsCfg .saveclose_buttons {margin: .7em;}",Fa="height: 16.7em; width: 30em; border: 1px solid; border-radius: 3px; position: fixed; z-index: 999;";GM_config.init({id:"OCAddonsCfg",title:"Configuration du module",fields:{nbHrsAfM:{section:["Statistiques","paramètres"],label:"Nombre de minutes pour une session AF",labelPos:"left",type:"input",default:30},nbHrsfM:{label:"Nombre de minutes pour une session financée",labelPos:"left",type:"input",default:45},nbHrsD:{label:"Nombre de minutes pour une session de soutenance",labelPos:"left",type:"input",default:45},maxfetchpg:{section:["Application","optimisation"],label:"Maximum de page recherchées dans l'historique",labelPos:"left",type:"input",default:1e3},datacachelifetime:{label:"Temps de conservation des données dans le cache (en ms)",labelPos:"left",type:"input",default:12e4},checksessionalreadyexists:{section:["Application","Base de donnée"],label:"sessions: vérifier existence avant insertion",labelPos:"left",type:"checkbox",default:!0},sizeofcontentlist:{section:["Interface","thème"],label:"taille de la police des listes",labelPos:"left",type:"input",default:"1em;"},alwaysaddcbox:{section:["Interface","gadget"],label:"Toujours ajouter les checkbox sur l'interface",labelPos:"left",type:"checkbox",default:!0},hackheaderzindex:{label:"changer le zindex du bandeau haut",labelPos:"left",type:"checkbox",default:!0},support:{section:["","Support"],label:"StephaneTy-Pro.github.io",title:"more info on https://github.com/StephaneTy-Pro",type:"button",click:()=>{GM_openInTab("https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon",{active:!0,insert:!0,setParent:!0})}}},css:Ea,events:{save:function(){GM_config.close()}}});var ha=function(){GM_config.open(),OCAddonsCfg.style=Fa};const Ga=[{month:"janvier",id:"01"},{month:"février",id:"02"},{month:"mars",id:"03"},{month:"avril",id:"04"},{month:"mai",id:"05"},{month:"juin",id:"06"},{month:"juillet",id:"07"},{month:"août",id:"08"},{month:"septembre",id:"09"},{month:"octobre",id:"10"},{month:"novembre",id:"11"},{month:"décembre",id:"12"}];var aa=function(c){var h=c.trim().split(" "),f={month:"void",id:"void"};try{f=_.find(Ga,["month",h[1]])}catch(a){throw Error("Erreur qui ne devrait jamais arriver en conversion de date :"+a.stack||a)}return`${h[2]}-${f.id}-${h[0]}T${h[4]}`},ia=function(c,h=0){h===-1&&(h=c.children.length-1);var f=c.children[h].children[0].innerText;let a=aa(f);var b=dayjs(a);return b};const La=function(c,h="noname",f="nopath",a="unkonw",b){var o=sttctx.dbase,g=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");let k={id:c,fullname:h,path:f,fundedby:a,created:g};o.get("students").push(JSON.parse(JSON.stringify(k))).write()},ba=function(c){var h=sttctx.dbase,f=h.get("students").find({id:c}).value();return f===void 0?!1:!0};var Ma=function(c){var h=sttctx.dbase,f=h.get("students").find({id:c}).value();if(f==void 0)throw Error("IRRECOVERABLE ERROR STUDENT NOT IN DB:");return f.fundedby};const la=function(c){return Ma(c).toLowerCase()==="auto-financé"},Na=async function(c){const h=await _fetch(`https://openclassrooms.com/fr/mentorship/students/${c}/dashboard`,".mentorshipStudent__details > p");return h.innerText},ma=async(c,h)=>{var f=!1;h=h||sttctx;var a="table.crud-list tbody",b=document.querySelectorAll(a)[1],o=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),g=h.dbase;Swal.fire({position:"top-end",icon:"info",toast:!0,title:`mise à jour de la base de donnée des étudiants...
cela peut prendre du temps`,showConfirmButton:!1,timer:1e3});for(const l of b.children){var k=getKey(l.children[0],-2),j=l.children[0].innerText,n="non défini";l.children[1].firstElementChild&&(n=l.children[1].firstElementChild.href.split("/").pop());var e=g.get("students").find({id:k}).value();if(e&&f===!1)console.log(`${j}(uniquid:${k}) already present in database created at ${e.created}`);else{let p=await Na(k);console.log(`Financial Mode of student ${j}(id${k}) is ${p}`),Toastify({text:`Ajoute l'étudiant : ${j}(${p}) en base`,gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast(),La(k,j,n,p,o)}}};var ca=async function(c){var h=sttctx.dbase;if(GM_config.get("checksessionalreadyexists")===!0)var f=!0;if(D(dayjs(c.when)))c.isFunded=!0;else if(c.type.toLowerCase()==="soutenance")c.isFunded=!0;else{var a=ba(c.who_id);console.log("is student in db ?",a);if(a==!1){console.warn("%ci'm updating db .... could'nt do anything else","color:magenta"),await ma();var b=ba(c.who_id);if(b==!1)return createStudentsManually(c.who_id,c.who_name,c.when)}c.isFunded=!la(c.who_id)}f?V(c.id)==!1?h.get("sessions").push(JSON.parse(JSON.stringify(c))).write():console.info(`${c.who_name} at ${c.when} already present in database table sessions`):h.get("sessions").push(JSON.parse(JSON.stringify(c))).write()},da=function(c){var h=c.children[0].children[0].innerText,f=U(c.children[0]),a=c.children[1].children[0].innerText,b=U(c.children[1],-2),o=c.children[2].innerText.trim().toLowerCase(),g=c.children[3].children.length?c.children[3].children[0].innerText.toLowerCase():"session",k=-1;c.children[4].children.length>0&&(k=c.children[4].children[0].innerText),h=aa(h);var j={id:f,when:h,who_id:b,who_name:a,status:o,type:g,lvl:k};return j},U=function(c,h=-1){try{var f=(c.children[0].href||"/").split("/");return f[f.length+h]}catch(a){throw Error("Erreur qui ne devrait jamais arriver en getkey :"+a.stack||a)}},V=function(c){var h=sttctx.dbase,f=h.get("sessions").find({id:c}).value();return f===void 0?!1:!0},D=function(c){var h=null;typeof c==="string"?h=dayjs(c):h=c;try{return h.isBefore(dayjs("2020-06-01"))}catch(f){throw Error("Erreur qui ne devrait jamais arriver en IsInOldMode (probablement un probleme sur la conversion de la date en objet dayjs:"+f.stack||f)}};var ga=async function(c){var h=sttctx.dbase,f=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");let a={id:c[0].to.format("YYYYMM"),data:c,created_at:c[0].now};console.log(`will create archive for id ${c[0].to.format("YYYYMM")} (YYYYMM)`),h.get("f_archives").push(JSON.parse(JSON.stringify(a))).write()},ea=function(c){var h=sttctx.dbase,f=h.get("f_archives").find({id:c}).value();return f===void 0?!1:!0},fa=function(c){var h=sttctx.dbase,f=h.get("f_archives").find({id:c}).value();if(f===void 0){throw Error("Erreur qui ne devrait jamais arriver en getFinancialsArchive ");return!1}else return console.log(`will use archive for id ${c} (YYYYMM)`),f};const K="réalisée",N="annulée",O="annulée tardivement",P="étudiant absent",Q="étudiante absente",wa=30,xa=35,ya=40,za=45,Aa=50,Ba=55,L=6,R="background-color:blue;color:white";var X=function(c,h){if(ea(h.format("YYYYMM"))===!0){console.log("%cUse Archived version of financials","background-color:green;color: white");let f=fa(h.format("YYYYMM"));return f.data}return typeof c!=="string"&&(c=c.format("YYYY-MM-DD")),typeof h!=="string"&&(h=h.format("YYYY-MM-DD")),Da(c,h)},Ca=function(c,h){typeof c==="string"&&(c=dayjs(c)),typeof h==="string"&&(h=dayjs(h));var f=performance.now(),a=sttctx.dbase,b=a.get("sessions").filter(d=>dayjs(d.when).isSameOrBefore(h,"day")&&dayjs(d.when).isSameOrAfter(c,"day")),o=b.filter(d=>d.type.toLowerCase()==="soutenance")||0;let g=[0,wa,xa,ya,za,Aa,Ba],k=[],j=[];for(let d=1;d<=L;d+=1)j[d]=[],j[d][0]={session:null,defense:null},j[d][1]={session:null,defense:null},j[d][2]={session:null,defense:null},j[d][3]={session:null,defense:null},j[d][4]={session:null,defense:null},j[d][5]={session:null,defense:null},j[d][6]={session:null,defense:null},j[d][7]={session:null,defense:null},j[d][0].session=b.filter(i=>i.lvl==d&&i.status===K&&i.isFunded===!0)||0,j[d][1].session=b.filter(i=>i.lvl==d&&i.status===N&&i.isFunded===!0)||0,j[d][2].session=b.filter(i=>i.lvl==d&&i.status===O&&i.isFunded===!0)||0,j[d][3].session=b.filter(i=>i.lvl==d&&(i.status===P||i.status===Q)&&i.isFunded===!0)||0,j[d][4].session=b.filter(i=>i.lvl==d&&i.status===K&&i.isFunded===!1)||0,j[d][5].session=b.filter(i=>i.lvl==d&&i.status===N&&i.isFunded===!1)||0,j[d][6].session=b.filter(i=>i.lvl==d&&i.status===O&&i.isFunded===!1)||0,j[d][7].session=b.filter(i=>i.lvl==d&&(i.status===P||i.status===Q)&&i.isFunded===!1)||0,j[d][0].defense=o.filter(i=>i.lvl==d&&i.status===K&&i.isFunded===!0)||0,j[d][1].defense=o.filter(i=>i.lvl==d&&i.status===N&&i.isFunded===!0)||0,j[d][2].defense=o.filter(i=>i.lvl==d&&i.status===O&&i.isFunded===!0)||0,j[d][3].defense=o.filter(i=>i.lvl==d&&(i.status===P||i.status===Q)&&i.isFunded===!0)||0,j[d][4].defense=o.filter(i=>i.lvl==d&&i.status===K&&i.isFunded===!1)||0,j[d][5].defense=o.filter(i=>i.lvl==d&&i.status===N&&i.isFunded===!1)||0,j[d][6].defense=o.filter(i=>i.lvl==d&&i.status===O&&i.isFunded===!1)||0,j[d][7].defense=o.filter(i=>i.lvl==d&&(i.status===P||i.status===Q)&&i.isFunded===!1)||0;var n=performance.now();console.log("%cfiltering took "+(n-f)+" milliseconds.",R),k.push({total_errors:0,total_filtered:0,total:b.value().length,control:0}),k.push({type:"bad level",data:b.filter(d=>d.lvl<1||d.lvl>L).value()}),k.push({type:"bad status",data:b.filter(d=>d.status!==K&&d.status!==N&&d.status!==O&&d.status!==P&&d.status!==Q).value()}),k.push({type:"bad funded",data:b.filter(d=>d.isFunded!==!1&&d.isFunded!==!0).value()}),k[0].total_errors=k[1].data.length+k[2].data.length+k[3].data.length;var e=[],l=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),p=[];for(let d=1;d<=L;d+=1)D(c)?p[d]=[g[d],0,g[d]/2,g[d]/2,g[d],0,g[d]/2,g[d]/2]:p[d]=[g[d],0,0,g[d]/2,g[d]/2,0,0,g[d]/4];var x=performance.now();console.log("%cPU calculated took "+(x-n)+" milliseconds.",R);var w=b.filter(d=>d.type.toLowerCase()!=="soutenance"&&d.status===K&&d.isFunded===!1),q=w.groupBy(d=>d.who_id),v=[];for(var t in q.value())v.push({who_id:t,who_name:q.value()[t][0].who_name,sessions:q.value()[t].length});var y=performance.now();console.log("%cBonus took "+(y-x)+" milliseconds.",R);var s=[],r=[],z=0;for(let d=1;d<=L;d+=1){let i=[];i[0]=j[d][0].session.value().length,i[1]=j[d][1].session.value().length,i[2]=j[d][2].session.value().length,i[3]=j[d][3].session.value().length,i[4]=j[d][4].session.value().length,i[5]=j[d][5].session.value().length,i[6]=j[d][6].session.value().length,i[7]=j[d][7].session.value().length,s[d]=[i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7]],z+=s[d].reduce((W,va)=>W+va);let m=[];m[0]=j[d][0].defense.value().length,m[1]=j[d][1].defense.value().length,m[2]=j[d][2].defense.value().length,m[3]=j[d][3].defense.value().length,m[4]=j[d][4].defense.value().length,m[5]=j[d][5].defense.value().length,m[6]=j[d][6].defense.value().length,m[7]=j[d][7].defense.value().length,r[d]=[m[0],m[1],m[2],m[3],m[4],m[5],m[6],m[7]]}k[0].total_filtered=z,k[0].control=k[0].total-z;var A=performance.now();console.log("%cPrecalc some vars took "+(A-y)+" milliseconds.",R),e.push({from:c,to:h,created_at:l,errors:k,bonus:v,max_level:L});for(let d=1;d<=L;d+=1){let i=j[d];e.push({sessions:{data:[i[0].session,i[1].session,i[2].session,i[3].session,i[4].session,i[5].session,i[6].session,i[7].session],number:s[d],pu:p[d]},defenses:{data:[i[0].defense,i[1].defense,i[2].defense,i[3].defense,i[4].defense,i[5].defense,i[6].defense,i[7].defense],number:r[d],pu:p[d]}})}var M=performance.now();return console.log("%cMy array full storage took "+(M-A)+" milliseconds.",R),h.isBefore(dayjs())&&ga(e),e};const Da=moize.default(Ca,{maxAge:GM_config.get("datacachelifetime"),isSerialized:!0,onCacheAdd:function(c,h,f){console.log("cache add"),console.dir(c.keys)},onCacheHit:function(){console.log("cache hit")}});var Z={async XHR(c){const h=window.GM_xmlhttpRequest||(GM?GM.xmlHttpRequest:null);return h?new Promise((f,a)=>{Object.assign(c,{onabort:a,onerror:a,onload:f,ontimeout:a}),h(c)}):Promise.reject()},async getValue(c,h=null){return window.GM_getValue?Promise.resolve(GM_getValue(c)||h):await GM.getValue(c)||h},async setValue(c,h){window.GM_setValue?GM_setValue(c,h):GM.setValue(c,h)}};var Y=function(c,h){let f=[[0,1,2,3,4,5,5],[5,1,2,3,4,5,5],[4,5,1,2,3,4,4],[3,4,5,1,2,3,3],[2,3,4,5,1,2,2],[1,2,3,4,5,1,1],[0,1,2,3,4,5,0]];return Math.trunc(h.diff(c,"days")/7)*5+f[c.day()][h.day()]};const C=6,H="background-color:blue;color:white",Oa="OC-Addons";var na=async function(){var c="";const h=await Z.XHR({method:"GET",url:"https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/README.md",responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"}});var f=h.responseText,a=new showdown.Converter(),b=a.makeHtml(f);c+=b,Swal.fire({title:`<strong>A propos de ${Oa}</strong>`,icon:"info",html:c,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},S=function(){var c="table.crud-list tbody",h=document.querySelector(c),f=!1;if(h.querySelector("[type=checkbox]")===null){for(const p of h.children){var a=U(p.children[0]),b=document.createElement("input");b.type="checkbox",b.name="name",b.value=a,b.id="id",f=V(a),f===!0&&(b.checked=!0);var o=document.createElement("td");o.style="text-align: center",o.appendChild(b),p.appendChild(o)}c="table.crud-list thead tr";var g=document.querySelector(c);b=document.createElement("input"),b.type="checkbox",b.name="name",b.value="value",b.id="id",b.onclick=function(){document.querySelectorAll("tbody input[type=checkbox]").forEach(p=>p.checked=!p.checked)},b.style="visibility: hidden;";var k=document.createElement("label");k.innerText="in DB",k.style="display:block;",k.onMouseOver="this.style.cursor=pointer;",k.onMouseOut="this.style.cursor=auto;",k.appendChild(b),o=document.createElement("td"),o.style="text-align: center",o.appendChild(k),g.appendChild(o)}else{for(var j=h.querySelectorAll("[type=checkbox]"),n=j.length,e=new Array(n);n--;e[n]=j[n]);for(var l in e)f=V(e[l].value),f===!0?e[l].checked=!0:e[l].checked=!1}},oa=async function(){for(var c="table.crud-list tbody input:checked",h=document.querySelectorAll(c),f=0;f<h.length;f+=1){var a=h[f].parentElement.parentElement,b=da(a);await ca(b)}Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions cochées
Collecte terminée`,showConfirmButton:!1,timer:1500})},pa=async function(){var[c,h]=await T(dayjs().startOf("month"),dayjs().endOf("month")),f=sttctx.dbase,a=f.get("sessions").filter(v=>dayjs(v.when).isSameOrBefore(h,"day")&&dayjs(v.when).isSameOrAfter(c,"day")).sortBy(function(v){return dayjs(v.when).valueOf()}).value(),b="";b+="<table>";var o=30,g=35,k=40,j=50,n=[0,o,g,k,j];b+="<thead>",b+="<tr><th>Quand</th><th>Qui</th><th>Financé ?</th><th>Ancien Mode ?</th><th>PU HT</th><th>Statut</th><th>PU (corrigé) HT</th><th>Cumul</th></tr>",b+="<thead>",b+="<tbody>";var e=0;for(var l in a){var p=dayjs(a[l].when).format("DD/MM/YYYY à HH:mm:ss"),x=a[l].isFunded===!0?n[a[l].lvl]:n[a[l].lvl]*.5,w=0,q=!0;D(dayjs(a[l].when))?a[l].status==="réalisée"?w=x:(a[l].status==="étudiant absent"||a[l].status==="annulée tardivement")&&(w=x*.5):(q=!1,a[l].status==="réalisée"?w=x:a[l].status==="étudiant absent"&&(w=x*.5)),e+=w,b+="<tr>",b+=`<td>${p}</td><td>${a[l].who_name}</td><td>${a[l].isFunded===!0?"Oui":"Non"}</td><td>${q===!0?"Oui":"Non"}</td><td>${x}</td><td>${a[l].status}</td><td>${w}</td><td>${e}€</td>`,b+="</tr>"}b+="</tbody>",b+="</table>",Swal.fire({title:`<strong>Liste détaillées des sessions du ${c.format("DD/MM/YYYY")} au ${h.format("DD/MM/YYYY")}</strong>`,icon:"info",html:b,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:v=>{var t=v.querySelector("table"),y=new simpleDatatables.DataTable(t)}})},qa=async function(){var[c,h]=await T(dayjs().startOf("month"),dayjs().endOf("month"));let f=0,a=GM_config.get("maxfetchpg"),b=!0;var o={};let g=[],k=1;for(;b;){console.log(`iRecurse > iMaxRecurse ? ${f} > ${a} = ${f>a}`);if(f>a){console.warn("%cEMERGENCY EXIT LOOP","color:orange");break}o=await Pa(c,h,k,g),o.length>0&&dayjs(o[o.length-1].when).isSameOrBefore(c)===!0&&(b=!1),k+=1,f+=1}for(var j in o){if(dayjs(o[j].when).isBefore(c,"day")===!0){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions
Collecte terminée`,showConfirmButton:!1,timer:1500});break}if(dayjs(o[j].when).isAfter(h,"day")===!0)continue;dayjs(o[j].when).isBetween(c,h,"day","[]")&&await ca(o[j])}S()},Pa=async function(c,h,f=1,a=[]){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions de l'historique
du `+c.format("DD/MM/YYYY")+" au "+h.format("DD/MM/YYYY")+` 
page : `+f+`
cela peut prendre du temps...`,showConfirmButton:!1,timer:3e3});let b=await Sa(`https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history?page=${f}`,"table.crud-list tbody");if(b===null)throw new Error("Something went wrong .... try to navigate forward and backward or click some buttons to change url");if(ia(b,-1).isAfter(h,"day")===!0)return console.log("optimisation ne charge pas ce n'est pas encore arrivé"),a;for(var o=0;o<b.children.length;o+=1){var g=b.children[o],k=da(g);a.push(k)}return a},ra=async function(){var c="";c+="<style>",c+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",c+="form input {background: #fff;border: 1px solid #9c9c9c;}",c+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",c+="form button:hover {background: gold;}",c+="form label {padding: 0.5em 0.5em 0.5em 0;}",c+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",c+="form input:focus {outline: 3px solid gold;}",c+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",c+="</style>",c+='<form class="form1" action="">',c+='<label for="students" class="cbox">Suppr. des étudiants</label>',c+='<input id="students" type="checkbox" value="del_students_true" checked>',c+='<label for="sessions" class="cbox">Suppr. des sessions</label>',c+='<input id="sessions" type="checkbox" value="del_sessions_true" checked>',c+='<label for="archives" class="cbox">Suppr. des archives</label>',c+='<input id="archives" type="checkbox" value="del_archives_true" checked>',c+='<label for="radio1">filtrer la date</label>',c+='<input type="radio" id="radio1" name="date_filter" value="false" checked>',c+='<label for="radio2">ne pas filtrer</label>',c+='<input type="radio" id="radio2" name="date_filter" value="true">',c+='<label for="dtFrom" class="date">Date de début</label>',c+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',c+='<label for="dtTo" class="date">Date de fin</label>',c+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',c+="</form>";const{value:h}=await Swal.fire({title:"<strong>RAZ des données</strong>",icon:"info",html:c,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez ce que vous allez supprimer de la base de donnée",preConfirm:()=>{let j=document.getElementsByName("date_filter"),n="notfound";for(var e in j)j[e].checked===!0&&(n=j[e].value);return[document.getElementById("students").checked,document.getElementById("sessions").checked,document.getElementById("archives").checked,document.getElementById("dtFrom").disabled===!0?null:document.getElementById("dtFrom").value,document.getElementById("dtTo").disabled===!0?null:document.getElementById("dtTo").value,n]},onOpen:j=>{j.querySelector("#radio1").addEventListener("change",function(){console.log(document.getElementById("radio1").checked);let n=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!n,document.getElementById("dtTo").disabled=!n}),j.querySelector("#radio2").addEventListener("change",function(){let n=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!n,document.getElementById("dtTo").disabled=!n}),j.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:j=>{j.querySelector("#radio1").removeEventListener("change"),j.querySelector("#radio2").removeEventListener("change"),j.querySelector("#dtFrom").removeEventListener("change")}});let f=h[0],a=h[1],b=h[2];console.log(`wanna raz students ? ${f}, wanna raz sessions ? ${a}, wanna raz archives ? ${b}`);var o=sttctx.dbase,g={};if(f===!0&&a===!0&&b===!0){setTimeout(function(){Toastify({text:`Suppression de la base 
des étudiants 
et des sessions`,gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),o.setState(g),o.defaults({students:[],pricing:[],sessions:[],f_archives:[]}).write();return}f===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des étudiants",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),o.get("students").remove().write()),a===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des sessions",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),o.get("sessions").remove().write());if(b===!0){setTimeout(function(){Toastify({text:"Suppression de la base des archives (financières)",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500);if(h[3]===null)o.get("f_archives").remove().write();else{let j=dayjs(h[3]),n=dayjs(h[4]);var k=n.get("month")-j.get("month")+1;let e=0;for(;e<k;)console.log("delete for a month id :"+j.format("YYYYMM")),o.get("f_archives").remove({id:j.format("YYYYMM")}).write(),j=j.add(1,"month"),e+=1}}},sa=async function(){var c=sttctx.dbase,h="";h+="<style>",h+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",h+="form input {background: #fff;border: 1px solid #9c9c9c;}",h+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",h+="form button:hover {background: gold;}",h+="form label {padding: 0.5em 0.5em 0.5em 0;}",h+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",h+="form input:focus {outline: 3px solid gold;}",h+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",h+="</style>",h+='<form class="form1" action="">',h+='<label for="dd" class="date">Date de début</label>',h+='<input id="dd" type="date" max="2030-12-31" min="2010-12-31">',h+='<label for="df" class="date">Date de fin</label>',h+='<input id="df" type="date" max="2030-12-31" min="2010-12-31">',h+="</form>";var[f,a]=await T(dayjs().startOf("month"),dayjs().endOf("month")),b=X(f,a);D(f)?Qa(f,a,b):Ra(f,a,b)},Qa=function(c,h,f){var a="",b=null,o=0,g=0,k=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],j=f[0].max_level;a+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",a+='<div class="wrapper">',a+="<table>",a+="<caption>Sessions de mentorat</caption>",a+="<thead>",a+="<tr>",a+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',a+="</tr>",a+="</thead>",a+="<tbody>";for(var n in k){a+="<tr>",a+="<td>"+k[n][1]+"</td>",b=f[k[n][0]].sessions;let s=b.number[0],r=b.number[4],z=s*b.pu[0],A=r*b.pu[4];o+=s+r,g+=z+A,a+=`<td>${s+r}</td><td>${(b.pu[0]+b.pu[4])/2}</td><td>${z+A}€</td>`,a+="</tr>"}a+="</tbody>",a+="<tfoot>",a+="<tr>",a+="<td>Total</td>",a+=`<td>${o}</td><td></td><td>${g}€</td>`,a+="</tr>",a+="<tr>",a+="</tr>",a+="</tfoot>",a+="</table>";var e=o,l=g;o=0,g=0,a+="<table>",a+="<caption>Sessions de mentorat (NoShow)</caption>",a+="<thead>",a+="<tr>",a+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',a+="</tr>",a+="</thead>",a+="<tbody>";for(n in k){a+="<tr>",a+="<td>"+k[n][1]+"</td>",b=f[k[n][0]].sessions;let s=b.number[2]+b.number[3],r=b.number[6]+b.number[7],z=s*(b.pu[2]+b.pu[3])/2,A=r*(b.pu[6]+b.pu[7])/2;o+=s+r,g+=z+A,a+=`<td>${s+r}</td><td>${(b.pu[2]+b.pu[3]+b.pu[6]+b.pu[7])/4}</td><td>${z+A}€</td>`,a+="</tr>"}a+="</tbody>",a+="<tfoot>",a+="<tr>",a+="<td>Total</td>",a+=`<td>${o}</td><td></td><td>${g}€</td>`,a+="</tr>",a+="<tr>",a+="</tr>",a+="</tfoot>",a+="</table>",e+=o,l+=g;for(var p=0,x=0,w=0,q=0,v=0,t=1;t<=C;){p+=f[t].sessions.number[1],p+=f[t].sessions.number[5];for(let s in[...Array(8).keys()]){let r=f[t].sessions.number[s];console.log(`je vais ajouter ${r} sessions`),x+=r,w+=r*f[t].sessions.pu[s],r=f[t].defenses.number[s],q+=r,v+=r*f[t].defenses.pu[s]}t+=1}let y=f[0].errors[0].total;x+=y,a+=`<p>Ces ${x} session(s) se répartissent en ${e-o} session(s) de mentorat (${l-g}€)`,a+=`, ${o} NoShows (${g}€)`,a+=`${p} session(s) annulée(s) (${0}€), ainsi que ${y} session(s) en anomalie</p>`,a+=`<p>Sur le total de ${x} session(s) (${w}€) `,a+=`vous avez réalisé ${q} soutenance(s) (${v}€)</p>`,y&&(a+=`pour info il y a ${y} session(s) qui présente(nt) une anomalie ceci devrait par contre être normal (c'est souvent un étudiant qui n'a plus de parcours associé au moment de la collecte)`,a+="cela se traduit par une erreur de type bad level pour plus d'information regarder du côté dela console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(f[0].errors),console.warn("détail"),console.warn(`${f[0].errors[1].data.length} erreurs de type ${f[0].errors[1].type} data are`,f[0].errors[1].data),console.warn(`${f[0].errors[2].data.length} erreurs de type ${f[0].errors[2].type} data are`,f[0].errors[2].data),console.warn(`${f[0].errors[3].data.length} erreurs de type ${f[0].errors[3].type} data are`,f[0].errors[3].data)),Swal.fire({title:`<strong>Liste des formations tarifées du ${c.format("DD/MM/YYYY")} au ${h.format("DD/MM/YYYY")}</strong>`,html:a,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},Ra=function(c,h,f){console.log("enter computation bill");var a=performance.now(),b="",o=null,g=0,k=0,j=0,n=0,e=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],l=f[0].max_level;b+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",b+='<div class="wrapper">',b+="<table>",b+="<caption>Sessions de mentorat (dont soutenances)</caption>",b+="<thead>",b+="<tr>",b+='<th rowspan="2">Type</th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th>',b+="</tr>",b+="<tr>",b+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>";for(var p=1;p<=C;){b+="<tr>",b+=`<td> Niveau ${p}</td>`;let u=f[p].sessions,B=f[p].defenses,F=u.number[0],G=u.number[4],I=F*u.pu[0],J=G*u.pu[4];g+=F,k+=G,j+=I,n+=J,b+=`<td>${F} (${B.number[0]})</td><td>${u.pu[0]}</td><td>${I}€</td>`,b+=`<td>${G} (${B.number[4]})</td><td>${u.pu[4]}</td><td>${J}€</td>`,b+=`<td>${F+G} (${B.number[0]+B.number[4]})</td><td>${I+J}€</td>`,b+="</tr>",p+=1}var x=performance.now();console.log("%cCalculate first array"+(x-a)+" milliseconds.",H),b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${g}</td><td></td><td>${j}€</td>`,b+=`<td>${k}</td><td></td><td>${n}€</td>`,b+=`<td>${g+k}</td><td>${j+n}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>";var w=g+k,q=j+n;for(g=0,k=0,j=0,n=0,b+="<table>",b+="<caption>Sessions de mentorat :NoShow (dont soutenances)</caption>",b+="<thead>",b+="<tr>",b+='<th rowspan="2"></th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th><th colspan="2" scope="colgroup">Ensemble</th>',b+="</tr>",b+="<tr>",b+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>",p=1;p<=C;){b+="<tr>",b+=`<td> Niveau ${p}</td>`;let u=f[p].sessions,B=f[p].defenses,F=u.number[3],G=u.number[7],I=F*u.pu[3],J=G*u.pu[7];g+=F,k+=G,j+=I,n+=J,b+=`<td>${F} (${B.number[3]})</td><td>${u.pu[3]}</td><td>${I}€</td>`,b+=`<td>${G} (${B.number[7]})</td><td>${u.pu[7]}</td><td>${J}€</td>`,b+=`<td>${F+G}</td><td>${I+J}€</td>`,b+="</tr>",p+=1}b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${g}</td><td></td><td>${j}€</td>`,b+=`<td>${k}</td><td></td><td>${n}€</td>`,b+=`<td>${g+k}</td><td>${j+n}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>";var v=performance.now();console.log("%cCalculate second html table took "+(v-x)+" milliseconds.",H),w+=g+k,q+=j+n;var t=0,y=0,s=0,r=0,z=0;for(p=1;p<=C;){t+=f[p].sessions.number[1],t+=f[p].sessions.number[2],t+=f[p].sessions.number[5],t+=f[p].sessions.number[6];for(let u in[...Array(8).keys()]){let B=f[p].sessions.number[u];y+=B,s+=B*f[p].sessions.pu[u],B=f[p].defenses.number[u],r+=B,z+=B*f[p].defenses.pu[u]}p+=1}let A=f[0].errors[0].total_errors;y+=A,b+=`<p>Ces ${y} session(s) se répartissent en ${w-g-k} session(s) de mentorat (${q-j-n}€)`,b+=`, ${g+k} NoShows (${j+n}€)`,b+=` et ${t} session(s) annulée(s) (${0}€)`,b+=`<br>Sur le total de ${y} session(s) (${s}€) `,b+=`vous avez réalisé ${r} soutenance(s) (${z}€)</p>`;if(A){let u=f[0].errors[0];b+=`pour info il y a ${A} session(s) qui présente(nt) une anomalie ceci devrait par contre être normal (c'est souvent un étudiant qui n'a plus de parcours associé au moment de la collecte)`,b+="cela se traduit par une erreur de type bad level pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${u.total_errors} erreurs relevées , notez qu'il y a ${u.total_filtered} ennregistrements filtrés(lvl,...)  sur ${u.total} enregistrements dans la période, le total des erreurs devrait donc être de ${u.control} erreurs`),console.warn("détail"),console.warn(`${f[0].errors[1].data.length} erreurs de type ${f[0].errors[1].type} data are`,f[0].errors[1].data),console.warn(`${f[0].errors[2].data.length} erreurs de type ${f[0].errors[2].type} data are`,f[0].errors[2].data),console.warn(`${f[0].errors[3].data.length} erreurs de type ${f[0].errors[3].type} data are`,f[0].errors[3].data)}var M=performance.now();console.log("%cCalcuate bottom remark <p> took "+(M-v)+" milliseconds.",H),b+="<table>",b+="<caption>Sessions de mentorat Bonus AF</caption>",b+="<thead>",b+="<th>Qui</th><th>Nb Sessions</th><th>PU</th><th>Total</th>",b+="</thead>",b+="<tbody>";var d=0;let i="";for(var m in f[0].bonus)f[0].bonus[m].sessions>=1?(d+=30,b+=`<tr><td>${f[0].bonus[m].who_name}</td><td>100%</td><td>30</td><td>30 €</td></tr>`):b+=`<tr><td>${f[0].bonus[m].who_name}</td><td>0 %</td><td>30</td><td>0 €</td></tr>`;b+="</tbody>",b+="<tfoot>",b+=`<tr><td>total</td><td></td><td></td><td>${d} €</td></tr>`,b+="</tfoot>",b+="</table>",b+=`<p>Soit un total à facturer de ${s+d} €`;var W=performance.now();console.log("%cCalculate AF took "+(W-M)+" milliseconds.",H);var va=performance.now();console.log("%cCalculate html table took "+(W-a)+" milliseconds.",H),Swal.fire({title:`<strong>Liste des formations tarifées du ${c.format("DD/MM/YYYY")} au ${h.format("DD/MM/YYYY")}</strong>`,html:b,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},ta=async function(){var[c,h]=await T(dayjs().startOf("month"),dayjs().endOf("month"),!1);let f=c,a=[];for(var b=performance.now();f.isSameOrBefore(h,"day");){let d=f.endOf("month");a.push(X(f,d)),f=f.add(1,"month")}var o=performance.now();console.log("%cComputed data between the two dates in"+(o-b)+" milliseconds.",H);var g="",k=h.get("month")-c.get("month");g+="<table>",g+="<thead>",g+="<tr><th>Origine</th>";for(var j=0;j<=k;){let d=c.add(j,"month");g+=`<th>${d.format("MMMM")}</th>`,j+=1}g+="<th>Total</th><th>Moyenne</th></tr>",g+="</thdead>",g+="<tbody>",g+="<tr>",g+=`<td colspan=${k} style="text-align:left;">Sessions</td></tr>`,g+="<tr>",g+="<td>Sessions (Mt)</td>";let n=0,e=0,l=0,p=[],x=[],w=[],q=[],v=[],t=[],y=[];for(f=c;e<=k;){let d=1;for(p[e]=0,x[e]=0,w[e]=0,v[e]=0,t[e]=0,y[e]=0;d<C;){let i=[...Array(8).keys()];for(let m=0;m<i.length;m+=1)l+=a[e][d].sessions.number[m]*a[e][d].sessions.pu[m],p[e]+=a[e][d].sessions.number[m],x[e]+=a[e][d].defenses.number[m],w[e]+=a[e][d].sessions.number[m]-a[e][d].defenses.number[m],D(f)?[1,5].includes(m)&&(v[e]+=a[e][d].sessions.number[m],t[e]+=a[e][d].defenses.number[m],y[e]+=a[e][d].sessions.number[m]-a[e][d].defenses.number[m]):[1,2,5,6].includes(m)&&(v[e]+=a[e][d].sessions.number[m],t[e]+=a[e][d].defenses.number[m],y[e]+=a[e][d].sessions.number[m]-a[e][d].defenses.number[m]);d+=1}g+=`<td>${l}</td>`,q[e]=l,n+=l,l=0,e+=1,f=f.add(1,"month")}for(g+=`<td>${n}</td><td>${(n/(k+1)).toFixed(2)}</td>`,g+="</tr>",g+="<tr>",g+="<td>Sessions (Nb)</td>",n=0,e=0,l=0;e<=k;)g+=`<td>${p[e]-v[e]}(${p[e]})</td>`,n+=p[e],e+=1;for(g+=`<td>${n}</td><td>${(n/(k+1)).toFixed(2)}</td>`,g+="</tr>",g+="<tr>",g+="<td>Sessions (PU)</td>",n=0,e=0,l=0;e<=k;)g+=`<td>${(q[e]/(p[e]-v[e])).toFixed(2)}</td>`,n+=l,l=0,e+=1;for(g+=`<td>${n.toFixed(2)}</td><td>n/a</td>`,g+="</tr>",g+="<tr>",g+=`<td colspan=${k} style="text-align:left;">Mentorat</td></tr>`,g+="<tr>",g+="<td>Mentorat (Mt)</td>",e=0,l=0,q=[];e<=k;){let d=1;for(;d<C;){let i=[...Array(8).keys()];for(let m=0;m<i.length;m+=1)l+=a[e][d].sessions.number[m]*a[e][d].sessions.pu[m]-a[e][d].defenses.number[m]*a[e][d].defenses.pu[m],q[e]=l;d+=1}g+=`<td>${l}</td>`,e+=1,l=0}for(g+="<tr>",g+="<tr>",g+="<td>Mentorat (Nb)</td>",n=0,e=0,l=0,p=[];e<=k;)g+=`<td>${w[e]-y[e]}(${w[e]})</td>`,n+=l,l=0,e+=1;for(g+=`<td>${n}</td><td>${(n/(k+1)).toFixed(2)}</td>`,g+="</tr>",g+="<td>Mentorat (PU)</td>",e=0;e<=k;)g+=`<td>${(q[e]/(w[e]-y[e])).toFixed(2)}</td>`,q[e]=l,n+=l,l=0,e+=1;for(g+=`<td>${n}</td><td>${(n/(k+1)).toFixed(2)}</td>`,g+="</tr>",g+="<tr>",g+=`<td colspan=${k} style="text-align:left;">Soutenances</td></tr>`,g+="<tr>",g+="<td>Soutenances (Mt)</td>",n=0,e=0,l=0,p=[],q=[];e<=k;){let d=1;for(p[e]=0;d<C;){let i=[...Array(8).keys()];for(let m=0;m<i.length;m+=1)l+=a[e][d].defenses.number[m]*a[e][d].defenses.pu[m],p[e]+=a[e][d].defenses.number[m];d+=1}g+=`<td>${l}</td>`,q[e]=l,n+=l,l=0,e+=1}for(g+=`<td>${n}</td><td>${(n/(k+1)).toFixed(2)}</td>`,g+="</tr>",g+="<tr>",g+="<td>Soutenances (Nb)</td>",n=0,e=0,l=0;e<=k;)g+=`<td>${p[e]-t[e]}(${p[e]})</td>`,n+=p[e],e+=1;for(g+=`<td>${n}</td><td>${(n/(k+1)).toFixed(2)}</td>`,g+="</tr>",g+="<tr>",g+="<td>Soutenances (PU)</td>",n=0,e=0,l=0;e<=k;)g+=`<td>${((q[e]-t[e])/p[e]).toFixed(2)}</td>`,n+=l,l=0,e+=1;g+=`<td>${n.toFixed(2)}</td><td>n/a</td>`,g+="</tr>",g+=`<td colspan=${k} style="text-align:left;">Bonus</td></tr>`,g+="<tr>",g+="<td>Bonus AF</td>",e=0,l=0;let s=[];for(;e<=k;){let d=a[e][0].bonus;s[e]=0;for(let i=0;i<d.length;i+=1)l+=d[i].sessions>4?d[i].sessions*30/5:d[i].sessions*30/4;g+=`<td>${l}</td>`,s[e]=l,l=0,e+=1}g+="</tr>",g+="<tr>",g+=`<td colspan=${k} style="text-align:left;">TJM</td></tr>`,g+="<tr>",g+="<td>Nb Jrs</td>",e=0;var r=[];n=0,f=c,q=[],f=c.clone();let z=f.clone().endOf("month"),A=[];for(;e<=k;)z.isAfter(h,"day")&&(z=h.clone()),g+=`<td>${Y(f,z)} jrs</td>`,A[e]=Y(f,z),f=f.add(1,"month"),z=z.add(1,"month"),e+=1;for(g+="</tr>",g+="<tr>",g+="<td>TJM</td>",e=0;e<=k;){l=0;let d=1;for(q[e]=0,r[e]=0;d<C;){let i=[...Array(8).keys()];for(let m=0;m<i.length;m+=1)q[e]+=a[e][d].sessions.number[m]*a[e][d].sessions.pu[m];d+=1}g+=`<td>${(q[e]/A[e]).toFixed(2)} €</td>`,e+=1}for(g+="</tr>",g+="<tr>",g+="<td>THM (théorique)</td>",e=0,r=[],n=0,f=c,q=[];e<=k;){l=0;let d=1;for(q[e]=0,r[e]=0;d<C;){let i=[...Array(8).keys()];for(let m=0;m<i.length;m+=1)q[e]+=a[e][d].sessions.number[m]*a[e][d].sessions.pu[m],D(f)?l+=(a[e][d].sessions.number[m]-a[e][d].defenses.number[m])*(45/60):([4,5,6,7].includes(m)&&(l+=(a[e][d].sessions.number[m]-a[e][d].defenses.number[m])*(30/60)),[0,1,2,3].includes(m)&&(l+=(a[e][d].sessions.number[m]-a[e][d].defenses.number[m])*(45/60))),l+=a[e][d].defenses.number[m]*(45/60);d+=1}console.log(`montant mensuel : ${q[e]} + bonus ${s[e]}/ Nb heures ${l} = $((aAmInMonth[_m]+aAmBoInMonth[_m])/iTotal).toFixed(2)`),g+=`<td>${((q[e]+s[e])/l).toFixed(2)} €</td>`,n+=l,r[e]=l,l=0,e+=1,f=f.add(1,"month")}for(g+="</tr>",g+="<tr>",g+="<td>Nb heures</td>",n=0,e=0,l=0;e<=k;)g+=`<td>${r[e].toFixed(2)} h</td>`,n+=l,l=0,e+=1;for(g+=`<td>${n.toFixed(2)}</td><td>n/a</td>`,g+="</tr>",g+="<tr>",g+="<td>THM (person.)</td>",e=0,r=[],n=0,f=c,q=[];e<=k;){l=0;let d=1;for(q[e]=0,r[e]=0;d<C;){let i=[...Array(8).keys()];for(let m=0;m<i.length;m+=1)q[e]+=a[e][d].sessions.number[m]*a[e][d].sessions.pu[m],D(f)?l+=(a[e][d].sessions.number[m]-a[e][d].defenses.number[m])*(GM_config.get("nbHrsfM")/60):([4,5,6,7].includes(m)&&(l+=(a[e][d].sessions.number[m]-a[e][d].defenses.number[m])*(GM_config.get("nbHrsAfM")/60)),[0,1,2,3].includes(m)&&(l+=(a[e][d].sessions.number[m]-a[e][d].defenses.number[m])*(GM_config.get("nbHrsfM")/60))),l+=a[e][d].defenses.number[m]*(GM_config.get("nbHrsD")/60);d+=1}console.log(`montant mensuel : ${q[e]} + bonus ${s[e]}/ Nb heures ${l} = $((aAmInMonth[_m]+aAmBoInMonth[_m])/iTotal).toFixed(2)`),g+=`<td>${((q[e]+s[e])/l).toFixed(2)} €</td>`,n+=l,r[e]=l,l=0,e+=1,f=f.add(1,"month")}for(g+="</tr>",g+="<tr>",g+="<td>Nb heures</td>",n=0,e=0,l=0;e<=k;)g+=`<td>${r[e].toFixed(2)} h</td>`,n+=l,l=0,e+=1;g+=`<td>${n.toFixed(2)}</td><td>n/a</td>`,g+="</tr>",g+="</tbody>",g+="<tfoot>",g+"",g+="</tfoot>",g+="</table>";var M=performance.now();console.log("%cTime to show table :"+(M-o)+" milliseconds.",H),Swal.fire({title:`<strong>Statistiques du ${c.format("DD/MM/YYYY")} au ${h.format("DD/MM/YYYY")}</strong>`,icon:"info",html:g,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:d=>{}})},ua=function(){var c=sttctx.dbase;let h=c.get("students").value();var f="<table>";f+="<caption>Liste des étudiant</caption>",f+="<thead>",f+="<tr>",f+="<th>Nom</th><th>Parcours</th><th>Financé</th><th>date de création</th>",f+="</tr>",f+="</thead>",f+="<tbody>";for(var a in h)f+="<tr>",f+=`<td>${h[a].fullname}</td><td>${h[a].path}</td><td>${h[a].fundedby}</td><td>${h[a].created}</td>`,f+="</tr>";f+="</tbody>",f+="</table>",Swal.fire({title:"<strong>Liste des Etudiants</strong>",icon:"info",html:f,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"fullscreen",onOpen:b=>{var o=b.querySelector("table"),g=new simpleDatatables.DataTable(o)}})},Sa=async function(c="",h="",f=!1){console.info("%c_fetch() waiting return from : "+c,"background-color:green,color:white");const a=await Z.XHR({method:"GET",url:c,responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"}});let b=new DOMParser(),o=b.parseFromString(a.responseText.replace(/\n/mg,""),"text/html");var g={};return f===!0?g=o.querySelectorAll(h):g=o.querySelector(h),g};var ja=function(){console.log("%c in initUI","background-color:green;color:white"),Ta();var c=new Draggabilly(".draggable",{handle:".handle"});Va("animation-target")},Ta=function(){console.log("%c in buildUI","background-color:green;color:white"),GM_addStyle(".flex > * { margin: 2px 1px; }"),GM_addStyle(".flex > :first-child { margin-left: 0; }"),GM_addStyle(".flex > :last-child { margin-right: 0; }"),GM_addStyle(".panel {display: flex; justify-content: center;z-index:999}"),GM_addStyle(".menuBar {border-top: 1px solid; padding: 10px; font-size: 1rem; pointer-events: inherit;position: relative;top:0px;  flex-flow: row wrap;/*align-content: space-between;justify-content: space-between;*/}"),GM_addStyle(".draggable {background: transparent;border-radius: 10px;padding: 20px;}"),GM_addStyle(".draggable.is-pointer-down {background: #09F;}"),GM_addStyle(".draggable.is-dragging { opacity: 0.7; }"),GM_addStyle(".handle {background: #555;background: hsla(0, 0%, 0%, 0.4);width: 20px;height: 20px; border-radius: 10px;}"),GM_addStyle(".flex > :nth-last-child(2) {page-break-after: always; /* CSS 2.1 syntax */break-after: always; /* New syntax */}"),GM_addStyle("#animation-target {width: 10px;height: 5px;background-color:coral;border-radius: 25%;}");var c=document.createElement("div"),h=document.createElement("div");h.classList.add("handle"),c.appendChild(h),c.classList.add("panel","menuBar","flex","draggable"),document.body.appendFirst(c),E("addCbox",S,{},c),E("collectChecked",oa,{},c),E("CollectAuto",qa,{},c),E("showBill",sa,{},c),E("billInDetails",pa,{},c),E("RAZ",ra,{},c),E("SList",ua,{},c),E("statistics",ta,{},c),E("about",na,{},c);var f=document.createElement("div");f.id="animation-target",c.appendChild(f)},E=function(c,h,f,a){a=a||document.body,f=f||{position:"absolute",bottom:"7%",left:"4%","z-index":3};let b=document.createElement("button"),o=b.style;return b.classList.add("button--primary","button"),a.appendChild(b),b.innerHTML=c,b.onclick=h,Object.keys(f).forEach(g=>o[g]=f[g]),b},T=async function(c=null,h=null,f=!0){var a="";a+="<style>",a+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",a+="form input {background: #fff;border: 1px solid #9c9c9c;}",a+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",a+="form button:hover {background: gold;}",a+="form label {padding: 0.5em 0.5em 0.5em 0;}",a+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",a+="form input:focus {outline: 3px solid gold;}",a+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",a+="</style>",a+='<form class="form1" action="">',a+='<label for="dtFrom" class="date">Date de début</label>',c?a+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(c).format("YYYY-MM-DD")+'">':a+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',a+='<label for="dtTo" class="date">Date de fin</label>',c?a+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(h).format("YYYY-MM-DD")+'">':a+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',a+="</form>";const{value:b}=await Swal.fire({title:"<strong>Choix de la période</strong>",icon:"info",html:a,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez la période pour la sélection des temps facturés",showLoaderOnConfirm:!0,preConfirm:()=>[document.getElementById("dtFrom").value,document.getElementById("dtTo").value],onRender:o=>{},onOpen:o=>{f===!0&&o.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:o=>{f===!0&&o.querySelector("#dtFrom").removeEventListener("change")},onAfterClose:o=>{},onDestroy:o=>{}});return c=dayjs(b[0]),h=dayjs(b[1]),await Ua(250),[c,h]};function Ua(c){return new Promise(h=>setTimeout(h,c))}function Va(c){const h=document.getElementById(c),f=k=>h.style.transform=`translateX(${k}px)`;let a=0;const b=7,o=k=>{f(a),a+=b,a>100?requestAnimationFrame(g):requestAnimationFrame(o)},g=k=>{f(a),a-=b,a<-100?requestAnimationFrame(o):requestAnimationFrame(g)};requestAnimationFrame(o)}var Ha=function(c){return Object.prototype.toString.call(c).slice(8,-1).toLowerCase()};_.trueTypeOf=Ha;var Ia=function(){if(!window.DOMParser)return!1;var c=new DOMParser();try{c.parseFromString("x","text/html")}catch(h){return!1}return!0;return _.trueTypeOf(fetchInject)!=="function"&&console.log("%cWe Will have a problem because fetchInject isn't loaded","background-color:red;color:white"),_.trueTypeOf(document.arrive)!=="function"&&(console.warn("%cWe have a problem document.arrive is not loaded, let's try another strategy for loading it","background-color:coral;color:white"),fetchInject(["https://raw.githubusercontent.com/StephaneTy-Pro/userscripts/master/arrive.min.js"]).then(()=>{console.log("external arrive.min.js loaded"),document.arrive(".MuiAvatar-img",ka)})),!0},ka=function(){console.log("%cinSetup","background-color:green;color:white"),GM_addStyle(GM_getResourceText("jspanelcss")),GM_addStyle(GM_getResourceText("toastifycss")),GM_addStyle(GM_getResourceText("simpledatatablecss")),GM_registerMenuCommand("OC Facturier - configure",ha),GM_config.get("hackheaderzindex")===!0&&(document.getElementById("header").style.zIndex=0),GM_addStyle(".swal2-content{font-size:"+GM_config.get("sizeofcontentlist")+"}"),GM_addStyle(".swal2-title{font-size:1.275em)"),Ja()},Ja=function(){console.log("​​​%cMainLoaded​​​","background-color:green;color:white");var c=new LocalStorage("db"),h=low(c);h.defaults({students:[],pricing:[],sessions:[],f_archives:[]}).write();var f={dbase:h};window.sttctx=f,dayjs.extend(dayjs_plugin_isSameOrAfter),dayjs.extend(dayjs_plugin_isSameOrBefore),dayjs.extend(dayjs_plugin_isBetween),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_customParseFormat),document.querySelector(".panel.menuBar.flex.draggable")===null&&ja(),GM_config.get("alwaysaddcbox")===!0&&S(),dayjs.locale("fr")};const Ka=Ia();console.log("%cAre all functions supported ?","background-color:green;color:white",Ka);document.arrive(".MuiAvatar-img",ka);HTMLElement.prototype.appendFirst=function(c){this.firstChild?this.insertBefore(c,this.firstChild):this.appendChild(c)};})();
//# sourceMappingURL=biling.min.js.map
