// // ==UserScript==
// @name         Facturier (alpha)
// @namespace    http://tampermonkey.net/
// @version      1.0001
// @description  Un addon pour vous aidez dans votre facturation
// @author       Stéphane TORCHY
// @updateURL    https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/dist/app.min.js
// @downloadURL  https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/dist/app.min.js
// @match        https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history*
// @grant        unsafeWindow
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @grant        GM_registerMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        GM.xmlHttpRequest

// @require      https://cdn.jsdelivr.net/npm/lodash@4.17.19/lodash.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/low.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/LocalStorage.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/dayjs.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/locale/fr.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isBetween.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrBefore.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrAfter.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/customParseFormat.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/localeData.min.js


// GM_Config
// @require      https://openuserjs.org/src/libs/sizzle/GM_config.js

// sweetalert 2
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.all.min.js

// draggabilly
// @require      https://cdnjs.cloudflare.com/ajax/libs/draggabilly/2.2.0/draggabilly.pkgd.min.js

// toastify
// @require     https://cdn.jsdelivr.net/npm/toastify-js@1.8.0/src/toastify.min.js
// @resource    toastifycss https://raw.githubusercontent.com/apvarun/toastify-js/master/src/toastify.css

//
// @require     https://raw.githubusercontent.com/uzairfarooq/arrive/master/minified/arrive.min.js

// simple-datatables
// @require     https://cdn.jsdelivr.net/npm/simple-datatables@latest
// @resource    simpledatatablecss https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css

// require https://raw.githubusercontent.com/anywhichway/nano-memoize/master/dist/nano-memoize.min.js
// @require https://cdn.jsdelivr.net/npm/moize@5.4.7/dist/moize.min.js

// require https://raw.githubusercontent.com/StephaneTy-Pro/userscripts/master/fetch-inject.umd.min.js
// @require https://cdn.jsdelivr.net/npm/fetch-inject

// PARSER MKDOWN
// @require 	 https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js

// PDF https://pdf-lib.js.org/docs/api/
// @require      https://unpkg.com/pdf-lib@1.9.0/dist/pdf-lib.min.js
// @require      https://unpkg.com/downloadjs@1.4.7/download.js

/*
 * History
 * cf https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon/blob/master/CHANGELOG.md
 */



// ==/UserScript==

(function() {

    'use strict';
let ta=Object.defineProperty,Ua=Object.prototype.hasOwnProperty,eb=(a,f)=>()=>(f||(f={exports:{}},a(f.exports,f)),f.exports),Va=a=>ta(a,"__esModule",{value:!0}),fb=(a,f)=>{Va(a);for(let c in f)ta(a,c,{get:f[c],enumerable:!0})},gb=(a,f)=>{Va(a);if(typeof f==="object"||typeof f==="function")for(let c in f)Ua.call(f,c)&&!Ua.call(a,c)&&c!=="default"&&ta(a,c,{get:()=>f[c],enumerable:!0});return a},ja=a=>a&&a.__esModule?a:gb(ta({},"default",{value:a,enumerable:!0}),a);var X=eb(j=>{fb(j,{APP_AUTHOR:()=>Da,APP_DEBUG_STYLE:()=>x,APP_ERROR_STYLE:()=>Ga,APP_INFO_STYLE:()=>Fa,APP_LOG_STYLE:()=>Ea,APP_NAME:()=>na,APP_PERF_STYLE:()=>F,APP_WARN_STYLE:()=>ha,OC_AUTOFUNDED:()=>la,OC_FUNDED:()=>oa,OC_MAX_LEVEL:()=>R,OC_PRICE1:()=>$,OC_PRICE2:()=>aa,OC_PRICE3:()=>ba,OC_PRICE4:()=>ca,OC_PRICE5:()=>da,OC_PRICE6:()=>ea,OC_STATUS_0:()=>I,OC_STATUS_1:()=>V,OC_STATUS_2:()=>O,OC_STATUS_3_F:()=>L,OC_STATUS_3_M:()=>K,default:()=>h});const m={Cfg:{dbase:null},start:async function(){await Ta();const d=m.checkSupport();console.log(`%cAre all functions supported ? : ${d}`,x),document.arrive(".MuiAvatar-img",m._warmup)},checkSupport:function(){return!0},_warmup:function(){console.log("%cinSetup",x),GM===void 0?(console.log("%cI am not in a tamper env"),m._userscriptless()):console.log(`%cTamper environment detected the version is ${GM.info.version}`,x),GM_addStyle(GM_getResourceText("jspanelcss")),GM_addStyle(GM_getResourceText("toastifycss")),GM_addStyle(GM_getResourceText("simpledatatablecss")),GM_config.init(Qa),GM_registerMenuCommand("OC Facturier - configure",Ra),GM_config.get("hackheaderzindex")===!0&&(document.getElementById("header").style.zIndex=0),GM_addStyle(".swal2-content{font-size:"+GM_config.get("sizeofcontentlist")+"}"),GM_addStyle(".swal2-title{font-size:1.275em)"),m._main()},_userscriptless(){},_main:function(){console.log("​​​%cMainLoaded​​​",x);let d=new LocalStorage("db");var k=low(d);k.defaults({students:[],sessions:[],f_archives:[],history_session_cache:[]}).write(),m.Cfg.dbase=k,dayjs.extend(dayjs_plugin_isSameOrAfter),dayjs.extend(dayjs_plugin_isSameOrBefore),dayjs.extend(dayjs_plugin_isBetween),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_customParseFormat),document.querySelector(".panel.menuBar.flex.draggable")===null&&Sa.init(),GM_config.get("alwaysaddcbox")===!0&&za(),dayjs.locale("fr");if(GM_config.get("use_custom_css")===!0){let p=GM_config.get("custom_css_url"),C=p.split(",");if(C.length!==0)fetchInject([C]).then(()=>{console.log(`%cDependencies ${C} loaded`,x)});else{let A=GM_config.get("custom_css_data");A.length()>0&&console.log(`%cNeed to inject a custom css in application content is ${A}`,x)}}GM.info.script.downloadURL==="https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/billing.js"?(console.log("%cALERTE .... version locale !!!!!! ","background-color:coral;color:white"),unsafeWindow.Facturier={libs:[],cfg:{dbase:null}},unsafeWindow.Facturier.cfg.dbase=m.Cfg.dbase,unsafeWindow.Facturier.libs.push({id:"fetchInject",ptr:fetchInject}),unsafeWindow.Facturier.libs.push({id:"dayjs",ptr:dayjs}),console.log("%cImportants values are exported in unsafeWindow.Facturier",x),m.loadDependencies()):console.log(`GM.info.script.downloadURL url : ${GM.info.script.downloadURL}`)},loadDependencies:function(){let d=[];d.push("http://localhost:8000/src/branch01/sandbox.js"),d.push("http://localhost:8000/src/branch01/sandbox.css"),fetchInject(d).then(()=>{console.log(`dependencies ${d} loaded`)})}};window.Facturier!==void 0?window.Facturier.start():m.start();var h=m});var ra={async XHR(a){const f=window.GM_xmlhttpRequest||(GM?GM.xmlHttpRequest:null);return f?new Promise((c,b)=>{Object.assign(a,{onabort:b,onerror:b,onload:c,ontimeout:b}),f(a)}):Promise.reject()},async getValue(a,f=null){return window.GM_getValue?Promise.resolve(GM_getValue(a)||f):await GM.getValue(a)||f},async setValue(a,f){window.GM_setValue?GM_setValue(a,f):GM.setValue(a,f)}};const na="OC-Addons",Da="Stéphane TORCHY",x="background-color:green;color:white",Ea="background-color:black;color:white",ha="background-color:coral;color:white",Fa="background-color:cyan;color:white",Ga="background-color:red;color:white",F="background-color:blue;color:white",la="auto-financé",oa="financé par un tiers",I="réalisée",V="annulée",O="annulée tardivement",K="étudiant absent",L="étudiante absente",R=6,$=30,aa=35,ba=40,ca=45,da=50,ea=55;var Ta=function(){return new Promise(a=>{document.readyState=="loading"?document.addEventListener("DOMContentLoaded",a):a()})},pa=async function(a="",f="",c=!1){console.info(`%cfetch() waiting return from : ${a}`,x);const b=await ra.XHR({method:"GET",url:a,responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"}});let e=new DOMParser(),m=e.parseFromString(b.responseText.replace(/\n/mg,""),"text/html");var h={};return c===!0?h=m.querySelectorAll(f):h=m.querySelector(f),h},Y=function(a,f=-1){try{var c=(a.children[0].href||"/").split("/");return c[c.length+f]}catch(b){throw Error("Erreur qui ne devrait jamais arriver en getkey :"+b.stack||b)}},Ba=function(a){var f=a.trim().split(" ");try{id=dayjs_locale_fr.months.findIndex(c=>c===f[1])+1}catch(c){throw Error("Erreur qui ne devrait jamais arriver en conversion de date :"+c.stack||c)}return`${f[2]}-${id}-${f[0]}T${f[4]}`},Ha=function(a,f=0){f===-1&&(f=a.children.length-1);var c=a.children[f].children[0].innerText;let b=Ba(c);var e=dayjs(b);return e};function Ca(a){return new Promise(f=>setTimeout(f,a))}HTMLElement.prototype.appendFirst=function(a){this.firstChild?this.insertBefore(a,this.firstChild):this.appendChild(a)};var ga=async function(a=null,f=null,c=!0){var b="";b+="<style>",b+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",b+="form input {background: #fff;border: 1px solid #9c9c9c;}",b+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",b+="form button:hover {background: gold;}",b+="form label {padding: 0.5em 0.5em 0.5em 0;}",b+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",b+="form input:focus {outline: 3px solid gold;}",b+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",b+="</style>",b+='<form class="form1" action="">',b+='<label for="dtFrom" class="date">Date de début</label>',a?b+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(a).format("YYYY-MM-DD")+'">':b+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',b+='<label for="dtTo" class="date">Date de fin</label>',a?b+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(f).format("YYYY-MM-DD")+'">':b+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',b+="</form>";const{value:e}=await Swal.fire({title:"<strong>Choix de la période</strong>",icon:"info",html:b,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez la période pour la sélection des temps facturés",showLoaderOnConfirm:!0,preConfirm:()=>[document.getElementById("dtFrom").value,document.getElementById("dtTo").value],onRender:m=>{},onOpen:m=>{c===!0&&m.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:m=>{c===!0&&m.querySelector("#dtFrom").removeEventListener("change")},onAfterClose:m=>{},onDestroy:m=>{}});return a=dayjs(e[0]),f=dayjs(e[1]),await Ca(250),[a,f]},wa=async function(a){await Swal.fire({position:"top-end",icon:"success",title:a,showConfirmButton:!1,timer:1500})};const qb=ja(X());class W{static tbl_name="f_archives";static add=async function(a){let f=qb.default.Cfg.dbase,c=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),b={id:a[0].to.format("YYYYMM"),data:a,created_at:a[0].now};console.log(`%cWill create archive for id ${a[0].to.format("YYYYMM")} (YYYYMM)`,x),f.get(W.tbl_name).push(JSON.parse(JSON.stringify(b))).write()};static exists=function(a){let f=qb.default.Cfg.dbase,c=f.get(W.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static get=function(a){let f=qb.default.Cfg.dbase;var c=f.get(W.tbl_name).find({id:a}).value();if(c===void 0){throw Error("Erreur qui ne devrait jamais arriver en Archive.get");return!1}else return console.log(`%cWill use archive for id ${a} (YYYYMM)`,x),c};static delete=function(a=null,f=null){let c=qb.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(a===null&&f==null){console.log("%cWanna suppress ALL Archives from DB ",x),c.get(W.tbl_name).remove().write();return}if(f==null){c.get(W.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isBefore(f),"month"}).write();return}if(a==null){c.get(W.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isAfter(a,"month")}).write();return}c.get(W.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isBetween(a,f,"month","[]")}).write()}}var fa=W;class Xa{static isInOldMode=function(a){var f=null;typeof a==="string"?f=dayjs(a):f=a;try{return f.isBefore(dayjs("2020-06-01"))}catch(c){throw Error("Erreur qui ne devrait jamais arriver en IsInOldMode (probablement un probleme sur la conversion de la date en objet dayjs:"+c.stack||c)}}}var M=Xa;const fc=ja(X());class G{static tbl_name="students";static add=function(a,f="noname",c="nopath",b="unkonw",e){let m=fc.default.Cfg.dbase;var h=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");let j={id:a,fullname:f,path:c,fundedby:b,created:h};m.get(G.tbl_name).push(JSON.parse(JSON.stringify(j))).write()};static exists=function(a){let f=fc.default.Cfg.dbase;var c=f.get(G.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static getFunded=function(a){let f=fc.default.Cfg.dbase,c=f.get(G.tbl_name).find({id:a}).value();if(c==void 0)throw Error(`IRRECOVERABLE ERROR STUDENT WITH ID ${a} NOT IN DB:`);return c.fundedby};static isAutoFunded=function(a){return G.getFunded(a).toLowerCase()===la};static getFinancialMode=async function(a){const f=await pa(`https://openclassrooms.com/fr/mentorship/students/${a}/dashboard`,".mentorshipStudent__details > p");return f.innerText};static delete=function(a=null,f=null){let c=fc.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(a===null&&f==null){console.log("%cWanna suppress ALL Students from DB",x),c.get(G.tbl_name).remove().write();return}if(f==null){c.get(G.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isBefore(f),"day"}).write();return}if(a==null){c.get(G.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isAfter(a,"day")}).write();return}c.get(G.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isBetween(a,f,"day","[]")}).write()};static getAll=async(a,f)=>{var c=!1;let b=fc.default.Cfg.dbase;var e="table.crud-list tbody",m=document.querySelectorAll(e)[1],h=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");Swal.fire({position:"top-end",icon:"info",toast:!0,title:`mise à jour de la base de donnée des étudiants...
cela peut prendre du temps`,showConfirmButton:!1,timer:1e3});for(const k of m.children){var j=Y(k.children[0],-2),n=k.children[0].innerText,l="non défini";k.children[1].firstElementChild&&(l=k.children[1].firstElementChild.href.split("/").pop());var d=b.get(G.tbl_name).find({id:j}).value();if(d&&c===!1)console.log(`%c${n}(uniquid:${j}) already present in database created at ${d.created}`,x);else{let p=await G.getFinancialMode(j);console.log(`%cFinancial Mode of student ${n}(id:${j}) is ${p}`,x),Toastify({text:`Ajoute l'étudiant : ${n}(${p}) en base`,gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast(),G.add(j,n,l,p,h)}}};static showList=function(){let a=fc.default.Cfg.dbase,f=a.get(G.tbl_name).value();var c="";c+="<table>",c+="<caption>Liste des étudiant</caption>",c+="<thead>",c+="<tr>",c+="<th>Nom</th><th>Parcours</th><th>Financement</th><th>Date de création</th>",c+="</tr>",c+="</thead>",c+="<tbody>";for(var b in f)c+="<tr>",c+=`<td>${f[b].fullname}</td><td>${f[b].path}</td><td>${f[b].fundedby}</td><td>${f[b].created.format("DD/MM/YYYY à HH:mm")}</td>`,c+="</tr>";c+="</tbody>",c+="</table>",Swal.fire({title:"<strong>Liste des Etudiants</strong>",icon:"info",html:c,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"fullscreen",onOpen:e=>{var m=e.querySelector("table"),h=new simpleDatatables.DataTable(m)}})};static createManually=async function(a,f,c){let b=["non présent dans la liste","Chef de projet digital","Chef de projet SI","Développeur d'application - Frontend","Développeur Web","Expert en stratégie marketing et communication ","Production de contenu web avec CMS et Content Marketing ","Tech lead"];var e="";e+="<style>",e+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",e+="form input {background: #fff;border: 1px solid #9c9c9c;}",e+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",e+="form button:hover {background: gold;}",e+="form label {padding: 0.5em 0.5em 0.5em 0;}",e+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",e+="form input:focus {outline: 3px solid gold;}",e+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",e+="</style>",e+='<form class="form1" action="">',e+='<label for="student_id" class="name">Reference</label>',e+='<input id="student_id" type="text" value="'+a+'">',e+='<label for="student_name" class="name">Name</label>',e+='<input id="student_name" type="text" value="'+f+'">',e+='<label for="fundedby">Autofinancé</label>',e+='<input id="fundedby" type="checkbox" value="autofunded">',e+='<label for="student_path">Parcours</label>',e+='<input id="student_path" name="student_path" type="text" list="student_path-list">',e+='<datalist id="student_path-list">';for(var m in b)e+=`<option>${b[m]}</option>`;e+="/<datalist>",e+='<label for="session_date">Date</label>',e+='<input id="session_date" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(c).format("YYYY-MM-DD")+'">',e+="</form>";const{value:h}=await Swal.fire({title:"<strong>Ajout d'un étudiant en mode manuel</strong>",icon:"info",html:e,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:`votre étudiant(e) ${f} n'a pas été trouvé`,preConfirm:()=>[document.getElementById("student_id").value,document.getElementById("student_name").value,document.getElementById("student_path").value,document.getElementById("fundedby").checked,document.getElementById("session_date").value]});if(h){var j="";h[3]===!0?j=la:j=oa,G.add(h[0],h[1],h[2],j,h[4])}}}var P=G;const $b=ja(X());class S{static tbl_name="sessions";static add=async function(a){let f=$b.default.Cfg.dbase;if(GM_config.get("checksessionalreadyexists")===!0)var c=!0;if(M.isInOldMode(dayjs(a.when)))a.isFunded=!0;else if(a.type.toLowerCase()==="soutenance")a.isFunded=!0;else{var b=P.exists(a.who_id);console.log("is student in db ?",b);if(b==!1){console.warn("%cI'm updating db .... could'nt do anything else",ha),await P.getAll();var e=P.exists(a.who_id);if(e==!1)return P.createManually(a.who_id,a.who_name,a.when)}a.isFunded=!P.isAutoFunded(a.who_id)}c?S.exists(a.id)==!1?f.get(S.tbl_name).push(JSON.parse(JSON.stringify(a))).write():console.info(`%cSession of ${a.who_name} at ${a.when} already present in database table sessions, skip it!`,x):f.get(S.tbl_name).push(JSON.parse(JSON.stringify(a))).write()};static exists=function(a){let f=$b.default.Cfg.dbase;var c=f.get(S.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static delete=function(a=null,f=null){let c=$b.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(a===null&&f==null){console.log("%cWanna suppress ALL Sessions from DB",x),c.get(S.tbl_name).remove().write();return}if(f==null){c.get(S.tbl_name).remove(function(b){return dayjs(b.when).isBefore(f),"day"}).write();return}if(a==null){c.get(S.tbl_name).remove(function(b){return dayjs(b.when).isAfter(a,"day")}).write();return}c.get(S.tbl_name).remove(function(b){return dayjs(b.when).isBetween(a,f,"day","[]")}).write()};static parseTable=function(a){var f=a.children[0].children[0].innerText,c=Y(a.children[0]),b=a.children[1].children[0].innerText,e=Y(a.children[1],-2),m=a.children[2].innerText.trim().toLowerCase(),h=a.children[3].children.length?a.children[3].children[0].innerText.trim().toLowerCase():"session",j=-1;a.children[4].children.length>0&&(j=a.children[4].children[0].innerText),f=Ba(f);var n={id:c,when:f,who_id:e,who_name:b,status:m,type:h,lvl:j};return n}}var J=S;const kb=ja(X());class ua{static calculateBill=function(a,f){let c=f.format("YYYYMM");if(fa.exists(c)===!0){console.log("%cUse Archived version ${sArchiveId} of accounting",x);let b=fa.get(c);return b.data}return typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD")),ua.memoized(a,f)};static _calculateBill=function(a,f){typeof a==="string"&&(a=dayjs(a)),typeof f==="string"&&(f=dayjs(f));var c=performance.now();let b=kb.default.Cfg.dbase;var e=b.get(J.tbl_name).filter(g=>dayjs(g.when).isSameOrBefore(f,"day")&&dayjs(g.when).isSameOrAfter(a,"day")),m=e.filter(g=>g.type.toLowerCase()==="soutenance")||0;let h=[0,$,aa,ba,ca,da,ea],j=[],n=[];for(let g=1;g<=R;g+=1)n[g]=[],n[g][0]={session:null,defense:null},n[g][1]={session:null,defense:null},n[g][2]={session:null,defense:null},n[g][3]={session:null,defense:null},n[g][4]={session:null,defense:null},n[g][5]={session:null,defense:null},n[g][6]={session:null,defense:null},n[g][7]={session:null,defense:null},n[g][0].session=e.filter(i=>i.lvl==g&&i.status===I&&i.isFunded===!0)||0,n[g][1].session=e.filter(i=>i.lvl==g&&i.status===V&&i.isFunded===!0)||0,n[g][2].session=e.filter(i=>i.lvl==g&&i.status===O&&i.isFunded===!0)||0,n[g][3].session=e.filter(i=>i.lvl==g&&(i.status===K||i.status===L)&&i.isFunded===!0)||0,n[g][4].session=e.filter(i=>i.lvl==g&&i.status===I&&i.isFunded===!1)||0,n[g][5].session=e.filter(i=>i.lvl==g&&i.status===V&&i.isFunded===!1)||0,n[g][6].session=e.filter(i=>i.lvl==g&&i.status===O&&i.isFunded===!1)||0,n[g][7].session=e.filter(i=>i.lvl==g&&(i.status===K||i.status===L)&&i.isFunded===!1)||0,n[g][0].defense=m.filter(i=>i.lvl==g&&i.status===I&&i.isFunded===!0)||0,n[g][1].defense=m.filter(i=>i.lvl==g&&i.status===V&&i.isFunded===!0)||0,n[g][2].defense=m.filter(i=>i.lvl==g&&i.status===O&&i.isFunded===!0)||0,n[g][3].defense=m.filter(i=>i.lvl==g&&(i.status===K||i.status===L)&&i.isFunded===!0)||0,n[g][4].defense=m.filter(i=>i.lvl==g&&i.status===I&&i.isFunded===!1)||0,n[g][5].defense=m.filter(i=>i.lvl==g&&i.status===V&&i.isFunded===!1)||0,n[g][6].defense=m.filter(i=>i.lvl==g&&i.status===O&&i.isFunded===!1)||0,n[g][7].defense=m.filter(i=>i.lvl==g&&(i.status===K||i.status===L)&&i.isFunded===!1)||0;var l=performance.now();console.log("%cFiltering took "+(l-c)+" milliseconds.",F),j.push({total_errors:0,total_filtered:0,total:e.value().length,control:0}),j.push({type:"bad level",data:e.filter(g=>g.lvl<1||g.lvl>R).value()}),j.push({type:"bad status",data:e.filter(g=>g.status!==I&&g.status!==V&&g.status!==O&&g.status!==K&&g.status!==L).value()}),j.push({type:"bad funded",data:e.filter(g=>g.isFunded!==!1&&g.isFunded!==!0).value()}),j[0].total_errors=j[1].data.length+j[2].data.length+j[3].data.length;var d=[],k=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),p=[];for(let g=1;g<=R;g+=1)M.isInOldMode(a)?p[g]=[h[g],0,h[g]/2,h[g]/2,h[g],0,h[g]/2,h[g]/2]:p[g]=[h[g],0,0,h[g]/2,h[g]/2,0,0,h[g]/4];var C=performance.now();console.log("%cPU calculated took "+(C-l)+" milliseconds.",F);var A=e.filter(g=>g.type.toLowerCase()!=="soutenance"&&g.status===I&&g.isFunded===!1),t=A.groupBy(g=>g.who_id),v=[];for(var q in t.value())v.push({who_id:q,who_name:t.value()[q][0].who_name,sessions:t.value()[q].length});var B=performance.now();console.log("%cBonus took "+(B-C)+" milliseconds.",F);var s=[],y=[],E=0;for(let g=1;g<=R;g+=1){let i=[];i[0]=n[g][0].session.value().length,i[1]=n[g][1].session.value().length,i[2]=n[g][2].session.value().length,i[3]=n[g][3].session.value().length,i[4]=n[g][4].session.value().length,i[5]=n[g][5].session.value().length,i[6]=n[g][6].session.value().length,i[7]=n[g][7].session.value().length,s[g]=[i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7]],E+=s[g].reduce((o,ka)=>o+ka);let w=[];w[0]=n[g][0].defense.value().length,w[1]=n[g][1].defense.value().length,w[2]=n[g][2].defense.value().length,w[3]=n[g][3].defense.value().length,w[4]=n[g][4].defense.value().length,w[5]=n[g][5].defense.value().length,w[6]=n[g][6].defense.value().length,w[7]=n[g][7].defense.value().length,y[g]=[w[0],w[1],w[2],w[3],w[4],w[5],w[6],w[7]]}j[0].total_filtered=E,j[0].control=j[0].total-E;var u=performance.now();console.log("%cPrecalc some vars took "+(u-B)+" milliseconds.",F),d.push({from:a,to:f,created_at:k,errors:j,bonus:v,max_level:R});for(let g=1;g<=R;g+=1){let i=n[g];d.push({sessions:{data:[i[0].session,i[1].session,i[2].session,i[3].session,i[4].session,i[5].session,i[6].session,i[7].session],number:s[g],pu:p[g]},defenses:{data:[i[0].defense,i[1].defense,i[2].defense,i[3].defense,i[4].defense,i[5].defense,i[6].defense,i[7].defense],number:y[g],pu:p[g]}})}var H=performance.now();return console.log("%cMy array full storage took "+(H-u)+" milliseconds.",F),f.isBefore(dayjs())&&fa.add(d),d};static memoized=moize.default(ua._calculateBill,{maxAge:12e4,isSerialized:!0,onCacheAdd:function(a,f,c){console.log("%cCache add",x),console.dir(a.keys)},onCacheHit:function(){console.log("%cCache hit",x)}})}var va=ua;const Rb=ja(X());class Q{static tbl_name="history_session_cache";static getSessionPage=function(a){a.get("day")<a.daysInMonth()&&(a=a.endOf("month"));let f=Rb.default.Cfg.dbase;if(!f.has(Q.tbl_name).value()){throw Error(`DB ${Q.db_name} NOT FOUND`);return-1}let c=f.get(Q.tbl_name).find({id:a.format("YYYYMMDD")}).value();return c===void 0?-1:c};static delete=function(a=null,f=null){let c=Rb.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(a===null&&f==null){c.get(Student.tbl_name).remove().write(),console.log("%cWanna suppress ALL History from DB",x);return}if(f==null){c.get(Student.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isBefore(f),"day"}).write();return}if(a==null){c.get(Student.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isAfter(a,"day")}).write();return}c.get(Student.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isBetween(a,f,"day","[]")}).write()};static addOrUpdateSessionPage=function(a=1,f=dayjs("1970-10-06")){Q.getSessionPage(f)==-1?Q.addSessionPage(a,f):Q.updateSessionPage(a,f)};static updateSessionPage=function(a=1,f=dayjs("1970-10-06")){let c=Rb.default.Cfg.dbase,b=Q.getSessionPage(f);if(b==-1){throw Error("session page not found in history");return-1}c.get(Q.tbl_name).find({id:f.format("YYYYMMDD")}).assign({page:a}).write()};static addSessionPage=function(a=1,f=dayjs("1970-10-06")){let c=Rb.default.Cfg.dbase;c.get(Q.tbl_name).push(JSON.parse(JSON.stringify({id:f.format("YYYYMMDD"),page:a}))).write()}}var qa=Q;const Wb=ja(X());class cb{static detail_bill="truc";static getListDetailBill=function(a,f){let c=Wb.default.Cfg.dbase,b=c.get(J.tbl_name).filter(d=>dayjs(d.when).isSameOrBefore(f,"day")&&dayjs(d.when).isSameOrAfter(a,"day")).sortBy(function(d){return dayjs(d.when).valueOf()}).value();var e=[0,$,aa,ba,ca,da,ea];let m=0;for(var h in b){if(b[h].lvl>e.length-1)throw Error("ERROR PRICE ARRAY MUST BE UPDATED IN LISTS.JS");var j=b[h].isFunded===!0?e[b[h].lvl]:e[b[h].lvl]*.5,n=0,l=!0;M.isInOldMode(dayjs(b[h].when))?b[h].status===I?n=j:(b[h].status===K||b[h].status===L||b[h].status===O)&&(n=j*.5):(l=!1,b[h].status===I?n=j:(b[h].status===K||b[h].status===L)&&(n=j*.5)),m+=n,b[h].iPu=j,b[h].oldMode=l,b[h].iCumul=m,b[h].iFPu=n}return b}}var ya=cb;var xa=function(a,f){let c=[[0,1,2,3,4,5,5],[5,1,2,3,4,5,5],[4,5,1,2,3,4,4],[3,4,5,1,2,3,3],[2,3,4,5,1,2,2],[1,2,3,4,5,1,1],[0,1,2,3,4,5,0]];return Math.trunc(f.diff(a,"days")/7)*5+c[a.day()][f.day()]};var Ia=async function(){var a="";a+="<style>div.about_content {background-color: #fed9ff;/*width: 600px;*/height: var(--heigth, 80%);overflow-x: hidden;overflow-y: auto;text-align: left;padding: 20px;}</style>",a+='<div class="about_content" style="--heigth: 600px;">',a+='<div class="about_content__wrapper">';const f=await ra.XHR({method:"GET",url:"https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/README.md",responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"}});var c=f.responseText,b=new showdown.Converter(),e=b.makeHtml(c);a+=e,a+="</div>",a+="</div>",Swal.fire({title:`<strong>A propos de ${na}</strong>`,icon:"info",html:a,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},za=function(){var a="table.crud-list tbody",f=document.querySelector(a),c=!1;if(f.querySelector("[type=checkbox]")===null){for(const p of f.children){var b=Y(p.children[0]),e=document.createElement("input");e.type="checkbox",e.name="name",e.value=b,e.id="id",c=J.exists(b),c===!0&&(e.checked=!0);var m=document.createElement("td");m.style="text-align: center",m.appendChild(e),p.appendChild(m)}a="table.crud-list thead tr";var h=document.querySelector(a);e=document.createElement("input"),e.type="checkbox",e.name="name",e.value="value",e.id="id",e.onclick=function(){document.querySelectorAll("tbody input[type=checkbox]").forEach(p=>p.checked=!p.checked)},e.style="visibility: hidden;";var j=document.createElement("label");j.innerText="in DB",j.style="display:block;",j.onMouseOver="this.style.cursor=pointer;",j.onMouseOut="this.style.cursor=auto;",j.appendChild(e),m=document.createElement("td"),m.style="text-align: center",m.appendChild(j),h.appendChild(m)}else{for(var n=f.querySelectorAll("[type=checkbox]"),l=n.length,d=new Array(l);l--;d[l]=n[l]);for(var k in d)c=J.exists(d[k].value),c===!0?d[k].checked=!0:d[k].checked=!1}},Ja=async function(){var[a,f]=await ga(dayjs().startOf("month"),dayjs().endOf("month"));let c=ya.getListDetailBill(a,f),b="";b+="<table>",b+="<thead>",b+="<tr><th>Quand</th><th>Qui</th><th>Financé ?</th><th>Ancien Mode ?</th><th>PU HT</th><th>Statut</th><th>PU (corrigé) HT</th><th>Cumul</th></tr>",b+="<thead>",b+="<tbody>";var e=0;for(let m=0;m<c.length;m+=1)b+="<tr>",b+=`<td>${dayjs(c[m].when).format("DD/MM/YYYY à HH:mm:ss")}</td><td>${c[m].who_name}</td><td>${c[m].isFunded===!0?"Oui":"Non"}</td><td>${c[m].oldMode===!0?"Oui":"Non"}</td><td>${c[m].iPu}</td><td>${c[m].status}</td><td>${c[m].iFPu}</td><td>${c[m].iCumul}€</td>`,b+="</tr>";b+="</tbody>",b+="</table>",Swal.fire({title:`<strong>Liste détaillées des sessions du ${a.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,icon:"info",html:b,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:m=>{var h=m.querySelector("table"),j=new simpleDatatables.DataTable(h)}})},Ka=async function(){for(var a="table.crud-list tbody input:checked",f=document.querySelectorAll(a),c=0;c<f.length;c+=1){var b=f[c].parentElement.parentElement,e=J.parseTable(b);await J.add(e)}wa(`Collecte des sessions cochées
terminée`)},La=async function(){var[a,f]=await ga(dayjs().startOf("month"),dayjs().endOf("month"));let c=0,b=GM_config.get("maxfetchpg"),e=!0;var m={};let h=[],j=1,n=qa.getSessionPage(f);for(n!==void 0&&n.page>j&&(j=n.page);e;){if(c>b){console.warn("%cEMERGENCY EXIT LOOP",ha);break}m=await Ya(a,f,j,h),m.length>0&&dayjs(m[m.length-1].when).isSameOrBefore(a)===!0&&(e=!1);let d=dayjs(m[m.length-1].when),k=dayjs(m[20*c].when);if(d.get("month")!=k.get("month")){let p=d.endOf("month");qa.addOrUpdateSessionPage(j,p)}j+=1,c+=1}for(var l in m){if(dayjs(m[l].when).isBefore(a,"day")===!0){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions
Collecte terminée`,showConfirmButton:!1,timer:1500});break}if(dayjs(m[l].when).isAfter(f,"day")===!0)continue;dayjs(m[l].when).isBetween(a,f,"day","[]")&&await J.add(m[l])}za(),wa("Collecte automatique terminée")},Ya=async function(a,f,c=1,b=[]){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions de l'historique
du `+a.format("DD/MM/YYYY")+" au "+f.format("DD/MM/YYYY")+`
page : `+c+`
cela peut prendre du temps...`,showConfirmButton:!1,timer:3e3});let e=await pa(`https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history?page=${c}`,"table.crud-list tbody");if(e===null)throw new Error("Something went wrong .... try to navigate forward and backward or click some buttons to change url");if(Ha(e,-1).isAfter(f,"day")===!0)return console.log("optimisation ne charge pas ce n'est pas encore arrivé"),b;for(var m=0;m<e.children.length;m+=1){var h=e.children[m],j=J.parseTable(h);b.push(j)}return b},Ma=function(){const{degrees:a,PDFDocument:f,rgb:c,StandardFonts:b}=PDFLib;async function e(){const j="https://pdf-lib.js.org/assets/with_update_sections.pdf",n=await fetch(j).then(v=>v.arrayBuffer()),l=await f.load(n),d=await l.embedFont(b.Helvetica),k=l.getPages(),p=k[0],{width:C,height:A}=p.getSize();p.drawText("This text was added with JavaScript!",{x:5,y:A/2+300,size:50,font:d,color:c(.95,.1,.1),rotate:a(-45)});const t=await l.save();download(t,"pdf-lib_modification_example.pdf","application/pdf")}async function m(){const j=await f.create(),n=await j.embedFont(b.TimesRoman),l=j.addPage(),{width:d,height:k}=l.getSize(),p=30;l.drawText("Creating PDFs in JavaScript is awesome!",{x:50,y:k-4*p,size:p,font:n,color:c(0,.53,.71)});const C=await j.save();download(C,"pdf-lib_modification_example.pdf","application/pdf")}async function h(){var[j,n]=await ga(dayjs().startOf("month"),dayjs().endOf("month"));let l=ya.getListDetailBill(j,n);const d=await f.create(),k=await d.embedFont(b.TimesRoman),p=d.addPage(),{width:C,height:A}=p.getSize(),t=30;p.drawText(`Prestations en détail

 du ${j.format("DD/MM/YYYY")} au ${n.format("DD/MM/YYYY")}`,{x:50,y:A/2-t,size:t,font:k,color:c(116/255,81/255,235/255)});let v=d.addPage(),q=12,B=1.25;v.font_size=q,v.line_space=B,v.font=k;let s=1,y=20,E=B*q+y,u=A/2;const H=function(D){const r="LOrEm ipsum DOLor sit aMet, conSEc/tetUr 25 porttitor. ";return D*1.0925*(k.widthOfTextAtSize(r,q)/r.length)};let g=[0,H(18),H(36),H(18),H(5),H(8),H(5),H(7)],i=16,w=25;for(let D=1;D<l.length;D+=1){u=A-B*q*s,u<E&&(s=1,v=d.addPage(),u=A-B*q*s);if(s===1){let z=w;v.drawText("Quand",{font:k,size:q,y:u,x:z,lineHeight:i}),z+=g[1],v.drawText("Qui",{font:k,size:q,y:u,x:z,lineHeight:i}),z+=g[2],v.drawText("Quoi",{font:k,size:q,y:u,x:z,lineHeight:i}),z+=g[3],v.drawText("PU",{font:k,size:q,y:u,x:z,lineHeight:i}),z+=g[4],v.drawText("Statut",{font:k,size:q,y:u,x:z,lineHeight:i}),z+=g[5],v.drawText("PUf",{font:k,size:q,y:u,x:z,lineHeight:i}),z+=g[6],v.drawText("Montant",{font:k,size:q,y:u,x:z,lineHeight:i}),s+=1,u=A-B*q*s}let r=w;v.drawText(dayjs(l[D].when).format("DD/MM/YYYY à HH:mm"),{font:k,size:q,y:u,x:r,lineHeight:i}),r+=g[1],v.drawText(l[D].who_name.trim(),{font:k,size:q,y:u,x:r,lineHeight:i}),r+=g[2],v.drawText(`${l[D].type} ${l[D].isFunded===!0?"F.":"AF"} (${l[D].lvl})`,{font:k,size:q,y:u,x:r,lineHeight:i}),r+=g[3],v.drawText(l[D].iPu.toString(),{font:k,size:q,y:u,x:r,lineHeight:i}),r+=g[4],v.drawText(l[D].status,{font:k,size:q,y:u,x:r,lineHeight:i}),r+=g[5],v.drawText(l[D].iFPu.toString(),{font:k,size:q,y:u,x:r,lineHeight:i}),r+=g[6],v.drawText(l[D].iCumul.toString(),{font:k,size:q,y:u,x:r,lineHeight:i}),s+=1}const o=d.getPages();o.forEach((D,r)=>{D.moveTo(10,15),D.setFont(k),D.setFontSize(12),D.setFontColor(c(1,0,0)),D.drawText("Facturier version: XX.XX",{x:15}),D.drawText(`page ${r+1} / ${o.length}`,{x:C-k.widthOfTextAtSize("page 999/999",12)}),D.drawRectangle({x:10,y:10,width:C-20,height:20,color:c(253/255,246/255,227/255),opacity:.6,borderColor:c(0,0,0),borderWidth:1})});const ka=await d.save();download(ka,`prestations_facturees_detail_${j.format("YYYYMMDD")}-${n.format("YYYYMMDD")}.pdf`,"application/pdf")}h()},Na=async function(){GM_addStyle(".form_addon {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}"),GM_addStyle(".form_addon input {background: #fff;border: 1px solid #9c9c9c;}"),GM_addStyle(".form_addon button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}"),GM_addStyle(".form_addon button:hover {background: gold;}"),GM_addStyle(".form_addon label {padding: 0.5em 0.5em 0.5em 0;}"),GM_addStyle(".form_addon input {padding: 0.7em;margin-bottom: 0.5rem;}"),GM_addStyle(".form_addon input:focus {outline: 3px solid gold;}"),GM_addStyle("@media (min-width: 400px) {.form_addon {grid-template-columns: 200px 1fr;grid-gap: 16px;} .form_addon label {text-align: right;grid-column: 1 / 2;} .form_addon input, .form_addon button {grid-column: 2 / 3;}}");var a="";a+='<form id="RAZ" class="form_addon" action="">',a+='<label for="students" class="cbox">Etudiants</label>',a+='<input id="students" type="checkbox" value="del_students_true" checked>',a+='<label for="sessions" class="cbox">Sessions</label>',a+='<input id="sessions" type="checkbox" value="del_sessions_true" checked>',a+='<label for="archives" class="cbox">Archives : factures</label>',a+='<input id="archives" type="checkbox" value="del_archives_true" checked>',a+='<label for="history_cache" class="cbox">Signet historique</label>',a+='<input id="history_cache" type="checkbox" value="del_history_cache_true" checked>',a+='<label for="radio1">filtrer la date</label>',a+='<input type="radio" id="radio1" name="date_filter" value="false" checked>',a+='<label for="radio2">ne pas filtrer</label>',a+='<input type="radio" id="radio2" name="date_filter" value="true">',a+='<label for="dtFrom" class="date">Date de début</label>',a+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',a+='<label for="dtTo" class="date">Date de fin</label>',a+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',a+="<!-- Switch -->",a+='<input type="checkbox" class="switch" name="s1" id="s1">',a+='<label for="s1">Switch</label>',a+="</form>";const{value:f}=await Swal.fire({title:"<strong>RAZ des données</strong>",icon:"info",html:a,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez ce que vous allez supprimer de la base de donnée",preConfirm:()=>{let n=document.getElementsByName("date_filter"),l="notfound";for(var d in n)n[d].checked===!0&&(l=n[d].value);return console.log(document.getElementById("s1")),[document.getElementById("students").checked,document.getElementById("sessions").checked,document.getElementById("archives").checked,document.getElementById("history_cache").checked,document.getElementById("dtFrom").disabled===!0?null:document.getElementById("dtFrom").value,document.getElementById("dtTo").disabled===!0?null:document.getElementById("dtTo").value,l]},onOpen:n=>{n.querySelector("#radio1").addEventListener("change",function(){console.log(document.getElementById("radio1").checked);let l=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!l,document.getElementById("dtTo").disabled=!l}),n.querySelector("#radio2").addEventListener("change",function(){let l=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!l,document.getElementById("dtTo").disabled=!l}),n.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:n=>{n.querySelector("#radio1").removeEventListener("change"),n.querySelector("#radio2").removeEventListener("change"),n.querySelector("#dtFrom").removeEventListener("change")}});let c=f[0],b=f[1],e=f[2],m=f[3];console.log(`wanna raz students ? ${c}, wanna raz sessions ? ${b}, wanna raz archives ? ${e}`);let h=f[4]?dayjs(f[4]):null,j=f[5]?dayjs(f[5]):null;c===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des étudiants",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),P.delete(h,j)),b===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des sessions",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),J.delete(h,j)),e===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des archives (financières)",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),fa.delete(h,j)),m===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base du cache des historique de session",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),qa.delete(h,j))},Oa=async function(){var a="";a+="<style>",a+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",a+="form input {background: #fff;border: 1px solid #9c9c9c;}",a+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",a+="form button:hover {background: gold;}",a+="form label {padding: 0.5em 0.5em 0.5em 0;}",a+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",a+="form input:focus {outline: 3px solid gold;}",a+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",a+="</style>",a+='<form class="form1" action="">',a+='<label for="dd" class="date">Date de début</label>',a+='<input id="dd" type="date" max="2030-12-31" min="2010-12-31">',a+='<label for="df" class="date">Date de fin</label>',a+='<input id="df" type="date" max="2030-12-31" min="2010-12-31">',a+="</form>";var[f,c]=await ga(dayjs().startOf("month"),dayjs().endOf("month")),b=va.calculateBill(f,c);M.isInOldMode(f)?Za(f,c,b):_a(f,c,b)},Za=function(a,f,c){var b="",e=null,m=0,h=0,j=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],n=c[0].max_level;b+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",b+='<div class="wrapper">',b+="<table>",b+="<caption>Sessions de mentorat</caption>",b+="<thead>",b+="<tr>",b+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>";for(var l in j){b+="<tr>",b+="<td>"+j[l][1]+"</td>",e=c[j[l][0]].sessions;let s=e.number[0],y=e.number[4],E=s*e.pu[0],u=y*e.pu[4];m+=s+y,h+=E+u,b+=`<td>${s+y}</td><td>${(e.pu[0]+e.pu[4])/2}</td><td>${E+u}€</td>`,b+="</tr>"}b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${m}</td><td></td><td>${h}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>";var d=m,k=h;m=0,h=0,b+="<table>",b+="<caption>Sessions de mentorat (NoShow)</caption>",b+="<thead>",b+="<tr>",b+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>";for(l in j){b+="<tr>",b+="<td>"+j[l][1]+"</td>",e=c[j[l][0]].sessions;let s=e.number[2]+e.number[3],y=e.number[6]+e.number[7],E=s*(e.pu[2]+e.pu[3])/2,u=y*(e.pu[6]+e.pu[7])/2;m+=s+y,h+=E+u,b+=`<td>${s+y}</td><td>${(e.pu[2]+e.pu[3]+e.pu[6]+e.pu[7])/4}</td><td>${E+u}€</td>`,b+="</tr>"}b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${m}</td><td></td><td>${h}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>",d+=m,k+=h;for(var p=0,C=0,A=0,t=0,v=0,q=1;q<=n;){p+=c[q].sessions.number[1],p+=c[q].sessions.number[5];for(let s in[...Array(8).keys()]){let y=c[q].sessions.number[s];C+=y,A+=y*c[q].sessions.pu[s],y=c[q].defenses.number[s],t+=y,v+=y*c[q].defenses.pu[s]}q+=1}let B=c[0].errors[0].total_errors;C+=B,b+=`<p>Ces ${C} session(s) se répartissent en ${d-m} session(s) de mentorat (${k-h}€)`,b+=`, ${m} NoShows (${h}€)`,B==0?b+=`et ${p} session(s) annulée(s) (${0}€) </p>`:b+=`, ${p} session(s) annulée(s) (${0}€) ainsi que ${B} session(s) en anomalie (cf 1.)`,b+=`<br >Sur le total de ${C} session(s) (${A}€) `,b+=`vous avez réalisé ${t} soutenance(s) (${v}€)</p>`;if(B>0){let s=c[0].errors[0];b+=`(1) Attention, il y a ${B} session(s) qui présente(nt) une anomalie c'est peut être normal : exemple un étudiant qui n'a plus de parcours associé au moment de la collecte de session`,b+=", pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${s.total_errors} erreurs relevées , notez qu'il y a ${s.total_filtered} ennregistrements filtrés(lvl,...)  sur ${s.total} enregistrements dans la période, le total des erreurs devrait donc être de ${s.control} erreurs`),console.warn("détail"),console.warn(`${c[0].errors[1].data.length} erreurs de type ${c[0].errors[1].type} data are`,c[0].errors[1].data),console.warn(`${c[0].errors[2].data.length} erreurs de type ${c[0].errors[2].type} data are`,c[0].errors[2].data),console.warn(`${c[0].errors[3].data.length} erreurs de type ${c[0].errors[3].type} data are`,c[0].errors[3].data)}b+=`<p>Soit un total général à facturer de ${A}€`,Swal.fire({title:`<strong>Liste des formations tarifées du ${a.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,html:b,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},_a=function(a,f,c){console.log("enter computation bill");var b=performance.now(),e="",m=null,h=0,j=0,n=0,l=0,d=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],k=c[0].max_level;e+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",e+='<div class="wrapper">',e+="<table>",e+="<caption>Sessions de mentorat (dont soutenances)</caption>",e+="<thead>",e+="<tr>",e+='<th rowspan="2">Type</th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th>',e+="</tr>",e+="<tr>",e+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',e+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',e+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',e+="</tr>",e+="</thead>",e+="<tbody>";for(var p=1;p<=k;){e+="<tr>",e+=`<td> Niveau ${p}</td>`;let r=c[p].sessions,z=c[p].defenses,T=r.number[0],U=r.number[4],Z=T*r.pu[0],_=U*r.pu[4];h+=T,j+=U,n+=Z,l+=_,e+=`<td>${T} (${z.number[0]})</td><td>${r.pu[0]}</td><td>${Z}€</td>`,e+=`<td>${U} (${z.number[4]})</td><td>${r.pu[4]}</td><td>${_}€</td>`,e+=`<td>${T+U} (${z.number[0]+z.number[4]})</td><td>${Z+_}€</td>`,e+="</tr>",p+=1}var C=performance.now();console.log("%cCalculate first array"+(C-b)+" milliseconds.",F),e+="</tbody>",e+="<tfoot>",e+="<tr>",e+="<td>Total</td>",e+=`<td>${h}</td><td></td><td>${n}€</td>`,e+=`<td>${j}</td><td></td><td>${l}€</td>`,e+=`<td>${h+j}</td><td>${n+l}€</td>`,e+="</tr>",e+="<tr>",e+="</tr>",e+="</tfoot>",e+="</table>";var A=h+j,t=n+l;for(h=0,j=0,n=0,l=0,e+="<table>",e+="<caption>Sessions de mentorat :NoShow (dont soutenances)</caption>",e+="<thead>",e+="<tr>",e+='<th rowspan="2"></th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th><th colspan="2" scope="colgroup">Ensemble</th>',e+="</tr>",e+="<tr>",e+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',e+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',e+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',e+="</tr>",e+="</thead>",e+="<tbody>",p=1;p<=k;){e+="<tr>",e+=`<td> Niveau ${p}</td>`;let r=c[p].sessions,z=c[p].defenses,T=r.number[3],U=r.number[7],Z=T*r.pu[3],_=U*r.pu[7];h+=T,j+=U,n+=Z,l+=_,e+=`<td>${T} (${z.number[3]})</td><td>${r.pu[3]}</td><td>${Z}€</td>`,e+=`<td>${U} (${z.number[7]})</td><td>${r.pu[7]}</td><td>${_}€</td>`,e+=`<td>${T+U}</td><td>${Z+_}€</td>`,e+="</tr>",p+=1}e+="</tbody>",e+="<tfoot>",e+="<tr>",e+="<td>Total</td>",e+=`<td>${h}</td><td></td><td>${n}€</td>`,e+=`<td>${j}</td><td></td><td>${l}€</td>`,e+=`<td>${h+j}</td><td>${n+l}€</td>`,e+="</tr>",e+="<tr>",e+="</tr>",e+="</tfoot>",e+="</table>";var v=performance.now();console.log("%cCalculate second html table took "+(v-C)+" milliseconds.",F),A+=h+j,t+=n+l;var q=0,B=0,s=0,y=0,E=0;for(p=1;p<=k;){q+=c[p].sessions.number[1],q+=c[p].sessions.number[2],q+=c[p].sessions.number[5],q+=c[p].sessions.number[6];for(let r in[...Array(8).keys()]){let z=c[p].sessions.number[r];B+=z,s+=z*c[p].sessions.pu[r],z=c[p].defenses.number[r],y+=z,E+=z*c[p].defenses.pu[r]}p+=1}let u=c[0].errors[0].total_errors;B+=u,e+=`<p>Ces ${B} session(s) se répartissent en ${A-h-j} session(s) de mentorat (${t-n-l}€)`,e+=`, ${h+j} NoShows (${n+l}€)`,u==0?e+=`et ${q} session(s) annulée(s) (${0}€)`:e+=`, ${q} session(s) annulée(s) (${0}€) ainsi que ${u} session(s) en anomalie (cf 1.)`,e+=`<br>Sur le total de ${B} session(s) (${s}€) `,e+=`vous avez réalisé ${y} soutenance(s) (${E}€)</p>`;if(u>0){let r=c[0].errors[0];e+=`(1) Attention, il y a ${u} session(s) qui présente(nt) une anomalie c'est peut être normal : exemple un étudiant qui n'a plus de parcours associé au moment de la collecte de session`,e+=", pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${r.total_errors} erreurs relevées , notez qu'il y a ${r.total_filtered} ennregistrements filtrés(lvl,...)  sur ${r.total} enregistrements dans la période, le total des erreurs devrait donc être de ${r.control} erreurs`),console.warn("détail"),console.warn(`${c[0].errors[1].data.length} erreurs de type ${c[0].errors[1].type} data are`,c[0].errors[1].data),console.warn(`${c[0].errors[2].data.length} erreurs de type ${c[0].errors[2].type} data are`,c[0].errors[2].data),console.warn(`${c[0].errors[3].data.length} erreurs de type ${c[0].errors[3].type} data are`,c[0].errors[3].data)}var H=performance.now();console.log("%cCalculate bottom remark + errors took "+(H-v)+" milliseconds.",F);var g=0;let i="",w="";for(var o in c[0].bonus)c[0].bonus[o].sessions>=1?(g+=30,i+=c[0].bonus[o].who_name+","):w+=c[0].bonus[o].who_name+",";e+=`<p>Calcul du forfait "autofinancé". Vous sont affectés ${c[0].bonus.length} étudiants financés, parmi ceux ci, ${g/30} étudiant(s) avaient au moins une session programmée (${i.slice(0,-1)})`,g/30!==c[0].bonus.length&&(e+=`, (${c[0].bonus.length-g/30}) étudiant(s) (${w.slice(0,-1)}) n'ont pas eu de sessions`),e+=`, le forfait est donc de ${g}€</p>`,e+=`<p>Soit un total général à facturer de ${s+g}€`;var ka=performance.now();console.log("%cCalculate AF took "+(ka-H)+" milliseconds.",F);var D=performance.now();console.log("%cCalculate html table took "+(ka-b)+" milliseconds.",F),Swal.fire({title:`<strong>Liste des formations tarifées du ${a.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,html:e,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},Pa=async function(){var[a,f]=await ga(dayjs().startOf("month"),dayjs().endOf("month"),!1);let c=a,b=[];for(var e=performance.now();c.isSameOrBefore(f,"day");){let g=c.endOf("month");b.push(va.calculateBill(c,g)),c=c.add(1,"month")}console.dir(b);var m=performance.now();console.log("%cComputed data between the two dates in"+(m-e)+" milliseconds.",F);var h="",j=f.get("month")-a.get("month");h+="<table>",h+="<thead>",h+="<tr><th>Origine</th>";for(var n=0;n<=j;){let g=a.add(n,"month");h+=`<th>${g.format("MMMM")}</th>`,n+=1}h+="<th>Total</th><th>Moyenne</th></tr>",h+="</thdead>",h+="<tbody>",h+="<tr>",h+=`<td colspan=${j} style="text-align:left;">Sessions</td></tr>`,h+="<tr>",h+="<td>Sessions (Mt)</td>";let l=0,d=0,k=0,p=[],C=[],A=[],t=[],v=[],q=[],B=[];for(c=a;d<=j;){let g=1;p[d]=0,C[d]=0,A[d]=0,v[d]=0,q[d]=0,B[d]=0;let i=b[d][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)k+=b[d][g].sessions.number[o]*b[d][g].sessions.pu[o],p[d]+=b[d][g].sessions.number[o],C[d]+=b[d][g].defenses.number[o],A[d]+=b[d][g].sessions.number[o]-b[d][g].defenses.number[o],M.isInOldMode(c)?[1,5].includes(o)&&(v[d]+=b[d][g].sessions.number[o],q[d]+=b[d][g].defenses.number[o],B[d]+=b[d][g].sessions.number[o]-b[d][g].defenses.number[o]):[1,2,5,6].includes(o)&&(v[d]+=b[d][g].sessions.number[o],q[d]+=b[d][g].defenses.number[o],B[d]+=b[d][g].sessions.number[o]-b[d][g].defenses.number[o]);g+=1}h+=`<td>${k}</td>`,t[d]=k,l+=k,k=0,d+=1,c=c.add(1,"month")}for(h+=`<td>${l}</td><td>${(l/(j+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Sessions (Nb)</td>",l=0,d=0,k=0;d<=j;)h+=`<td>${p[d]-v[d]}(${p[d]})</td>`,l+=p[d],d+=1;for(h+=`<td>${l}</td><td>${(l/(j+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Sessions (PU)</td>",l=0,d=0,k=0;d<=j;)h+=`<td>${(t[d]/(p[d]-v[d])).toFixed(2)}</td>`,l+=k,k=0,d+=1;for(h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+="<tr>",h+=`<td colspan=${j} style="text-align:left;">Mentorat</td></tr>`,h+="<tr>",h+="<td>Mentorat (Mt)</td>",d=0,k=0,t=[];d<=j;){let g=1,i=b[d][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)k+=b[d][g].sessions.number[o]*b[d][g].sessions.pu[o]-b[d][g].defenses.number[o]*b[d][g].defenses.pu[o],t[d]=k;g+=1}h+=`<td>${k}</td>`,d+=1,k=0}for(h+="<tr>",h+="<tr>",h+="<td>Mentorat (Nb)</td>",l=0,d=0,k=0,p=[];d<=j;)h+=`<td>${A[d]-B[d]}(${A[d]})</td>`,l+=k,k=0,d+=1;for(h+=`<td>${l}</td><td>${(l/(j+1)).toFixed(2)}</td>`,h+="</tr>",h+="<td>Mentorat (PU)</td>",d=0;d<=j;)h+=`<td>${(t[d]/(A[d]-B[d])).toFixed(2)}</td>`,t[d]=k,l+=k,k=0,d+=1;for(h+=`<td>${l}</td><td>${(l/(j+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+=`<td colspan=${j} style="text-align:left;">Soutenances</td></tr>`,h+="<tr>",h+="<td>Soutenances (Mt)</td>",l=0,d=0,k=0,p=[],t=[];d<=j;){let g=1;p[d]=0;let i=b[d][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)k+=b[d][g].defenses.number[o]*b[d][g].defenses.pu[o],p[d]+=b[d][g].defenses.number[o];g+=1}h+=`<td>${k}</td>`,t[d]=k,l+=k,k=0,d+=1}for(h+=`<td>${l}</td><td>${(l/(j+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Soutenances (Nb)</td>",l=0,d=0,k=0;d<=j;)h+=`<td>${p[d]-q[d]}(${p[d]})</td>`,l+=p[d],d+=1;for(h+=`<td>${l}</td><td>${(l/(j+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Soutenances (PU)</td>",l=0,d=0,k=0;d<=j;)h+=`<td>${(t[d]/(p[d]-q[d])).toFixed(2)}</td>`,l+=k,k=0,d+=1;h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+=`<td colspan=${j} style="text-align:left;">Bonus</td></tr>`,h+="<tr>",h+="<td>Bonus AF</td>",d=0,k=0;let s=[];for(;d<=j;){let g=b[d][0].bonus;s[d]=0;for(let i=0;i<g.length;i+=1)k+=g[i].sessions>0?30:0;h+=`<td>${k}</td>`,s[d]=k,k=0,d+=1}h+="</tr>",h+="<tr>",h+=`<td colspan=${j} style="text-align:left;">TJM</td></tr>`,h+="<tr>",h+="<td>Nb Jrs</td>",d=0;var y=[];l=0,c=a,t=[],c=a.clone();let E=c.clone().endOf("month"),u=[];for(;d<=j;)E.isAfter(f,"day")&&(E=f.clone()),h+=`<td>${xa(c,E)} jrs</td>`,u[d]=xa(c,E),c=c.add(1,"month"),E=E.add(1,"month"),d+=1;for(h+="</tr>",h+="<tr>",h+="<td>TJM</td>",d=0;d<=j;){k=0;let g=1;t[d]=0,y[d]=0;let i=b[d][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)t[d]+=b[d][g].sessions.number[o]*b[d][g].sessions.pu[o];g+=1}h+=`<td>${(t[d]/u[d]).toFixed(2)} €</td>`,d+=1}for(h+="</tr>",h+="<tr>",h+="<td>THM (théorique)</td>",d=0,y=[],l=0,c=a,t=[];d<=j;){k=0;let g=1;t[d]=0,y[d]=0;let i=b[d][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)t[d]+=b[d][g].sessions.number[o]*b[d][g].sessions.pu[o],M.isInOldMode(c)?k+=(b[d][g].sessions.number[o]-b[d][g].defenses.number[o])*(45/60):([4,5,6,7].includes(o)&&(k+=(b[d][g].sessions.number[o]-b[d][g].defenses.number[o])*(30/60)),[0,1,2,3].includes(o)&&(k+=(b[d][g].sessions.number[o]-b[d][g].defenses.number[o])*(45/60))),k+=b[d][g].defenses.number[o]*(45/60);g+=1}console.log(`montant mensuel : ${t[d]} + bonus ${s[d]}/ Nb heures ${k} = $((aAmInMonth[_m]+aAmBoInMonth[_m])/iTotal).toFixed(2)`),h+=`<td>${((t[d]+s[d])/k).toFixed(2)} €</td>`,l+=k,y[d]=k,k=0,d+=1,c=c.add(1,"month")}for(h+="</tr>",h+="<tr>",h+="<td>Nb heures</td>",l=0,d=0,k=0;d<=j;)h+=`<td>${y[d].toFixed(2)} h</td>`,l+=k,k=0,d+=1;for(h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+="<tr>",h+="<td>THM (person.)</td>",d=0,y=[],l=0,c=a,t=[];d<=j;){k=0;let g=1;t[d]=0,y[d]=0;let i=b[d][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)t[d]+=b[d][g].sessions.number[o]*b[d][g].sessions.pu[o],M.isInOldMode(c)?k+=(b[d][g].sessions.number[o]-b[d][g].defenses.number[o])*(GM_config.get("nbHrsfM")/60):([4,5,6,7].includes(o)&&(k+=(b[d][g].sessions.number[o]-b[d][g].defenses.number[o])*(GM_config.get("nbHrsAfM")/60)),[0,1,2,3].includes(o)&&(k+=(b[d][g].sessions.number[o]-b[d][g].defenses.number[o])*(GM_config.get("nbHrsfM")/60))),k+=b[d][g].defenses.number[o]*(GM_config.get("nbHrsD")/60);g+=1}console.log(`montant mensuel : ${t[d]} + bonus ${s[d]}/ Nb heures ${k} = $((aAmInMonth[_m]+aAmBoInMonth[_m])/iTotal).toFixed(2)`),h+=`<td>${((t[d]+s[d])/k).toFixed(2)} €</td>`,l+=k,y[d]=k,k=0,d+=1,c=c.add(1,"month")}for(h+="</tr>",h+="<tr>",h+="<td>Nb heures</td>",l=0,d=0,k=0;d<=j;)h+=`<td>${y[d].toFixed(2)} h</td>`,l+=k,k=0,d+=1;h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+="</tbody>",h+="<tfoot>",h+"",h+="</tfoot>",h+="</table>";var H=performance.now();console.log("%cTime to show table :"+(H-m)+" milliseconds.",F),Swal.fire({title:`<strong>Statistiques du ${a.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,icon:"info",html:h,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:g=>{}})};class N{static init=function(){console.log("%cin initUI",x),N.build();var a=new Draggabilly(".draggable",{handle:".handle"});db.start("animation-target")};static build=function(){console.log("%c in buildUI","background-color:green;color:white"),GM_addStyle(".flex > * { margin: 2px 1px; }"),GM_addStyle(".flex > :first-child { margin-left: 0; }"),GM_addStyle(".flex > :last-child { margin-right: 0; }"),GM_addStyle(".panel {display: flex; justify-content: center;z-index:999}"),GM_addStyle(".menuBar {border-top: 1px solid; padding: 10px; font-size: 1rem; pointer-events: inherit;position: relative;top:0px;  flex-flow: row wrap;/*align-content: space-between;justify-content: space-between;*/}"),GM_addStyle(".draggable {background: transparent;border-radius: 10px;padding: 20px;}"),GM_addStyle(".draggable.is-pointer-down {background: #09F;}"),GM_addStyle(".draggable.is-dragging { opacity: 0.7; }"),GM_addStyle(".handle {background: #555;background: hsla(0, 0%, 0%, 0.4);width: 20px;height: 20px; border-radius: 10px;}"),GM_addStyle(".flex > :nth-last-child(2) {page-break-after: always; /* CSS 2.1 syntax */break-after: always; /* New syntax */}"),GM_addStyle("#animation-target {width: 10px;height: 5px;background-color:coral;border-radius: 25%;}");var a=document.createElement("div"),f=document.createElement("div");f.classList.add("handle"),a.appendChild(f),a.classList.add("panel","menuBar","flex","draggable"),document.body.appendFirst(a),N.addButton("collectChecked",Ka,{},a),N.addButton("CollectAuto",La,{},a),N.addButton("showBill",Oa,{},a),N.addButton("billInDetails",Ja,{},a),N.addButton("PDF",Ma,{},a),N.addButton("SList",P.showList,{},a),N.addButton("RAZ",Na,{},a),N.addButton("statistics",Pa,{},a),N.addButton("about",Ia,{},a);var c=document.createElement("div");c.id="animation-target",a.appendChild(c)};static addButton=function(a,f,c,b){b=b||document.body,c=c||{position:"absolute",bottom:"7%",left:"4%","z-index":3};let e=document.createElement("button"),m=e.style;return e.classList.add("button--primary","button"),b.appendChild(e),e.innerHTML=a,e.onclick=f,Object.keys(c).forEach(h=>m[h]=c[h]),e}}class db{static start=function(a){const f=document.getElementById(a),c=j=>f.style.transform=`translateX(${j}px)`;let b=0;const e=7,m=j=>{c(b),b+=e,b>100?requestAnimationFrame(h):requestAnimationFrame(m)},h=j=>{c(b),b-=e,b<-100?requestAnimationFrame(m):requestAnimationFrame(h)};requestAnimationFrame(m)}}var Sa=N;const $a="#OCAddonsCfg {background-color: lightblue;} #OCAddonsCfg .reset_holder {float: left; position: relative; bottom: -1em;} #OCAddonsCfg .saveclose_buttons {margin: .7em;}",ab="height: 16.7em; width: 30em; border: 1px solid; border-radius: 3px; position: fixed; z-index: 999;",Qa={id:"OCAddonsCfg",title:"Configuration du module",fields:{nbHrsAfM:{section:["Statistiques","paramètres"],label:"Nombre de minutes pour une session AF",labelPos:"left",type:"input",default:30},nbHrsfM:{label:"Nombre de minutes pour une session financée",labelPos:"left",type:"input",default:45},nbHrsD:{label:"Nombre de minutes pour une session de soutenance",labelPos:"left",type:"input",default:45},maxfetchpg:{section:["Application","optimisation"],label:"Maximum de page recherchées dans l'historique",labelPos:"left",type:"input",default:1e3},datacachelifetime:{label:"Temps de conservation des données dans le cache (en ms)",labelPos:"left",type:"input",default:12e4},checksessionalreadyexists:{section:["Application","Base de donnée"],label:"sessions: vérifier existence avant insertion",labelPos:"left",type:"checkbox",default:!0},sizeofcontentlist:{section:["Interface","thème"],label:"taille de la police des listes",labelPos:"left",type:"input",default:"1em;"},use_custom_css:{label:"utiliser des styles personnalisés",labelPos:"left",type:"checkbox",default:!1},custom_css_url:{label:"url de la feuille de style (si plusieurs les séparer par des virgules)",labelPos:"left",type:"input",default:""},custom_css_data:{label:"saisir ici le code css à injecter directement dans la page",title:"Je me demande bien à quoi sert le titre",labelPos:"left",type:"input",default:""},alwaysaddcbox:{section:["Interface","gadget"],label:"Toujours ajouter les checkbox sur l'interface",labelPos:"left",type:"checkbox",default:!0},hackheaderzindex:{label:"changer le zindex du bandeau haut",labelPos:"left",type:"checkbox",default:!0},support:{section:["","Support"],label:"StephaneTy-Pro.github.io",title:"more info on https://github.com/StephaneTy-Pro",type:"button",click:()=>{GM_openInTab("https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon",{active:!0,insert:!0,setParent:!0})}}},css:$a,events:{save:function(){GM_config.close()}}};var Ra=function(){GM_config.open(),OCAddonsCfg.style=ab};X();})();
//# sourceMappingURL=billing.min.js.map

