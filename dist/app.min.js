// ==UserScript==
// @name         Facturier (alpha)
// @namespace    http://tampermonkey.net/
// @version      1.00
// @description  Un addon pour vous aidez dans votre facturation
// @author       Stéphane TORCHY
// @updateURL    https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/dist/app.min.js
// @downloadURL  https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/dist/app.min.js
// @match        https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history*
// @grant        unsafeWindow
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @grant        GM_registerMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        GM.xmlHttpRequest

// @require      https://cdn.jsdelivr.net/npm/lodash@4.17.19/lodash.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/low.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/LocalStorage.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/dayjs.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/locale/fr.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isBetween.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrBefore.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrAfter.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/customParseFormat.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/localeData.min.js


// GM_Config
// @require      https://openuserjs.org/src/libs/sizzle/GM_config.js

// sweetalert 2
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.all.min.js

// draggabilly
// @require      https://cdnjs.cloudflare.com/ajax/libs/draggabilly/2.2.0/draggabilly.pkgd.min.js

// toastify
// @require     https://cdn.jsdelivr.net/npm/toastify-js@1.8.0/src/toastify.min.js
// @resource    toastifycss https://raw.githubusercontent.com/apvarun/toastify-js/master/src/toastify.css

//
// @require     https://raw.githubusercontent.com/uzairfarooq/arrive/master/minified/arrive.min.js

// simple-datatables
// @require     https://cdn.jsdelivr.net/npm/simple-datatables@latest
// @resource    simpledatatablecss https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css

// require https://raw.githubusercontent.com/anywhichway/nano-memoize/master/dist/nano-memoize.min.js
// @require https://cdn.jsdelivr.net/npm/moize@5.4.7/dist/moize.min.js

// require https://raw.githubusercontent.com/StephaneTy-Pro/userscripts/master/fetch-inject.umd.min.js
// @require https://cdn.jsdelivr.net/npm/fetch-inject

// PARSER MKDOWN
// @require 	 https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js

// PDF https://pdf-lib.js.org/docs/api/
// @require      https://unpkg.com/pdf-lib@1.9.0/dist/pdf-lib.min.js
// @require      https://unpkg.com/downloadjs@1.4.7/download.js

/*
 * History
 * cf https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon/blob/master/CHANGELOG.md
 */



// ==/UserScript==

(function() {

    'use strict';
let ta=Object.defineProperty,Ua=Object.prototype.hasOwnProperty,eb=(a,f)=>()=>(f||(f={exports:{}},a(f.exports,f)),f.exports),Va=a=>ta(a,"__esModule",{value:!0}),fb=(a,f)=>{Va(a);for(let c in f)ta(a,c,{get:f[c],enumerable:!0})},gb=(a,f)=>{Va(a);if(typeof f==="object"||typeof f==="function")for(let c in f)Ua.call(f,c)&&!Ua.call(a,c)&&c!=="default"&&ta(a,c,{get:()=>f[c],enumerable:!0});return a},ja=a=>a&&a.__esModule?a:gb(ta({},"default",{value:a,enumerable:!0}),a);var X=eb(k=>{fb(k,{APP_AUTHOR:()=>Ca,APP_DEBUG_STYLE:()=>y,APP_ERROR_STYLE:()=>Fa,APP_INFO_STYLE:()=>Ea,APP_LOG_STYLE:()=>Da,APP_NAME:()=>na,APP_PERF_STYLE:()=>F,APP_WARN_STYLE:()=>ha,OC_AUTOFUNDED:()=>la,OC_FUNDED:()=>oa,OC_MAX_LEVEL:()=>R,OC_PRICE1:()=>$,OC_PRICE2:()=>aa,OC_PRICE3:()=>ba,OC_PRICE4:()=>ca,OC_PRICE5:()=>da,OC_PRICE6:()=>ea,OC_STATUS_0:()=>I,OC_STATUS_1:()=>V,OC_STATUS_2:()=>O,OC_STATUS_3_F:()=>M,OC_STATUS_3_M:()=>L,default:()=>h});const n={Cfg:{dbase:null},start:async function(){await Ta();const e=n.checkSupport();console.log(`%cAre all functions supported ? : ${e}`,y),document.arrive(".MuiAvatar-img",n._warmup)},checkSupport:function(){return!0},_warmup:function(){console.log("%cinSetup",y),GM===void 0?(console.log("%cI am not in a tamper env"),n._userscriptless()):console.log(`%cTamper environment detected the version is ${GM.info.version}`,y),GM_addStyle(GM_getResourceText("jspanelcss")),GM_addStyle(GM_getResourceText("toastifycss")),GM_addStyle(GM_getResourceText("simpledatatablecss")),GM_config.init(Qa),GM_registerMenuCommand("OC Facturier - configure",Ra),GM_config.get("hackheaderzindex")===!0&&(document.getElementById("header").style.zIndex=0),GM_addStyle(".swal2-content{font-size:"+GM_config.get("sizeofcontentlist")+"}"),GM_addStyle(".swal2-title{font-size:1.275em)"),n._main()},_userscriptless(){},_main:function(){console.log("​​​%cMainLoaded​​​",y);let e=new LocalStorage("db");var j=low(e);j.defaults({students:[],sessions:[],f_archives:[],history_session_cache:[]}).write(),n.Cfg.dbase=j,dayjs.extend(dayjs_plugin_isSameOrAfter),dayjs.extend(dayjs_plugin_isSameOrBefore),dayjs.extend(dayjs_plugin_isBetween),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_customParseFormat),document.querySelector(".panel.menuBar.flex.draggable")===null&&Sa.init(),GM_config.get("alwaysaddcbox")===!0&&ya(),dayjs.locale("fr");if(GM_config.get("use_custom_css")===!0){let p=GM_config.get("custom_css_url"),A=p.split(",");if(A.length!==0)fetchInject([A]).then(()=>{console.log(`%cDependencies ${A} loaded`,y)});else{let x=GM_config.get("custom_css_data");x.length()>0&&console.log(`%cNeed to inject a custom css in application content is ${x}`,y)}}GM.info.script.downloadURL==="https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/billing.js"?(console.log("%cALERTE .... version locale !!!!!! ","background-color:coral;color:white"),unsafeWindow.Facturier={libs:[],cfg:{dbase:null}},unsafeWindow.Facturier.cfg.dbase=n.Cfg.dbase,unsafeWindow.Facturier.libs.push({id:"fetchInject",ptr:fetchInject}),unsafeWindow.Facturier.libs.push({id:"dayjs",ptr:dayjs}),console.log("%cImportants values are exported in unsafeWindow.Facturier",y),n.loadDependencies()):console.log(`GM.info.script.downloadURL url : ${GM.info.script.downloadURL}`)},loadDependencies:function(){let e=[];e.push("http://localhost:8000/src/branch01/sandbox.js"),e.push("http://localhost:8000/src/branch01/sandbox.css"),fetchInject(e).then(()=>{console.log(`dependencies ${e} loaded`)})}};window.Facturier!==void 0?window.Facturier.start():n.start();var h=n});var ra={async XHR(a){const f=window.GM_xmlhttpRequest||(GM?GM.xmlHttpRequest:null);return f?new Promise((c,b)=>{Object.assign(a,{onabort:b,onerror:b,onload:c,ontimeout:b}),f(a)}):Promise.reject()},async getValue(a,f=null){return window.GM_getValue?Promise.resolve(GM_getValue(a)||f):await GM.getValue(a)||f},async setValue(a,f){window.GM_setValue?GM_setValue(a,f):GM.setValue(a,f)}};const na="OC-Addons",Ca="Stéphane TORCHY",y="background-color:green;color:white",Da="background-color:black;color:white",ha="background-color:coral;color:white",Ea="background-color:cyan;color:white",Fa="background-color:red;color:white",F="background-color:blue;color:white",la="auto-financé",oa="financé par un tiers",I="réalisée",V="annulée",O="annulée tardivement",L="étudiant absent",M="étudiante absente",R=6,$=30,aa=35,ba=40,ca=45,da=50,ea=55;var Ta=function(){return new Promise(a=>{document.readyState=="loading"?document.addEventListener("DOMContentLoaded",a):a()})},pa=async function(a="",f="",c=!1){console.info(`%cfetch() waiting return from : ${a}`,y);const b=await ra.XHR({method:"GET",url:a,responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"}});let d=new DOMParser(),n=d.parseFromString(b.responseText.replace(/\n/mg,""),"text/html");var h={};return c===!0?h=n.querySelectorAll(f):h=n.querySelector(f),h},Y=function(a,f=-1){try{var c=(a.children[0].href||"/").split("/");return c[c.length+f]}catch(b){throw Error("Erreur qui ne devrait jamais arriver en getkey :"+b.stack||b)}},Aa=function(a){var f=a.trim().split(" ");try{id=dayjs_locale_fr.months.findIndex(c=>c===f[1])+1}catch(c){throw Error("Erreur qui ne devrait jamais arriver en conversion de date :"+c.stack||c)}return`${f[2]}-${id}-${f[0]}T${f[4]}`},Ga=function(a,f=0){f===-1&&(f=a.children.length-1);var c=a.children[f].children[0].innerText;let b=Aa(c);var d=dayjs(b);return d};function Ba(a){return new Promise(f=>setTimeout(f,a))}HTMLElement.prototype.appendFirst=function(a){this.firstChild?this.insertBefore(a,this.firstChild):this.appendChild(a)};var ga=async function(a=null,f=null,c=!0){var b="";b+="<style>",b+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",b+="form input {background: #fff;border: 1px solid #9c9c9c;}",b+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",b+="form button:hover {background: gold;}",b+="form label {padding: 0.5em 0.5em 0.5em 0;}",b+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",b+="form input:focus {outline: 3px solid gold;}",b+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",b+="</style>",b+='<form class="form1" action="">',b+='<label for="dtFrom" class="date">Date de début</label>',a?b+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(a).format("YYYY-MM-DD")+'">':b+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',b+='<label for="dtTo" class="date">Date de fin</label>',a?b+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(f).format("YYYY-MM-DD")+'">':b+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',b+="</form>";const{value:d}=await Swal.fire({title:"<strong>Choix de la période</strong>",icon:"info",html:b,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez la période pour la sélection des temps facturés",showLoaderOnConfirm:!0,preConfirm:()=>[document.getElementById("dtFrom").value,document.getElementById("dtTo").value],onRender:n=>{},onOpen:n=>{c===!0&&n.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:n=>{c===!0&&n.querySelector("#dtFrom").removeEventListener("change")},onAfterClose:n=>{},onDestroy:n=>{}});return a=dayjs(d[0]),f=dayjs(d[1]),await Ba(250),[a,f]},wa=async function(a){await Swal.fire({position:"top-end",icon:"success",title:a,showConfirmButton:!1,timer:1500})};const qb=ja(X());class W{static tbl_name="f_archives";static add=async function(a){let f=qb.default.Cfg.dbase,c=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),b={id:a[0].to.format("YYYYMM"),data:a,created_at:a[0].now};console.log(`%cWill create archive for id ${a[0].to.format("YYYYMM")} (YYYYMM)`,y),f.get(W.tbl_name).push(JSON.parse(JSON.stringify(b))).write()};static exists=function(a){let f=qb.default.Cfg.dbase,c=f.get(W.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static get=function(a){let f=qb.default.Cfg.dbase;var c=f.get(W.tbl_name).find({id:a}).value();if(c===void 0){throw Error("Erreur qui ne devrait jamais arriver en Archive.get");return!1}else return console.log(`%cWill use archive for id ${a} (YYYYMM)`,y),c};static delete=function(a=null,f=null){let c=qb.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(a===null&&f==null){console.log("%cWanna suppress ALL Archives from DB ",y),c.get(W.tbl_name).remove().write();return}if(f==null){c.get(W.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isBefore(f),"month"}).write();return}if(a==null){c.get(W.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isAfter(a,"month")}).write();return}c.get(W.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isBetween(a,f,"month","[]")}).write()}}var fa=W;class Xa{static isInOldMode=function(a){var f=null;typeof a==="string"?f=dayjs(a):f=a;try{return f.isBefore(dayjs("2020-06-01"))}catch(c){throw Error("Erreur qui ne devrait jamais arriver en IsInOldMode (probablement un probleme sur la conversion de la date en objet dayjs:"+c.stack||c)}}}var K=Xa;const fc=ja(X());class G{static tbl_name="students";static add=function(a,f="noname",c="nopath",b="unkonw",d){let n=fc.default.Cfg.dbase;var h=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");let k={id:a,fullname:f,path:c,fundedby:b,created:h};n.get(G.tbl_name).push(JSON.parse(JSON.stringify(k))).write()};static exists=function(a){let f=fc.default.Cfg.dbase;var c=f.get(G.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static getFunded=function(a){let f=fc.default.Cfg.dbase,c=f.get(G.tbl_name).find({id:a}).value();if(c==void 0)throw Error(`IRRECOVERABLE ERROR STUDENT WITH ID ${a} NOT IN DB:`);return c.fundedby};static isAutoFunded=function(a){return G.getFunded(a).toLowerCase()===la};static getFinancialMode=async function(a){const f=await pa(`https://openclassrooms.com/fr/mentorship/students/${a}/dashboard`,".mentorshipStudent__details > p");return f.innerText};static delete=function(a=null,f=null){let c=fc.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(a===null&&f==null){console.log("%cWanna suppress ALL Students from DB",y),c.get(G.tbl_name).remove().write();return}if(f==null){c.get(G.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isBefore(f),"day"}).write();return}if(a==null){c.get(G.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isAfter(a,"day")}).write();return}c.get(G.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isBetween(a,f,"day","[]")}).write()};static getAll=async(a,f)=>{var c=!1;let b=fc.default.Cfg.dbase;var d="table.crud-list tbody",n=document.querySelectorAll(d)[1],h=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");Swal.fire({position:"top-end",icon:"info",toast:!0,title:`mise à jour de la base de donnée des étudiants...
cela peut prendre du temps`,showConfirmButton:!1,timer:1e3});for(const j of n.children){var k=Y(j.children[0],-2),m=j.children[0].innerText,l="non défini";j.children[1].firstElementChild&&(l=j.children[1].firstElementChild.href.split("/").pop());var e=b.get(G.tbl_name).find({id:k}).value();if(e&&c===!1)console.log(`%c${m}(uniquid:${k}) already present in database created at ${e.created}`,y);else{let p=await G.getFinancialMode(k);console.log(`%cFinancial Mode of student ${m}(id:${k}) is ${p}`,y),Toastify({text:`Ajoute l'étudiant : ${m}(${p}) en base`,gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast(),G.add(k,m,l,p,h)}}};static showList=function(){let a=fc.default.Cfg.dbase,f=a.get(G.tbl_name).value();var c="";c+="<table>",c+="<caption>Liste des étudiant</caption>",c+="<thead>",c+="<tr>",c+="<th>Nom</th><th>Parcours</th><th>Financement</th><th>Date de création</th>",c+="</tr>",c+="</thead>",c+="<tbody>";for(var b in f)c+="<tr>",c+=`<td>${f[b].fullname}</td><td>${f[b].path}</td><td>${f[b].fundedby}</td><td>${f[b].created.format("DD/MM/YYYY à HH:mm")}</td>`,c+="</tr>";c+="</tbody>",c+="</table>",Swal.fire({title:"<strong>Liste des Etudiants</strong>",icon:"info",html:c,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"fullscreen",onOpen:d=>{var n=d.querySelector("table"),h=new simpleDatatables.DataTable(n)}})};static createManually=async function(a,f,c){let b=["non présent dans la liste","Chef de projet digital","Chef de projet SI","Développeur d'application - Frontend","Développeur Web","Expert en stratégie marketing et communication ","Production de contenu web avec CMS et Content Marketing ","Tech lead"];var d="";d+="<style>",d+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",d+="form input {background: #fff;border: 1px solid #9c9c9c;}",d+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",d+="form button:hover {background: gold;}",d+="form label {padding: 0.5em 0.5em 0.5em 0;}",d+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",d+="form input:focus {outline: 3px solid gold;}",d+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",d+="</style>",d+='<form class="form1" action="">',d+='<label for="student_id" class="name">Reference</label>',d+='<input id="student_id" type="text" value="'+a+'">',d+='<label for="student_name" class="name">Name</label>',d+='<input id="student_name" type="text" value="'+f+'">',d+='<label for="fundedby">Autofinancé</label>',d+='<input id="fundedby" type="checkbox" value="autofunded">',d+='<label for="student_path">Parcours</label>',d+='<input id="student_path" name="student_path" type="text" list="student_path-list">',d+='<datalist id="student_path-list">';for(var n in b)d+=`<option>${b[n]}</option>`;d+="/<datalist>",d+='<label for="session_date">Date</label>',d+='<input id="session_date" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(c).format("YYYY-MM-DD")+'">',d+="</form>";const{value:h}=await Swal.fire({title:"<strong>Ajout d'un étudiant en mode manuel</strong>",icon:"info",html:d,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:`votre étudiant(e) ${f} n'a pas été trouvé`,preConfirm:()=>[document.getElementById("student_id").value,document.getElementById("student_name").value,document.getElementById("student_path").value,document.getElementById("fundedby").checked,document.getElementById("session_date").value]});if(h){var k="";h[3]===!0?k=la:k=oa,G.add(h[0],h[1],h[2],k,h[4])}}}var P=G;const $b=ja(X());class S{static tbl_name="sessions";static add=async function(a){let f=$b.default.Cfg.dbase;if(GM_config.get("checksessionalreadyexists")===!0)var c=!0;if(K.isInOldMode(dayjs(a.when)))a.isFunded=!0;else if(a.type.toLowerCase()==="soutenance")a.isFunded=!0;else{var b=P.exists(a.who_id);console.log("is student in db ?",b);if(b==!1){console.warn("%cI'm updating db .... could'nt do anything else",ha),await P.getAll();var d=P.exists(a.who_id);if(d==!1)return P.createManually(a.who_id,a.who_name,a.when)}a.isFunded=!P.isAutoFunded(a.who_id)}c?S.exists(a.id)==!1?f.get(S.tbl_name).push(JSON.parse(JSON.stringify(a))).write():console.info(`%cSession of ${a.who_name} at ${a.when} already present in database table sessions, skip it!`,y):f.get(S.tbl_name).push(JSON.parse(JSON.stringify(a))).write()};static exists=function(a){let f=$b.default.Cfg.dbase;var c=f.get(S.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static delete=function(a=null,f=null){let c=$b.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(a===null&&f==null){console.log("%cWanna suppress ALL Sessions from DB",y),c.get(S.tbl_name).remove().write();return}if(f==null){c.get(S.tbl_name).remove(function(b){return dayjs(b.when).isBefore(f),"day"}).write();return}if(a==null){c.get(S.tbl_name).remove(function(b){return dayjs(b.when).isAfter(a,"day")}).write();return}c.get(S.tbl_name).remove(function(b){return dayjs(b.when).isBetween(a,f,"day","[]")}).write()};static parseTable=function(a){var f=a.children[0].children[0].innerText,c=Y(a.children[0]),b=a.children[1].children[0].innerText,d=Y(a.children[1],-2),n=a.children[2].innerText.trim().toLowerCase(),h=a.children[3].children.length?a.children[3].children[0].innerText.trim().toLowerCase():"session",k=-1;a.children[4].children.length>0&&(k=a.children[4].children[0].innerText),f=Aa(f);var m={id:c,when:f,who_id:d,who_name:b,status:n,type:h,lvl:k};return m}}var J=S;const kb=ja(X());class ua{static calculateBill=function(a,f){let c=f.format("YYYYMM");if(fa.exists(c)===!0){console.log("%cUse Archived version ${sArchiveId} of accounting",y);let b=fa.get(c);return b.data}return typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD")),ua.memoized(a,f)};static _calculateBill=function(a,f){typeof a==="string"&&(a=dayjs(a)),typeof f==="string"&&(f=dayjs(f));var c=performance.now();let b=kb.default.Cfg.dbase;var d=b.get(J.tbl_name).filter(g=>dayjs(g.when).isSameOrBefore(f,"day")&&dayjs(g.when).isSameOrAfter(a,"day")),n=d.filter(g=>g.type.toLowerCase()==="soutenance")||0;let h=[0,$,aa,ba,ca,da,ea],k=[],m=[];for(let g=1;g<=R;g+=1)m[g]=[],m[g][0]={session:null,defense:null},m[g][1]={session:null,defense:null},m[g][2]={session:null,defense:null},m[g][3]={session:null,defense:null},m[g][4]={session:null,defense:null},m[g][5]={session:null,defense:null},m[g][6]={session:null,defense:null},m[g][7]={session:null,defense:null},m[g][0].session=d.filter(i=>i.lvl==g&&i.status===I&&i.isFunded===!0)||0,m[g][1].session=d.filter(i=>i.lvl==g&&i.status===V&&i.isFunded===!0)||0,m[g][2].session=d.filter(i=>i.lvl==g&&i.status===O&&i.isFunded===!0)||0,m[g][3].session=d.filter(i=>i.lvl==g&&(i.status===L||i.status===M)&&i.isFunded===!0)||0,m[g][4].session=d.filter(i=>i.lvl==g&&i.status===I&&i.isFunded===!1)||0,m[g][5].session=d.filter(i=>i.lvl==g&&i.status===V&&i.isFunded===!1)||0,m[g][6].session=d.filter(i=>i.lvl==g&&i.status===O&&i.isFunded===!1)||0,m[g][7].session=d.filter(i=>i.lvl==g&&(i.status===L||i.status===M)&&i.isFunded===!1)||0,m[g][0].defense=n.filter(i=>i.lvl==g&&i.status===I&&i.isFunded===!0)||0,m[g][1].defense=n.filter(i=>i.lvl==g&&i.status===V&&i.isFunded===!0)||0,m[g][2].defense=n.filter(i=>i.lvl==g&&i.status===O&&i.isFunded===!0)||0,m[g][3].defense=n.filter(i=>i.lvl==g&&(i.status===L||i.status===M)&&i.isFunded===!0)||0,m[g][4].defense=n.filter(i=>i.lvl==g&&i.status===I&&i.isFunded===!1)||0,m[g][5].defense=n.filter(i=>i.lvl==g&&i.status===V&&i.isFunded===!1)||0,m[g][6].defense=n.filter(i=>i.lvl==g&&i.status===O&&i.isFunded===!1)||0,m[g][7].defense=n.filter(i=>i.lvl==g&&(i.status===L||i.status===M)&&i.isFunded===!1)||0;var l=performance.now();console.log("%cFiltering took "+(l-c)+" milliseconds.",F),k.push({total_errors:0,total_filtered:0,total:d.value().length,control:0}),k.push({type:"bad level",data:d.filter(g=>g.lvl<1||g.lvl>R).value()}),k.push({type:"bad status",data:d.filter(g=>g.status!==I&&g.status!==V&&g.status!==O&&g.status!==L&&g.status!==M).value()}),k.push({type:"bad funded",data:d.filter(g=>g.isFunded!==!1&&g.isFunded!==!0).value()}),k[0].total_errors=k[1].data.length+k[2].data.length+k[3].data.length;var e=[],j=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),p=[];for(let g=1;g<=R;g+=1)K.isInOldMode(a)?p[g]=[h[g],0,h[g]/2,h[g]/2,h[g],0,h[g]/2,h[g]/2]:p[g]=[h[g],0,0,h[g]/2,h[g]/2,0,0,h[g]/4];var A=performance.now();console.log("%cPU calculated took "+(A-l)+" milliseconds.",F);var x=d.filter(g=>g.type.toLowerCase()!=="soutenance"&&g.status===I&&g.isFunded===!1),t=x.groupBy(g=>g.who_id),r=[];for(var q in t.value())r.push({who_id:q,who_name:t.value()[q][0].who_name,sessions:t.value()[q].length});var C=performance.now();console.log("%cBonus took "+(C-A)+" milliseconds.",F);var u=[],z=[],E=0;for(let g=1;g<=R;g+=1){let i=[];i[0]=m[g][0].session.value().length,i[1]=m[g][1].session.value().length,i[2]=m[g][2].session.value().length,i[3]=m[g][3].session.value().length,i[4]=m[g][4].session.value().length,i[5]=m[g][5].session.value().length,i[6]=m[g][6].session.value().length,i[7]=m[g][7].session.value().length,u[g]=[i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7]],E+=u[g].reduce((o,ka)=>o+ka);let w=[];w[0]=m[g][0].defense.value().length,w[1]=m[g][1].defense.value().length,w[2]=m[g][2].defense.value().length,w[3]=m[g][3].defense.value().length,w[4]=m[g][4].defense.value().length,w[5]=m[g][5].defense.value().length,w[6]=m[g][6].defense.value().length,w[7]=m[g][7].defense.value().length,z[g]=[w[0],w[1],w[2],w[3],w[4],w[5],w[6],w[7]]}k[0].total_filtered=E,k[0].control=k[0].total-E;var v=performance.now();console.log("%cPrecalc some vars took "+(v-C)+" milliseconds.",F),e.push({from:a,to:f,created_at:j,errors:k,bonus:r,max_level:R});for(let g=1;g<=R;g+=1){let i=m[g];e.push({sessions:{data:[i[0].session,i[1].session,i[2].session,i[3].session,i[4].session,i[5].session,i[6].session,i[7].session],number:u[g],pu:p[g]},defenses:{data:[i[0].defense,i[1].defense,i[2].defense,i[3].defense,i[4].defense,i[5].defense,i[6].defense,i[7].defense],number:z[g],pu:p[g]}})}var H=performance.now();return console.log("%cMy array full storage took "+(H-v)+" milliseconds.",F),f.isBefore(dayjs())&&fa.add(e),e};static memoized=moize.default(ua._calculateBill,{maxAge:12e4,isSerialized:!0,onCacheAdd:function(a,f,c){console.log("%cCache add",y),console.dir(a.keys)},onCacheHit:function(){console.log("%cCache hit",y)}})}var va=ua;const Rb=ja(X());class Q{static tbl_name="history_session_cache";static getSessionPage=function(a){a.get("day")<a.daysInMonth()&&(a=a.endOf("month"));let f=Rb.default.Cfg.dbase;if(!f.has(Q.tbl_name).value()){throw Error(`DB ${Q.db_name} NOT FOUND`);return-1}let c=f.get(Q.tbl_name).find({id:a.format("YYYYMMDD")}).value();return c===void 0?-1:c};static delete=function(a=null,f=null){let c=Rb.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(a===null&&f==null){c.get(Student.tbl_name).remove().write(),console.log("%cWanna suppress ALL History from DB",y);return}if(f==null){c.get(Student.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isBefore(f),"day"}).write();return}if(a==null){c.get(Student.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isAfter(a,"day")}).write();return}c.get(Student.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isBetween(a,f,"day","[]")}).write()};static addOrUpdateSessionPage=function(a=1,f=dayjs("1970-10-06")){Q.getSessionPage(f)==-1?Q.addSessionPage(a,f):Q.updateSessionPage(a,f)};static updateSessionPage=function(a=1,f=dayjs("1970-10-06")){let c=Rb.default.Cfg.dbase,b=Q.getSessionPage(f);if(b==-1){throw Error("session page not found in history");return-1}c.get(Q.tbl_name).find({id:f.format("YYYYMMDD")}).assign({page:a}).write()};static addSessionPage=function(a=1,f=dayjs("1970-10-06")){let c=Rb.default.Cfg.dbase;c.get(Q.tbl_name).push(JSON.parse(JSON.stringify({id:f.format("YYYYMMDD"),page:a}))).write()}}var qa=Q;const Wb=ja(X());class cb{static detail_bill="truc";static getListDetailBill=function(a,f){let c=Wb.default.Cfg.dbase,b=c.get(J.tbl_name).filter(e=>dayjs(e.when).isSameOrBefore(f,"day")&&dayjs(e.when).isSameOrAfter(a,"day")).sortBy(function(e){return dayjs(e.when).valueOf()}).value();var d=[0,$,aa,ba,ca,da,ea];let n=0;for(var h in b){if(b[h].lvl>d.length-1)throw Error("ERROR PRICE ARRAY MUST BE UPDATED IN LISTS.JS");var k=b[h].isFunded===!0?d[b[h].lvl]:d[b[h].lvl]*.5,m=0,l=!0;K.isInOldMode(dayjs(b[h].when))?b[h].status===I?m=k:(b[h].status===L||b[h].status===M||b[h].status===O)&&(m=k*.5):(l=!1,b[h].status===I?m=k:(b[h].status===L||b[h].status===M)&&(m=k*.5)),n+=m,b[h].iPu=k,b[h].oldMode=l,b[h].iCumul=n,b[h].iFPu=m}return b}}var Ha=cb;var xa=function(a,f){let c=[[0,1,2,3,4,5,5],[5,1,2,3,4,5,5],[4,5,1,2,3,4,4],[3,4,5,1,2,3,3],[2,3,4,5,1,2,2],[1,2,3,4,5,1,1],[0,1,2,3,4,5,0]];return Math.trunc(f.diff(a,"days")/7)*5+c[a.day()][f.day()]};var Ia=async function(){var a="";a+="<style>div.about_content {background-color: #fed9ff;/*width: 600px;*/height: var(--heigth, 80%);overflow-x: hidden;overflow-y: auto;text-align: left;padding: 20px;}</style>",a+='<div class="about_content" style="--heigth: 600px;">',a+='<div class="about_content__wrapper">';const f=await ra.XHR({method:"GET",url:"https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/README.md",responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"}});var c=f.responseText,b=new showdown.Converter(),d=b.makeHtml(c);a+=d,a+="</div>",a+="</div>",Swal.fire({title:`<strong>A propos de ${na}</strong>`,icon:"info",html:a,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},ya=function(){var a="table.crud-list tbody",f=document.querySelector(a),c=!1;if(f.querySelector("[type=checkbox]")===null){for(const p of f.children){var b=Y(p.children[0]),d=document.createElement("input");d.type="checkbox",d.name="name",d.value=b,d.id="id",c=J.exists(b),c===!0&&(d.checked=!0);var n=document.createElement("td");n.style="text-align: center",n.appendChild(d),p.appendChild(n)}a="table.crud-list thead tr";var h=document.querySelector(a);d=document.createElement("input"),d.type="checkbox",d.name="name",d.value="value",d.id="id",d.onclick=function(){document.querySelectorAll("tbody input[type=checkbox]").forEach(p=>p.checked=!p.checked)},d.style="visibility: hidden;";var k=document.createElement("label");k.innerText="in DB",k.style="display:block;",k.onMouseOver="this.style.cursor=pointer;",k.onMouseOut="this.style.cursor=auto;",k.appendChild(d),n=document.createElement("td"),n.style="text-align: center",n.appendChild(k),h.appendChild(n)}else{for(var m=f.querySelectorAll("[type=checkbox]"),l=m.length,e=new Array(l);l--;e[l]=m[l]);for(var j in e)c=J.exists(e[j].value),c===!0?e[j].checked=!0:e[j].checked=!1}},Ja=async function(){var[a,f]=await ga(dayjs().startOf("month"),dayjs().endOf("month")),c=sttctx.dbase,b=c.get("sessions").filter(r=>dayjs(r.when).isSameOrBefore(f,"day")&&dayjs(r.when).isSameOrAfter(a,"day")).sortBy(function(r){return dayjs(r.when).valueOf()}).value(),d="";d+="<table>";var n=30,h=35,k=40,m=50,l=[0,n,h,k,m];d+="<thead>",d+="<tr><th>Quand</th><th>Qui</th><th>Financé ?</th><th>Ancien Mode ?</th><th>PU HT</th><th>Statut</th><th>PU (corrigé) HT</th><th>Cumul</th></tr>",d+="<thead>",d+="<tbody>";var e=0;for(var j in b){var p=dayjs(b[j].when).format("DD/MM/YYYY à HH:mm:ss"),A=b[j].isFunded===!0?l[b[j].lvl]:l[b[j].lvl]*.5,x=0,t=!0;K.isInOldMode(dayjs(b[j].when))?b[j].status==="réalisée"?x=A:(b[j].status==="étudiant absent"||b[j].status==="annulée tardivement")&&(x=A*.5):(t=!1,b[j].status==="réalisée"?x=A:b[j].status==="étudiant absent"&&(x=A*.5)),e+=x,d+="<tr>",d+=`<td>${p}</td><td>${b[j].who_name}</td><td>${b[j].isFunded===!0?"Oui":"Non"}</td><td>${t===!0?"Oui":"Non"}</td><td>${A}</td><td>${b[j].status}</td><td>${x}</td><td>${e}€</td>`,d+="</tr>"}d+="</tbody>",d+="</table>",Swal.fire({title:`<strong>Liste détaillées des sessions du ${a.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,icon:"info",html:d,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:r=>{var q=r.querySelector("table"),C=new simpleDatatables.DataTable(q)}})},Ka=async function(){for(var a="table.crud-list tbody input:checked",f=document.querySelectorAll(a),c=0;c<f.length;c+=1){var b=f[c].parentElement.parentElement,d=J.parseTable(b);await J.add(d)}wa(`Collecte des sessions cochées
terminée`)},La=async function(){var[a,f]=await ga(dayjs().startOf("month"),dayjs().endOf("month"));let c=0,b=GM_config.get("maxfetchpg"),d=!0;var n={};let h=[],k=1,m=qa.getSessionPage(f);for(m!==void 0&&m.page>k&&(k=m.page);d;){if(c>b){console.warn("%cEMERGENCY EXIT LOOP",ha);break}n=await Ya(a,f,k,h),n.length>0&&dayjs(n[n.length-1].when).isSameOrBefore(a)===!0&&(d=!1);let e=dayjs(n[n.length-1].when),j=dayjs(n[20*c].when);if(e.get("month")!=j.get("month")){let p=e.endOf("month");qa.addOrUpdateSessionPage(k,p)}k+=1,c+=1}for(var l in n){if(dayjs(n[l].when).isBefore(a,"day")===!0){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions
Collecte terminée`,showConfirmButton:!1,timer:1500});break}if(dayjs(n[l].when).isAfter(f,"day")===!0)continue;dayjs(n[l].when).isBetween(a,f,"day","[]")&&await J.add(n[l])}ya(),wa("Collecte automatique terminée")},Ya=async function(a,f,c=1,b=[]){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions de l'historique
du `+a.format("DD/MM/YYYY")+" au "+f.format("DD/MM/YYYY")+`
page : `+c+`
cela peut prendre du temps...`,showConfirmButton:!1,timer:3e3});let d=await pa(`https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history?page=${c}`,"table.crud-list tbody");if(d===null)throw new Error("Something went wrong .... try to navigate forward and backward or click some buttons to change url");if(Ga(d,-1).isAfter(f,"day")===!0)return console.log("optimisation ne charge pas ce n'est pas encore arrivé"),b;for(var n=0;n<d.children.length;n+=1){var h=d.children[n],k=J.parseTable(h);b.push(k)}return b},Ma=function(){const{degrees:a,PDFDocument:f,rgb:c,StandardFonts:b}=PDFLib;async function d(){const k="https://pdf-lib.js.org/assets/with_update_sections.pdf",m=await fetch(k).then(r=>r.arrayBuffer()),l=await f.load(m),e=await l.embedFont(b.Helvetica),j=l.getPages(),p=j[0],{width:A,height:x}=p.getSize();p.drawText("This text was added with JavaScript!",{x:5,y:x/2+300,size:50,font:e,color:c(.95,.1,.1),rotate:a(-45)});const t=await l.save();download(t,"pdf-lib_modification_example.pdf","application/pdf")}async function n(){const k=await f.create(),m=await k.embedFont(b.TimesRoman),l=k.addPage(),{width:e,height:j}=l.getSize(),p=30;l.drawText("Creating PDFs in JavaScript is awesome!",{x:50,y:j-4*p,size:p,font:m,color:c(0,.53,.71)});const A=await k.save();download(A,"pdf-lib_modification_example.pdf","application/pdf")}async function h(){var[k,m]=await ga(dayjs().startOf("month"),dayjs().endOf("month"));let l=Ha.getListDetailBill(k,m);const e=await f.create(),j=await e.embedFont(b.TimesRoman),p=e.addPage(),{width:A,height:x}=p.getSize(),t=30;p.drawText(`Prestations en détail

 du ${k.format("DD/MM/YYYY")} au ${m.format("DD/MM/YYYY")}`,{x:50,y:x/2-t,size:t,font:j,color:c(116/255,81/255,235/255)});let r=e.addPage(),q=12,C=1.25;r.font_size=q,r.line_space=C,r.font=j;let u=1,z=20,E=C*q+z,v=x/2;const H=function(D){const s="LOrEm ipsum DOLor sit aMet, conSEc/tetUr 25 porttitor. ";return D*1.0925*(j.widthOfTextAtSize(s,q)/s.length)};let g=[0,H(18),H(36),H(18),H(5),H(8),H(5),H(7)],i=16,w=25;for(let D=1;D<l.length;D+=1){v=x-C*q*u,v<E&&(u=1,r=e.addPage(),v=x-C*q*u);if(u===1){let B=w;r.drawText("Quand",{font:j,size:q,y:v,x:B,lineHeight:i}),B+=g[1],r.drawText("Qui",{font:j,size:q,y:v,x:B,lineHeight:i}),B+=g[2],r.drawText("Quoi",{font:j,size:q,y:v,x:B,lineHeight:i}),B+=g[3],r.drawText("PU",{font:j,size:q,y:v,x:B,lineHeight:i}),B+=g[4],r.drawText("Statut",{font:j,size:q,y:v,x:B,lineHeight:i}),B+=g[5],r.drawText("PUf",{font:j,size:q,y:v,x:B,lineHeight:i}),B+=g[6],r.drawText("Montant",{font:j,size:q,y:v,x:B,lineHeight:i}),u+=1,v=x-C*q*u}let s=w;r.drawText(dayjs(l[D].when).format("DD/MM/YYYY à HH:mm"),{font:j,size:q,y:v,x:s,lineHeight:i}),s+=g[1],r.drawText(l[D].who_name.trim(),{font:j,size:q,y:v,x:s,lineHeight:i}),s+=g[2],r.drawText(`${l[D].type} ${l[D].isFunded===!0?"F.":"AF"} (${l[D].lvl})`,{font:j,size:q,y:v,x:s,lineHeight:i}),s+=g[3],r.drawText(l[D].iPu.toString(),{font:j,size:q,y:v,x:s,lineHeight:i}),s+=g[4],r.drawText(l[D].status,{font:j,size:q,y:v,x:s,lineHeight:i}),s+=g[5],r.drawText(l[D].iFPu.toString(),{font:j,size:q,y:v,x:s,lineHeight:i}),s+=g[6],r.drawText(l[D].iCumul.toString(),{font:j,size:q,y:v,x:s,lineHeight:i}),u+=1}const o=e.getPages();o.forEach((D,s)=>{D.moveTo(10,15),D.setFont(j),D.setFontSize(12),D.setFontColor(c(1,0,0)),D.drawText("Facturier version: XX.XX",{x:15}),D.drawText(`page ${s+1} / ${o.length}`,{x:A-j.widthOfTextAtSize("page 999/999",12)}),D.drawRectangle({x:10,y:10,width:A-20,height:20,color:c(253/255,246/255,227/255),opacity:.6,borderColor:c(0,0,0),borderWidth:1})});const ka=await e.save();download(ka,`prestations_facturees_detail_${k.format("YYYYMMDD")}-${m.format("YYYYMMDD")}.pdf`,"application/pdf")}h()},Na=async function(){GM_addStyle(".form_addon {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}"),GM_addStyle(".form_addon input {background: #fff;border: 1px solid #9c9c9c;}"),GM_addStyle(".form_addon button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}"),GM_addStyle(".form_addon button:hover {background: gold;}"),GM_addStyle(".form_addon label {padding: 0.5em 0.5em 0.5em 0;}"),GM_addStyle(".form_addon input {padding: 0.7em;margin-bottom: 0.5rem;}"),GM_addStyle(".form_addon input:focus {outline: 3px solid gold;}"),GM_addStyle("@media (min-width: 400px) {.form_addon {grid-template-columns: 200px 1fr;grid-gap: 16px;} .form_addon label {text-align: right;grid-column: 1 / 2;} .form_addon input, .form_addon button {grid-column: 2 / 3;}}");var a="";a+='<form id="RAZ" class="form_addon" action="">',a+='<label for="students" class="cbox">Etudiants</label>',a+='<input id="students" type="checkbox" value="del_students_true" checked>',a+='<label for="sessions" class="cbox">Sessions</label>',a+='<input id="sessions" type="checkbox" value="del_sessions_true" checked>',a+='<label for="archives" class="cbox">Archives : factures</label>',a+='<input id="archives" type="checkbox" value="del_archives_true" checked>',a+='<label for="history_cache" class="cbox">Signet historique</label>',a+='<input id="history_cache" type="checkbox" value="del_history_cache_true" checked>',a+='<label for="radio1">filtrer la date</label>',a+='<input type="radio" id="radio1" name="date_filter" value="false" checked>',a+='<label for="radio2">ne pas filtrer</label>',a+='<input type="radio" id="radio2" name="date_filter" value="true">',a+='<label for="dtFrom" class="date">Date de début</label>',a+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',a+='<label for="dtTo" class="date">Date de fin</label>',a+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',a+="<!-- Switch -->",a+='<input type="checkbox" class="switch" name="s1" id="s1">',a+='<label for="s1">Switch</label>',a+="</form>";const{value:f}=await Swal.fire({title:"<strong>RAZ des données</strong>",icon:"info",html:a,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez ce que vous allez supprimer de la base de donnée",preConfirm:()=>{let m=document.getElementsByName("date_filter"),l="notfound";for(var e in m)m[e].checked===!0&&(l=m[e].value);return console.log(document.getElementById("s1")),[document.getElementById("students").checked,document.getElementById("sessions").checked,document.getElementById("archives").checked,document.getElementById("history_cache").checked,document.getElementById("dtFrom").disabled===!0?null:document.getElementById("dtFrom").value,document.getElementById("dtTo").disabled===!0?null:document.getElementById("dtTo").value,l]},onOpen:m=>{m.querySelector("#radio1").addEventListener("change",function(){console.log(document.getElementById("radio1").checked);let l=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!l,document.getElementById("dtTo").disabled=!l}),m.querySelector("#radio2").addEventListener("change",function(){let l=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!l,document.getElementById("dtTo").disabled=!l}),m.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:m=>{m.querySelector("#radio1").removeEventListener("change"),m.querySelector("#radio2").removeEventListener("change"),m.querySelector("#dtFrom").removeEventListener("change")}});let c=f[0],b=f[1],d=f[2],n=f[3];console.log(`wanna raz students ? ${c}, wanna raz sessions ? ${b}, wanna raz archives ? ${d}`);let h=f[4]?dayjs(f[4]):null,k=f[5]?dayjs(f[5]):null;c===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des étudiants",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),P.delete(h,k)),b===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des sessions",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),J.delete(h,k)),d===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des archives (financières)",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),fa.delete(h,k)),n===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base du cache des historique de session",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),qa.delete(h,k))},Oa=async function(){var a="";a+="<style>",a+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",a+="form input {background: #fff;border: 1px solid #9c9c9c;}",a+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",a+="form button:hover {background: gold;}",a+="form label {padding: 0.5em 0.5em 0.5em 0;}",a+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",a+="form input:focus {outline: 3px solid gold;}",a+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",a+="</style>",a+='<form class="form1" action="">',a+='<label for="dd" class="date">Date de début</label>',a+='<input id="dd" type="date" max="2030-12-31" min="2010-12-31">',a+='<label for="df" class="date">Date de fin</label>',a+='<input id="df" type="date" max="2030-12-31" min="2010-12-31">',a+="</form>";var[f,c]=await ga(dayjs().startOf("month"),dayjs().endOf("month")),b=va.calculateBill(f,c);K.isInOldMode(f)?Za(f,c,b):_a(f,c,b)},Za=function(a,f,c){var b="",d=null,n=0,h=0,k=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],m=c[0].max_level;b+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",b+='<div class="wrapper">',b+="<table>",b+="<caption>Sessions de mentorat</caption>",b+="<thead>",b+="<tr>",b+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>";for(var l in k){b+="<tr>",b+="<td>"+k[l][1]+"</td>",d=c[k[l][0]].sessions;let u=d.number[0],z=d.number[4],E=u*d.pu[0],v=z*d.pu[4];n+=u+z,h+=E+v,b+=`<td>${u+z}</td><td>${(d.pu[0]+d.pu[4])/2}</td><td>${E+v}€</td>`,b+="</tr>"}b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${n}</td><td></td><td>${h}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>";var e=n,j=h;n=0,h=0,b+="<table>",b+="<caption>Sessions de mentorat (NoShow)</caption>",b+="<thead>",b+="<tr>",b+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>";for(l in k){b+="<tr>",b+="<td>"+k[l][1]+"</td>",d=c[k[l][0]].sessions;let u=d.number[2]+d.number[3],z=d.number[6]+d.number[7],E=u*(d.pu[2]+d.pu[3])/2,v=z*(d.pu[6]+d.pu[7])/2;n+=u+z,h+=E+v,b+=`<td>${u+z}</td><td>${(d.pu[2]+d.pu[3]+d.pu[6]+d.pu[7])/4}</td><td>${E+v}€</td>`,b+="</tr>"}b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${n}</td><td></td><td>${h}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>",e+=n,j+=h;for(var p=0,A=0,x=0,t=0,r=0,q=1;q<=m;){p+=c[q].sessions.number[1],p+=c[q].sessions.number[5];for(let u in[...Array(8).keys()]){let z=c[q].sessions.number[u];A+=z,x+=z*c[q].sessions.pu[u],z=c[q].defenses.number[u],t+=z,r+=z*c[q].defenses.pu[u]}q+=1}let C=c[0].errors[0].total_errors;A+=C,b+=`<p>Ces ${A} session(s) se répartissent en ${e-n} session(s) de mentorat (${j-h}€)`,b+=`, ${n} NoShows (${h}€)`,C==0?b+=`et ${p} session(s) annulée(s) (${0}€) </p>`:b+=`, ${p} session(s) annulée(s) (${0}€) ainsi que ${C} session(s) en anomalie (cf 1.)`,b+=`<br >Sur le total de ${A} session(s) (${x}€) `,b+=`vous avez réalisé ${t} soutenance(s) (${r}€)</p>`;if(C>0){let u=c[0].errors[0];b+=`(1) Attention, il y a ${C} session(s) qui présente(nt) une anomalie c'est peut être normal : exemple un étudiant qui n'a plus de parcours associé au moment de la collecte de session`,b+=", pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${u.total_errors} erreurs relevées , notez qu'il y a ${u.total_filtered} ennregistrements filtrés(lvl,...)  sur ${u.total} enregistrements dans la période, le total des erreurs devrait donc être de ${u.control} erreurs`),console.warn("détail"),console.warn(`${c[0].errors[1].data.length} erreurs de type ${c[0].errors[1].type} data are`,c[0].errors[1].data),console.warn(`${c[0].errors[2].data.length} erreurs de type ${c[0].errors[2].type} data are`,c[0].errors[2].data),console.warn(`${c[0].errors[3].data.length} erreurs de type ${c[0].errors[3].type} data are`,c[0].errors[3].data)}b+=`<p>Soit un total général à facturer de ${x}€`,Swal.fire({title:`<strong>Liste des formations tarifées du ${a.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,html:b,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},_a=function(a,f,c){console.log("enter computation bill");var b=performance.now(),d="",n=null,h=0,k=0,m=0,l=0,e=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],j=c[0].max_level;d+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",d+='<div class="wrapper">',d+="<table>",d+="<caption>Sessions de mentorat (dont soutenances)</caption>",d+="<thead>",d+="<tr>",d+='<th rowspan="2">Type</th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th>',d+="</tr>",d+="<tr>",d+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',d+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',d+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',d+="</tr>",d+="</thead>",d+="<tbody>";for(var p=1;p<=j;){d+="<tr>",d+=`<td> Niveau ${p}</td>`;let s=c[p].sessions,B=c[p].defenses,T=s.number[0],U=s.number[4],Z=T*s.pu[0],_=U*s.pu[4];h+=T,k+=U,m+=Z,l+=_,d+=`<td>${T} (${B.number[0]})</td><td>${s.pu[0]}</td><td>${Z}€</td>`,d+=`<td>${U} (${B.number[4]})</td><td>${s.pu[4]}</td><td>${_}€</td>`,d+=`<td>${T+U} (${B.number[0]+B.number[4]})</td><td>${Z+_}€</td>`,d+="</tr>",p+=1}var A=performance.now();console.log("%cCalculate first array"+(A-b)+" milliseconds.",F),d+="</tbody>",d+="<tfoot>",d+="<tr>",d+="<td>Total</td>",d+=`<td>${h}</td><td></td><td>${m}€</td>`,d+=`<td>${k}</td><td></td><td>${l}€</td>`,d+=`<td>${h+k}</td><td>${m+l}€</td>`,d+="</tr>",d+="<tr>",d+="</tr>",d+="</tfoot>",d+="</table>";var x=h+k,t=m+l;for(h=0,k=0,m=0,l=0,d+="<table>",d+="<caption>Sessions de mentorat :NoShow (dont soutenances)</caption>",d+="<thead>",d+="<tr>",d+='<th rowspan="2"></th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th><th colspan="2" scope="colgroup">Ensemble</th>',d+="</tr>",d+="<tr>",d+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',d+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',d+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',d+="</tr>",d+="</thead>",d+="<tbody>",p=1;p<=j;){d+="<tr>",d+=`<td> Niveau ${p}</td>`;let s=c[p].sessions,B=c[p].defenses,T=s.number[3],U=s.number[7],Z=T*s.pu[3],_=U*s.pu[7];h+=T,k+=U,m+=Z,l+=_,d+=`<td>${T} (${B.number[3]})</td><td>${s.pu[3]}</td><td>${Z}€</td>`,d+=`<td>${U} (${B.number[7]})</td><td>${s.pu[7]}</td><td>${_}€</td>`,d+=`<td>${T+U}</td><td>${Z+_}€</td>`,d+="</tr>",p+=1}d+="</tbody>",d+="<tfoot>",d+="<tr>",d+="<td>Total</td>",d+=`<td>${h}</td><td></td><td>${m}€</td>`,d+=`<td>${k}</td><td></td><td>${l}€</td>`,d+=`<td>${h+k}</td><td>${m+l}€</td>`,d+="</tr>",d+="<tr>",d+="</tr>",d+="</tfoot>",d+="</table>";var r=performance.now();console.log("%cCalculate second html table took "+(r-A)+" milliseconds.",F),x+=h+k,t+=m+l;var q=0,C=0,u=0,z=0,E=0;for(p=1;p<=j;){q+=c[p].sessions.number[1],q+=c[p].sessions.number[2],q+=c[p].sessions.number[5],q+=c[p].sessions.number[6];for(let s in[...Array(8).keys()]){let B=c[p].sessions.number[s];C+=B,u+=B*c[p].sessions.pu[s],B=c[p].defenses.number[s],z+=B,E+=B*c[p].defenses.pu[s]}p+=1}let v=c[0].errors[0].total_errors;C+=v,d+=`<p>Ces ${C} session(s) se répartissent en ${x-h-k} session(s) de mentorat (${t-m-l}€)`,d+=`, ${h+k} NoShows (${m+l}€)`,v==0?d+=`et ${q} session(s) annulée(s) (${0}€)`:d+=`, ${q} session(s) annulée(s) (${0}€) ainsi que ${v} session(s) en anomalie (cf 1.)`,d+=`<br>Sur le total de ${C} session(s) (${u}€) `,d+=`vous avez réalisé ${z} soutenance(s) (${E}€)</p>`;if(v>0){let s=c[0].errors[0];d+=`(1) Attention, il y a ${v} session(s) qui présente(nt) une anomalie c'est peut être normal : exemple un étudiant qui n'a plus de parcours associé au moment de la collecte de session`,d+=", pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${s.total_errors} erreurs relevées , notez qu'il y a ${s.total_filtered} ennregistrements filtrés(lvl,...)  sur ${s.total} enregistrements dans la période, le total des erreurs devrait donc être de ${s.control} erreurs`),console.warn("détail"),console.warn(`${c[0].errors[1].data.length} erreurs de type ${c[0].errors[1].type} data are`,c[0].errors[1].data),console.warn(`${c[0].errors[2].data.length} erreurs de type ${c[0].errors[2].type} data are`,c[0].errors[2].data),console.warn(`${c[0].errors[3].data.length} erreurs de type ${c[0].errors[3].type} data are`,c[0].errors[3].data)}var H=performance.now();console.log("%cCalculate bottom remark + errors took "+(H-r)+" milliseconds.",F);var g=0;let i="",w="";for(var o in c[0].bonus)c[0].bonus[o].sessions>=1?(g+=30,i+=c[0].bonus[o].who_name+","):w+=c[0].bonus[o].who_name+",";d+=`<p>Calcul du forfait "autofinancé". Vous sont affectés ${c[0].bonus.length} étudiants financés, parmi ceux ci, ${g/30} étudiant(s) avaient au moins une session programmée (${i.slice(0,-1)})`,g/30!==c[0].bonus.length&&(d+=`, (${c[0].bonus.length-g/30}) étudiant(s) (${w.slice(0,-1)}) n'ont pas eu de sessions`),d+=`, le forfait est donc de ${g}€</p>`,d+=`<p>Soit un total général à facturer de ${u+g}€`;var ka=performance.now();console.log("%cCalculate AF took "+(ka-H)+" milliseconds.",F);var D=performance.now();console.log("%cCalculate html table took "+(ka-b)+" milliseconds.",F),Swal.fire({title:`<strong>Liste des formations tarifées du ${a.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,html:d,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},Pa=async function(){var[a,f]=await ga(dayjs().startOf("month"),dayjs().endOf("month"),!1);let c=a,b=[];for(var d=performance.now();c.isSameOrBefore(f,"day");){let g=c.endOf("month");b.push(va.calculateBill(c,g)),c=c.add(1,"month")}console.dir(b);var n=performance.now();console.log("%cComputed data between the two dates in"+(n-d)+" milliseconds.",F);var h="",k=f.get("month")-a.get("month");h+="<table>",h+="<thead>",h+="<tr><th>Origine</th>";for(var m=0;m<=k;){let g=a.add(m,"month");h+=`<th>${g.format("MMMM")}</th>`,m+=1}h+="<th>Total</th><th>Moyenne</th></tr>",h+="</thdead>",h+="<tbody>",h+="<tr>",h+=`<td colspan=${k} style="text-align:left;">Sessions</td></tr>`,h+="<tr>",h+="<td>Sessions (Mt)</td>";let l=0,e=0,j=0,p=[],A=[],x=[],t=[],r=[],q=[],C=[];for(c=a;e<=k;){let g=1;p[e]=0,A[e]=0,x[e]=0,r[e]=0,q[e]=0,C[e]=0;let i=b[e][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)j+=b[e][g].sessions.number[o]*b[e][g].sessions.pu[o],p[e]+=b[e][g].sessions.number[o],A[e]+=b[e][g].defenses.number[o],x[e]+=b[e][g].sessions.number[o]-b[e][g].defenses.number[o],K.isInOldMode(c)?[1,5].includes(o)&&(r[e]+=b[e][g].sessions.number[o],q[e]+=b[e][g].defenses.number[o],C[e]+=b[e][g].sessions.number[o]-b[e][g].defenses.number[o]):[1,2,5,6].includes(o)&&(r[e]+=b[e][g].sessions.number[o],q[e]+=b[e][g].defenses.number[o],C[e]+=b[e][g].sessions.number[o]-b[e][g].defenses.number[o]);g+=1}h+=`<td>${j}</td>`,t[e]=j,l+=j,j=0,e+=1,c=c.add(1,"month")}for(h+=`<td>${l}</td><td>${(l/(k+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Sessions (Nb)</td>",l=0,e=0,j=0;e<=k;)h+=`<td>${p[e]-r[e]}(${p[e]})</td>`,l+=p[e],e+=1;for(h+=`<td>${l}</td><td>${(l/(k+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Sessions (PU)</td>",l=0,e=0,j=0;e<=k;)h+=`<td>${(t[e]/(p[e]-r[e])).toFixed(2)}</td>`,l+=j,j=0,e+=1;for(h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+="<tr>",h+=`<td colspan=${k} style="text-align:left;">Mentorat</td></tr>`,h+="<tr>",h+="<td>Mentorat (Mt)</td>",e=0,j=0,t=[];e<=k;){let g=1,i=b[e][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)j+=b[e][g].sessions.number[o]*b[e][g].sessions.pu[o]-b[e][g].defenses.number[o]*b[e][g].defenses.pu[o],t[e]=j;g+=1}h+=`<td>${j}</td>`,e+=1,j=0}for(h+="<tr>",h+="<tr>",h+="<td>Mentorat (Nb)</td>",l=0,e=0,j=0,p=[];e<=k;)h+=`<td>${x[e]-C[e]}(${x[e]})</td>`,l+=j,j=0,e+=1;for(h+=`<td>${l}</td><td>${(l/(k+1)).toFixed(2)}</td>`,h+="</tr>",h+="<td>Mentorat (PU)</td>",e=0;e<=k;)h+=`<td>${(t[e]/(x[e]-C[e])).toFixed(2)}</td>`,t[e]=j,l+=j,j=0,e+=1;for(h+=`<td>${l}</td><td>${(l/(k+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+=`<td colspan=${k} style="text-align:left;">Soutenances</td></tr>`,h+="<tr>",h+="<td>Soutenances (Mt)</td>",l=0,e=0,j=0,p=[],t=[];e<=k;){let g=1;p[e]=0;let i=b[e][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)j+=b[e][g].defenses.number[o]*b[e][g].defenses.pu[o],p[e]+=b[e][g].defenses.number[o];g+=1}h+=`<td>${j}</td>`,t[e]=j,l+=j,j=0,e+=1}for(h+=`<td>${l}</td><td>${(l/(k+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Soutenances (Nb)</td>",l=0,e=0,j=0;e<=k;)h+=`<td>${p[e]-q[e]}(${p[e]})</td>`,l+=p[e],e+=1;for(h+=`<td>${l}</td><td>${(l/(k+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Soutenances (PU)</td>",l=0,e=0,j=0;e<=k;)h+=`<td>${(t[e]/(p[e]-q[e])).toFixed(2)}</td>`,l+=j,j=0,e+=1;h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+=`<td colspan=${k} style="text-align:left;">Bonus</td></tr>`,h+="<tr>",h+="<td>Bonus AF</td>",e=0,j=0;let u=[];for(;e<=k;){let g=b[e][0].bonus;u[e]=0;for(let i=0;i<g.length;i+=1)j+=g[i].sessions>0?30:0;h+=`<td>${j}</td>`,u[e]=j,j=0,e+=1}h+="</tr>",h+="<tr>",h+=`<td colspan=${k} style="text-align:left;">TJM</td></tr>`,h+="<tr>",h+="<td>Nb Jrs</td>",e=0;var z=[];l=0,c=a,t=[],c=a.clone();let E=c.clone().endOf("month"),v=[];for(;e<=k;)E.isAfter(f,"day")&&(E=f.clone()),h+=`<td>${xa(c,E)} jrs</td>`,v[e]=xa(c,E),c=c.add(1,"month"),E=E.add(1,"month"),e+=1;for(h+="</tr>",h+="<tr>",h+="<td>TJM</td>",e=0;e<=k;){j=0;let g=1;t[e]=0,z[e]=0;let i=b[e][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)t[e]+=b[e][g].sessions.number[o]*b[e][g].sessions.pu[o];g+=1}h+=`<td>${(t[e]/v[e]).toFixed(2)} €</td>`,e+=1}for(h+="</tr>",h+="<tr>",h+="<td>THM (théorique)</td>",e=0,z=[],l=0,c=a,t=[];e<=k;){j=0;let g=1;t[e]=0,z[e]=0;let i=b[e][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)t[e]+=b[e][g].sessions.number[o]*b[e][g].sessions.pu[o],K.isInOldMode(c)?j+=(b[e][g].sessions.number[o]-b[e][g].defenses.number[o])*(45/60):([4,5,6,7].includes(o)&&(j+=(b[e][g].sessions.number[o]-b[e][g].defenses.number[o])*(30/60)),[0,1,2,3].includes(o)&&(j+=(b[e][g].sessions.number[o]-b[e][g].defenses.number[o])*(45/60))),j+=b[e][g].defenses.number[o]*(45/60);g+=1}console.log(`montant mensuel : ${t[e]} + bonus ${u[e]}/ Nb heures ${j} = $((aAmInMonth[_m]+aAmBoInMonth[_m])/iTotal).toFixed(2)`),h+=`<td>${((t[e]+u[e])/j).toFixed(2)} €</td>`,l+=j,z[e]=j,j=0,e+=1,c=c.add(1,"month")}for(h+="</tr>",h+="<tr>",h+="<td>Nb heures</td>",l=0,e=0,j=0;e<=k;)h+=`<td>${z[e].toFixed(2)} h</td>`,l+=j,j=0,e+=1;for(h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+="<tr>",h+="<td>THM (person.)</td>",e=0,z=[],l=0,c=a,t=[];e<=k;){j=0;let g=1;t[e]=0,z[e]=0;let i=b[e][0].max_level;for(;g<i;){let w=[...Array(8).keys()];for(let o=0;o<w.length;o+=1)t[e]+=b[e][g].sessions.number[o]*b[e][g].sessions.pu[o],K.isInOldMode(c)?j+=(b[e][g].sessions.number[o]-b[e][g].defenses.number[o])*(GM_config.get("nbHrsfM")/60):([4,5,6,7].includes(o)&&(j+=(b[e][g].sessions.number[o]-b[e][g].defenses.number[o])*(GM_config.get("nbHrsAfM")/60)),[0,1,2,3].includes(o)&&(j+=(b[e][g].sessions.number[o]-b[e][g].defenses.number[o])*(GM_config.get("nbHrsfM")/60))),j+=b[e][g].defenses.number[o]*(GM_config.get("nbHrsD")/60);g+=1}console.log(`montant mensuel : ${t[e]} + bonus ${u[e]}/ Nb heures ${j} = $((aAmInMonth[_m]+aAmBoInMonth[_m])/iTotal).toFixed(2)`),h+=`<td>${((t[e]+u[e])/j).toFixed(2)} €</td>`,l+=j,z[e]=j,j=0,e+=1,c=c.add(1,"month")}for(h+="</tr>",h+="<tr>",h+="<td>Nb heures</td>",l=0,e=0,j=0;e<=k;)h+=`<td>${z[e].toFixed(2)} h</td>`,l+=j,j=0,e+=1;h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+="</tbody>",h+="<tfoot>",h+"",h+="</tfoot>",h+="</table>";var H=performance.now();console.log("%cTime to show table :"+(H-n)+" milliseconds.",F),Swal.fire({title:`<strong>Statistiques du ${a.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,icon:"info",html:h,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:g=>{}})};class N{static init=function(){console.log("%cin initUI",y),N.build();var a=new Draggabilly(".draggable",{handle:".handle"});db.start("animation-target")};static build=function(){console.log("%c in buildUI","background-color:green;color:white"),GM_addStyle(".flex > * { margin: 2px 1px; }"),GM_addStyle(".flex > :first-child { margin-left: 0; }"),GM_addStyle(".flex > :last-child { margin-right: 0; }"),GM_addStyle(".panel {display: flex; justify-content: center;z-index:999}"),GM_addStyle(".menuBar {border-top: 1px solid; padding: 10px; font-size: 1rem; pointer-events: inherit;position: relative;top:0px;  flex-flow: row wrap;/*align-content: space-between;justify-content: space-between;*/}"),GM_addStyle(".draggable {background: transparent;border-radius: 10px;padding: 20px;}"),GM_addStyle(".draggable.is-pointer-down {background: #09F;}"),GM_addStyle(".draggable.is-dragging { opacity: 0.7; }"),GM_addStyle(".handle {background: #555;background: hsla(0, 0%, 0%, 0.4);width: 20px;height: 20px; border-radius: 10px;}"),GM_addStyle(".flex > :nth-last-child(2) {page-break-after: always; /* CSS 2.1 syntax */break-after: always; /* New syntax */}"),GM_addStyle("#animation-target {width: 10px;height: 5px;background-color:coral;border-radius: 25%;}");var a=document.createElement("div"),f=document.createElement("div");f.classList.add("handle"),a.appendChild(f),a.classList.add("panel","menuBar","flex","draggable"),document.body.appendFirst(a),N.addButton("collectChecked",Ka,{},a),N.addButton("CollectAuto",La,{},a),N.addButton("showBill",Oa,{},a),N.addButton("billInDetails",Ja,{},a),N.addButton("PDF",Ma,{},a),N.addButton("SList",P.showList,{},a),N.addButton("RAZ",Na,{},a),N.addButton("statistics",Pa,{},a),N.addButton("about",Ia,{},a);var c=document.createElement("div");c.id="animation-target",a.appendChild(c)};static addButton=function(a,f,c,b){b=b||document.body,c=c||{position:"absolute",bottom:"7%",left:"4%","z-index":3};let d=document.createElement("button"),n=d.style;return d.classList.add("button--primary","button"),b.appendChild(d),d.innerHTML=a,d.onclick=f,Object.keys(c).forEach(h=>n[h]=c[h]),d}}class db{static start=function(a){const f=document.getElementById(a),c=k=>f.style.transform=`translateX(${k}px)`;let b=0;const d=7,n=k=>{c(b),b+=d,b>100?requestAnimationFrame(h):requestAnimationFrame(n)},h=k=>{c(b),b-=d,b<-100?requestAnimationFrame(n):requestAnimationFrame(h)};requestAnimationFrame(n)}}var Sa=N;const $a="#OCAddonsCfg {background-color: lightblue;} #OCAddonsCfg .reset_holder {float: left; position: relative; bottom: -1em;} #OCAddonsCfg .saveclose_buttons {margin: .7em;}",ab="height: 16.7em; width: 30em; border: 1px solid; border-radius: 3px; position: fixed; z-index: 999;",Qa={id:"OCAddonsCfg",title:"Configuration du module",fields:{nbHrsAfM:{section:["Statistiques","paramètres"],label:"Nombre de minutes pour une session AF",labelPos:"left",type:"input",default:30},nbHrsfM:{label:"Nombre de minutes pour une session financée",labelPos:"left",type:"input",default:45},nbHrsD:{label:"Nombre de minutes pour une session de soutenance",labelPos:"left",type:"input",default:45},maxfetchpg:{section:["Application","optimisation"],label:"Maximum de page recherchées dans l'historique",labelPos:"left",type:"input",default:1e3},datacachelifetime:{label:"Temps de conservation des données dans le cache (en ms)",labelPos:"left",type:"input",default:12e4},checksessionalreadyexists:{section:["Application","Base de donnée"],label:"sessions: vérifier existence avant insertion",labelPos:"left",type:"checkbox",default:!0},sizeofcontentlist:{section:["Interface","thème"],label:"taille de la police des listes",labelPos:"left",type:"input",default:"1em;"},use_custom_css:{label:"utiliser des styles personnalisés",labelPos:"left",type:"checkbox",default:!1},custom_css_url:{label:"url de la feuille de style (si plusieurs les séparer par des virgules)",labelPos:"left",type:"input",default:""},custom_css_data:{label:"saisir ici le code css à injecter directement dans la page",title:"Je me demande bien à quoi sert le titre",labelPos:"left",type:"input",default:""},alwaysaddcbox:{section:["Interface","gadget"],label:"Toujours ajouter les checkbox sur l'interface",labelPos:"left",type:"checkbox",default:!0},hackheaderzindex:{label:"changer le zindex du bandeau haut",labelPos:"left",type:"checkbox",default:!0},support:{section:["","Support"],label:"StephaneTy-Pro.github.io",title:"more info on https://github.com/StephaneTy-Pro",type:"button",click:()=>{GM_openInTab("https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon",{active:!0,insert:!0,setParent:!0})}}},css:$a,events:{save:function(){GM_config.close()}}};var Ra=function(){GM_config.open(),OCAddonsCfg.style=ab};X();})();
//# sourceMappingURL=billing.min.js.map
