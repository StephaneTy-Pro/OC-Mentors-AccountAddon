// ==UserScript==
// @name         Facturier (alpha)
// @namespace    http://tampermonkey.net/
// @version      1.00.0005
// @description  Un addon pour vous aidez dans votre facturation
// @author       Stéphane TORCHY
// @updateURL    https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/dist/app.min.js
// @downloadURL  https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/dist/app.min.js
// @match        https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history*
// @run-at          document-end
// @grant        unsafeWindow
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @grant        GM_registerMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        GM.xmlHttpRequest
// @grant        GM_notification

// @require      https://cdn.jsdelivr.net/npm/lodash@4.17.19/lodash.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/low.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/LocalStorage.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/dayjs.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/locale/fr.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isBetween.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrBefore.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrAfter.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/customParseFormat.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/localeData.min.js


// GM_Config
// @require      https://openuserjs.org/src/libs/sizzle/GM_config.js

// sweetalert 2
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.all.min.js

// draggabilly
// @require      https://cdnjs.cloudflare.com/ajax/libs/draggabilly/2.2.0/draggabilly.pkgd.min.js

// toastify
// @require     https://cdn.jsdelivr.net/npm/toastify-js@1.8.0/src/toastify.min.js
// @resource    toastifycss https://raw.githubusercontent.com/apvarun/toastify-js/master/src/toastify.css

//
// @require     https://raw.githubusercontent.com/uzairfarooq/arrive/master/minified/arrive.min.js

// simple-datatables
// @require     https://cdn.jsdelivr.net/npm/simple-datatables@latest
// @resource    simpledatatablecss https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css

// require https://raw.githubusercontent.com/anywhichway/nano-memoize/master/dist/nano-memoize.min.js
// @require https://cdn.jsdelivr.net/npm/moize@5.4.7/dist/moize.min.js

// require https://raw.githubusercontent.com/StephaneTy-Pro/userscripts/master/fetch-inject.umd.min.js
// @require https://cdn.jsdelivr.net/npm/fetch-inject

// PARSER MKDOWN
// @require 	 https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js

// PDF https://pdf-lib.js.org/docs/api/
// @require      https://unpkg.com/pdf-lib@1.9.0/dist/pdf-lib.min.js
// @require      https://unpkg.com/downloadjs@1.4.7/download.js


/*
 * History
 * cf https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon/blob/master/CHANGELOG.md
 */



// ==/UserScript==

(function() {

    'use strict';
let ya=Object.defineProperty,Za=Object.prototype.hasOwnProperty,pb=(c,f)=>()=>(f||(f={exports:{}},c(f.exports,f)),f.exports),_a=c=>ya(c,"__esModule",{value:!0}),qb=(c,f)=>{_a(c);for(let a in f)ya(c,a,{get:f[a],enumerable:!0})},rb=(c,f)=>{_a(c);if(typeof f==="object"||typeof f==="function")for(let a in f)Za.call(f,a)&&!Za.call(c,a)&&a!=="default"&&ya(c,a,{get:()=>f[a],enumerable:!0});return c},_=c=>c&&c.__esModule?c:rb(ya({},"default",{value:c,enumerable:!0}),c);var V=pb(h=>{qb(h,{APP_AUTHOR:()=>Ha,APP_DEBUG_STYLE:()=>o,APP_ERROR_STYLE:()=>S,APP_INFO_STYLE:()=>Ja,APP_LOG_STYLE:()=>Ia,APP_NAME:()=>sa,APP_PERF_STYLE:()=>E,APP_WARN_STYLE:()=>ka,OC_AUTOFUNDED:()=>ma,OC_FUNDED:()=>ta,OC_MAX_LEVEL:()=>U,OC_PRICE1:()=>ca,OC_PRICE2:()=>da,OC_PRICE3:()=>ea,OC_PRICE4:()=>fa,OC_PRICE5:()=>ga,OC_PRICE6:()=>ha,OC_STATUS_0:()=>L,OC_STATUS_1:()=>X,OC_STATUS_2:()=>Q,OC_STATUS_3_F:()=>O,OC_STATUS_3_M:()=>N,default:()=>l});const j={Cfg:{dbase:null},raf:null,start:async function(){await Xa();const m=j.checkSupport();console.log(`%cAre all functions supported ? : ${m}`,o),document.arrive(".MuiAvatar-img",j._warmup)},checkSupport:function(){return!0},_warmup:function(){console.log("%cinSetup",o),GM===void 0?(console.log("%cI am not in a tamper env"),j._userscriptless()):console.log(`%cTamper environment detected the version is ${GM.info.version}`,o),GM_addStyle(GM_getResourceText("jspanelcss")),GM_addStyle(GM_getResourceText("toastifycss")),GM_addStyle(GM_getResourceText("simpledatatablecss")),GM_config.init(Ua),GM_registerMenuCommand("OC Facturier - configure",Va),GM_config.get("hackheaderzindex")===!0&&(document.getElementById("header").style.zIndex=0),GM_addStyle(".swal2-title{font-size:1.275em)"),j._main()},_userscriptless(){},_main:function(){console.log("​​​%cMainLoaded​​​",o),Da.paintTiming(),Da.longTaskTiming();let m=new LocalStorage("db");var n=low(m);n.defaults({students:[],sessions:[],f_archives:[],history_session_cache:[]}).write(),j.Cfg.dbase=n,dayjs.extend(dayjs_plugin_isSameOrAfter),dayjs.extend(dayjs_plugin_isSameOrBefore),dayjs.extend(dayjs_plugin_isBetween),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_customParseFormat),document.querySelector(".panel.menuBar.flex.draggable")===null&&Wa.init(),GM_config.get("alwaysaddcbox")===!0&&na(),dayjs.locale("fr");if(GM_config.get("use_custom_css")===!0){let p=GM_config.get("custom_css_url"),x=p.split(",");if(x.length!==0)fetchInject([x]).then(()=>{console.log(`%cDependencies ${x} loaded`,o)});else{let A=GM_config.get("custom_css_data");A.length()>0&&console.log(`%cNeed to inject a custom css in application content is ${A}`,o)}}GM.info.script.downloadURL==="http://localhost:8000/dist/app-facturier.iife.js"?(console.log("%cALERTE .... version locale !!!!!! ","background-color:coral;color:white"),unsafeWindow.Facturier={libs:[],cfg:{dbase:null}},unsafeWindow.Facturier.cfg.dbase=j.Cfg.dbase,unsafeWindow.Facturier.libs.push({id:"fetchInject",ptr:fetchInject}),unsafeWindow.Facturier.libs.push({id:"dayjs",ptr:dayjs}),console.log("%cImportants values are exported in unsafeWindow.Facturier",o),console.log("%c test readfile",o),Ya("file:////media/pwyll/USB120Go/DevStt/UserScripts/SttAddon/src/update_data_base.js",function(p){console.log(p)}),j.loadDependencies()):console.log(`%c GM.info.script.downloadURL url : ${GM.info.script.downloadURL}`,o)},loadDependencies:function(){let m=[];m.push("http://localhost:8000/src/branch01/sandbox.js"),m.push("http://localhost:8000/src/branch01/sandbox.css"),fetchInject(m).then(()=>{console.log(`dependencies ${m} loaded`)})},overrideDebug:function(){var m=window.XMLHttpRequest.prototype.open,n=window.XMLHttpRequest.prototype.send;function p(u,v,t,r,y){return this._url=v,m.apply(this,arguments)}function x(u){return this.onreadystatechange&&(this._onreadystatechange=this.onreadystatechange),console.log(`%c Request sent : ${u}`,o),this.onreadystatechange=A,n.apply(this,arguments)}function A(){console.log(`%c Ready state changed to: ${this.readyState}`,o);if(this._onreadystatechange)return this._onreadystatechange.apply(this,arguments)}window.XMLHttpRequest.prototype.open=p,window.XMLHttpRequest.prototype.send=x}};window.Facturier!==void 0?window.Facturier.start():j.start();var l=j});var wa={async XHR(c){const f=window.GM_xmlhttpRequest||(GM?GM.xmlHttpRequest:null);return f?new Promise((a,d)=>{Object.assign(c,{onabort:d,onerror:d,onload:a,ontimeout:d}),f(c)}):Promise.reject()},async getValue(c,f=null){return window.GM_getValue?Promise.resolve(GM_getValue(c)||f):await GM.getValue(c)||f},async setValue(c,f){window.GM_setValue?GM_setValue(c,f):GM.setValue(c,f)}};const sa="OC-Addons",Ha="Stéphane TORCHY",o="background-color:green;color:white",Ia="background-color:black;color:white",ka="background-color:coral;color:white",Ja="background-color:cyan;color:white",S="background-color:red;color:white",E="background-color:blue;color:white",ma="auto-financé",ta="financé par un tiers",L="réalisée",X="annulée",Q="annulée tardivement",N="étudiant absent",O="étudiante absente",U=6,ca=30,da=35,ea=40,fa=45,ga=50,ha=55;var Xa=function(){return new Promise(c=>{document.readyState=="loading"?document.addEventListener("DOMContentLoaded",c):c()})},ua=async function(c="",f="",a=!1){console.info(`%cfetch() waiting return from : ${c}`,o);const d=await wa.XHR({method:"GET",url:c,responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"},onprogress:function(h){console.log("%cOn progress function:",o),console.log(`%cgm_xhr onprogress lengthComputable: ${h.lengthComputable}`,o),console.log(`%cgm_xhr onprogress loaded: ${h.loaded}`,o),console.log(`%cgm_xhr onprogress total: ${h.total}`,o),console.log(`%cgm_xhr onprogress total: ${h.position}`,o),console.log(`%cgm_xhr onprogress total: ${h.done}`,o)}}).catch(h=>{console.error(`%cError ${h}`,S)});let b=new DOMParser(),g=b.parseFromString(d.responseText.replace(/\n/mg,""),"text/html"),j=g.querySelector("meta[id=captcha-bypass]");if(j!==null)throw console.error(`%cError CloudFlare CAPTCHA : ${g.querySelector("title").innerText}`,o),new Error("Must Respond to Cloudflare Captcha or waiting....");var l={};return a===!0?l=g.querySelectorAll(f):l=g.querySelector(f),l},Z=function(c,f=-1){try{var a=(c.children[0].href||"/").split("/");return a[a.length+f]}catch(d){console.error(`%cError in getkey${d.stack||d}`,S)}},Fa=function(c){var f=c.trim().split(" ");try{var a=dayjs_locale_fr.months.findIndex(d=>d===f[1])+1}catch(d){console.error(`%cError in extractDate${d.stack||d}`,S)}return`${f[2]}-${a}-${f[0]}T${f[4]}`},Ca=function(c,f=0){f===-1&&(f=c.children.length-1);var a=c.children[f].children[0].innerText;let d=Fa(a);var b=dayjs(d);return b},Ga=function(c){return new Promise(f=>setTimeout(f,c))};function Ya(c,f){return console.info("Reading:",c),fetch(c,{mode:"same-origin"}).then(function(a){return a.blob()}).then(function(a){var d=new FileReader();d.addEventListener("loadend",function(){f(this.result)}),d.readAsText(a)})}HTMLElement.prototype.appendFirst=function(c){this.firstChild?this.insertBefore(c,this.firstChild):this.appendChild(c)};var ja=async function(c=null,f=null,a=!0){var d="";d+="<style>",d+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",d+="form input {background: #fff;border: 1px solid #9c9c9c;}",d+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",d+="form button:hover {background: gold;}",d+="form label {padding: 0.5em 0.5em 0.5em 0;}",d+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",d+="form input:focus {outline: 3px solid gold;}",d+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",d+="</style>",d+='<form class="form1" action="">',d+='<label for="dtFrom" class="date">Date de début</label>',c?d+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(c).format("YYYY-MM-DD")+'">':d+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',d+='<label for="dtTo" class="date">Date de fin</label>',c?d+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(f).format("YYYY-MM-DD")+'">':d+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',d+="</form>";const{value:b}=await Swal.fire({title:"<strong>Choix de la période</strong>",icon:"info",html:d,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez la période pour la sélection des temps facturés",showLoaderOnConfirm:!0,preConfirm:()=>[document.getElementById("dtFrom").value,document.getElementById("dtTo").value],onRender:g=>{},onOpen:g=>{a===!0&&g.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:g=>{a===!0&&g.querySelector("#dtFrom").removeEventListener("change")},onAfterClose:g=>{},onDestroy:g=>{}});return c=dayjs(b[0]),f=dayjs(b[1]),await Ga(250),[c,f]},ra=async function(c){await Swal.fire({position:"top-end",icon:"success",title:c,showConfirmButton:!1,timer:1500})};const Db=_(V());class Y{static tbl_name="f_archives";static add=async function(c){let f=Db.default.Cfg.dbase,a=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),d={id:c[0].to.format("YYYYMM"),data:c,created_at:c[0].now};console.log(`%cWill create archive for id ${c[0].to.format("YYYYMM")} (YYYYMM)`,o),f.get(Y.tbl_name).push(JSON.parse(JSON.stringify(d))).write()};static exists=function(c){let f=Db.default.Cfg.dbase,a=f.get(Y.tbl_name).find({id:c}).value();return a===void 0?!1:!0};static get=function(c){let f=Db.default.Cfg.dbase;var a=f.get(Y.tbl_name).find({id:c}).value();if(a===void 0){throw Error("Erreur qui ne devrait jamais arriver en Archive.get");return!1}else return console.log(`%cWill use archive for id ${c} (YYYYMM)`,o),a};static delete=function(c=null,f=null){let a=Db.default.Cfg.dbase;typeof c==="string"&&(c=c.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(c===null&&f==null){console.log("%cWanna suppress ALL Archives from DB ",o),a.get(Y.tbl_name).remove().write();return}if(f==null){a.get(Y.tbl_name).remove(function(d){return dayjs(d.id,"YYYYMM").isBefore(f),"month"}).write();return}if(c==null){a.get(Y.tbl_name).remove(function(d){return dayjs(d.id,"YYYYMM").isAfter(c,"month")}).write();return}a.get(Y.tbl_name).remove(function(d){return dayjs(d.id,"YYYYMM").isBetween(c,f,"month","[]")}).write()}}var ia=Y;class ab{static isInOldMode=function(c){var f=null;typeof c==="string"?f=dayjs(c):f=c;try{return f.isBefore(dayjs("2020-06-01"))}catch(a){throw Error("Erreur qui ne devrait jamais arriver en IsInOldMode (probablement un probleme sur la conversion de la date en objet dayjs:"+a.stack||a)}}}var R=ab;const Bc=_(V());class I{static tbl_name="students";static add=function(c,f="noname",a="nopath",d="unkonw",b){let g=Bc.default.Cfg.dbase;var j=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");let l={id:c,fullname:f,path:a,fundedby:d,created:j};g.get(I.tbl_name).push(JSON.parse(JSON.stringify(l))).write()};static exists=function(c){let f=Bc.default.Cfg.dbase;var a=f.get(I.tbl_name).find({id:c}).value();return a===void 0?!1:!0};static getFunded=function(c){let f=Bc.default.Cfg.dbase,a=f.get(I.tbl_name).find({id:c}).value();if(a==void 0)throw Error(`IRRECOVERABLE ERROR STUDENT WITH ID ${c} NOT IN DB:`);return a.fundedby};static isAutoFunded=function(c){return I.getFunded(c).toLowerCase()===ma};static getFinancialMode=async function(c){const f=await ua(`https://openclassrooms.com/fr/mentorship/students/${c}/dashboard`,".mentorshipStudent__details > p");return f.innerText};static delete=function(c=null,f=null){let a=Bc.default.Cfg.dbase;typeof c==="string"&&(c=c.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(c===null&&f==null){console.log("%cWanna suppress ALL Students from DB",o),a.get(I.tbl_name).remove().write();return}if(f==null){a.get(I.tbl_name).remove(function(d){return dayjs(d.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isBefore(f),"day"}).write();return}if(c==null){a.get(I.tbl_name).remove(function(d){return dayjs(d.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isAfter(c,"day")}).write();return}a.get(I.tbl_name).remove(function(d){return dayjs(d.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isBetween(c,f,"day","[]")}).write()};static getAll=async(c,f)=>{var a=!1;let d=Bc.default.Cfg.dbase;var b="table.crud-list tbody",g=document.querySelectorAll(b)[1],j=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");Swal.fire({position:"top-end",icon:"info",toast:!0,title:`mise à jour de la base de donnée des étudiants...
cela peut prendre du temps`,showConfirmButton:!1,timer:1e3});for(const m of g.children){var l=Z(m.children[0],-2),h=m.children[0].innerText,e="non défini";m.children[1].firstElementChild&&(e=m.children[1].firstElementChild.href.split("/").pop());var q=d.get(I.tbl_name).find({id:l}).value();if(q&&a===!1)console.log(`%c${h}(uniquid:${l}) already present in database created at ${q.created}`,o);else{let n=await I.getFinancialMode(l);console.log(`%cFinancial Mode of student ${h}(id:${l}) is ${n}`,o),Toastify({text:`Ajoute l'étudiant : ${h}(${n}) en base`,gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast(),I.add(l,h,e,n,j)}}};static showList=function(){let c=Bc.default.Cfg.dbase,f=c.get(I.tbl_name).value();var a="";a+="<table>",a+="<caption>Liste des étudiant</caption>",a+="<thead>",a+="<tr>",a+="<th>Nom</th><th>Parcours</th><th>Financement</th><th>Date de création</th>",a+="</tr>",a+="</thead>",a+="<tbody>";for(var d in f)a+="<tr>",a+=`<td>${f[d].fullname}</td><td>${f[d].path}</td><td>${f[d].fundedby}</td><td>${dayjs(f[d].created,"YYYY-MM-DDTHH:mm:ssZ[Z]").format("DD/MM/YYYY à HH:mm")}</td>`,a+="</tr>";a+="</tbody>",a+="</table>",Swal.fire({title:"<strong>Liste des Etudiants</strong>",icon:"info",html:a,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"fullscreen",onOpen:b=>{var g=b.querySelector("table"),j=new simpleDatatables.DataTable(g)}})};static createManually=async function(c,f,a){let d=["non présent dans la liste","Chef de projet digital","Chef de projet SI","Développeur d'application - Frontend","Développeur Web","Expert en stratégie marketing et communication ","Production de contenu web avec CMS et Content Marketing ","Tech lead"];var b="";b+="<style>",b+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",b+="form input {background: #fff;border: 1px solid #9c9c9c;}",b+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",b+="form button:hover {background: gold;}",b+="form label {padding: 0.5em 0.5em 0.5em 0;}",b+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",b+="form input:focus {outline: 3px solid gold;}",b+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",b+="</style>",b+='<form class="form1" action="">',b+='<label for="student_id" class="name">Reference</label>',b+='<input id="student_id" type="text" value="'+c+'">',b+='<label for="student_name" class="name">Name</label>',b+='<input id="student_name" type="text" value="'+f+'">',b+='<label for="fundedby">Autofinancé</label>',b+='<input id="fundedby" type="checkbox" value="autofunded">',b+='<label for="student_path">Parcours</label>',b+='<input id="student_path" name="student_path" type="text" list="student_path-list">',b+='<datalist id="student_path-list">';for(var g in d)b+=`<option>${d[g]}</option>`;b+="/<datalist>",b+='<label for="session_date">Date</label>',b+='<input id="session_date" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(a).format("YYYY-MM-DD")+'">',b+="</form>";const{value:j}=await Swal.fire({title:"<strong>Ajout d'un étudiant en mode manuel</strong>",icon:"info",html:b,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:`votre étudiant(e) ${f} n'a pas été trouvé`,preConfirm:()=>[document.getElementById("student_id").value,document.getElementById("student_name").value,document.getElementById("student_path").value,document.getElementById("fundedby").checked,document.getElementById("session_date").value]});if(j){var l="";j[3]===!0?l=ma:l=ta,I.add(j[0],j[1],j[2],l,j[4])}}}var T=I;const vc=_(V());class W{static tbl_name="sessions";static add=async function(c){let f=vc.default.Cfg.dbase;if(GM_config.get("checksessionalreadyexists")===!0)var a=!0;if(R.isInOldMode(dayjs(c.when)))c.isFunded=!0;else if(c.type.toLowerCase()==="soutenance")c.isFunded=!0;else{var d=T.exists(c.who_id);console.log("is student in db ?",d);if(d==!1){console.warn("%cI'm updating db .... could'nt do anything else",ka),await T.getAll();var b=T.exists(c.who_id);if(b==!1)return T.createManually(c.who_id,c.who_name,c.when)}c.isFunded=!T.isAutoFunded(c.who_id)}a?W.exists(c.id)==!1?f.get(W.tbl_name).push(JSON.parse(JSON.stringify(c))).write():console.info(`%cSession of ${c.who_name} at ${c.when} already present in database table sessions, skip it!`,o):f.get(W.tbl_name).push(JSON.parse(JSON.stringify(c))).write()};static exists=function(c){let f=vc.default.Cfg.dbase;var a=f.get(W.tbl_name).find({id:c}).value();return a===void 0?!1:!0};static delete=function(c=null,f=null){let a=vc.default.Cfg.dbase;typeof c==="string"&&(c=c.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(c===null&&f==null){console.log("%cWanna suppress ALL Sessions from DB",o),a.get(W.tbl_name).remove().write();return}if(f==null){a.get(W.tbl_name).remove(function(d){return dayjs(d.when).isBefore(f),"day"}).write();return}if(c==null){a.get(W.tbl_name).remove(function(d){return dayjs(d.when).isAfter(c,"day")}).write();return}a.get(W.tbl_name).remove(function(d){return dayjs(d.when).isBetween(c,f,"day","[]")}).write()};static parseTable=function(c){var f=c.children[0].children[0].innerText,a=Z(c.children[0]),d=c.children[1].children[0].innerText,b=Z(c.children[1],-2),g=c.children[2].innerText.trim().toLowerCase(),j=c.children[3].children.length?c.children[3].children[0].innerText.trim().toLowerCase():"session",l=-1;c.children[4].children.length>0&&(l=c.children[4].children[0].innerText),f=Fa(f);var h={id:a,when:f,who_id:b,who_name:d,status:g,type:j,lvl:l};return h}}var M=W;const vb=_(V());class za{static calculateBill=function(c,f){let a=f.format("YYYYMM");if(ia.exists(a)===!0){console.log(`%cUse Archived version ${a} of accounting`,o);let d=ia.get(a);return d.data}return typeof c==="string"&&(c=c.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD")),za.memoized(c,f)};static _calculateBill=function(c,f){typeof c==="string"&&(c=dayjs(c)),typeof f==="string"&&(f=dayjs(f));var a=performance.now();let d=vb.default.Cfg.dbase;var b=d.get(M.tbl_name).filter(i=>dayjs(i.when).isSameOrBefore(f,"day")&&dayjs(i.when).isSameOrAfter(c,"day")),g=b.filter(i=>i.type.toLowerCase()==="soutenance")||0;let j=[0,ca,da,ea,fa,ga,ha],l=[],h=[];for(let i=1;i<=U;i+=1)h[i]=[],h[i][0]={session:null,defense:null},h[i][1]={session:null,defense:null},h[i][2]={session:null,defense:null},h[i][3]={session:null,defense:null},h[i][4]={session:null,defense:null},h[i][5]={session:null,defense:null},h[i][6]={session:null,defense:null},h[i][7]={session:null,defense:null},h[i][0].session=b.filter(k=>k.lvl==i&&k.status===L&&k.isFunded===!0)||0,h[i][1].session=b.filter(k=>k.lvl==i&&k.status===X&&k.isFunded===!0)||0,h[i][2].session=b.filter(k=>k.lvl==i&&k.status===Q&&k.isFunded===!0)||0,h[i][3].session=b.filter(k=>k.lvl==i&&(k.status===N||k.status===O)&&k.isFunded===!0)||0,h[i][4].session=b.filter(k=>k.lvl==i&&k.status===L&&k.isFunded===!1)||0,h[i][5].session=b.filter(k=>k.lvl==i&&k.status===X&&k.isFunded===!1)||0,h[i][6].session=b.filter(k=>k.lvl==i&&k.status===Q&&k.isFunded===!1)||0,h[i][7].session=b.filter(k=>k.lvl==i&&(k.status===N||k.status===O)&&k.isFunded===!1)||0,h[i][0].defense=g.filter(k=>k.lvl==i&&k.status===L&&k.isFunded===!0)||0,h[i][1].defense=g.filter(k=>k.lvl==i&&k.status===X&&k.isFunded===!0)||0,h[i][2].defense=g.filter(k=>k.lvl==i&&k.status===Q&&k.isFunded===!0)||0,h[i][3].defense=g.filter(k=>k.lvl==i&&(k.status===N||k.status===O)&&k.isFunded===!0)||0,h[i][4].defense=g.filter(k=>k.lvl==i&&k.status===L&&k.isFunded===!1)||0,h[i][5].defense=g.filter(k=>k.lvl==i&&k.status===X&&k.isFunded===!1)||0,h[i][6].defense=g.filter(k=>k.lvl==i&&k.status===Q&&k.isFunded===!1)||0,h[i][7].defense=g.filter(k=>k.lvl==i&&(k.status===N||k.status===O)&&k.isFunded===!1)||0;var e=performance.now();console.log("%cFiltering took "+(e-a)+" milliseconds.",E),l.push({total_errors:0,total_filtered:0,total:b.value().length,control:0}),l.push({type:"bad level",data:b.filter(i=>i.lvl<1||i.lvl>U).value()}),l.push({type:"bad status",data:b.filter(i=>i.status!==L&&i.status!==X&&i.status!==Q&&i.status!==N&&i.status!==O).value()}),l.push({type:"bad funded",data:b.filter(i=>i.isFunded!==!1&&i.isFunded!==!0).value()}),l[0].total_errors=l[1].data.length+l[2].data.length+l[3].data.length;var q=[],m=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),n=[];for(let i=1;i<=U;i+=1)R.isInOldMode(c)?n[i]=[j[i],0,j[i]/2,j[i]/2,j[i],0,j[i]/2,j[i]/2]:n[i]=[j[i],0,0,j[i]/2,j[i]/2,0,0,j[i]/4];var p=performance.now();console.log("%cPU calculated took "+(p-e)+" milliseconds.",E);var x=b.filter(i=>i.type.toLowerCase()!=="soutenance"&&i.status===L&&i.isFunded===!1),A=x.groupBy(i=>i.who_id),u=[];for(var v in A.value())u.push({who_id:v,who_name:A.value()[v][0].who_name,sessions:A.value()[v].length});var t=performance.now();console.log("%cBonus took "+(t-p)+" milliseconds.",E);var r=[],y=[],F=0;for(let i=1;i<=U;i+=1){let k=[];k[0]=h[i][0].session.value().length,k[1]=h[i][1].session.value().length,k[2]=h[i][2].session.value().length,k[3]=h[i][3].session.value().length,k[4]=h[i][4].session.value().length,k[5]=h[i][5].session.value().length,k[6]=h[i][6].session.value().length,k[7]=h[i][7].session.value().length,r[i]=[k[0],k[1],k[2],k[3],k[4],k[5],k[6],k[7]],F+=r[i].reduce(($,C)=>$+C);let z=[];z[0]=h[i][0].defense.value().length,z[1]=h[i][1].defense.value().length,z[2]=h[i][2].defense.value().length,z[3]=h[i][3].defense.value().length,z[4]=h[i][4].defense.value().length,z[5]=h[i][5].defense.value().length,z[6]=h[i][6].defense.value().length,z[7]=h[i][7].defense.value().length,y[i]=[z[0],z[1],z[2],z[3],z[4],z[5],z[6],z[7]]}l[0].total_filtered=F,l[0].control=l[0].total-F;var s=performance.now();console.log("%cPrecalc some vars took "+(s-t)+" milliseconds.",E),q.push({from:c,to:f,created_at:m,errors:l,bonus:u,max_level:U});for(let i=1;i<=U;i+=1){let k=h[i];q.push({sessions:{data:[k[0].session,k[1].session,k[2].session,k[3].session,k[4].session,k[5].session,k[6].session,k[7].session],number:r[i],pu:n[i]},defenses:{data:[k[0].defense,k[1].defense,k[2].defense,k[3].defense,k[4].defense,k[5].defense,k[6].defense,k[7].defense],number:y[i],pu:n[i]}})}var H=performance.now();return console.log("%cMy array full storage took "+(H-s)+" milliseconds.",E),f.isBefore(dayjs())&&ia.add(q),q};static memoized=moize.default(za._calculateBill,{maxAge:12e4,isSerialized:!0,onCacheAdd:function(c,f,a){console.log("%cAdd data to cache",o)},onCacheHit:function(){console.log("%cGet data from cache",o)}})}var pa=za;const ic=_(V());class B{static tbl_name="history_session_cache";static getSessionPage=function(c){c.get("day")<c.daysInMonth()&&(c=c.endOf("month")),console.log(`%cSearch in history session cache data for id: ${c.format("DD/MM/YYYY")}`,o);let f=ic.default.Cfg.dbase;if(!f.has(B.tbl_name).value()){throw Error(`DB ${B.db_name} NOT FOUND`);return-1}let a=f.get(B.tbl_name).find({id:+c.format("YYYYMMDD")}).value();return a===void 0?-1:a};static getNearestSessionPage=function(c){c.get("day")<c.daysInMonth()&&(c=c.endOf("month")),console.log(`%cSearch in history session cache NEAREST cached data for id: ${c.format("DD/MM/YYYY")}`,o);let f=ic.default.Cfg.dbase;if(!f.has(B.tbl_name).value()){throw Error(`DB ${B.db_name} NOT FOUND`);return-1}let a=+c.format("YYYYMMDD"),d=f.get(B.tbl_name).value().map(j=>+j.id-a);const b=j=>Math.min(...j);let g=b(d)+a;return console.log(`%cNearest data in history session cache is data with id: ${c.format("DD/MM/YYYY")}`,o),d=f.get(B.tbl_name).find({id:g}).value(),d===void 0?-1:d};static getSameOrNearestSessionPage=function(c){let f=B.getSessionPage(c);return f===-1&&(f=B.getNearestSessionPage(c)),f};static delete=function(c=null,f=null){let a=ic.default.Cfg.dbase;typeof c==="string"&&(c=c.format("YYYY-MM-DD")),typeof f==="string"&&(f=f.format("YYYY-MM-DD"));if(c===null&&f==null){a.get(B.tbl_name).remove().write(),console.log("%cWanna suppress ALL History from DB",o);return}if(f==null){a.get(B.tbl_name).remove(function(d){return dayjs(d.id,"YYYYMMDD").isBefore(f),"day"}).write();return}if(c==null){a.get(B.tbl_name).remove(function(d){return dayjs(d.id,"YYYYMMDD").isAfter(c,"day")}).write();return}a.get(B.tbl_name).remove(function(d){return dayjs(d.id,"YYYYMMDD").isBetween(c,f,"day","[]")}).write()};static addOrUpdateSessionPage=function(c=1,f=dayjs("1970-10-06")){B.getSessionPage(f)==-1?B.addSessionPage(c,f):B.updateSessionPage(c,f)};static updateSessionPage=function(c=1,f=dayjs("1970-10-06")){let a=ic.default.Cfg.dbase,d=B.getSessionPage(f);if(d==-1){throw Error("session page not found in history");return-1}a.get(B.tbl_name).find({id:+f.format("YYYYMMDD")}).assign({page:c}).write()};static addSessionPage=function(c=1,f=dayjs("1970-10-06")){let a=ic.default.Cfg.dbase;a.get(B.tbl_name).push(JSON.parse(JSON.stringify({id:+f.format("YYYYMMDD"),page:c}))).write()}}var va=B;var Aa=function(c,f){let a=[[0,1,2,3,4,5,5],[5,1,2,3,4,5,5],[4,5,1,2,3,4,4],[3,4,5,1,2,3,3],[2,3,4,5,1,2,2],[1,2,3,4,5,1,1],[0,1,2,3,4,5,0]];return Math.trunc(f.diff(c,"days")/7)*5+a[c.day()][f.day()]};const nc=_(V());class mb{static detail_bill="truc";static getListDetailBill=function(c,f){let a=nc.default.Cfg.dbase,d=a.get(M.tbl_name).filter(q=>dayjs(q.when).isSameOrBefore(f,"day")&&dayjs(q.when).isSameOrAfter(c,"day")).sortBy(function(q){return dayjs(q.when).valueOf()}).value();var b=[0,ca,da,ea,fa,ga,ha];let g=0;for(var j in d){if(d[j].lvl>b.length-1)throw Error("ERROR PRICE ARRAY MUST BE UPDATED IN LISTS.JS");var l=d[j].isFunded===!0?b[d[j].lvl]:b[d[j].lvl]*.5,h=0,e=!0;R.isInOldMode(dayjs(d[j].when))?d[j].status===L?h=l:(d[j].status===N||d[j].status===O||d[j].status===Q)&&(h=l*.5):(e=!1,d[j].status===L?h=l:(d[j].status===N||d[j].status===O)&&(h=l*.5)),g+=h,d[j].iPu=l,d[j].oldMode=e,d[j].iCumul=g,d[j].iFPu=h}return d};static getListStatistic=function(c,f){let a=c.clone(),d=a.endOf("month"),b=[],g=[],j=f.get("month")-c.get("month");for(var l=performance.now();a.isSameOrBefore(f,"day");)b.push(pa.calculateBill(a,d)),a=a.add(1,"month"),d=a.endOf("month");var h=performance.now();console.log("%cComputed data between the two dates in"+(h-l)+" milliseconds.",E);let e=0;for(a=c.clone(),d=a.endOf("month");e<=j;){let q=b[e][0].max_level;g[e]={header:{dtFrom:null,dtTo:null,created_at:null},sessions:{total:0,nb:0,pu:0,nbc:0},defenses:{total:0,nb:0,pu:0,nbc:0},coaches:{total:0,nb:0,pu:0,nbc:0},bonus:0,kpi:{jrs:0,hrs:0,hrsp:0}};let m=1;for(;m<q;){let n=[...Array(8).keys()];for(let p=0;p<n.length;p+=1)g[e].sessions.total+=b[e][m].sessions.number[p]*b[e][m].sessions.pu[p],g[e].sessions.nb+=b[e][m].sessions.number[p],g[e].defenses.total+=b[e][m].defenses.number[p]*b[e][m].defenses.pu[p],g[e].defenses.nb+=b[e][m].defenses.number[p],R.isInOldMode(a)?[1,5].includes(p)&&(g[e].sessions.nbc+=b[e][m].sessions.number[p],g[e].defenses.nbc+=b[e][m].defenses.number[p]):[1,2,5,6].includes(p)&&(g[e].sessions.nbc+=b[e][m].sessions.number[p],g[e].defenses.nbc+=b[e][m].defenses.number[p]),R.isInOldMode(a)?(g[e].kpi.hrs+=(b[e][m].sessions.number[p]-b[e][m].defenses.number[p])*(45/60),g[e].kpi.hrsp+=(b[e][m].sessions.number[p]-b[e][m].defenses.number[p])*(GM_config.get("nbHrsfM")/60)):([4,5,6,7].includes(p)&&(g[e].kpi.hrs+=(b[e][m].sessions.number[p]-b[e][m].defenses.number[p])*(30/60),g[e].kpi.hrsp+=(b[e][m].sessions.number[p]-b[e][m].defenses.number[p])*(GM_config.get("nbHrsAfM")/60)),[0,1,2,3].includes(p)&&(g[e].kpi.hrs+=(b[e][m].sessions.number[p]-b[e][m].defenses.number[p])*(45/60),g[e].kpi.hrsp+=(b[e][m].sessions.number[p]-b[e][m].defenses.number[p])*(GM_config.get("nbHrsfM")/60))),g[e].kpi.hrs+=b[e][m].defenses.number[p]*(45/60),g[e].kpi.hrsp+=b[e][m].defenses.number[p]*(GM_config.get("nbHrsD")/60);m+=1}g[e].sessions.pu=g[e].sessions.total/(g[e].sessions.nb-g[e].sessions.nbc),g[e].defenses.pu=g[e].defenses.total/(g[e].defenses.nb-g[e].defenses.nbc),g[e].coaches.total=g[e].sessions.total-g[e].defenses.total,g[e].coaches.nb=g[e].sessions.nb-g[e].defenses.nb,g[e].coaches.nbc=g[e].sessions.nbc-g[e].defenses.nbc,g[e].coaches.pu=g[e].coaches.total/(g[e].coaches.nb-g[e].coaches.nbc);for(let n=0;n<b[e][0].bonus.length;n+=1)g[e].bonus+=b[e][0].bonus[n].sessions>0?30:0;d.isAfter(f,"day")&&(d=f.clone()),g[e].kpi.jrs=Aa(a,d),g[e].header.dtFrom=a.format("YYYY-MM-DD"),g[e].header.dtTo=d.format("YYYY-MM-DD"),g[e].header.created_at=dayjs().format("YYYY-MM-DD HH:mm:ss"),a=a.add(1,"month"),d=a.endOf("month"),e+=1}return g}}var xa=mb;class nb{static addFooter=async function(c,f,a={}){const{degrees:d,PDFDocument:b,rgb:g,StandardFonts:j}=PDFLib,l=c.getPageCount(),h="8".repeat(l),e=await c.embedFont(j.TimesRoman),q=12,m=e.widthOfTextAtSize(`page ${h} / ${h}`,q),n=10,p=10,x=1,A=g(0/255,0/255,0/255),u=g(253/255,246/255,227/255),v=5,t=5,r=3,y=3,F=!0;c.getPages().forEach((s,H)=>{if(!(F===!0&&H==0)){const{width:i,height:k}=s.getSize(),z=q+2*x+r+y;s.moveTo(n+v,q+y),s.setFont(e),s.setFontSize(q),s.setFontColor(g(1,0,0)),f!==void 0&&s.drawText(`${f}`),s.drawText(`page ${H+1} / ${l}`,{x:i-m-t}),s.drawRectangle({x:n,y:10,width:i-(n+p),height:z,color:u,opacity:.6,borderColor:A,borderWidth:x})}})}}var La=nb;const Ob=_(V());class bb{static export=function(){return console.log("%cWanna export DBASE",o),JSON.stringify(Ob.default.Cfg.dbase.getState())};static import=function(c){return console.log(`%cWanna import ${c} in DBASE`,o),console.log("%c !!!!!! TYPE NOT CHECKED BE CARREFULL",o),Ob.default.Cfg.dbase.setState(JSON.parse(c)).write()}}var Ba=bb;var Ma=async function(){var c="";c+="<style>div.about_content {background-color: #fed9ff;/*width: 600px;*/height: var(--heigth, 80%);overflow-x: hidden;overflow-y: auto;text-align: left;padding: 20px;}</style>",c+='<div class="about_content" style="--heigth: 600px;">',c+='<div class="about_content__wrapper">';const f=await wa.XHR({method:"GET",url:"https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/README.md",responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"}});var a=f.responseText,d=new showdown.Converter(),b=d.makeHtml(a);c+=b,c+="</div>",c+="</div>",Swal.fire({title:`<strong>A propos de ${sa}</strong>`,icon:"info",html:c,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},na=function(){var c="table.crud-list tbody",f=document.querySelector(c),a=!1;if(f.querySelector("[type=checkbox]")===null){for(const n of f.children){var d=Z(n.children[0]),b=document.createElement("input");b.type="checkbox",b.name="name",b.value=d,b.id="id",a=M.exists(d),a===!0&&(b.checked=!0);var g=document.createElement("td");g.style="text-align: center",g.appendChild(b),n.appendChild(g)}c="table.crud-list thead tr";var j=document.querySelector(c);b=document.createElement("input"),b.type="checkbox",b.name="name",b.value="value",b.id="id",b.onclick=function(){document.querySelectorAll("tbody input[type=checkbox]").forEach(n=>n.checked=!n.checked)},b.style="visibility: hidden;";var l=document.createElement("label");l.innerText="in DB",l.style="display:block;",l.onMouseOver="this.style.cursor=pointer;",l.onMouseOut="this.style.cursor=auto;",l.appendChild(b),g=document.createElement("td"),g.style="text-align: center",g.appendChild(l),j.appendChild(g)}else{for(var h=f.querySelectorAll("[type=checkbox]"),e=h.length,q=new Array(e);e--;q[e]=h[e]);for(var m in q)a=M.exists(q[m].value),a===!0?q[m].checked=!0:q[m].checked=!1}},Na=async function(){var[c,f]=await ja(dayjs().startOf("month"),dayjs().endOf("month"));let a=xa.getListDetailBill(c,f),d="";d+="<table>",d+="<thead>",d+="<tr><th>Quand</th><th>Qui</th><th>Financé ?</th><th>Ancien Mode ?</th><th>PU HT</th><th>Statut</th><th>PU (corrigé) HT</th><th>Cumul</th></tr>",d+="<thead>",d+="<tbody>";var b=0;for(let g=0;g<a.length;g+=1)d+="<tr>",d+=`<td>${dayjs(a[g].when).format("DD/MM/YYYY à HH:mm:ss")}</td><td>${a[g].who_name}</td><td>${a[g].isFunded===!0?"Oui":"Non"}</td><td>${a[g].oldMode===!0?"Oui":"Non"}</td><td>${a[g].iPu}</td><td>${a[g].status}</td><td>${a[g].iFPu}</td><td>${a[g].iCumul}€</td>`,d+="</tr>";d+="</tbody>",d+="</table>",Swal.fire({title:`<strong>Liste détaillées des sessions du ${c.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,icon:"info",html:d,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:g=>{var j=g.querySelector("table"),l=new simpleDatatables.DataTable(j)}})},Oa=async function(){var[c,f]=await ja(dayjs().startOf("month"),dayjs().endOf("month"));let a=0,d=GM_config.get("maxfetchpg"),b=!0;var g={};let j=[],l=1,h=va.getSameOrNearestSessionPage(f);for(h!==void 0&&h.page>l&&(l=h.page);b;){if(a>d){console.warn("%cEMERGENCY EXIT LOOP",ka);break}try{g=await cb(c,f,l,j)}catch(q){throw console.error(`%c IRRECOVERABLE ERROR ... ${q}, will exit !!!! `,S),new Error()}g.length>0&&dayjs(g[g.length-1].when).isSameOrBefore(c)===!0&&(b=!1),l+=1,a+=1}for(var e in g){if(dayjs(g[e].when).isBefore(c,"day")===!0){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions
Collecte terminée`,showConfirmButton:!1,timer:1500});break}if(dayjs(g[e].when).isAfter(f,"day")===!0)continue;dayjs(g[e].when).isBetween(c,f,"day","[]")&&await M.add(g[e])}na(),ra("Collecte automatique terminée")},Pa=async function(){for(var c="table.crud-list tbody input:checked",f=document.querySelectorAll(c),a=0;a<f.length;a+=1){var d=f[a].parentElement.parentElement,b=M.parseTable(d);await M.add(b)}ra(`Collecte des sessions cochées
terminée`)},cb=async function(c,f,a=1,d=[]){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions de l'historique
du `+c.format("DD/MM/YYYY")+" au "+f.format("DD/MM/YYYY")+`
page : `+a+`
cela peut prendre du temps...`,showConfirmButton:!1,timer:3e3});let b=null;try{b=await ua(`https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history?page=${a}`,"table.crud-list tbody")}catch(q){console.error(`%c _historyFetch : ${q}`,S)}if(b===null)throw new Error(`Something went wrong could'nt collect anything from ${c.format("DD/MM/YYYY")} to ${f.format("DD/MM/YYYY")} working on history page:${a}.... try to navigate forward and backward or click some buttons to change url`);let g=Ca(b),j=Ca(b,-1);if(g.get("month")!=j.get("month")){let q=j.endOf("month");va.addOrUpdateSessionPage(a,q)}if(j.isAfter(f,"day")===!0)return console.log(`%cOptimization: oldest (last) data from page are at :${j.format("DD/MM/YYYY")}, don't analyze what was before end date of extraction ${f.format("DD/MM/YYYY")}`,o),d;for(var l=0;l<b.children.length;l+=1){var h=b.children[l],e=M.parseTable(h);d.push(e)}return d},Qa=function(){const{degrees:c,PDFDocument:f,rgb:a,StandardFonts:d}=PDFLib;async function b(){const l="https://pdf-lib.js.org/assets/with_update_sections.pdf",h=await fetch(l).then(u=>u.arrayBuffer()),e=await f.load(h),q=await e.embedFont(d.Helvetica),m=e.getPages(),n=m[0],{width:p,height:x}=n.getSize();n.drawText("This text was added with JavaScript!",{x:5,y:x/2+300,size:50,font:q,color:a(.95,.1,.1),rotate:c(-45)});const A=await e.save();download(A,"pdf-lib_modification_example.pdf","application/pdf")}async function g(){const l=await f.create(),h=await l.embedFont(d.TimesRoman),e=l.addPage(),{width:q,height:m}=e.getSize(),n=30;e.drawText("Creating PDFs in JavaScript is awesome!",{x:50,y:m-4*n,size:n,font:h,color:a(0,.53,.71)});const p=await l.save();download(p,"pdf-lib_modification_example.pdf","application/pdf")}async function j(){var[l,h]=await ja(dayjs().startOf("month"),dayjs().endOf("month"));let e=xa.getListDetailBill(l,h);const q=await f.create(),m=await q.embedFont(d.TimesRoman),n=q.addPage(),{width:p,height:x}=n.getSize(),A=30;n.drawText(`Prestations en détail

 du ${l.format("DD/MM/YYYY")} au ${h.format("DD/MM/YYYY")}`,{x:50,y:x/2-A,size:A,font:m,color:a(116/255,81/255,235/255)});let u=12,v=1.25,t=q.addPage();t.setFontSize(u),t.line_space=v,t.font=m;let r=1,y=20,F=v*u+y,s=x/2;const H=function(C){const D="LOrEm ipsum DOLor sit aMet, conSEc/tetUr 25 porttitor. ";return C*1.0925*(m.widthOfTextAtSize(D,u)/D.length)};let i=[0,H(18),H(36),H(18),H(5),H(8),H(5),H(7)],k=n.lineHeight,z=25;for(let C=1;C<e.length;C+=1){s=x-v*u*r,s<F&&(r=1,t=q.addPage(),t.font=m,t.setFontSize(u),t.line_space=v,s=x-v*u*r);if(r===1){let G=["","Quand","Qui","Quoi","PU","Statut","Puf","Montant"],K=z;t.moveTo(K,s);for(let J=1;J<G.length;J+=1)t.drawText(G[J],{x:K}),K+=i[J];r+=1,s=x-v*u*r}let D=z;t.drawText(dayjs(e[C].when).format("DD/MM/YYYY à HH:mm"),{font:m,size:u,y:s,x:D,lineHeight:k}),D+=i[1],t.drawText(e[C].who_name.trim(),{font:m,size:u,y:s,x:D,lineHeight:k}),D+=i[2],t.drawText(`${e[C].type} ${e[C].isFunded===!0?"F.":"AF"} (${e[C].lvl})`,{font:m,size:u,y:s,x:D,lineHeight:k}),D+=i[3],t.drawText(e[C].iPu.toString(),{font:m,size:u,y:s,x:D,lineHeight:k}),D+=i[4];let w=e[C].status;e[C].status==="étudiant absent"&&(w="absent"),t.drawText(w,{font:m,size:u,y:s,x:D,lineHeight:k}),D+=i[5],t.drawText(e[C].iFPu.toString(),{font:m,size:u,y:s,x:D,lineHeight:k}),D+=i[6],t.drawText(e[C].iCumul.toString(),{font:m,size:u,y:s,x:D,lineHeight:k}),r+=1}La.addFooter(q,"Généré avec Facturier version 1.01");const $=await q.save();download($,`prestations_facturees_detail_${l.format("YYYYMMDD")}-${h.format("YYYYMMDD")}.pdf`,"application/pdf")}j()},Ra=async function(){GM_addStyle('.formgrid{font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", Helvetica, Arial, sans-serif;}'),GM_addStyle(".swal2-styled[type=button]{background-color:#3085d6;border-radius:.75em;color:#fff;font-size:1.0625em;border-left-color:#3085d6;border-right-color:#3085d6;display:inline-block}.formgrid{display:grid;grid-template-columns:1fr 1em 1fr;grid-gap:.3em .6em;grid-auto-flow:dense;align-items:center}input,output,textarea,select,button{grid-column:2 / 4;width:auto;margin:0}legend{font-size:1.2em;width:100%;border-bottom:1px dotted #99c}fieldset{max-width:40em;padding:4px;margin:2em auto;border:0 none}");let c="";c+="<legend>Que voulez vous faire ?</legend>",c+="<fieldset>",c+='<div class="formgrid">',c+='Epurer<button id="answer1" data-action="raz" class="swal2-styled" type="button">RAZ</button>',c+='Exporter<button id="answer2" data-action="export" class="swal2-styled" type="button">Exporter</button>',c+='Importer<button id="answer3" data-action="import" class="swal2-styled" type="button">Importer</button>',c+="</fieldset>",c+="</div>";const{value:f}=await Swal.fire({title:"Gestion de la base de donnée",html:c,focusConfirm:!1,preConfirm:()=>[document.getElementById("answer1").value,document.getElementById("answer2").value],onOpen:a=>{a.querySelector(".formgrid").addEventListener("click",function(d){const b=function(l){l.target.matches('button[data-action="raz"]')&&(Swal.close(),fb());return},g=function(l){l.target.matches('button[data-action="export"]')&&(Swal.close(),db());return},j=function(l){l.target.matches('button[data-action="import"]')&&(Swal.close(),eb());return};b(d),g(d),j(d)}),console.log("%conOpen popup","color:coral")},onClose:a=>{a.querySelector(".formgrid").removeEventListener("click"),console.log("%conClose popup","color:coral")}});f&&Swal.fire(JSON.stringify(f))},db=async function(){let c=Ba.export();console.log(`%cWanna export : ${c}`,o);let f=dayjs(),a="";a+=`<a id="download" href="data:text/plain;charset=utf-8,${encodeURIComponent(c)}" download="export_${f.format("YYYYMMDD")}.json" style="display:none"></a>`,a+=`<a id="download" href="data:text/plain;charset=utf-8,${encodeURIComponent(c)}" download="export_${f.format("YYYYMMDD")}.json">export_${f.format("YYYYMMDD")}.json</a>`,Swal.fire({title:"Export de la base de donnée",html:a,focusConfirm:!1,onOpen:d=>{d.querySelector("#download").click()},onClose:d=>{}})},eb=async function(){console.log("%cWanna import DATABASE",o);const{value:c}=await Swal.fire({title:"Selection de la sauvegarde (json)",input:"file",inputAttributes:{accept:".json","aria-label":"Upload your database"}});if(c){const f=new FileReader();f.onload=a=>{Ba.import(a.target.result),na(),ra("Import terminé")},f.readAsText(c)}},fb=async function(){GM_addStyle(".form_addon {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}"),GM_addStyle(".form_addon input {background: #fff;border: 1px solid #9c9c9c;}"),GM_addStyle(".form_addon button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}"),GM_addStyle(".form_addon button:hover {background: gold;}"),GM_addStyle(".form_addon label {padding: 0.5em 0.5em 0.5em 0;}"),GM_addStyle(".form_addon input {padding: 0.7em;margin-bottom: 0.5rem;}"),GM_addStyle(".form_addon input:focus {outline: 3px solid gold;}"),GM_addStyle("@media (min-width: 400px) {.form_addon {grid-template-columns: 200px 1fr;grid-gap: 16px;} .form_addon label {text-align: right;grid-column: 1 / 2;} .form_addon input, .form_addon button {grid-column: 2 / 3;}}");var c="";c+='<form id="RAZ" class="form_addon" action="">',c+='<label for="students" class="cbox">Etudiants</label>',c+='<input id="students" type="checkbox" value="del_students_true" checked>',c+='<label for="sessions" class="cbox">Sessions</label>',c+='<input id="sessions" type="checkbox" value="del_sessions_true" checked>',c+='<label for="archives" class="cbox">Archives : factures</label>',c+='<input id="archives" type="checkbox" value="del_archives_true" checked>',c+='<label for="history_cache" class="cbox">Signet historique</label>',c+='<input id="history_cache" type="checkbox" value="del_history_cache_true" checked>',c+='<label for="radio1">filtrer la date</label>',c+='<input type="radio" id="radio1" name="date_filter" value="false" checked>',c+='<label for="radio2">ne pas filtrer</label>',c+='<input type="radio" id="radio2" name="date_filter" value="true">',c+='<label for="dtFrom" class="date">Date de début</label>',c+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',c+='<label for="dtTo" class="date">Date de fin</label>',c+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',c+="<!-- Switch -->",c+='<input type="checkbox" class="switch" name="s1" id="s1">',c+='<label for="s1">Switch</label>',c+="</form>";const{value:f}=await Swal.fire({title:"<strong>RAZ des données</strong>",icon:"info",html:c,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez ce que vous allez supprimer de la base de donnée",preConfirm:()=>{let h=document.getElementsByName("date_filter"),e="notfound";for(var q in h)h[q].checked===!0&&(e=h[q].value);return console.log(document.getElementById("s1")),[document.getElementById("students").checked,document.getElementById("sessions").checked,document.getElementById("archives").checked,document.getElementById("history_cache").checked,document.getElementById("dtFrom").disabled===!0?null:document.getElementById("dtFrom").value,document.getElementById("dtTo").disabled===!0?null:document.getElementById("dtTo").value,e]},onOpen:h=>{h.querySelector("#radio1").addEventListener("change",function(){console.log(document.getElementById("radio1").checked);let e=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!e,document.getElementById("dtTo").disabled=!e}),h.querySelector("#radio2").addEventListener("change",function(){let e=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!e,document.getElementById("dtTo").disabled=!e}),h.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:h=>{h.querySelector("#radio1").removeEventListener("change"),h.querySelector("#radio2").removeEventListener("change"),h.querySelector("#dtFrom").removeEventListener("change")}});let a=f[0],d=f[1],b=f[2],g=f[3];console.log(`wanna raz students ? ${a}, wanna raz sessions ? ${d}, wanna raz archives ? ${b}`);let j=f[4]?dayjs(f[4]):null,l=f[5]?dayjs(f[5]):null;a===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des étudiants",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),T.delete(j,l)),d===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des sessions",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),M.delete(j,l),na()),b===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des archives (financières)",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),ia.delete(j,l)),g===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base du cache des historique de session",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),va.delete(j,l))},Sa=async function(){var c="";c+="<style>",c+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",c+="form input {background: #fff;border: 1px solid #9c9c9c;}",c+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",c+="form button:hover {background: gold;}",c+="form label {padding: 0.5em 0.5em 0.5em 0;}",c+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",c+="form input:focus {outline: 3px solid gold;}",c+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",c+="</style>",c+='<form class="form1" action="">',c+='<label for="dd" class="date">Date de début</label>',c+='<input id="dd" type="date" max="2030-12-31" min="2010-12-31">',c+='<label for="df" class="date">Date de fin</label>',c+='<input id="df" type="date" max="2030-12-31" min="2010-12-31">',c+="</form>";var[f,a]=await ja(dayjs().startOf("month"),dayjs().endOf("month")),d=pa.calculateBill(f,a);R.isInOldMode(f)?gb(f,a,d):hb(f,a,d)},gb=function(c,f,a){var d="",b=null,g=0,j=0,l=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],h=a[0].max_level;d+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",d+='<div class="wrapper">',d+="<table>",d+="<caption>Sessions de mentorat</caption>",d+="<thead>",d+="<tr>",d+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',d+="</tr>",d+="</thead>",d+="<tbody>";for(var e in l){d+="<tr>",d+="<td>"+l[e][1]+"</td>",b=a[l[e][0]].sessions;let r=b.number[0],y=b.number[4],F=r*b.pu[0],s=y*b.pu[4];g+=r+y,j+=F+s,d+=`<td>${r+y}</td><td>${(b.pu[0]+b.pu[4])/2}</td><td>${F+s}€</td>`,d+="</tr>"}d+="</tbody>",d+="<tfoot>",d+="<tr>",d+="<td>Total</td>",d+=`<td>${g}</td><td></td><td>${j}€</td>`,d+="</tr>",d+="<tr>",d+="</tr>",d+="</tfoot>",d+="</table>";var q=g,m=j;g=0,j=0,d+="<table>",d+="<caption>Sessions de mentorat (NoShow)</caption>",d+="<thead>",d+="<tr>",d+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',d+="</tr>",d+="</thead>",d+="<tbody>";for(e in l){d+="<tr>",d+="<td>"+l[e][1]+"</td>",b=a[l[e][0]].sessions;let r=b.number[2]+b.number[3],y=b.number[6]+b.number[7],F=r*(b.pu[2]+b.pu[3])/2,s=y*(b.pu[6]+b.pu[7])/2;g+=r+y,j+=F+s,d+=`<td>${r+y}</td><td>${(b.pu[2]+b.pu[3]+b.pu[6]+b.pu[7])/4}</td><td>${F+s}€</td>`,d+="</tr>"}d+="</tbody>",d+="<tfoot>",d+="<tr>",d+="<td>Total</td>",d+=`<td>${g}</td><td></td><td>${j}€</td>`,d+="</tr>",d+="<tr>",d+="</tr>",d+="</tfoot>",d+="</table>",q+=g,m+=j;for(var n=0,p=0,x=0,A=0,u=0,v=1;v<=h;){n+=a[v].sessions.number[1],n+=a[v].sessions.number[5];for(let r in[...Array(8).keys()]){let y=a[v].sessions.number[r];p+=y,x+=y*a[v].sessions.pu[r],y=a[v].defenses.number[r],A+=y,u+=y*a[v].defenses.pu[r]}v+=1}let t=a[0].errors[0].total_errors;p+=t,d+=`<p>Ces ${p} session(s) se répartissent en ${q-g} session(s) de mentorat (${m-j}€)`,d+=`, ${g} NoShows (${j}€)`,t==0?d+=`et ${n} session(s) annulée(s) (${0}€) </p>`:d+=`, ${n} session(s) annulée(s) (${0}€) ainsi que ${t} session(s) en anomalie (cf 1.)`,d+=`<br >Sur le total de ${p} session(s) (${x}€) `,d+=`vous avez réalisé ${A} soutenance(s) (${u}€)</p>`;if(t>0){let r=a[0].errors[0];d+=`(1) Attention, il y a ${t} session(s) qui présente(nt) une anomalie c'est peut être normal : exemple un étudiant qui n'a plus de parcours associé au moment de la collecte de session`,d+=", pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${r.total_errors} erreurs relevées , notez qu'il y a ${r.total_filtered} ennregistrements filtrés(lvl,...)  sur ${r.total} enregistrements dans la période, le total des erreurs devrait donc être de ${r.control} erreurs`),console.warn("détail"),console.warn(`${a[0].errors[1].data.length} erreurs de type ${a[0].errors[1].type} data are`,a[0].errors[1].data),console.warn(`${a[0].errors[2].data.length} erreurs de type ${a[0].errors[2].type} data are`,a[0].errors[2].data),console.warn(`${a[0].errors[3].data.length} erreurs de type ${a[0].errors[3].type} data are`,a[0].errors[3].data)}d+=`<p>Soit un total général à facturer de ${x}€`,Swal.fire({title:`<strong>Liste des formations tarifées du ${c.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,html:d,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},hb=function(c,f,a){console.log("enter computation bill");var d=performance.now(),b="",g=null,j=0,l=0,h=0,e=0,q=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],m=a[0].max_level;b+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",b+='<div class="wrapper">',b+="<table>",b+="<caption>Sessions de mentorat (dont soutenances)</caption>",b+="<thead>",b+="<tr>",b+='<th rowspan="2">Type</th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th>',b+="</tr>",b+="<tr>",b+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>";for(var n=1;n<=m;){b+="<tr>",b+=`<td> Niveau ${n}</td>`;let w=a[n].sessions,G=a[n].defenses,K=w.number[0],J=w.number[4],aa=K*w.pu[0],ba=J*w.pu[4];j+=K,l+=J,h+=aa,e+=ba,b+=`<td>${K} (${G.number[0]})</td><td>${w.pu[0]}</td><td>${aa}€</td>`,b+=`<td>${J} (${G.number[4]})</td><td>${w.pu[4]}</td><td>${ba}€</td>`,b+=`<td>${K+J} (${G.number[0]+G.number[4]})</td><td>${aa+ba}€</td>`,b+="</tr>",n+=1}var p=performance.now();console.log("%cCalculate first array"+(p-d)+" milliseconds.",E),b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${j}</td><td></td><td>${h}€</td>`,b+=`<td>${l}</td><td></td><td>${e}€</td>`,b+=`<td>${j+l}</td><td>${h+e}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>";var x=j+l,A=h+e;for(j=0,l=0,h=0,e=0,b+="<table>",b+="<caption>Sessions de mentorat :NoShow (dont soutenances)</caption>",b+="<thead>",b+="<tr>",b+='<th rowspan="2"></th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th><th colspan="2" scope="colgroup">Ensemble</th>',b+="</tr>",b+="<tr>",b+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>",n=1;n<=m;){b+="<tr>",b+=`<td> Niveau ${n}</td>`;let w=a[n].sessions,G=a[n].defenses,K=w.number[3],J=w.number[7],aa=K*w.pu[3],ba=J*w.pu[7];j+=K,l+=J,h+=aa,e+=ba,b+=`<td>${K} (${G.number[3]})</td><td>${w.pu[3]}</td><td>${aa}€</td>`,b+=`<td>${J} (${G.number[7]})</td><td>${w.pu[7]}</td><td>${ba}€</td>`,b+=`<td>${K+J}</td><td>${aa+ba}€</td>`,b+="</tr>",n+=1}b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${j}</td><td></td><td>${h}€</td>`,b+=`<td>${l}</td><td></td><td>${e}€</td>`,b+=`<td>${j+l}</td><td>${h+e}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>";var u=performance.now();console.log("%cCalculate second html table took "+(u-p)+" milliseconds.",E),x+=j+l,A+=h+e;var v=0,t=0,r=0,y=0,F=0;for(n=1;n<=m;){v+=a[n].sessions.number[1],v+=a[n].sessions.number[2],v+=a[n].sessions.number[5],v+=a[n].sessions.number[6];for(let w in[...Array(8).keys()]){let G=a[n].sessions.number[w];t+=G,r+=G*a[n].sessions.pu[w],G=a[n].defenses.number[w],y+=G,F+=G*a[n].defenses.pu[w]}n+=1}let s=a[0].errors[0].total_errors;t+=s,b+=`<p>Ces ${t} session(s) se répartissent en ${x-j-l} session(s) de mentorat (${A-h-e}€)`,b+=`, ${j+l} NoShows (${h+e}€)`,s==0?b+=`et ${v} session(s) annulée(s) (${0}€)`:b+=`, ${v} session(s) annulée(s) (${0}€) ainsi que ${s} session(s) en anomalie (cf 1.)`,b+=`<br>Sur le total de ${t} session(s) (${r}€) `,b+=`vous avez réalisé ${y} soutenance(s) (${F}€)</p>`;if(s>0){let w=a[0].errors[0];b+=`(1) Attention, il y a ${s} session(s) qui présente(nt) une anomalie c'est peut être normal : exemple un étudiant qui n'a plus de parcours associé au moment de la collecte de session`,b+=", pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${w.total_errors} erreurs relevées , notez qu'il y a ${w.total_filtered} ennregistrements filtrés(lvl,...)  sur ${w.total} enregistrements dans la période, le total des erreurs devrait donc être de ${w.control} erreurs`),console.warn("détail"),console.warn(`${a[0].errors[1].data.length} erreurs de type ${a[0].errors[1].type} data are`,a[0].errors[1].data),console.warn(`${a[0].errors[2].data.length} erreurs de type ${a[0].errors[2].type} data are`,a[0].errors[2].data),console.warn(`${a[0].errors[3].data.length} erreurs de type ${a[0].errors[3].type} data are`,a[0].errors[3].data)}var H=performance.now();console.log("%cCalculate bottom remark + errors took "+(H-u)+" milliseconds.",E);var i=0;let k="",z="";for(var $ in a[0].bonus)a[0].bonus[$].sessions>=1?(i+=30,k+=a[0].bonus[$].who_name+","):z+=a[0].bonus[$].who_name+",";b+=`<p>Calcul du forfait "autofinancé". Vous sont affectés ${a[0].bonus.length} étudiants financés, parmi ceux ci, ${i/30} étudiant(s) avaient au moins une session programmée (${k.slice(0,-1)})`,i/30!==a[0].bonus.length&&(b+=`, (${a[0].bonus.length-i/30}) étudiant(s) (${z.slice(0,-1)}) n'ont pas eu de sessions`),b+=`, le forfait est donc de ${i}€</p>`,b+=`<p>Soit un total général à facturer de ${r+i}€`;var C=performance.now();console.log("%cCalculate AF took "+(C-H)+" milliseconds.",E);var D=performance.now();console.log("%cCalculate html table took "+(C-d)+" milliseconds.",E),Swal.fire({title:`<strong>Liste des formations tarifées du ${c.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,html:b,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},Ta=async function(){var[c,f]=await ja(dayjs().startOf("month"),dayjs().endOf("month"),!1);if(c===null||f===null)throw console.log("%cError need date from, date to",S),new Error();const a=xa.getListStatistic(c,f);let d="",b=new Array(22),g=Array.apply(null,Array(22)).map(Number.prototype.valueOf,0),j=c.clone(),l=j.endOf("month"),h="";b[0]="<thead><tr><th>Sessions</th>",b[1]="<tbody><tr><td>Sessions</td>",b[2]='<tr class="header"><td>Montant</td>',b[3]="<tr><td>Nb.",b[4]="<tr><td>Pu",b[5]='<tr class="header"><td>Mentorat</td>',b[6]="<tr><td>Montant</td>",b[7]="<tr><td>Nb.",b[8]="<tr><td>Pu",b[9]='<tr class="header"><td>Soutenances</td>',b[10]="<tr><td>Montant</td>",b[11]="<tr><td>Nb.",b[12]="<tr><td>Pu",b[13]='<tr class="header"><td>Bonus</td>',b[14]="<tr><td>Bonus AF</td>",b[15]='<tr class="header"><td>KPI</td>',b[16]="<tr><td>NbJrs</td>",b[17]="<tr><td>TJM</td>",b[18]="<tr><td>Nb hrs</td>",b[19]="<tr><td>THM</td>",b[20]="<tr><td>Nb hrs (p.)</td>",b[21]="<tr><td>THM (p)</td>";for(var e=0;e<a.length;e+=1)g[2]+=a[e].sessions.total,g[3]+=a[e].sessions.nb-a[e].sessions.nbc,g[4]+=a[e].sessions.pu,g[6]+=a[e].coaches.total,g[7]+=a[e].coaches.nb-a[e].coaches.nbc,g[8]+=a[e].coaches.pu,g[10]+=a[e].defenses.total,g[11]+=a[e].defenses.nb-a[e].defenses.nbc,g[12]+=a[e].defenses.pu,g[14]+=a[e].bonus,g[16]+=a[e].kpi.jrs,g[18]+=a[e].kpi.hrs,g[20]+=a[e].kpi.hrsp,a.length==1&&(h="</tr>"),e===a.length-1&&a.length>1?l.isAfter(f,"day")?(g[2]-=a[e].sessions.total,g[3]-=a[e].sessions.nb-a[e].sessions.nbc,g[4]-=a[e].sessions.pu,g[6]-=a[e].coaches.total,g[7]-=a[e].coaches.nb-a[e].coaches.nbc,g[8]-=a[e].coaches.pu,g[10]-=a[e].defenses.total,g[11]-=a[e].defenses.nb-a[e].defenses.nbc,g[12]-=a[e].defenses.pu,g[14]-=a[e].bonus,g[16]-=a[e].kpi.jrs,g[18]-=a[e].kpi.hrs,g[20]-=a[e].kpi.hrsp,b[0]+=`<td>Total(moy)</td><td>${dayjs(a[e].header.dtTo).format("MMMM")}</td></thead></tr>`,b[1]+="<td>&nbsp;</td><td>&nbsp;</td></tr>",b[2]+=`<td>${g[2]} (${(g[2]/(a.length-1)).toFixed(2)})</td><td>${a[e].sessions.total}</td></tr>`,b[3]+=`<td>${g[3]} (${(g[3]/(a.length-1)).toFixed(2)})</td><td>${a[e].sessions.nb} (${a[e].sessions.nbc})</td></tr>`,b[4]+=`<td> n/a (${(g[4]/(a.length-1)).toFixed(2)})</td><td>${a[e].sessions.pu.toFixed(2)}</td></tr>`,b[5]+="<td>&nbsp;</td><td>&nbsp;</td></tr>",b[6]+=`<td>${g[6]} (${(g[6]/(a.length-1)).toFixed(2)})</td><td>${a[e].coaches.total}</td></tr>`,b[7]+=`<td>${g[7]} (${(g[7]/(a.length-1)).toFixed(2)})</td><td>${a[e].coaches.nb} (${a[e].coaches.nbc})</td></tr>`,b[8]+=`<td> n/a (${(g[8]/(a.length-1)).toFixed(2)})</td><td>${a[e].coaches.pu.toFixed(2)}</td></tr>`,b[9]+=`<td>&nbsp;</td>${h}`,b[10]+=`<td>${g[10]} (${(g[10]/(a.length-1)).toFixed(2)})</td><td>${a[e].defenses.total}</td></tr>`,b[11]+=`<td>${g[11]} (${(g[11]/(a.length-1)).toFixed(2)})</td><td>${a[e].defenses.nb} (${a[e].defenses.nbc})</td></tr>`,b[12]+=`<td> n/a (${(g[12]/(a.length-1)).toFixed(2)})</td><td>${a[e].defenses.pu.toFixed(2)}</td></tr>`,b[13]+="<td>&nbsp;</td></tr>",b[14]+=`<td>${g[14]} (${(g[14]/(a.length-1)).toFixed(2)})</td><td>${a[e].bonus}</td></tr>`,b[15]+="<td>&nbsp;</td></tr>",b[16]+=`<td>${g[16]} (${(g[16]/(a.length-1)).toFixed(2)})</td><td>${a[e].kpi.jrs}</td></tr>`,b[17]+=`<td> n/a (${(g[2]/g[16]).toFixed(2)})</td><td>${(a[e].sessions.total/a[e].kpi.jrs).toFixed(2)}</td></tr>`,b[18]+=`<td>${g[18]} (${(g[18]/(a.length-1)).toFixed(2)})</td><td>${a[e].kpi.hrs}</td></tr>`,b[19]+=`<td> n/a  (${(g[2]/g[18]).toFixed(2)})</td><td>${(a[e].sessions.total/a[e].kpi.hrs).toFixed(2)}</td></tr>`,b[20]+=`<td>${g[20]} (${(g[20]/(a.length-1)).toFixed(2)})</td><td>${a[e].kpi.hrsp}</td></tr>`,b[21]+=`<td> n/a  (${(g[2]/g[20]).toFixed(2)})</td><td>${(a[e].sessions.total/a[e].kpi.hrsp).toFixed(2)}</td></tr>`):(b[0]+=`<td>${dayjs(a[e].header.dtTo).format("MMMM")}</td><td>Tot.</td></thead></tr>`,b[1]+="<td>&nbsp;</td><td>&nbsp;</td></tr>",b[2]+=`<td>${a[e].sessions.total}</td><td>${g[2]} (${(g[2]/a.length).toFixed(2)})</td></tr>`,b[3]+=`<td>${a[e].sessions.nb} (${a[e].sessions.nbc})</td><td>${g[3]} (${(g[3]/a.length).toFixed(2)})</td></tr>`,b[4]+=`<td>${a[e].sessions.pu.toFixed(2)}</td><td> n/a (${(g[4]/a.length).toFixed(2)})</td></tr>`,b[5]+="<td>&nbsp;</td><td>&nbsp;</td></tr>",b[6]+=`<td>${a[e].coaches.total}</td><td>${g[6]} (${(g[6]/a.length).toFixed(2)})</td></tr>`,b[7]+=`<td>${a[e].coaches.nb} (${a[e].coaches.nbc})</td><td>${g[7]} (${(g[7]/a.length).toFixed(2)})</td></tr>`,b[8]+=`<td>${a[e].coaches.pu.toFixed(2)}</td><td> n/a (${(g[8]/a.length).toFixed(2)})</td></tr>`,b[9]+=`<td>&nbsp;</td>${h}`,b[10]+=`<td>${a[e].defenses.total}</td><td>${g[10]} (${(g[10]/a.length).toFixed(2)})</td></tr>`,b[11]+=`<td>${a[e].defenses.nb} (${a[e].defenses.nbc})</td><td>${g[11]} (${(g[11]/a.length).toFixed(2)})</td></tr>`,b[12]+=`<td>${a[e].defenses.pu.toFixed(2)}</td><td> n/a (${(g[12]/a.length).toFixed(2)})</td></tr>`,b[13]+="<td>&nbsp;</td></tr>",b[14]+=`<td>${a[e].bonus}</td><td>${g[14]} (${(g[14]/a.length).toFixed(2)})</td></tr>`,b[15]+="<td>&nbsp;</td></tr>",b[16]+=`<td>${a[e].kpi.jrs}</td><td>${g[16]} (${(g[16]/a.length).toFixed(2)})</td></tr>`,b[17]+=`<td>${(a[e].sessions.total/a[e].kpi.jrs).toFixed(2)}</td><td> n/a (${(g[2]/g[16]).toFixed(2)})</td></tr>`,b[18]+=`<td>${a[e].kpi.hrs}</td><td>${g[18]} (${(g[18]/a.length).toFixed(2)})</td></tr>`,b[19]+=`<td>${(a[e].sessions.total/a[e].kpi.hrs).toFixed(2)}</td><td> n/a  (${(g[2]/g[18]).toFixed(2)})</td></tr>`,b[20]+=`<td>${a[e].kpi.hrsp}</td><td>${g[20]} (${(g[20]/a.length).toFixed(2)})</td></tr>`,b[21]+=`<td>${(a[e].sessions.total/a[e].kpi.hrsp).toFixed(2)}</td><td> n/a  (${(g[2]/g[20]).toFixed(2)})</td></tr>`):(b[0]+=`<td>${dayjs(a[e].header.dtTo).format("MMMM")}</td>${h}`,b[1]+=`<td>&nbsp;</td>${h}`,b[2]+=`<td>${a[e].sessions.total}</td>${h}`,b[3]+=`<td>${a[e].sessions.nb} (${a[e].sessions.nbc})</td>${h}`,b[4]+=`<td>${a[e].sessions.pu.toFixed(2)}</td>${h}`,b[5]+=`<td>&nbsp;</td>${h}`,b[6]+=`<td>${a[e].coaches.total}</td>${h}`,b[7]+=`<td>${a[e].coaches.nb} (${a[e].sessions.nbc})</td>${h}`,b[8]+=`<td>${a[e].coaches.pu.toFixed(2)}</td>${h}`,b[9]+=`<td>&nbsp;</td>${h}`,b[10]+=`<td>${a[e].defenses.total}</td>${h}`,b[11]+=`<td>${a[e].defenses.nb} (${a[e].defenses.nbc})</td>${h}`,b[12]+=`<td>${a[e].defenses.pu.toFixed(2)}</td>${h}`,b[13]+=`<td>&nbsp;</td>${h}`,b[14]+=`<td>${a[e].bonus}</td>${h}`,b[15]+=`<td>&nbsp;</td>${h}`,b[16]+=`<td>${a[e].kpi.jrs}</td>${h}`,b[17]+=`<td>${(a[e].sessions.total/a[e].kpi.jrs).toFixed(2)}</td>${h}`,b[18]+=`<td>${a[e].kpi.hrs}</td>${h}`,b[19]+=`<td>${(a[e].sessions.total/a[e].kpi.hrs).toFixed(2)}</td>${h}`,b[20]+=`<td>${a[e].kpi.hrsp}</td>${h}`,b[21]+=`<td>${(a[e].sessions.total/a[e].kpi.hrsp).toFixed(2)}</td>${h}`),j=j.add(1,"month"),l=j.endOf("month");d="<table>"+b.join(" ")+`</tbody><tfoot><tr><td colspan=${a.length+1}>la valeur entre parenthèse fait reference aux annulés</td></tr></tfoot></table>`,Swal.fire({title:`<strong>Statistiques du ${c.format("DD/MM/YYYY")} au ${f.format("DD/MM/YYYY")}</strong>`,icon:"info",html:d,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:q=>{}})};class P{static init=function(){console.log("%cin initUI",o),P.build();var c=new Draggabilly(".draggable",{handle:".handle"});GM_config.get("hackheaderzindex")===!0&&ob.start("animation-target")};static build=function(){console.log("%c in buildUI","background-color:green;color:white"),GM_addStyle(".flex > * { margin: 2px 1px; }"),GM_addStyle(".flex > :first-child { margin-left: 0; }"),GM_addStyle(".flex > :last-child { margin-right: 0; }"),GM_addStyle(".panel {display: flex; justify-content: center;z-index:999}"),GM_addStyle(".menuBar {border-top: 1px solid; padding: 10px; font-size: 1rem; pointer-events: inherit;position: relative;top:0px;  flex-flow: row wrap;/*align-content: space-between;justify-content: space-between;*/}"),GM_addStyle(".draggable {background: transparent;border-radius: 10px;padding: 20px;}"),GM_addStyle(".draggable.is-pointer-down {background: #09F;}"),GM_addStyle(".draggable.is-dragging { opacity: 0.7; }"),GM_addStyle(".handle {background: #555;background: hsla(0, 0%, 0%, 0.4);width: 20px;height: 20px; border-radius: 10px;}"),GM_addStyle(".flex > :nth-last-child(2) {page-break-after: always; /* CSS 2.1 syntax */break-after: always; /* New syntax */}"),GM_addStyle("#animation-target {width: 10px;height: 5px;background-color:coral;border-radius: 25%;}");var c=document.createElement("div"),f=document.createElement("div");f.classList.add("handle"),c.appendChild(f),c.classList.add("panel","menuBar","flex","draggable"),document.body.appendFirst(c),P.addButton("collectChecked",Pa,{},c),P.addButton("CollectAuto",Oa,{},c),P.addButton("showBill",Sa,{},c),P.addButton("billInDetails",Na,{},c),P.addButton("PDF",Qa,{},c),P.addButton("SList",T.showList,{},c),P.addButton("statistics",Ta,{},c),P.addButton("Database",Ra,{},c),P.addButton("about",Ma,{},c);if(GM_config.get("hackheaderzindex")===!0){var a=document.createElement("div");a.id="animation-target",c.appendChild(a)}};static addButton=function(c,f,a,d){d=d||document.body,a=a||{position:"absolute",bottom:"7%",left:"4%","z-index":3};let b=document.createElement("button"),g=b.style;return b.classList.add("button--primary","button"),d.appendChild(b),b.innerHTML=c,b.onclick=f,Object.keys(a).forEach(j=>g[j]=a[j]),b}}class ob{static start=function(c){const f=document.getElementById(c),a=l=>f.style.transform=`translateX(${l}px)`;let d=0;const b=7,g=l=>{a(d),d+=b,d>100?requestAnimationFrame(j):requestAnimationFrame(g)},j=l=>{a(d),d-=b,d<-100?requestAnimationFrame(g):requestAnimationFrame(j)};return requestAnimationFrame(g)};static stop=function(c){window.cancelAnimationFrame(c)}}var Wa=P;const jb="#OCAddonsCfg {background-color: lightblue;} #OCAddonsCfg .reset_holder {float: left; position: relative; bottom: -1em;} #OCAddonsCfg .saveclose_buttons {margin: .7em;}",kb="height: 16.7em; width: 30em; border: 1px solid; border-radius: 3px; position: fixed; z-index: 999;",Ua={id:"OCAddonsCfg",title:"Configuration du module",fields:{nbHrsAfM:{section:["Statistiques","paramètres"],label:"Nombre de minutes pour une session AF",labelPos:"left",type:"input",default:30},nbHrsfM:{label:"Nombre de minutes pour une session financée",labelPos:"left",type:"input",default:45},nbHrsD:{label:"Nombre de minutes pour une session de soutenance",labelPos:"left",type:"input",default:45},maxfetchpg:{section:["Application","optimisation"],label:"Maximum de page recherchées dans l'historique",labelPos:"left",type:"input",default:1e3},datacachelifetime:{label:"Temps de conservation des données dans le cache (en ms)",labelPos:"left",type:"input",default:12e4},checksessionalreadyexists:{section:["Application","Base de donnée"],label:"sessions: vérifier existence avant insertion",labelPos:"left",type:"checkbox",default:!0},sizeofcontentlist:{section:["Interface","thème"],label:"taille de la police des listes",labelPos:"left",type:"input",default:"1em;"},use_custom_css:{label:"utiliser des styles personnalisés",labelPos:"left",type:"checkbox",default:!1},custom_css_url:{label:"url de la feuille de style (si plusieurs les séparer par des virgules)",labelPos:"left",type:"input",default:""},custom_css_data:{label:"saisir ici le code css à injecter directement dans la page",title:"Je me demande bien à quoi sert le titre",labelPos:"left",type:"input",default:""},alwaysaddcbox:{section:["Interface","Gadget"],label:"Toujours ajouter les checkbox sur l'interface",labelPos:"left",type:"checkbox",default:!0},show_throttle:{label:"Afficher le temoin d'utilisation du CPU",title:"Affiche le point rouge qui circule dans la barre de menu. Quand il s'arrête le CPU est utilisé",labelPos:"left",type:"checkbox",default:!0},hackheaderzindex:{section:["","Hack"],label:"Changer le zindex du bandeau haut",title:"le bandeau haut à un z-index  (1000) qui le place au dessus de tout ce qui est présent à l'écran, ce qui gêne la barre de menu ; activer cette option réduit ce chiffre à 0",labelPos:"left",type:"checkbox",default:!0},support:{section:["","Support"],label:"StephaneTy-Pro.github.io",title:"more info on https://github.com/StephaneTy-Pro",type:"button",click:()=>{GM_openInTab("https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon",{active:!0,insert:!0,setParent:!0})}}},css:jb,events:{save:function(){GM_config.close()}}};var Va=function(){GM_config.open(),OCAddonsCfg.style=kb};class ib{static longTaskTiming=function(){if(window.self!==window.top)return;console.log("LongTasks: Initializing");var c=new window.PerformanceObserver(function(f){for(var a=f.getEntries(),d=0;d<a.length;d++)console.log("LongTasks: ",a[d].name,a[d].duration,a[d].attribution.length,a[d].attribution.length>0?a[d].attribution[0].containerType:null,a[d].attribution.length>0?a[d].attribution[0].containerName:null,a[d].attribution.length>0?a[d].attribution[0].containerSrc:null,a[d].attribution.length>0?a[d].attribution[0].containerId:null,a[d])});typeof window.PerformanceLongTaskTiming!=="undefined"?console.log("LongTasks: Appears to be supported"):console.log("LongTasks: Not supported");try{c.observe({entryTypes:["longtask"]})}catch(f){console.log("LongTasks: Not supported")}};static paintTiming=function(){if(window.self!==window.top)return;console.log("PaintTiming: Initializing");var c=new window.PerformanceObserver(function(f){for(var a=f.getEntries(),d=0;d<a.length;d++)console.log("PaintTiming: ",a[d].name,a[d].startTime)});if(typeof window.PerformancePaintTiming!=="undefined")console.log("PaintTiming: Appears to be supported");else{console.log("PaintTiming: Not supported");return}try{c.observe({entryTypes:["paint"],buffered:!0})}catch(f){console.log("PaintTiming: Not supported")}}}var Da=ib;V();})();
//# sourceMappingURL=app-facturier.min.js.map
