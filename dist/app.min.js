// ==UserScript==
// @name         Facturier (alpha)
// @namespace    http://tampermonkey.net/
// @version      1.00.0002
// @description  Un addon pour vous aidez dans votre facturation
// @author       Stéphane TORCHY
// @updateURL    https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/dist/app.min.js
// @downloadURL  https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/dist/app.min.js
// @match        https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history*
// @grant        unsafeWindow
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @grant        GM_registerMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        GM.xmlHttpRequest

// @require      https://cdn.jsdelivr.net/npm/lodash@4.17.19/lodash.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/low.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/LocalStorage.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/dayjs.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/locale/fr.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isBetween.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrBefore.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrAfter.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/customParseFormat.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/localeData.min.js


// GM_Config
// @require      https://openuserjs.org/src/libs/sizzle/GM_config.js

// sweetalert 2
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.all.min.js

// draggabilly
// @require      https://cdnjs.cloudflare.com/ajax/libs/draggabilly/2.2.0/draggabilly.pkgd.min.js

// toastify
// @require     https://cdn.jsdelivr.net/npm/toastify-js@1.8.0/src/toastify.min.js
// @resource    toastifycss https://raw.githubusercontent.com/apvarun/toastify-js/master/src/toastify.css

//
// @require     https://raw.githubusercontent.com/uzairfarooq/arrive/master/minified/arrive.min.js

// simple-datatables
// @require     https://cdn.jsdelivr.net/npm/simple-datatables@latest
// @resource    simpledatatablecss https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css

// require https://raw.githubusercontent.com/anywhichway/nano-memoize/master/dist/nano-memoize.min.js
// @require https://cdn.jsdelivr.net/npm/moize@5.4.7/dist/moize.min.js

// require https://raw.githubusercontent.com/StephaneTy-Pro/userscripts/master/fetch-inject.umd.min.js
// @require https://cdn.jsdelivr.net/npm/fetch-inject

// PARSER MKDOWN
// @require 	 https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js

// PDF https://pdf-lib.js.org/docs/api/
// @require      https://unpkg.com/pdf-lib@1.9.0/dist/pdf-lib.min.js
// @require      https://unpkg.com/downloadjs@1.4.7/download.js


/*
 * History
 * cf https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon/blob/master/CHANGELOG.md
 */



// ==/UserScript==

(function() {

    'use strict';
let va=Object.defineProperty,Xa=Object.prototype.hasOwnProperty,mb=(a,e)=>()=>(e||(e={exports:{}},a(e.exports,e)),e.exports),Ya=a=>va(a,"__esModule",{value:!0}),nb=(a,e)=>{Ya(a);for(let c in e)va(a,c,{get:e[c],enumerable:!0})},ob=(a,e)=>{Ya(a);if(typeof e==="object"||typeof e==="function")for(let c in e)Xa.call(e,c)&&!Xa.call(a,c)&&c!=="default"&&va(a,c,{get:()=>e[c],enumerable:!0});return a},_=a=>a&&a.__esModule?a:ob(va({},"default",{value:a,enumerable:!0}),a);var V=mb(i=>{nb(i,{APP_AUTHOR:()=>Ea,APP_DEBUG_STYLE:()=>s,APP_ERROR_STYLE:()=>Ha,APP_INFO_STYLE:()=>Ga,APP_LOG_STYLE:()=>Fa,APP_NAME:()=>pa,APP_PERF_STYLE:()=>E,APP_WARN_STYLE:()=>ja,OC_AUTOFUNDED:()=>la,OC_FUNDED:()=>qa,OC_MAX_LEVEL:()=>U,OC_PRICE1:()=>ba,OC_PRICE2:()=>ca,OC_PRICE3:()=>da,OC_PRICE4:()=>ea,OC_PRICE5:()=>fa,OC_PRICE6:()=>ga,OC_STATUS_0:()=>M,OC_STATUS_1:()=>X,OC_STATUS_2:()=>S,OC_STATUS_3_F:()=>P,OC_STATUS_3_M:()=>O,default:()=>h});const k={Cfg:{dbase:null},start:async function(){await Wa();const d=k.checkSupport();console.log(`%cAre all functions supported ? : ${d}`,s),document.arrive(".MuiAvatar-img",k._warmup)},checkSupport:function(){return!0},_warmup:function(){console.log("%cinSetup",s),GM===void 0?(console.log("%cI am not in a tamper env"),k._userscriptless()):console.log(`%cTamper environment detected the version is ${GM.info.version}`,s),GM_addStyle(GM_getResourceText("jspanelcss")),GM_addStyle(GM_getResourceText("toastifycss")),GM_addStyle(GM_getResourceText("simpledatatablecss")),GM_config.init(Ta),GM_registerMenuCommand("OC Facturier - configure",Ua),GM_config.get("hackheaderzindex")===!0&&(document.getElementById("header").style.zIndex=0),GM_addStyle(".swal2-content{font-size:"+GM_config.get("sizeofcontentlist")+"}"),GM_addStyle(".swal2-title{font-size:1.275em)"),k._main()},_userscriptless(){},_main:function(){console.log("​​​%cMainLoaded​​​",s);let d=new LocalStorage("db");var n=low(d);n.defaults({students:[],sessions:[],f_archives:[],history_session_cache:[]}).write(),k.Cfg.dbase=n,dayjs.extend(dayjs_plugin_isSameOrAfter),dayjs.extend(dayjs_plugin_isSameOrBefore),dayjs.extend(dayjs_plugin_isBetween),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_customParseFormat),document.querySelector(".panel.menuBar.flex.draggable")===null&&Va.init(),GM_config.get("alwaysaddcbox")===!0&&ma(),dayjs.locale("fr");if(GM_config.get("use_custom_css")===!0){let o=GM_config.get("custom_css_url"),B=o.split(",");if(B.length!==0)fetchInject([B]).then(()=>{console.log(`%cDependencies ${B} loaded`,s)});else{let z=GM_config.get("custom_css_data");z.length()>0&&console.log(`%cNeed to inject a custom css in application content is ${z}`,s)}}GM.info.script.downloadURL==="https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/billing.js"?(console.log("%cALERTE .... version locale !!!!!! ","background-color:coral;color:white"),unsafeWindow.Facturier={libs:[],cfg:{dbase:null}},unsafeWindow.Facturier.cfg.dbase=k.Cfg.dbase,unsafeWindow.Facturier.libs.push({id:"fetchInject",ptr:fetchInject}),unsafeWindow.Facturier.libs.push({id:"dayjs",ptr:dayjs}),console.log("%cImportants values are exported in unsafeWindow.Facturier",s),k.loadDependencies()):console.log(`GM.info.script.downloadURL url : ${GM.info.script.downloadURL}`)},loadDependencies:function(){let d=[];d.push("http://localhost:8000/src/branch01/sandbox.js"),d.push("http://localhost:8000/src/branch01/sandbox.css"),fetchInject(d).then(()=>{console.log(`dependencies ${d} loaded`)})}};window.Facturier!==void 0?window.Facturier.start():k.start();var h=k});var ta={async XHR(a){const e=window.GM_xmlhttpRequest||(GM?GM.xmlHttpRequest:null);return e?new Promise((c,b)=>{Object.assign(a,{onabort:b,onerror:b,onload:c,ontimeout:b}),e(a)}):Promise.reject()},async getValue(a,e=null){return window.GM_getValue?Promise.resolve(GM_getValue(a)||e):await GM.getValue(a)||e},async setValue(a,e){window.GM_setValue?GM_setValue(a,e):GM.setValue(a,e)}};const pa="OC-Addons",Ea="Stéphane TORCHY",s="background-color:green;color:white",Fa="background-color:black;color:white",ja="background-color:coral;color:white",Ga="background-color:cyan;color:white",Ha="background-color:red;color:white",E="background-color:blue;color:white",la="auto-financé",qa="financé par un tiers",M="réalisée",X="annulée",S="annulée tardivement",O="étudiant absent",P="étudiante absente",U=6,ba=30,ca=35,da=40,ea=45,fa=50,ga=55;var Wa=function(){return new Promise(a=>{document.readyState=="loading"?document.addEventListener("DOMContentLoaded",a):a()})},ra=async function(a="",e="",c=!1){console.info(`%cfetch() waiting return from : ${a}`,s);const b=await ta.XHR({method:"GET",url:a,responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"}});let f=new DOMParser(),k=f.parseFromString(b.responseText.replace(/\n/mg,""),"text/html");var h={};return c===!0?h=k.querySelectorAll(e):h=k.querySelector(e),h},Z=function(a,e=-1){try{var c=(a.children[0].href||"/").split("/");return c[c.length+e]}catch(b){throw Error("Erreur qui ne devrait jamais arriver en getkey :"+b.stack||b)}},Ca=function(a){var e=a.trim().split(" ");try{id=dayjs_locale_fr.months.findIndex(c=>c===e[1])+1}catch(c){throw Error("Erreur qui ne devrait jamais arriver en conversion de date :"+c.stack||c)}return`${e[2]}-${id}-${e[0]}T${e[4]}`},Ja=function(a,e=0){e===-1&&(e=a.children.length-1);var c=a.children[e].children[0].innerText;let b=Ca(c);var f=dayjs(b);return f};function Da(a){return new Promise(e=>setTimeout(e,a))}HTMLElement.prototype.appendFirst=function(a){this.firstChild?this.insertBefore(a,this.firstChild):this.appendChild(a)};var ia=async function(a=null,e=null,c=!0){var b="";b+="<style>",b+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",b+="form input {background: #fff;border: 1px solid #9c9c9c;}",b+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",b+="form button:hover {background: gold;}",b+="form label {padding: 0.5em 0.5em 0.5em 0;}",b+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",b+="form input:focus {outline: 3px solid gold;}",b+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",b+="</style>",b+='<form class="form1" action="">',b+='<label for="dtFrom" class="date">Date de début</label>',a?b+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(a).format("YYYY-MM-DD")+'">':b+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',b+='<label for="dtTo" class="date">Date de fin</label>',a?b+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(e).format("YYYY-MM-DD")+'">':b+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',b+="</form>";const{value:f}=await Swal.fire({title:"<strong>Choix de la période</strong>",icon:"info",html:b,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez la période pour la sélection des temps facturés",showLoaderOnConfirm:!0,preConfirm:()=>[document.getElementById("dtFrom").value,document.getElementById("dtTo").value],onRender:k=>{},onOpen:k=>{c===!0&&k.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:k=>{c===!0&&k.querySelector("#dtFrom").removeEventListener("change")},onAfterClose:k=>{},onDestroy:k=>{}});return a=dayjs(f[0]),e=dayjs(f[1]),await Da(250),[a,e]},oa=async function(a){await Swal.fire({position:"top-end",icon:"success",title:a,showConfirmButton:!1,timer:1500})};const yb=_(V());class Y{static tbl_name="f_archives";static add=async function(a){let e=yb.default.Cfg.dbase,c=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),b={id:a[0].to.format("YYYYMM"),data:a,created_at:a[0].now};console.log(`%cWill create archive for id ${a[0].to.format("YYYYMM")} (YYYYMM)`,s),e.get(Y.tbl_name).push(JSON.parse(JSON.stringify(b))).write()};static exists=function(a){let e=yb.default.Cfg.dbase,c=e.get(Y.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static get=function(a){let e=yb.default.Cfg.dbase;var c=e.get(Y.tbl_name).find({id:a}).value();if(c===void 0){throw Error("Erreur qui ne devrait jamais arriver en Archive.get");return!1}else return console.log(`%cWill use archive for id ${a} (YYYYMM)`,s),c};static delete=function(a=null,e=null){let c=yb.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof e==="string"&&(e=e.format("YYYY-MM-DD"));if(a===null&&e==null){console.log("%cWanna suppress ALL Archives from DB ",s),c.get(Y.tbl_name).remove().write();return}if(e==null){c.get(Y.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isBefore(e),"month"}).write();return}if(a==null){c.get(Y.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isAfter(a,"month")}).write();return}c.get(Y.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isBetween(a,e,"month","[]")}).write()}}var ha=Y;class _a{static isInOldMode=function(a){var e=null;typeof a==="string"?e=dayjs(a):e=a;try{return e.isBefore(dayjs("2020-06-01"))}catch(c){throw Error("Erreur qui ne devrait jamais arriver en IsInOldMode (probablement un probleme sur la conversion de la date en objet dayjs:"+c.stack||c)}}}var Q=_a;const tc=_(V());class J{static tbl_name="students";static add=function(a,e="noname",c="nopath",b="unkonw",f){let k=tc.default.Cfg.dbase;var h=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");let i={id:a,fullname:e,path:c,fundedby:b,created:h};k.get(J.tbl_name).push(JSON.parse(JSON.stringify(i))).write()};static exists=function(a){let e=tc.default.Cfg.dbase;var c=e.get(J.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static getFunded=function(a){let e=tc.default.Cfg.dbase,c=e.get(J.tbl_name).find({id:a}).value();if(c==void 0)throw Error(`IRRECOVERABLE ERROR STUDENT WITH ID ${a} NOT IN DB:`);return c.fundedby};static isAutoFunded=function(a){return J.getFunded(a).toLowerCase()===la};static getFinancialMode=async function(a){const e=await ra(`https://openclassrooms.com/fr/mentorship/students/${a}/dashboard`,".mentorshipStudent__details > p");return e.innerText};static delete=function(a=null,e=null){let c=tc.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof e==="string"&&(e=e.format("YYYY-MM-DD"));if(a===null&&e==null){console.log("%cWanna suppress ALL Students from DB",s),c.get(J.tbl_name).remove().write();return}if(e==null){c.get(J.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isBefore(e),"day"}).write();return}if(a==null){c.get(J.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isAfter(a,"day")}).write();return}c.get(J.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isBetween(a,e,"day","[]")}).write()};static getAll=async(a,e)=>{var c=!1;let b=tc.default.Cfg.dbase;var f="table.crud-list tbody",k=document.querySelectorAll(f)[1],h=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");Swal.fire({position:"top-end",icon:"info",toast:!0,title:`mise à jour de la base de donnée des étudiants...
cela peut prendre du temps`,showConfirmButton:!1,timer:1e3});for(const n of k.children){var i=Z(n.children[0],-2),m=n.children[0].innerText,l="non défini";n.children[1].firstElementChild&&(l=n.children[1].firstElementChild.href.split("/").pop());var d=b.get(J.tbl_name).find({id:i}).value();if(d&&c===!1)console.log(`%c${m}(uniquid:${i}) already present in database created at ${d.created}`,s);else{let o=await J.getFinancialMode(i);console.log(`%cFinancial Mode of student ${m}(id:${i}) is ${o}`,s),Toastify({text:`Ajoute l'étudiant : ${m}(${o}) en base`,gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast(),J.add(i,m,l,o,h)}}};static showList=function(){let a=tc.default.Cfg.dbase,e=a.get(J.tbl_name).value();var c="";c+="<table>",c+="<caption>Liste des étudiant</caption>",c+="<thead>",c+="<tr>",c+="<th>Nom</th><th>Parcours</th><th>Financement</th><th>Date de création</th>",c+="</tr>",c+="</thead>",c+="<tbody>";for(var b in e)c+="<tr>",c+=`<td>${e[b].fullname}</td><td>${e[b].path}</td><td>${e[b].fundedby}</td><td>${dayjs(e[b].created,"YYYY-MM-DDTHH:mm:ssZ[Z]").format("DD/MM/YYYY à HH:mm")}</td>`,c+="</tr>";c+="</tbody>",c+="</table>",Swal.fire({title:"<strong>Liste des Etudiants</strong>",icon:"info",html:c,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"fullscreen",onOpen:f=>{var k=f.querySelector("table"),h=new simpleDatatables.DataTable(k)}})};static createManually=async function(a,e,c){let b=["non présent dans la liste","Chef de projet digital","Chef de projet SI","Développeur d'application - Frontend","Développeur Web","Expert en stratégie marketing et communication ","Production de contenu web avec CMS et Content Marketing ","Tech lead"];var f="";f+="<style>",f+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",f+="form input {background: #fff;border: 1px solid #9c9c9c;}",f+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",f+="form button:hover {background: gold;}",f+="form label {padding: 0.5em 0.5em 0.5em 0;}",f+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",f+="form input:focus {outline: 3px solid gold;}",f+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",f+="</style>",f+='<form class="form1" action="">',f+='<label for="student_id" class="name">Reference</label>',f+='<input id="student_id" type="text" value="'+a+'">',f+='<label for="student_name" class="name">Name</label>',f+='<input id="student_name" type="text" value="'+e+'">',f+='<label for="fundedby">Autofinancé</label>',f+='<input id="fundedby" type="checkbox" value="autofunded">',f+='<label for="student_path">Parcours</label>',f+='<input id="student_path" name="student_path" type="text" list="student_path-list">',f+='<datalist id="student_path-list">';for(var k in b)f+=`<option>${b[k]}</option>`;f+="/<datalist>",f+='<label for="session_date">Date</label>',f+='<input id="session_date" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(c).format("YYYY-MM-DD")+'">',f+="</form>";const{value:h}=await Swal.fire({title:"<strong>Ajout d'un étudiant en mode manuel</strong>",icon:"info",html:f,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:`votre étudiant(e) ${e} n'a pas été trouvé`,preConfirm:()=>[document.getElementById("student_id").value,document.getElementById("student_name").value,document.getElementById("student_path").value,document.getElementById("fundedby").checked,document.getElementById("session_date").value]});if(h){var i="";h[3]===!0?i=la:i=qa,J.add(h[0],h[1],h[2],i,h[4])}}}var T=J;const nc=_(V());class W{static tbl_name="sessions";static add=async function(a){let e=nc.default.Cfg.dbase;if(GM_config.get("checksessionalreadyexists")===!0)var c=!0;if(Q.isInOldMode(dayjs(a.when)))a.isFunded=!0;else if(a.type.toLowerCase()==="soutenance")a.isFunded=!0;else{var b=T.exists(a.who_id);console.log("is student in db ?",b);if(b==!1){console.warn("%cI'm updating db .... could'nt do anything else",ja),await T.getAll();var f=T.exists(a.who_id);if(f==!1)return T.createManually(a.who_id,a.who_name,a.when)}a.isFunded=!T.isAutoFunded(a.who_id)}c?W.exists(a.id)==!1?e.get(W.tbl_name).push(JSON.parse(JSON.stringify(a))).write():console.info(`%cSession of ${a.who_name} at ${a.when} already present in database table sessions, skip it!`,s):e.get(W.tbl_name).push(JSON.parse(JSON.stringify(a))).write()};static exists=function(a){let e=nc.default.Cfg.dbase;var c=e.get(W.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static delete=function(a=null,e=null){let c=nc.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof e==="string"&&(e=e.format("YYYY-MM-DD"));if(a===null&&e==null){console.log("%cWanna suppress ALL Sessions from DB",s),c.get(W.tbl_name).remove().write();return}if(e==null){c.get(W.tbl_name).remove(function(b){return dayjs(b.when).isBefore(e),"day"}).write();return}if(a==null){c.get(W.tbl_name).remove(function(b){return dayjs(b.when).isAfter(a,"day")}).write();return}c.get(W.tbl_name).remove(function(b){return dayjs(b.when).isBetween(a,e,"day","[]")}).write()};static parseTable=function(a){var e=a.children[0].children[0].innerText,c=Z(a.children[0]),b=a.children[1].children[0].innerText,f=Z(a.children[1],-2),k=a.children[2].innerText.trim().toLowerCase(),h=a.children[3].children.length?a.children[3].children[0].innerText.trim().toLowerCase():"session",i=-1;a.children[4].children.length>0&&(i=a.children[4].children[0].innerText),e=Ca(e);var m={id:c,when:e,who_id:f,who_name:b,status:k,type:h,lvl:i};return m}}var N=W;const sb=_(V());class wa{static calculateBill=function(a,e){let c=e.format("YYYYMM");if(ha.exists(c)===!0){console.log(`%cUse Archived version ${c} of accounting`,s);let b=ha.get(c);return b.data}return typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof e==="string"&&(e=e.format("YYYY-MM-DD")),wa.memoized(a,e)};static _calculateBill=function(a,e){typeof a==="string"&&(a=dayjs(a)),typeof e==="string"&&(e=dayjs(e));var c=performance.now();let b=sb.default.Cfg.dbase;var f=b.get(N.tbl_name).filter(g=>dayjs(g.when).isSameOrBefore(e,"day")&&dayjs(g.when).isSameOrAfter(a,"day")),k=f.filter(g=>g.type.toLowerCase()==="soutenance")||0;let h=[0,ba,ca,da,ea,fa,ga],i=[],m=[];for(let g=1;g<=U;g+=1)m[g]=[],m[g][0]={session:null,defense:null},m[g][1]={session:null,defense:null},m[g][2]={session:null,defense:null},m[g][3]={session:null,defense:null},m[g][4]={session:null,defense:null},m[g][5]={session:null,defense:null},m[g][6]={session:null,defense:null},m[g][7]={session:null,defense:null},m[g][0].session=f.filter(j=>j.lvl==g&&j.status===M&&j.isFunded===!0)||0,m[g][1].session=f.filter(j=>j.lvl==g&&j.status===X&&j.isFunded===!0)||0,m[g][2].session=f.filter(j=>j.lvl==g&&j.status===S&&j.isFunded===!0)||0,m[g][3].session=f.filter(j=>j.lvl==g&&(j.status===O||j.status===P)&&j.isFunded===!0)||0,m[g][4].session=f.filter(j=>j.lvl==g&&j.status===M&&j.isFunded===!1)||0,m[g][5].session=f.filter(j=>j.lvl==g&&j.status===X&&j.isFunded===!1)||0,m[g][6].session=f.filter(j=>j.lvl==g&&j.status===S&&j.isFunded===!1)||0,m[g][7].session=f.filter(j=>j.lvl==g&&(j.status===O||j.status===P)&&j.isFunded===!1)||0,m[g][0].defense=k.filter(j=>j.lvl==g&&j.status===M&&j.isFunded===!0)||0,m[g][1].defense=k.filter(j=>j.lvl==g&&j.status===X&&j.isFunded===!0)||0,m[g][2].defense=k.filter(j=>j.lvl==g&&j.status===S&&j.isFunded===!0)||0,m[g][3].defense=k.filter(j=>j.lvl==g&&(j.status===O||j.status===P)&&j.isFunded===!0)||0,m[g][4].defense=k.filter(j=>j.lvl==g&&j.status===M&&j.isFunded===!1)||0,m[g][5].defense=k.filter(j=>j.lvl==g&&j.status===X&&j.isFunded===!1)||0,m[g][6].defense=k.filter(j=>j.lvl==g&&j.status===S&&j.isFunded===!1)||0,m[g][7].defense=k.filter(j=>j.lvl==g&&(j.status===O||j.status===P)&&j.isFunded===!1)||0;var l=performance.now();console.log("%cFiltering took "+(l-c)+" milliseconds.",E),i.push({total_errors:0,total_filtered:0,total:f.value().length,control:0}),i.push({type:"bad level",data:f.filter(g=>g.lvl<1||g.lvl>U).value()}),i.push({type:"bad status",data:f.filter(g=>g.status!==M&&g.status!==X&&g.status!==S&&g.status!==O&&g.status!==P).value()}),i.push({type:"bad funded",data:f.filter(g=>g.isFunded!==!1&&g.isFunded!==!0).value()}),i[0].total_errors=i[1].data.length+i[2].data.length+i[3].data.length;var d=[],n=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),o=[];for(let g=1;g<=U;g+=1)Q.isInOldMode(a)?o[g]=[h[g],0,h[g]/2,h[g]/2,h[g],0,h[g]/2,h[g]/2]:o[g]=[h[g],0,0,h[g]/2,h[g]/2,0,0,h[g]/4];var B=performance.now();console.log("%cPU calculated took "+(B-l)+" milliseconds.",E);var z=f.filter(g=>g.type.toLowerCase()!=="soutenance"&&g.status===M&&g.isFunded===!1),r=z.groupBy(g=>g.who_id),y=[];for(var w in r.value())y.push({who_id:w,who_name:r.value()[w][0].who_name,sessions:r.value()[w].length});var u=performance.now();console.log("%cBonus took "+(u-B)+" milliseconds.",E);var q=[],x=[],C=0;for(let g=1;g<=U;g+=1){let j=[];j[0]=m[g][0].session.value().length,j[1]=m[g][1].session.value().length,j[2]=m[g][2].session.value().length,j[3]=m[g][3].session.value().length,j[4]=m[g][4].session.value().length,j[5]=m[g][5].session.value().length,j[6]=m[g][6].session.value().length,j[7]=m[g][7].session.value().length,q[g]=[j[0],j[1],j[2],j[3],j[4],j[5],j[6],j[7]],C+=q[g].reduce((p,D)=>p+D);let v=[];v[0]=m[g][0].defense.value().length,v[1]=m[g][1].defense.value().length,v[2]=m[g][2].defense.value().length,v[3]=m[g][3].defense.value().length,v[4]=m[g][4].defense.value().length,v[5]=m[g][5].defense.value().length,v[6]=m[g][6].defense.value().length,v[7]=m[g][7].defense.value().length,x[g]=[v[0],v[1],v[2],v[3],v[4],v[5],v[6],v[7]]}i[0].total_filtered=C,i[0].control=i[0].total-C;var t=performance.now();console.log("%cPrecalc some vars took "+(t-u)+" milliseconds.",E),d.push({from:a,to:e,created_at:n,errors:i,bonus:y,max_level:U});for(let g=1;g<=U;g+=1){let j=m[g];d.push({sessions:{data:[j[0].session,j[1].session,j[2].session,j[3].session,j[4].session,j[5].session,j[6].session,j[7].session],number:q[g],pu:o[g]},defenses:{data:[j[0].defense,j[1].defense,j[2].defense,j[3].defense,j[4].defense,j[5].defense,j[6].defense,j[7].defense],number:x[g],pu:o[g]}})}var F=performance.now();return console.log("%cMy array full storage took "+(F-t)+" milliseconds.",E),e.isBefore(dayjs())&&ha.add(d),d};static memoized=moize.default(wa._calculateBill,{maxAge:12e4,isSerialized:!0,onCacheAdd:function(a,e,c){console.log("%cAdd data to cache",s)},onCacheHit:function(){console.log("%cGet data from cache",s)}})}var xa=wa;const cc=_(V());class I{static tbl_name="history_session_cache";static getSessionPage=function(a){a.get("day")<a.daysInMonth()&&(a=a.endOf("month"));let e=cc.default.Cfg.dbase;if(!e.has(I.tbl_name).value()){throw Error(`DB ${I.db_name} NOT FOUND`);return-1}let c=e.get(I.tbl_name).find({id:a.format("YYYYMMDD")}).value();return c===void 0?-1:c};static delete=function(a=null,e=null){let c=cc.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof e==="string"&&(e=e.format("YYYY-MM-DD"));if(a===null&&e==null){c.get(I.tbl_name).remove().write(),console.log("%cWanna suppress ALL History from DB",s);return}if(e==null){c.get(I.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isBefore(e),"day"}).write();return}if(a==null){c.get(I.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isAfter(a,"day")}).write();return}c.get(I.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isBetween(a,e,"day","[]")}).write()};static addOrUpdateSessionPage=function(a=1,e=dayjs("1970-10-06")){I.getSessionPage(e)==-1?I.addSessionPage(a,e):I.updateSessionPage(a,e)};static updateSessionPage=function(a=1,e=dayjs("1970-10-06")){let c=cc.default.Cfg.dbase,b=I.getSessionPage(e);if(b==-1){throw Error("session page not found in history");return-1}c.get(I.tbl_name).find({id:e.format("YYYYMMDD")}).assign({page:a}).write()};static addSessionPage=function(a=1,e=dayjs("1970-10-06")){let c=cc.default.Cfg.dbase;c.get(I.tbl_name).push(JSON.parse(JSON.stringify({id:e.format("YYYYMMDD"),page:a}))).write()}}var sa=I;const hc=_(V());class jb{static detail_bill="truc";static getListDetailBill=function(a,e){let c=hc.default.Cfg.dbase,b=c.get(N.tbl_name).filter(d=>dayjs(d.when).isSameOrBefore(e,"day")&&dayjs(d.when).isSameOrAfter(a,"day")).sortBy(function(d){return dayjs(d.when).valueOf()}).value();var f=[0,ba,ca,da,ea,fa,ga];let k=0;for(var h in b){if(b[h].lvl>f.length-1)throw Error("ERROR PRICE ARRAY MUST BE UPDATED IN LISTS.JS");var i=b[h].isFunded===!0?f[b[h].lvl]:f[b[h].lvl]*.5,m=0,l=!0;Q.isInOldMode(dayjs(b[h].when))?b[h].status===M?m=i:(b[h].status===O||b[h].status===P||b[h].status===S)&&(m=i*.5):(l=!1,b[h].status===M?m=i:(b[h].status===O||b[h].status===P)&&(m=i*.5)),k+=m,b[h].iPu=i,b[h].oldMode=l,b[h].iCumul=k,b[h].iFPu=m}return b};static getListStatistic=function(a,e){let c=a,b=[],f=[];for(var k=performance.now();c.isSameOrBefore(e,"day");){let i=c.endOf("month");b.push(Accounting.calculateBill(c,i)),c=c.add(1,"month")}var h=performance.now();console.log("%cComputed data between the two dates in"+(h-k)+" milliseconds.",E),f[1][1]=666}}var Aa=jb;var ya=function(a,e){let c=[[0,1,2,3,4,5,5],[5,1,2,3,4,5,5],[4,5,1,2,3,4,4],[3,4,5,1,2,3,3],[2,3,4,5,1,2,2],[1,2,3,4,5,1,1],[0,1,2,3,4,5,0]];return Math.trunc(e.diff(a,"days")/7)*5+c[a.day()][e.day()]};class kb{static addFooter=async function(a,e,c={}){const{degrees:b,PDFDocument:f,rgb:k,StandardFonts:h}=PDFLib,i=a.getPageCount(),m="8".repeat(i),l=await a.embedFont(h.TimesRoman),d=12,n=l.widthOfTextAtSize(`page ${m} / ${m}`,d),o=10,B=10,z=1,r=k(0/255,0/255,0/255),y=k(253/255,246/255,227/255),w=5,u=5,q=3,x=3,C=!0;a.getPages().forEach((t,F)=>{if(!(C===!0&&F==0)){const{width:g,height:j}=t.getSize(),v=d+2*z+q+x;t.moveTo(o+w,d+x),t.setFont(l),t.setFontSize(d),t.setFontColor(k(1,0,0)),e!==void 0&&t.drawText(`${e}`),t.drawText(`page ${F+1} / ${i}`,{x:g-n-u}),t.drawRectangle({x:o,y:10,width:g-(o+B),height:v,color:y,opacity:.6,borderColor:r,borderWidth:z})}})}}var Ka=kb;const Jb=_(V());class $a{static export=function(){return console.log("%cWanna export DBASE",s),JSON.stringify(Jb.default.Cfg.dbase.getState())};static import=function(a){return console.log(`%cWanna import ${a} in DBASE`,s),console.log("%c !!!!!! TYPE NOT CHECKED BE CARREFULL",s),Jb.default.Cfg.dbase.setState(JSON.parse(a)).write()}}var za=$a;var La=async function(){var a="";a+="<style>div.about_content {background-color: #fed9ff;/*width: 600px;*/height: var(--heigth, 80%);overflow-x: hidden;overflow-y: auto;text-align: left;padding: 20px;}</style>",a+='<div class="about_content" style="--heigth: 600px;">',a+='<div class="about_content__wrapper">';const e=await ta.XHR({method:"GET",url:"https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/README.md",responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"}});var c=e.responseText,b=new showdown.Converter(),f=b.makeHtml(c);a+=f,a+="</div>",a+="</div>",Swal.fire({title:`<strong>A propos de ${pa}</strong>`,icon:"info",html:a,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},ma=function(){var a="table.crud-list tbody",e=document.querySelector(a),c=!1;if(e.querySelector("[type=checkbox]")===null){for(const o of e.children){var b=Z(o.children[0]),f=document.createElement("input");f.type="checkbox",f.name="name",f.value=b,f.id="id",c=N.exists(b),c===!0&&(f.checked=!0);var k=document.createElement("td");k.style="text-align: center",k.appendChild(f),o.appendChild(k)}a="table.crud-list thead tr";var h=document.querySelector(a);f=document.createElement("input"),f.type="checkbox",f.name="name",f.value="value",f.id="id",f.onclick=function(){document.querySelectorAll("tbody input[type=checkbox]").forEach(o=>o.checked=!o.checked)},f.style="visibility: hidden;";var i=document.createElement("label");i.innerText="in DB",i.style="display:block;",i.onMouseOver="this.style.cursor=pointer;",i.onMouseOut="this.style.cursor=auto;",i.appendChild(f),k=document.createElement("td"),k.style="text-align: center",k.appendChild(i),h.appendChild(k)}else{for(var m=e.querySelectorAll("[type=checkbox]"),l=m.length,d=new Array(l);l--;d[l]=m[l]);for(var n in d)c=N.exists(d[n].value),c===!0?d[n].checked=!0:d[n].checked=!1}},Ma=async function(){var[a,e]=await ia(dayjs().startOf("month"),dayjs().endOf("month"));let c=Aa.getListDetailBill(a,e),b="";b+="<table>",b+="<thead>",b+="<tr><th>Quand</th><th>Qui</th><th>Financé ?</th><th>Ancien Mode ?</th><th>PU HT</th><th>Statut</th><th>PU (corrigé) HT</th><th>Cumul</th></tr>",b+="<thead>",b+="<tbody>";var f=0;for(let k=0;k<c.length;k+=1)b+="<tr>",b+=`<td>${dayjs(c[k].when).format("DD/MM/YYYY à HH:mm:ss")}</td><td>${c[k].who_name}</td><td>${c[k].isFunded===!0?"Oui":"Non"}</td><td>${c[k].oldMode===!0?"Oui":"Non"}</td><td>${c[k].iPu}</td><td>${c[k].status}</td><td>${c[k].iFPu}</td><td>${c[k].iCumul}€</td>`,b+="</tr>";b+="</tbody>",b+="</table>",Swal.fire({title:`<strong>Liste détaillées des sessions du ${a.format("DD/MM/YYYY")} au ${e.format("DD/MM/YYYY")}</strong>`,icon:"info",html:b,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:k=>{var h=k.querySelector("table"),i=new simpleDatatables.DataTable(h)}})},Na=async function(){for(var a="table.crud-list tbody input:checked",e=document.querySelectorAll(a),c=0;c<e.length;c+=1){var b=e[c].parentElement.parentElement,f=N.parseTable(b);await N.add(f)}oa(`Collecte des sessions cochées
terminée`)},Oa=async function(){var[a,e]=await ia(dayjs().startOf("month"),dayjs().endOf("month"));let c=0,b=GM_config.get("maxfetchpg"),f=!0;var k={};let h=[],i=1,m=sa.getSessionPage(e);for(m!==void 0&&m.page>i&&(i=m.page);f;){if(c>b){console.warn("%cEMERGENCY EXIT LOOP",ja);break}k=await ab(a,e,i,h),k.length>0&&dayjs(k[k.length-1].when).isSameOrBefore(a)===!0&&(f=!1);let d=dayjs(k[k.length-1].when),n=dayjs(k[20*c].when);if(d.get("month")!=n.get("month")){let o=d.endOf("month");sa.addOrUpdateSessionPage(i,o)}i+=1,c+=1}for(var l in k){if(dayjs(k[l].when).isBefore(a,"day")===!0){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions
Collecte terminée`,showConfirmButton:!1,timer:1500});break}if(dayjs(k[l].when).isAfter(e,"day")===!0)continue;dayjs(k[l].when).isBetween(a,e,"day","[]")&&await N.add(k[l])}ma(),oa("Collecte automatique terminée")},ab=async function(a,e,c=1,b=[]){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions de l'historique
du `+a.format("DD/MM/YYYY")+" au "+e.format("DD/MM/YYYY")+`
page : `+c+`
cela peut prendre du temps...`,showConfirmButton:!1,timer:3e3});let f=await ra(`https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history?page=${c}`,"table.crud-list tbody");if(f===null)throw new Error("Something went wrong .... try to navigate forward and backward or click some buttons to change url");if(Ja(f,-1).isAfter(e,"day")===!0)return console.log("optimisation ne charge pas ce n'est pas encore arrivé"),b;for(var k=0;k<f.children.length;k+=1){var h=f.children[k],i=N.parseTable(h);b.push(i)}return b},Pa=function(){const{degrees:a,PDFDocument:e,rgb:c,StandardFonts:b}=PDFLib;async function f(){const i="https://pdf-lib.js.org/assets/with_update_sections.pdf",m=await fetch(i).then(y=>y.arrayBuffer()),l=await e.load(m),d=await l.embedFont(b.Helvetica),n=l.getPages(),o=n[0],{width:B,height:z}=o.getSize();o.drawText("This text was added with JavaScript!",{x:5,y:z/2+300,size:50,font:d,color:c(.95,.1,.1),rotate:a(-45)});const r=await l.save();download(r,"pdf-lib_modification_example.pdf","application/pdf")}async function k(){const i=await e.create(),m=await i.embedFont(b.TimesRoman),l=i.addPage(),{width:d,height:n}=l.getSize(),o=30;l.drawText("Creating PDFs in JavaScript is awesome!",{x:50,y:n-4*o,size:o,font:m,color:c(0,.53,.71)});const B=await i.save();download(B,"pdf-lib_modification_example.pdf","application/pdf")}async function h(){var[i,m]=await ia(dayjs().startOf("month"),dayjs().endOf("month"));let l=Aa.getListDetailBill(i,m);const d=await e.create(),n=await d.embedFont(b.TimesRoman),o=d.addPage(),{width:B,height:z}=o.getSize(),r=30;o.drawText(`Prestations en détail

 du ${i.format("DD/MM/YYYY")} au ${m.format("DD/MM/YYYY")}`,{x:50,y:z/2-r,size:r,font:n,color:c(116/255,81/255,235/255)});let y=12,w=1.25,u=d.addPage();u.setFontSize(y),u.line_space=w,u.font=n;let q=1,x=20,C=w*y+x,t=z/2;const F=function(D){const G="LOrEm ipsum DOLor sit aMet, conSEc/tetUr 25 porttitor. ";return D*1.0925*(n.widthOfTextAtSize(G,y)/G.length)};let g=[0,F(18),F(36),F(18),F(5),F(8),F(5),F(7)],j=o.lineHeight,v=25;for(let D=1;D<l.length;D+=1){t=z-w*y*q,t<C&&(q=1,u=d.addPage(),u.font=n,u.setFontSize(y),u.line_space=w,t=z-w*y*q);if(q===1){let H=["","Quand","Qui","Quoi","PU","Statut","Puf","Montant"],L=v;u.moveTo(L,t);for(let K=1;K<H.length;K+=1)u.drawText(H[K],{x:L}),L+=g[K];q+=1,t=z-w*y*q}let G=v;u.drawText(dayjs(l[D].when).format("DD/MM/YYYY à HH:mm"),{font:n,size:y,y:t,x:G,lineHeight:j}),G+=g[1],u.drawText(l[D].who_name.trim(),{font:n,size:y,y:t,x:G,lineHeight:j}),G+=g[2],u.drawText(`${l[D].type} ${l[D].isFunded===!0?"F.":"AF"} (${l[D].lvl})`,{font:n,size:y,y:t,x:G,lineHeight:j}),G+=g[3],u.drawText(l[D].iPu.toString(),{font:n,size:y,y:t,x:G,lineHeight:j}),G+=g[4];let A=l[D].status;l[D].status==="étudiant absent"&&(A="absent"),u.drawText(A,{font:n,size:y,y:t,x:G,lineHeight:j}),G+=g[5],u.drawText(l[D].iFPu.toString(),{font:n,size:y,y:t,x:G,lineHeight:j}),G+=g[6],u.drawText(l[D].iCumul.toString(),{font:n,size:y,y:t,x:G,lineHeight:j}),q+=1}Ka.addFooter(d,"Généré avec Facturier version 1.01");const p=await d.save();download(p,`prestations_facturees_detail_${i.format("YYYYMMDD")}-${m.format("YYYYMMDD")}.pdf`,"application/pdf")}h()},Qa=async function(){GM_addStyle('.formgrid{font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", Helvetica, Arial, sans-serif;}'),GM_addStyle(".swal2-styled[type=button]{background-color:#3085d6;border-radius:.75em;color:#fff;font-size:1.0625em;border-left-color:#3085d6;border-right-color:#3085d6;display:inline-block}.formgrid{display:grid;grid-template-columns:1fr 1em 1fr;grid-gap:.3em .6em;grid-auto-flow:dense;align-items:center}input,output,textarea,select,button{grid-column:2 / 4;width:auto;margin:0}legend{font-size:1.2em;width:100%;border-bottom:1px dotted #99c}fieldset{max-width:40em;padding:4px;margin:2em auto;border:0 none}");let a="";a+="<legend>Que voulez vous faire ?</legend>",a+="<fieldset>",a+='<div class="formgrid">',a+='Epurer<button id="answer1" data-action="raz" class="swal2-styled" type="button">RAZ</button>',a+='Exporter<button id="answer2" data-action="export" class="swal2-styled" type="button">Exporter</button>',a+='Importer<button id="answer3" data-action="import" class="swal2-styled" type="button">Importer</button>',a+="</fieldset>",a+="</div>";const{value:e}=await Swal.fire({title:"Gestion de la base de donnée",html:a,focusConfirm:!1,preConfirm:()=>[document.getElementById("answer1").value,document.getElementById("answer2").value],onOpen:c=>{c.querySelector(".formgrid").addEventListener("click",function(b){const f=function(i){i.target.matches('button[data-action="raz"]')&&(Swal.close(),db());return},k=function(i){i.target.matches('button[data-action="export"]')&&(Swal.close(),bb());return},h=function(i){i.target.matches('button[data-action="import"]')&&(Swal.close(),cb());return};f(b),k(b),h(b)}),console.log("%conOpen popup","color:coral")},onClose:c=>{c.querySelector(".formgrid").removeEventListener("click"),console.log("%conClose popup","color:coral")}});e&&Swal.fire(JSON.stringify(e))},bb=async function(){let a=za.export();console.log(`%cWanna export : ${a}`,s);let e=dayjs(),c="";c+=`<a id="download" href="data:text/plain;charset=utf-8,${encodeURIComponent(a)}" download="export_${e.format("YYYYMMDD")}.json" style="display:none"></a>`,c+=`<a id="download" href="data:text/plain;charset=utf-8,${encodeURIComponent(a)}" download="export_${e.format("YYYYMMDD")}.json">export_${e.format("YYYYMMDD")}.json</a>`,Swal.fire({title:"Export de la base de donnée",html:c,focusConfirm:!1,onOpen:b=>{b.querySelector("#download").click()},onClose:b=>{}})},cb=async function(){console.log("%cWanna import DATABASE",s);const{value:a}=await Swal.fire({title:"Selection de la sauvegarde (json)",input:"file",inputAttributes:{accept:".json","aria-label":"Upload your database"}});if(a){const e=new FileReader();e.onload=c=>{za.import(c.target.result),ma(),oa("Import terminé")},e.readAsText(a)}},db=async function(){GM_addStyle(".form_addon {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}"),GM_addStyle(".form_addon input {background: #fff;border: 1px solid #9c9c9c;}"),GM_addStyle(".form_addon button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}"),GM_addStyle(".form_addon button:hover {background: gold;}"),GM_addStyle(".form_addon label {padding: 0.5em 0.5em 0.5em 0;}"),GM_addStyle(".form_addon input {padding: 0.7em;margin-bottom: 0.5rem;}"),GM_addStyle(".form_addon input:focus {outline: 3px solid gold;}"),GM_addStyle("@media (min-width: 400px) {.form_addon {grid-template-columns: 200px 1fr;grid-gap: 16px;} .form_addon label {text-align: right;grid-column: 1 / 2;} .form_addon input, .form_addon button {grid-column: 2 / 3;}}");var a="";a+='<form id="RAZ" class="form_addon" action="">',a+='<label for="students" class="cbox">Etudiants</label>',a+='<input id="students" type="checkbox" value="del_students_true" checked>',a+='<label for="sessions" class="cbox">Sessions</label>',a+='<input id="sessions" type="checkbox" value="del_sessions_true" checked>',a+='<label for="archives" class="cbox">Archives : factures</label>',a+='<input id="archives" type="checkbox" value="del_archives_true" checked>',a+='<label for="history_cache" class="cbox">Signet historique</label>',a+='<input id="history_cache" type="checkbox" value="del_history_cache_true" checked>',a+='<label for="radio1">filtrer la date</label>',a+='<input type="radio" id="radio1" name="date_filter" value="false" checked>',a+='<label for="radio2">ne pas filtrer</label>',a+='<input type="radio" id="radio2" name="date_filter" value="true">',a+='<label for="dtFrom" class="date">Date de début</label>',a+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',a+='<label for="dtTo" class="date">Date de fin</label>',a+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',a+="<!-- Switch -->",a+='<input type="checkbox" class="switch" name="s1" id="s1">',a+='<label for="s1">Switch</label>',a+="</form>";const{value:e}=await Swal.fire({title:"<strong>RAZ des données</strong>",icon:"info",html:a,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez ce que vous allez supprimer de la base de donnée",preConfirm:()=>{let m=document.getElementsByName("date_filter"),l="notfound";for(var d in m)m[d].checked===!0&&(l=m[d].value);return console.log(document.getElementById("s1")),[document.getElementById("students").checked,document.getElementById("sessions").checked,document.getElementById("archives").checked,document.getElementById("history_cache").checked,document.getElementById("dtFrom").disabled===!0?null:document.getElementById("dtFrom").value,document.getElementById("dtTo").disabled===!0?null:document.getElementById("dtTo").value,l]},onOpen:m=>{m.querySelector("#radio1").addEventListener("change",function(){console.log(document.getElementById("radio1").checked);let l=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!l,document.getElementById("dtTo").disabled=!l}),m.querySelector("#radio2").addEventListener("change",function(){let l=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!l,document.getElementById("dtTo").disabled=!l}),m.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:m=>{m.querySelector("#radio1").removeEventListener("change"),m.querySelector("#radio2").removeEventListener("change"),m.querySelector("#dtFrom").removeEventListener("change")}});let c=e[0],b=e[1],f=e[2],k=e[3];console.log(`wanna raz students ? ${c}, wanna raz sessions ? ${b}, wanna raz archives ? ${f}`);let h=e[4]?dayjs(e[4]):null,i=e[5]?dayjs(e[5]):null;c===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des étudiants",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),T.delete(h,i)),b===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des sessions",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),N.delete(h,i),ma()),f===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des archives (financières)",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),ha.delete(h,i)),k===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base du cache des historique de session",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),sa.delete(h,i))},Ra=async function(){var a="";a+="<style>",a+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",a+="form input {background: #fff;border: 1px solid #9c9c9c;}",a+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",a+="form button:hover {background: gold;}",a+="form label {padding: 0.5em 0.5em 0.5em 0;}",a+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",a+="form input:focus {outline: 3px solid gold;}",a+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",a+="</style>",a+='<form class="form1" action="">',a+='<label for="dd" class="date">Date de début</label>',a+='<input id="dd" type="date" max="2030-12-31" min="2010-12-31">',a+='<label for="df" class="date">Date de fin</label>',a+='<input id="df" type="date" max="2030-12-31" min="2010-12-31">',a+="</form>";var[e,c]=await ia(dayjs().startOf("month"),dayjs().endOf("month")),b=xa.calculateBill(e,c);Q.isInOldMode(e)?eb(e,c,b):fb(e,c,b)},eb=function(a,e,c){var b="",f=null,k=0,h=0,i=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],m=c[0].max_level;b+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",b+='<div class="wrapper">',b+="<table>",b+="<caption>Sessions de mentorat</caption>",b+="<thead>",b+="<tr>",b+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>";for(var l in i){b+="<tr>",b+="<td>"+i[l][1]+"</td>",f=c[i[l][0]].sessions;let q=f.number[0],x=f.number[4],C=q*f.pu[0],t=x*f.pu[4];k+=q+x,h+=C+t,b+=`<td>${q+x}</td><td>${(f.pu[0]+f.pu[4])/2}</td><td>${C+t}€</td>`,b+="</tr>"}b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${k}</td><td></td><td>${h}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>";var d=k,n=h;k=0,h=0,b+="<table>",b+="<caption>Sessions de mentorat (NoShow)</caption>",b+="<thead>",b+="<tr>",b+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>";for(l in i){b+="<tr>",b+="<td>"+i[l][1]+"</td>",f=c[i[l][0]].sessions;let q=f.number[2]+f.number[3],x=f.number[6]+f.number[7],C=q*(f.pu[2]+f.pu[3])/2,t=x*(f.pu[6]+f.pu[7])/2;k+=q+x,h+=C+t,b+=`<td>${q+x}</td><td>${(f.pu[2]+f.pu[3]+f.pu[6]+f.pu[7])/4}</td><td>${C+t}€</td>`,b+="</tr>"}b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${k}</td><td></td><td>${h}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>",d+=k,n+=h;for(var o=0,B=0,z=0,r=0,y=0,w=1;w<=m;){o+=c[w].sessions.number[1],o+=c[w].sessions.number[5];for(let q in[...Array(8).keys()]){let x=c[w].sessions.number[q];B+=x,z+=x*c[w].sessions.pu[q],x=c[w].defenses.number[q],r+=x,y+=x*c[w].defenses.pu[q]}w+=1}let u=c[0].errors[0].total_errors;B+=u,b+=`<p>Ces ${B} session(s) se répartissent en ${d-k} session(s) de mentorat (${n-h}€)`,b+=`, ${k} NoShows (${h}€)`,u==0?b+=`et ${o} session(s) annulée(s) (${0}€) </p>`:b+=`, ${o} session(s) annulée(s) (${0}€) ainsi que ${u} session(s) en anomalie (cf 1.)`,b+=`<br >Sur le total de ${B} session(s) (${z}€) `,b+=`vous avez réalisé ${r} soutenance(s) (${y}€)</p>`;if(u>0){let q=c[0].errors[0];b+=`(1) Attention, il y a ${u} session(s) qui présente(nt) une anomalie c'est peut être normal : exemple un étudiant qui n'a plus de parcours associé au moment de la collecte de session`,b+=", pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${q.total_errors} erreurs relevées , notez qu'il y a ${q.total_filtered} ennregistrements filtrés(lvl,...)  sur ${q.total} enregistrements dans la période, le total des erreurs devrait donc être de ${q.control} erreurs`),console.warn("détail"),console.warn(`${c[0].errors[1].data.length} erreurs de type ${c[0].errors[1].type} data are`,c[0].errors[1].data),console.warn(`${c[0].errors[2].data.length} erreurs de type ${c[0].errors[2].type} data are`,c[0].errors[2].data),console.warn(`${c[0].errors[3].data.length} erreurs de type ${c[0].errors[3].type} data are`,c[0].errors[3].data)}b+=`<p>Soit un total général à facturer de ${z}€`,Swal.fire({title:`<strong>Liste des formations tarifées du ${a.format("DD/MM/YYYY")} au ${e.format("DD/MM/YYYY")}</strong>`,html:b,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},fb=function(a,e,c){console.log("enter computation bill");var b=performance.now(),f="",k=null,h=0,i=0,m=0,l=0,d=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],n=c[0].max_level;f+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",f+='<div class="wrapper">',f+="<table>",f+="<caption>Sessions de mentorat (dont soutenances)</caption>",f+="<thead>",f+="<tr>",f+='<th rowspan="2">Type</th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th>',f+="</tr>",f+="<tr>",f+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+="</tr>",f+="</thead>",f+="<tbody>";for(var o=1;o<=n;){f+="<tr>",f+=`<td> Niveau ${o}</td>`;let A=c[o].sessions,H=c[o].defenses,L=A.number[0],K=A.number[4],$=L*A.pu[0],aa=K*A.pu[4];h+=L,i+=K,m+=$,l+=aa,f+=`<td>${L} (${H.number[0]})</td><td>${A.pu[0]}</td><td>${$}€</td>`,f+=`<td>${K} (${H.number[4]})</td><td>${A.pu[4]}</td><td>${aa}€</td>`,f+=`<td>${L+K} (${H.number[0]+H.number[4]})</td><td>${$+aa}€</td>`,f+="</tr>",o+=1}var B=performance.now();console.log("%cCalculate first array"+(B-b)+" milliseconds.",E),f+="</tbody>",f+="<tfoot>",f+="<tr>",f+="<td>Total</td>",f+=`<td>${h}</td><td></td><td>${m}€</td>`,f+=`<td>${i}</td><td></td><td>${l}€</td>`,f+=`<td>${h+i}</td><td>${m+l}€</td>`,f+="</tr>",f+="<tr>",f+="</tr>",f+="</tfoot>",f+="</table>";var z=h+i,r=m+l;for(h=0,i=0,m=0,l=0,f+="<table>",f+="<caption>Sessions de mentorat :NoShow (dont soutenances)</caption>",f+="<thead>",f+="<tr>",f+='<th rowspan="2"></th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th><th colspan="2" scope="colgroup">Ensemble</th>',f+="</tr>",f+="<tr>",f+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+="</tr>",f+="</thead>",f+="<tbody>",o=1;o<=n;){f+="<tr>",f+=`<td> Niveau ${o}</td>`;let A=c[o].sessions,H=c[o].defenses,L=A.number[3],K=A.number[7],$=L*A.pu[3],aa=K*A.pu[7];h+=L,i+=K,m+=$,l+=aa,f+=`<td>${L} (${H.number[3]})</td><td>${A.pu[3]}</td><td>${$}€</td>`,f+=`<td>${K} (${H.number[7]})</td><td>${A.pu[7]}</td><td>${aa}€</td>`,f+=`<td>${L+K}</td><td>${$+aa}€</td>`,f+="</tr>",o+=1}f+="</tbody>",f+="<tfoot>",f+="<tr>",f+="<td>Total</td>",f+=`<td>${h}</td><td></td><td>${m}€</td>`,f+=`<td>${i}</td><td></td><td>${l}€</td>`,f+=`<td>${h+i}</td><td>${m+l}€</td>`,f+="</tr>",f+="<tr>",f+="</tr>",f+="</tfoot>",f+="</table>";var y=performance.now();console.log("%cCalculate second html table took "+(y-B)+" milliseconds.",E),z+=h+i,r+=m+l;var w=0,u=0,q=0,x=0,C=0;for(o=1;o<=n;){w+=c[o].sessions.number[1],w+=c[o].sessions.number[2],w+=c[o].sessions.number[5],w+=c[o].sessions.number[6];for(let A in[...Array(8).keys()]){let H=c[o].sessions.number[A];u+=H,q+=H*c[o].sessions.pu[A],H=c[o].defenses.number[A],x+=H,C+=H*c[o].defenses.pu[A]}o+=1}let t=c[0].errors[0].total_errors;u+=t,f+=`<p>Ces ${u} session(s) se répartissent en ${z-h-i} session(s) de mentorat (${r-m-l}€)`,f+=`, ${h+i} NoShows (${m+l}€)`,t==0?f+=`et ${w} session(s) annulée(s) (${0}€)`:f+=`, ${w} session(s) annulée(s) (${0}€) ainsi que ${t} session(s) en anomalie (cf 1.)`,f+=`<br>Sur le total de ${u} session(s) (${q}€) `,f+=`vous avez réalisé ${x} soutenance(s) (${C}€)</p>`;if(t>0){let A=c[0].errors[0];f+=`(1) Attention, il y a ${t} session(s) qui présente(nt) une anomalie c'est peut être normal : exemple un étudiant qui n'a plus de parcours associé au moment de la collecte de session`,f+=", pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${A.total_errors} erreurs relevées , notez qu'il y a ${A.total_filtered} ennregistrements filtrés(lvl,...)  sur ${A.total} enregistrements dans la période, le total des erreurs devrait donc être de ${A.control} erreurs`),console.warn("détail"),console.warn(`${c[0].errors[1].data.length} erreurs de type ${c[0].errors[1].type} data are`,c[0].errors[1].data),console.warn(`${c[0].errors[2].data.length} erreurs de type ${c[0].errors[2].type} data are`,c[0].errors[2].data),console.warn(`${c[0].errors[3].data.length} erreurs de type ${c[0].errors[3].type} data are`,c[0].errors[3].data)}var F=performance.now();console.log("%cCalculate bottom remark + errors took "+(F-y)+" milliseconds.",E);var g=0;let j="",v="";for(var p in c[0].bonus)c[0].bonus[p].sessions>=1?(g+=30,j+=c[0].bonus[p].who_name+","):v+=c[0].bonus[p].who_name+",";f+=`<p>Calcul du forfait "autofinancé". Vous sont affectés ${c[0].bonus.length} étudiants financés, parmi ceux ci, ${g/30} étudiant(s) avaient au moins une session programmée (${j.slice(0,-1)})`,g/30!==c[0].bonus.length&&(f+=`, (${c[0].bonus.length-g/30}) étudiant(s) (${v.slice(0,-1)}) n'ont pas eu de sessions`),f+=`, le forfait est donc de ${g}€</p>`,f+=`<p>Soit un total général à facturer de ${q+g}€`;var D=performance.now();console.log("%cCalculate AF took "+(D-F)+" milliseconds.",E);var G=performance.now();console.log("%cCalculate html table took "+(D-b)+" milliseconds.",E),Swal.fire({title:`<strong>Liste des formations tarifées du ${a.format("DD/MM/YYYY")} au ${e.format("DD/MM/YYYY")}</strong>`,html:f,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},Sa=async function(){var[a,e]=await ia(dayjs().startOf("month"),dayjs().endOf("month"),!1);let c=a,b=[];for(var f=performance.now();c.isSameOrBefore(e,"day");){let g=c.endOf("month");b.push(xa.calculateBill(c,g)),c=c.add(1,"month")}var k=performance.now();console.log("%cComputed data between the two dates in"+(k-f)+" milliseconds.",E);var h="",i=e.get("month")-a.get("month");h+="<table>",h+="<thead>",h+="<tr><th>Origine</th>";for(var m=0;m<=i;){let g=a.add(m,"month");h+=`<th>${g.format("MMMM")}</th>`,m+=1}h+="<th>Total</th><th>Moyenne</th></tr>",h+="</thdead>",h+="<tbody>",h+="<tr>",h+=`<td colspan=${i} style="text-align:left;">Sessions</td></tr>`,h+="<tr>",h+="<td>Sessions (Mt)</td>";let l=0,d=0,n=0,o=[],B=[],z=[],r=[],y=[],w=[],u=[];for(c=a;d<=i;){let g=1;o[d]=0,B[d]=0,z[d]=0,y[d]=0,w[d]=0,u[d]=0;let j=b[d][0].max_level;for(;g<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)n+=b[d][g].sessions.number[p]*b[d][g].sessions.pu[p],o[d]+=b[d][g].sessions.number[p],B[d]+=b[d][g].defenses.number[p],z[d]+=b[d][g].sessions.number[p]-b[d][g].defenses.number[p],Q.isInOldMode(c)?[1,5].includes(p)&&(y[d]+=b[d][g].sessions.number[p],w[d]+=b[d][g].defenses.number[p],u[d]+=b[d][g].sessions.number[p]-b[d][g].defenses.number[p]):[1,2,5,6].includes(p)&&(y[d]+=b[d][g].sessions.number[p],w[d]+=b[d][g].defenses.number[p],u[d]+=b[d][g].sessions.number[p]-b[d][g].defenses.number[p]);g+=1}h+=`<td>${n}</td>`,r[d]=n,l+=n,n=0,d+=1,c=c.add(1,"month")}for(h+=`<td>${l}</td><td>${(l/(i+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Sessions (Nb)</td>",l=0,d=0,n=0;d<=i;)h+=`<td>${o[d]-y[d]}(${o[d]})</td>`,l+=o[d],d+=1;for(h+=`<td>${l}</td><td>${(l/(i+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Sessions (PU)</td>",l=0,d=0,n=0;d<=i;)h+=`<td>${(r[d]/(o[d]-y[d])).toFixed(2)}</td>`,l+=n,n=0,d+=1;for(h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+="<tr>",h+=`<td colspan=${i} style="text-align:left;">Mentorat</td></tr>`,h+="<tr>",h+="<td>Mentorat (Mt)</td>",d=0,n=0,r=[];d<=i;){let g=1,j=b[d][0].max_level;for(;g<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)n+=b[d][g].sessions.number[p]*b[d][g].sessions.pu[p]-b[d][g].defenses.number[p]*b[d][g].defenses.pu[p],r[d]=n;g+=1}h+=`<td>${n}</td>`,d+=1,n=0}for(h+="<tr>",h+="<tr>",h+="<td>Mentorat (Nb)</td>",l=0,d=0,n=0,o=[];d<=i;)h+=`<td>${z[d]-u[d]}(${z[d]})</td>`,l+=n,n=0,d+=1;for(h+=`<td>${l}</td><td>${(l/(i+1)).toFixed(2)}</td>`,h+="</tr>",h+="<td>Mentorat (PU)</td>",d=0;d<=i;)h+=`<td>${(r[d]/(z[d]-u[d])).toFixed(2)}</td>`,r[d]=n,l+=n,n=0,d+=1;for(h+=`<td>${l}</td><td>${(l/(i+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+=`<td colspan=${i} style="text-align:left;">Soutenances</td></tr>`,h+="<tr>",h+="<td>Soutenances (Mt)</td>",l=0,d=0,n=0,o=[],r=[];d<=i;){let g=1;o[d]=0;let j=b[d][0].max_level;for(;g<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)n+=b[d][g].defenses.number[p]*b[d][g].defenses.pu[p],o[d]+=b[d][g].defenses.number[p];g+=1}h+=`<td>${n}</td>`,r[d]=n,l+=n,n=0,d+=1}for(h+=`<td>${l}</td><td>${(l/(i+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Soutenances (Nb)</td>",l=0,d=0,n=0;d<=i;)h+=`<td>${o[d]-w[d]}(${o[d]})</td>`,l+=o[d],d+=1;for(h+=`<td>${l}</td><td>${(l/(i+1)).toFixed(2)}</td>`,h+="</tr>",h+="<tr>",h+="<td>Soutenances (PU)</td>",l=0,d=0,n=0;d<=i;)h+=`<td>${(r[d]/(o[d]-w[d])).toFixed(2)}</td>`,l+=n,n=0,d+=1;h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+=`<td colspan=${i} style="text-align:left;">Bonus</td></tr>`,h+="<tr>",h+="<td>Bonus AF</td>",d=0,n=0;let q=[];for(;d<=i;){let g=b[d][0].bonus;q[d]=0;for(let j=0;j<g.length;j+=1)n+=g[j].sessions>0?30:0;h+=`<td>${n}</td>`,q[d]=n,n=0,d+=1}h+="</tr>",h+="<tr>",h+=`<td colspan=${i} style="text-align:left;">TJM</td></tr>`,h+="<tr>",h+="<td>Nb Jrs</td>",d=0;var x=[];l=0,c=a,r=[],c=a.clone();let C=c.clone().endOf("month"),t=[];for(;d<=i;)C.isAfter(e,"day")&&(C=e.clone()),h+=`<td>${ya(c,C)} jrs</td>`,t[d]=ya(c,C),c=c.add(1,"month"),C=C.add(1,"month"),d+=1;for(h+="</tr>",h+="<tr>",h+="<td>TJM</td>",d=0;d<=i;){n=0;let g=1;r[d]=0,x[d]=0;let j=b[d][0].max_level;for(;g<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)r[d]+=b[d][g].sessions.number[p]*b[d][g].sessions.pu[p];g+=1}h+=`<td>${(r[d]/t[d]).toFixed(2)} €</td>`,d+=1}for(h+="</tr>",h+="<tr>",h+="<td>THM (théorique)</td>",d=0,x=[],l=0,c=a,r=[];d<=i;){n=0;let g=1;r[d]=0,x[d]=0;let j=b[d][0].max_level;for(;g<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)r[d]+=b[d][g].sessions.number[p]*b[d][g].sessions.pu[p],Q.isInOldMode(c)?n+=(b[d][g].sessions.number[p]-b[d][g].defenses.number[p])*(45/60):([4,5,6,7].includes(p)&&(n+=(b[d][g].sessions.number[p]-b[d][g].defenses.number[p])*(30/60)),[0,1,2,3].includes(p)&&(n+=(b[d][g].sessions.number[p]-b[d][g].defenses.number[p])*(45/60))),n+=b[d][g].defenses.number[p]*(45/60);g+=1}console.log(`%cMontant mensuel : ${r[d]} + bonus ${q[d]}/ Nb heures ${n} = $((aAmInMonth[_m]+aAmBoInMonth[_m])/iTotal).toFixed(2)`,s),h+=`<td>${((r[d]+q[d])/n).toFixed(2)} €</td>`,l+=n,x[d]=n,n=0,d+=1,c=c.add(1,"month")}for(h+="</tr>",h+="<tr>",h+="<td>Nb heures</td>",l=0,d=0,n=0;d<=i;)h+=`<td>${x[d].toFixed(2)} h</td>`,l+=n,n=0,d+=1;for(h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+="<tr>",h+="<td>THM (person.)</td>",d=0,x=[],l=0,c=a,r=[];d<=i;){n=0;let g=1;r[d]=0,x[d]=0;let j=b[d][0].max_level;for(;g<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)r[d]+=b[d][g].sessions.number[p]*b[d][g].sessions.pu[p],Q.isInOldMode(c)?n+=(b[d][g].sessions.number[p]-b[d][g].defenses.number[p])*(GM_config.get("nbHrsfM")/60):([4,5,6,7].includes(p)&&(n+=(b[d][g].sessions.number[p]-b[d][g].defenses.number[p])*(GM_config.get("nbHrsAfM")/60)),[0,1,2,3].includes(p)&&(n+=(b[d][g].sessions.number[p]-b[d][g].defenses.number[p])*(GM_config.get("nbHrsfM")/60))),n+=b[d][g].defenses.number[p]*(GM_config.get("nbHrsD")/60);g+=1}console.log(`montant mensuel : ${r[d]} + bonus ${q[d]}/ Nb heures ${n} = $((aAmInMonth[_m]+aAmBoInMonth[_m])/iTotal).toFixed(2)`),h+=`<td>${((r[d]+q[d])/n).toFixed(2)} €</td>`,l+=n,x[d]=n,n=0,d+=1,c=c.add(1,"month")}for(h+="</tr>",h+="<tr>",h+="<td>Nb heures</td>",l=0,d=0,n=0;d<=i;)h+=`<td>${x[d].toFixed(2)} h</td>`,l+=n,n=0,d+=1;h+=`<td>${l.toFixed(2)}</td><td>n/a</td>`,h+="</tr>",h+="</tbody>",h+="<tfoot>",h+"",h+="</tfoot>",h+="</table>";var F=performance.now();console.log("%cTime to show table :"+(F-k)+" milliseconds.",E),Swal.fire({title:`<strong>Statistiques du ${a.format("DD/MM/YYYY")} au ${e.format("DD/MM/YYYY")}</strong>`,icon:"info",html:h,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:g=>{}})};class R{static init=function(){console.log("%cin initUI",s),R.build();var a=new Draggabilly(".draggable",{handle:".handle"});lb.start("animation-target")};static build=function(){console.log("%c in buildUI","background-color:green;color:white"),GM_addStyle(".flex > * { margin: 2px 1px; }"),GM_addStyle(".flex > :first-child { margin-left: 0; }"),GM_addStyle(".flex > :last-child { margin-right: 0; }"),GM_addStyle(".panel {display: flex; justify-content: center;z-index:999}"),GM_addStyle(".menuBar {border-top: 1px solid; padding: 10px; font-size: 1rem; pointer-events: inherit;position: relative;top:0px;  flex-flow: row wrap;/*align-content: space-between;justify-content: space-between;*/}"),GM_addStyle(".draggable {background: transparent;border-radius: 10px;padding: 20px;}"),GM_addStyle(".draggable.is-pointer-down {background: #09F;}"),GM_addStyle(".draggable.is-dragging { opacity: 0.7; }"),GM_addStyle(".handle {background: #555;background: hsla(0, 0%, 0%, 0.4);width: 20px;height: 20px; border-radius: 10px;}"),GM_addStyle(".flex > :nth-last-child(2) {page-break-after: always; /* CSS 2.1 syntax */break-after: always; /* New syntax */}"),GM_addStyle("#animation-target {width: 10px;height: 5px;background-color:coral;border-radius: 25%;}");var a=document.createElement("div"),e=document.createElement("div");e.classList.add("handle"),a.appendChild(e),a.classList.add("panel","menuBar","flex","draggable"),document.body.appendFirst(a),R.addButton("collectChecked",Na,{},a),R.addButton("CollectAuto",Oa,{},a),R.addButton("showBill",Ra,{},a),R.addButton("billInDetails",Ma,{},a),R.addButton("PDF",Pa,{},a),R.addButton("SList",T.showList,{},a),R.addButton("statistics",Sa,{},a),R.addButton("Database",Qa,{},a),R.addButton("about",La,{},a);var c=document.createElement("div");c.id="animation-target",a.appendChild(c)};static addButton=function(a,e,c,b){b=b||document.body,c=c||{position:"absolute",bottom:"7%",left:"4%","z-index":3};let f=document.createElement("button"),k=f.style;return f.classList.add("button--primary","button"),b.appendChild(f),f.innerHTML=a,f.onclick=e,Object.keys(c).forEach(h=>k[h]=c[h]),f}}class lb{static start=function(a){const e=document.getElementById(a),c=i=>e.style.transform=`translateX(${i}px)`;let b=0;const f=7,k=i=>{c(b),b+=f,b>100?requestAnimationFrame(h):requestAnimationFrame(k)},h=i=>{c(b),b-=f,b<-100?requestAnimationFrame(k):requestAnimationFrame(h)};requestAnimationFrame(k)}}var Va=R;const gb="#OCAddonsCfg {background-color: lightblue;} #OCAddonsCfg .reset_holder {float: left; position: relative; bottom: -1em;} #OCAddonsCfg .saveclose_buttons {margin: .7em;}",hb="height: 16.7em; width: 30em; border: 1px solid; border-radius: 3px; position: fixed; z-index: 999;",Ta={id:"OCAddonsCfg",title:"Configuration du module",fields:{nbHrsAfM:{section:["Statistiques","paramètres"],label:"Nombre de minutes pour une session AF",labelPos:"left",type:"input",default:30},nbHrsfM:{label:"Nombre de minutes pour une session financée",labelPos:"left",type:"input",default:45},nbHrsD:{label:"Nombre de minutes pour une session de soutenance",labelPos:"left",type:"input",default:45},maxfetchpg:{section:["Application","optimisation"],label:"Maximum de page recherchées dans l'historique",labelPos:"left",type:"input",default:1e3},datacachelifetime:{label:"Temps de conservation des données dans le cache (en ms)",labelPos:"left",type:"input",default:12e4},checksessionalreadyexists:{section:["Application","Base de donnée"],label:"sessions: vérifier existence avant insertion",labelPos:"left",type:"checkbox",default:!0},sizeofcontentlist:{section:["Interface","thème"],label:"taille de la police des listes",labelPos:"left",type:"input",default:"1em;"},use_custom_css:{label:"utiliser des styles personnalisés",labelPos:"left",type:"checkbox",default:!1},custom_css_url:{label:"url de la feuille de style (si plusieurs les séparer par des virgules)",labelPos:"left",type:"input",default:""},custom_css_data:{label:"saisir ici le code css à injecter directement dans la page",title:"Je me demande bien à quoi sert le titre",labelPos:"left",type:"input",default:""},alwaysaddcbox:{section:["Interface","gadget"],label:"Toujours ajouter les checkbox sur l'interface",labelPos:"left",type:"checkbox",default:!0},hackheaderzindex:{label:"changer le zindex du bandeau haut",labelPos:"left",type:"checkbox",default:!0},support:{section:["","Support"],label:"StephaneTy-Pro.github.io",title:"more info on https://github.com/StephaneTy-Pro",type:"button",click:()=>{GM_openInTab("https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon",{active:!0,insert:!0,setParent:!0})}}},css:gb,events:{save:function(){GM_config.close()}}};var Ua=function(){GM_config.open(),OCAddonsCfg.style=hb};V();})();
//# sourceMappingURL=billing.min.js.map
