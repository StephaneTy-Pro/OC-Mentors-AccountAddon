// ==UserScript==
// @name         Facturier (alpha)
// @namespace    http://tampermonkey.net/
// @version      1.00.0003
// @description  Un addon pour vous aidez dans votre facturation
// @author       Stéphane TORCHY
// @updateURL    https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/dist/app.min.js
// @downloadURL  https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/dist/app.min.js
// @match        https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history*
// @grant        unsafeWindow
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @grant        GM_registerMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        GM.xmlHttpRequest
// @grant        GM_notification

// @require      https://cdn.jsdelivr.net/npm/lodash@4.17.19/lodash.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/low.min.js
// @require      https://unpkg.com/lowdb@0.17/dist/LocalStorage.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/dayjs.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/locale/fr.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isBetween.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrBefore.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/isSameOrAfter.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/customParseFormat.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.29/plugin/localeData.min.js


// GM_Config
// @require      https://openuserjs.org/src/libs/sizzle/GM_config.js

// sweetalert 2
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.all.min.js

// draggabilly
// @require      https://cdnjs.cloudflare.com/ajax/libs/draggabilly/2.2.0/draggabilly.pkgd.min.js

// toastify
// @require     https://cdn.jsdelivr.net/npm/toastify-js@1.8.0/src/toastify.min.js
// @resource    toastifycss https://raw.githubusercontent.com/apvarun/toastify-js/master/src/toastify.css

//
// @require     https://raw.githubusercontent.com/uzairfarooq/arrive/master/minified/arrive.min.js

// simple-datatables
// @require     https://cdn.jsdelivr.net/npm/simple-datatables@latest
// @resource    simpledatatablecss https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css

// require https://raw.githubusercontent.com/anywhichway/nano-memoize/master/dist/nano-memoize.min.js
// @require https://cdn.jsdelivr.net/npm/moize@5.4.7/dist/moize.min.js

// require https://raw.githubusercontent.com/StephaneTy-Pro/userscripts/master/fetch-inject.umd.min.js
// @require https://cdn.jsdelivr.net/npm/fetch-inject

// PARSER MKDOWN
// @require 	 https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js

// PDF https://pdf-lib.js.org/docs/api/
// @require      https://unpkg.com/pdf-lib@1.9.0/dist/pdf-lib.min.js
// @require      https://unpkg.com/downloadjs@1.4.7/download.js


/*
 * History
 * cf https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon/blob/master/CHANGELOG.md
 */



// ==/UserScript==

(function() {

    'use strict';
let va=Object.defineProperty,Xa=Object.prototype.hasOwnProperty,mb=(a,d)=>()=>(d||(d={exports:{}},a(d.exports,d)),d.exports),Ya=a=>va(a,"__esModule",{value:!0}),nb=(a,d)=>{Ya(a);for(let c in d)va(a,c,{get:d[c],enumerable:!0})},ob=(a,d)=>{Ya(a);if(typeof d==="object"||typeof d==="function")for(let c in d)Xa.call(d,c)&&!Xa.call(a,c)&&c!=="default"&&va(a,c,{get:()=>d[c],enumerable:!0});return a},_=a=>a&&a.__esModule?a:ob(va({},"default",{value:a,enumerable:!0}),a);var V=mb(i=>{nb(i,{APP_AUTHOR:()=>Fa,APP_DEBUG_STYLE:()=>q,APP_ERROR_STYLE:()=>Ia,APP_INFO_STYLE:()=>Ha,APP_LOG_STYLE:()=>Ga,APP_NAME:()=>qa,APP_PERF_STYLE:()=>F,APP_WARN_STYLE:()=>ja,OC_AUTOFUNDED:()=>la,OC_FUNDED:()=>ra,OC_MAX_LEVEL:()=>U,OC_PRICE1:()=>ba,OC_PRICE2:()=>ca,OC_PRICE3:()=>da,OC_PRICE4:()=>ea,OC_PRICE5:()=>fa,OC_PRICE6:()=>ga,OC_STATUS_0:()=>M,OC_STATUS_1:()=>X,OC_STATUS_2:()=>S,OC_STATUS_3_F:()=>P,OC_STATUS_3_M:()=>O,default:()=>g});const l={Cfg:{dbase:null},start:async function(){await Wa();const e=l.checkSupport();console.log(`%cAre all functions supported ? : ${e}`,q),document.arrive(".MuiAvatar-img",l._warmup)},checkSupport:function(){return!0},_warmup:function(){console.log("%cinSetup",q),GM===void 0?(console.log("%cI am not in a tamper env"),l._userscriptless()):console.log(`%cTamper environment detected the version is ${GM.info.version}`,q),GM_addStyle(GM_getResourceText("jspanelcss")),GM_addStyle(GM_getResourceText("toastifycss")),GM_addStyle(GM_getResourceText("simpledatatablecss")),GM_config.init(Ta),GM_registerMenuCommand("OC Facturier - configure",Ua),GM_config.get("hackheaderzindex")===!0&&(document.getElementById("header").style.zIndex=0),GM_addStyle(".swal2-content{font-size:"+GM_config.get("sizeofcontentlist")+"}"),GM_addStyle(".swal2-title{font-size:1.275em)"),l._main()},_userscriptless(){},_main:function(){console.log("​​​%cMainLoaded​​​",q);let e=new LocalStorage("db");var n=low(e);n.defaults({students:[],sessions:[],f_archives:[],history_session_cache:[]}).write(),l.Cfg.dbase=n,dayjs.extend(dayjs_plugin_isSameOrAfter),dayjs.extend(dayjs_plugin_isSameOrBefore),dayjs.extend(dayjs_plugin_isBetween),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_localeData),dayjs.extend(dayjs_plugin_customParseFormat),document.querySelector(".panel.menuBar.flex.draggable")===null&&Va.init(),GM_config.get("alwaysaddcbox")===!0&&ma(),dayjs.locale("fr");if(GM_config.get("use_custom_css")===!0){let o=GM_config.get("custom_css_url"),B=o.split(",");if(B.length!==0)fetchInject([B]).then(()=>{console.log(`%cDependencies ${B} loaded`,q)});else{let z=GM_config.get("custom_css_data");z.length()>0&&console.log(`%cNeed to inject a custom css in application content is ${z}`,q)}}GM.info.script.downloadURL==="https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/billing.js"?(console.log("%cALERTE .... version locale !!!!!! ","background-color:coral;color:white"),unsafeWindow.Facturier={libs:[],cfg:{dbase:null}},unsafeWindow.Facturier.cfg.dbase=l.Cfg.dbase,unsafeWindow.Facturier.libs.push({id:"fetchInject",ptr:fetchInject}),unsafeWindow.Facturier.libs.push({id:"dayjs",ptr:dayjs}),console.log("%cImportants values are exported in unsafeWindow.Facturier",q),l.loadDependencies()):console.log(`GM.info.script.downloadURL url : ${GM.info.script.downloadURL}`)},loadDependencies:function(){let e=[];e.push("http://localhost:8000/src/branch01/sandbox.js"),e.push("http://localhost:8000/src/branch01/sandbox.css"),fetchInject(e).then(()=>{console.log(`dependencies ${e} loaded`)})}};window.Facturier!==void 0?window.Facturier.start():l.start();var g=l});var ua={async XHR(a){const d=window.GM_xmlhttpRequest||(GM?GM.xmlHttpRequest:null);return d?new Promise((c,b)=>{Object.assign(a,{onabort:b,onerror:b,onload:c,ontimeout:b}),d(a)}):Promise.reject()},async getValue(a,d=null){return window.GM_getValue?Promise.resolve(GM_getValue(a)||d):await GM.getValue(a)||d},async setValue(a,d){window.GM_setValue?GM_setValue(a,d):GM.setValue(a,d)}};const qa="OC-Addons",Fa="Stéphane TORCHY",q="background-color:green;color:white",Ga="background-color:black;color:white",ja="background-color:coral;color:white",Ha="background-color:cyan;color:white",Ia="background-color:red;color:white",F="background-color:blue;color:white",la="auto-financé",ra="financé par un tiers",M="réalisée",X="annulée",S="annulée tardivement",O="étudiant absent",P="étudiante absente",U=6,ba=30,ca=35,da=40,ea=45,fa=50,ga=55;var Wa=function(){return new Promise(a=>{document.readyState=="loading"?document.addEventListener("DOMContentLoaded",a):a()})},sa=async function(a="",d="",c=!1){console.info(`%cfetch() waiting return from : ${a}`,q);const b=await ua.XHR({method:"GET",url:a,responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"},onprogress:function(i){console.log("%cOn progress function:",q),console.log(`%cgm_xhr onprogress lengthComputable: ${i.lengthComputable}`,q),console.log(`%cgm_xhr onprogress loaded: ${i.loaded}`,q),console.log(`%cgm_xhr onprogress total: ${i.total}`,q),console.log(`%cgm_xhr onprogress total: ${i.position}`,q),console.log(`%cgm_xhr onprogress total: ${i.done}`,q)}}).catch(i=>{console.error(`%cError ${i}`,APP_ERROR_STYLE)});let f=new DOMParser(),l=f.parseFromString(b.responseText.replace(/\n/mg,""),"text/html");var g={};return c===!0?g=l.querySelectorAll(d):g=l.querySelector(d),g},Z=function(a,d=-1){try{var c=(a.children[0].href||"/").split("/");return c[c.length+d]}catch(b){throw Error("Erreur qui ne devrait jamais arriver en getkey :"+b.stack||b)}},Da=function(a){var d=a.trim().split(" ");try{id=dayjs_locale_fr.months.findIndex(c=>c===d[1])+1}catch(c){throw Error("Erreur qui ne devrait jamais arriver en conversion de date :"+c.stack||c)}return`${d[2]}-${id}-${d[0]}T${d[4]}`},Aa=function(a,d=0){d===-1&&(d=a.children.length-1);var c=a.children[d].children[0].innerText;let b=Da(c);var f=dayjs(b);return f};function Ea(a){return new Promise(d=>setTimeout(d,a))}HTMLElement.prototype.appendFirst=function(a){this.firstChild?this.insertBefore(a,this.firstChild):this.appendChild(a)};var ia=async function(a=null,d=null,c=!0){var b="";b+="<style>",b+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",b+="form input {background: #fff;border: 1px solid #9c9c9c;}",b+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",b+="form button:hover {background: gold;}",b+="form label {padding: 0.5em 0.5em 0.5em 0;}",b+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",b+="form input:focus {outline: 3px solid gold;}",b+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",b+="</style>",b+='<form class="form1" action="">',b+='<label for="dtFrom" class="date">Date de début</label>',a?b+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(a).format("YYYY-MM-DD")+'">':b+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',b+='<label for="dtTo" class="date">Date de fin</label>',a?b+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(d).format("YYYY-MM-DD")+'">':b+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',b+="</form>";const{value:f}=await Swal.fire({title:"<strong>Choix de la période</strong>",icon:"info",html:b,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez la période pour la sélection des temps facturés",showLoaderOnConfirm:!0,preConfirm:()=>[document.getElementById("dtFrom").value,document.getElementById("dtTo").value],onRender:l=>{},onOpen:l=>{c===!0&&l.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:l=>{c===!0&&l.querySelector("#dtFrom").removeEventListener("change")},onAfterClose:l=>{},onDestroy:l=>{}});return a=dayjs(f[0]),d=dayjs(f[1]),await Ea(250),[a,d]},pa=async function(a){await Swal.fire({position:"top-end",icon:"success",title:a,showConfirmButton:!1,timer:1500})};const yb=_(V());class Y{static tbl_name="f_archives";static add=async function(a){let d=yb.default.Cfg.dbase,c=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),b={id:a[0].to.format("YYYYMM"),data:a,created_at:a[0].now};console.log(`%cWill create archive for id ${a[0].to.format("YYYYMM")} (YYYYMM)`,q),d.get(Y.tbl_name).push(JSON.parse(JSON.stringify(b))).write()};static exists=function(a){let d=yb.default.Cfg.dbase,c=d.get(Y.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static get=function(a){let d=yb.default.Cfg.dbase;var c=d.get(Y.tbl_name).find({id:a}).value();if(c===void 0){throw Error("Erreur qui ne devrait jamais arriver en Archive.get");return!1}else return console.log(`%cWill use archive for id ${a} (YYYYMM)`,q),c};static delete=function(a=null,d=null){let c=yb.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof d==="string"&&(d=d.format("YYYY-MM-DD"));if(a===null&&d==null){console.log("%cWanna suppress ALL Archives from DB ",q),c.get(Y.tbl_name).remove().write();return}if(d==null){c.get(Y.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isBefore(d),"month"}).write();return}if(a==null){c.get(Y.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isAfter(a,"month")}).write();return}c.get(Y.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMM").isBetween(a,d,"month","[]")}).write()}}var ha=Y;class _a{static isInOldMode=function(a){var d=null;typeof a==="string"?d=dayjs(a):d=a;try{return d.isBefore(dayjs("2020-06-01"))}catch(c){throw Error("Erreur qui ne devrait jamais arriver en IsInOldMode (probablement un probleme sur la conversion de la date en objet dayjs:"+c.stack||c)}}}var Q=_a;const tc=_(V());class J{static tbl_name="students";static add=function(a,d="noname",c="nopath",b="unkonw",f){let l=tc.default.Cfg.dbase;var g=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");let i={id:a,fullname:d,path:c,fundedby:b,created:g};l.get(J.tbl_name).push(JSON.parse(JSON.stringify(i))).write()};static exists=function(a){let d=tc.default.Cfg.dbase;var c=d.get(J.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static getFunded=function(a){let d=tc.default.Cfg.dbase,c=d.get(J.tbl_name).find({id:a}).value();if(c==void 0)throw Error(`IRRECOVERABLE ERROR STUDENT WITH ID ${a} NOT IN DB:`);return c.fundedby};static isAutoFunded=function(a){return J.getFunded(a).toLowerCase()===la};static getFinancialMode=async function(a){const d=await sa(`https://openclassrooms.com/fr/mentorship/students/${a}/dashboard`,".mentorshipStudent__details > p");return d.innerText};static delete=function(a=null,d=null){let c=tc.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof d==="string"&&(d=d.format("YYYY-MM-DD"));if(a===null&&d==null){console.log("%cWanna suppress ALL Students from DB",q),c.get(J.tbl_name).remove().write();return}if(d==null){c.get(J.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isBefore(d),"day"}).write();return}if(a==null){c.get(J.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isAfter(a,"day")}).write();return}c.get(J.tbl_name).remove(function(b){return dayjs(b.created,"YYYY-MM-DDTHH:mm:ssZ[Z]").isBetween(a,d,"day","[]")}).write()};static getAll=async(a,d)=>{var c=!1;let b=tc.default.Cfg.dbase;var f="table.crud-list tbody",l=document.querySelectorAll(f)[1],g=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]");Swal.fire({position:"top-end",icon:"info",toast:!0,title:`mise à jour de la base de donnée des étudiants...
cela peut prendre du temps`,showConfirmButton:!1,timer:1e3});for(const n of l.children){var i=Z(n.children[0],-2),m=n.children[0].innerText,k="non défini";n.children[1].firstElementChild&&(k=n.children[1].firstElementChild.href.split("/").pop());var e=b.get(J.tbl_name).find({id:i}).value();if(e&&c===!1)console.log(`%c${m}(uniquid:${i}) already present in database created at ${e.created}`,q);else{let o=await J.getFinancialMode(i);console.log(`%cFinancial Mode of student ${m}(id:${i}) is ${o}`,q),Toastify({text:`Ajoute l'étudiant : ${m}(${o}) en base`,gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast(),J.add(i,m,k,o,g)}}};static showList=function(){let a=tc.default.Cfg.dbase,d=a.get(J.tbl_name).value();var c="";c+="<table>",c+="<caption>Liste des étudiant</caption>",c+="<thead>",c+="<tr>",c+="<th>Nom</th><th>Parcours</th><th>Financement</th><th>Date de création</th>",c+="</tr>",c+="</thead>",c+="<tbody>";for(var b in d)c+="<tr>",c+=`<td>${d[b].fullname}</td><td>${d[b].path}</td><td>${d[b].fundedby}</td><td>${dayjs(d[b].created,"YYYY-MM-DDTHH:mm:ssZ[Z]").format("DD/MM/YYYY à HH:mm")}</td>`,c+="</tr>";c+="</tbody>",c+="</table>",Swal.fire({title:"<strong>Liste des Etudiants</strong>",icon:"info",html:c,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"fullscreen",onOpen:f=>{var l=f.querySelector("table"),g=new simpleDatatables.DataTable(l)}})};static createManually=async function(a,d,c){let b=["non présent dans la liste","Chef de projet digital","Chef de projet SI","Développeur d'application - Frontend","Développeur Web","Expert en stratégie marketing et communication ","Production de contenu web avec CMS et Content Marketing ","Tech lead"];var f="";f+="<style>",f+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",f+="form input {background: #fff;border: 1px solid #9c9c9c;}",f+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",f+="form button:hover {background: gold;}",f+="form label {padding: 0.5em 0.5em 0.5em 0;}",f+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",f+="form input:focus {outline: 3px solid gold;}",f+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",f+="</style>",f+='<form class="form1" action="">',f+='<label for="student_id" class="name">Reference</label>',f+='<input id="student_id" type="text" value="'+a+'">',f+='<label for="student_name" class="name">Name</label>',f+='<input id="student_name" type="text" value="'+d+'">',f+='<label for="fundedby">Autofinancé</label>',f+='<input id="fundedby" type="checkbox" value="autofunded">',f+='<label for="student_path">Parcours</label>',f+='<input id="student_path" name="student_path" type="text" list="student_path-list">',f+='<datalist id="student_path-list">';for(var l in b)f+=`<option>${b[l]}</option>`;f+="/<datalist>",f+='<label for="session_date">Date</label>',f+='<input id="session_date" type="date" max="2030-12-31" min="2010-12-31" value="'+dayjs(c).format("YYYY-MM-DD")+'">',f+="</form>";const{value:g}=await Swal.fire({title:"<strong>Ajout d'un étudiant en mode manuel</strong>",icon:"info",html:f,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:`votre étudiant(e) ${d} n'a pas été trouvé`,preConfirm:()=>[document.getElementById("student_id").value,document.getElementById("student_name").value,document.getElementById("student_path").value,document.getElementById("fundedby").checked,document.getElementById("session_date").value]});if(g){var i="";g[3]===!0?i=la:i=ra,J.add(g[0],g[1],g[2],i,g[4])}}}var T=J;const nc=_(V());class W{static tbl_name="sessions";static add=async function(a){let d=nc.default.Cfg.dbase;if(GM_config.get("checksessionalreadyexists")===!0)var c=!0;if(Q.isInOldMode(dayjs(a.when)))a.isFunded=!0;else if(a.type.toLowerCase()==="soutenance")a.isFunded=!0;else{var b=T.exists(a.who_id);console.log("is student in db ?",b);if(b==!1){console.warn("%cI'm updating db .... could'nt do anything else",ja),await T.getAll();var f=T.exists(a.who_id);if(f==!1)return T.createManually(a.who_id,a.who_name,a.when)}a.isFunded=!T.isAutoFunded(a.who_id)}c?W.exists(a.id)==!1?d.get(W.tbl_name).push(JSON.parse(JSON.stringify(a))).write():console.info(`%cSession of ${a.who_name} at ${a.when} already present in database table sessions, skip it!`,q):d.get(W.tbl_name).push(JSON.parse(JSON.stringify(a))).write()};static exists=function(a){let d=nc.default.Cfg.dbase;var c=d.get(W.tbl_name).find({id:a}).value();return c===void 0?!1:!0};static delete=function(a=null,d=null){let c=nc.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof d==="string"&&(d=d.format("YYYY-MM-DD"));if(a===null&&d==null){console.log("%cWanna suppress ALL Sessions from DB",q),c.get(W.tbl_name).remove().write();return}if(d==null){c.get(W.tbl_name).remove(function(b){return dayjs(b.when).isBefore(d),"day"}).write();return}if(a==null){c.get(W.tbl_name).remove(function(b){return dayjs(b.when).isAfter(a,"day")}).write();return}c.get(W.tbl_name).remove(function(b){return dayjs(b.when).isBetween(a,d,"day","[]")}).write()};static parseTable=function(a){var d=a.children[0].children[0].innerText,c=Z(a.children[0]),b=a.children[1].children[0].innerText,f=Z(a.children[1],-2),l=a.children[2].innerText.trim().toLowerCase(),g=a.children[3].children.length?a.children[3].children[0].innerText.trim().toLowerCase():"session",i=-1;a.children[4].children.length>0&&(i=a.children[4].children[0].innerText),d=Da(d);var m={id:c,when:d,who_id:f,who_name:b,status:l,type:g,lvl:i};return m}}var N=W;const sb=_(V());class wa{static calculateBill=function(a,d){let c=d.format("YYYYMM");if(ha.exists(c)===!0){console.log(`%cUse Archived version ${c} of accounting`,q);let b=ha.get(c);return b.data}return typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof d==="string"&&(d=d.format("YYYY-MM-DD")),wa.memoized(a,d)};static _calculateBill=function(a,d){typeof a==="string"&&(a=dayjs(a)),typeof d==="string"&&(d=dayjs(d));var c=performance.now();let b=sb.default.Cfg.dbase;var f=b.get(N.tbl_name).filter(h=>dayjs(h.when).isSameOrBefore(d,"day")&&dayjs(h.when).isSameOrAfter(a,"day")),l=f.filter(h=>h.type.toLowerCase()==="soutenance")||0;let g=[0,ba,ca,da,ea,fa,ga],i=[],m=[];for(let h=1;h<=U;h+=1)m[h]=[],m[h][0]={session:null,defense:null},m[h][1]={session:null,defense:null},m[h][2]={session:null,defense:null},m[h][3]={session:null,defense:null},m[h][4]={session:null,defense:null},m[h][5]={session:null,defense:null},m[h][6]={session:null,defense:null},m[h][7]={session:null,defense:null},m[h][0].session=f.filter(j=>j.lvl==h&&j.status===M&&j.isFunded===!0)||0,m[h][1].session=f.filter(j=>j.lvl==h&&j.status===X&&j.isFunded===!0)||0,m[h][2].session=f.filter(j=>j.lvl==h&&j.status===S&&j.isFunded===!0)||0,m[h][3].session=f.filter(j=>j.lvl==h&&(j.status===O||j.status===P)&&j.isFunded===!0)||0,m[h][4].session=f.filter(j=>j.lvl==h&&j.status===M&&j.isFunded===!1)||0,m[h][5].session=f.filter(j=>j.lvl==h&&j.status===X&&j.isFunded===!1)||0,m[h][6].session=f.filter(j=>j.lvl==h&&j.status===S&&j.isFunded===!1)||0,m[h][7].session=f.filter(j=>j.lvl==h&&(j.status===O||j.status===P)&&j.isFunded===!1)||0,m[h][0].defense=l.filter(j=>j.lvl==h&&j.status===M&&j.isFunded===!0)||0,m[h][1].defense=l.filter(j=>j.lvl==h&&j.status===X&&j.isFunded===!0)||0,m[h][2].defense=l.filter(j=>j.lvl==h&&j.status===S&&j.isFunded===!0)||0,m[h][3].defense=l.filter(j=>j.lvl==h&&(j.status===O||j.status===P)&&j.isFunded===!0)||0,m[h][4].defense=l.filter(j=>j.lvl==h&&j.status===M&&j.isFunded===!1)||0,m[h][5].defense=l.filter(j=>j.lvl==h&&j.status===X&&j.isFunded===!1)||0,m[h][6].defense=l.filter(j=>j.lvl==h&&j.status===S&&j.isFunded===!1)||0,m[h][7].defense=l.filter(j=>j.lvl==h&&(j.status===O||j.status===P)&&j.isFunded===!1)||0;var k=performance.now();console.log("%cFiltering took "+(k-c)+" milliseconds.",F),i.push({total_errors:0,total_filtered:0,total:f.value().length,control:0}),i.push({type:"bad level",data:f.filter(h=>h.lvl<1||h.lvl>U).value()}),i.push({type:"bad status",data:f.filter(h=>h.status!==M&&h.status!==X&&h.status!==S&&h.status!==O&&h.status!==P).value()}),i.push({type:"bad funded",data:f.filter(h=>h.isFunded!==!1&&h.isFunded!==!0).value()}),i[0].total_errors=i[1].data.length+i[2].data.length+i[3].data.length;var e=[],n=dayjs().format("YYYY-MM-DDTHH:mm:ssZ[Z]"),o=[];for(let h=1;h<=U;h+=1)Q.isInOldMode(a)?o[h]=[g[h],0,g[h]/2,g[h]/2,g[h],0,g[h]/2,g[h]/2]:o[h]=[g[h],0,0,g[h]/2,g[h]/2,0,0,g[h]/4];var B=performance.now();console.log("%cPU calculated took "+(B-k)+" milliseconds.",F);var z=f.filter(h=>h.type.toLowerCase()!=="soutenance"&&h.status===M&&h.isFunded===!1),s=z.groupBy(h=>h.who_id),y=[];for(var w in s.value())y.push({who_id:w,who_name:s.value()[w][0].who_name,sessions:s.value()[w].length});var u=performance.now();console.log("%cBonus took "+(u-B)+" milliseconds.",F);var r=[],x=[],C=0;for(let h=1;h<=U;h+=1){let j=[];j[0]=m[h][0].session.value().length,j[1]=m[h][1].session.value().length,j[2]=m[h][2].session.value().length,j[3]=m[h][3].session.value().length,j[4]=m[h][4].session.value().length,j[5]=m[h][5].session.value().length,j[6]=m[h][6].session.value().length,j[7]=m[h][7].session.value().length,r[h]=[j[0],j[1],j[2],j[3],j[4],j[5],j[6],j[7]],C+=r[h].reduce((p,E)=>p+E);let v=[];v[0]=m[h][0].defense.value().length,v[1]=m[h][1].defense.value().length,v[2]=m[h][2].defense.value().length,v[3]=m[h][3].defense.value().length,v[4]=m[h][4].defense.value().length,v[5]=m[h][5].defense.value().length,v[6]=m[h][6].defense.value().length,v[7]=m[h][7].defense.value().length,x[h]=[v[0],v[1],v[2],v[3],v[4],v[5],v[6],v[7]]}i[0].total_filtered=C,i[0].control=i[0].total-C;var t=performance.now();console.log("%cPrecalc some vars took "+(t-u)+" milliseconds.",F),e.push({from:a,to:d,created_at:n,errors:i,bonus:y,max_level:U});for(let h=1;h<=U;h+=1){let j=m[h];e.push({sessions:{data:[j[0].session,j[1].session,j[2].session,j[3].session,j[4].session,j[5].session,j[6].session,j[7].session],number:r[h],pu:o[h]},defenses:{data:[j[0].defense,j[1].defense,j[2].defense,j[3].defense,j[4].defense,j[5].defense,j[6].defense,j[7].defense],number:x[h],pu:o[h]}})}var G=performance.now();return console.log("%cMy array full storage took "+(G-t)+" milliseconds.",F),d.isBefore(dayjs())&&ha.add(e),e};static memoized=moize.default(wa._calculateBill,{maxAge:12e4,isSerialized:!0,onCacheAdd:function(a,d,c){console.log("%cAdd data to cache",q)},onCacheHit:function(){console.log("%cGet data from cache",q)}})}var xa=wa;const cc=_(V());class D{static tbl_name="history_session_cache";static getSessionPage=function(a){a.get("day")<a.daysInMonth()&&(a=a.endOf("month")),console.log(`%cSearch in history session cache data for id: ${a.format("DD/MM/YYYY")}`,q);let d=cc.default.Cfg.dbase;if(!d.has(D.tbl_name).value()){throw Error(`DB ${D.db_name} NOT FOUND`);return-1}let c=d.get(D.tbl_name).find({id:+a.format("YYYYMMDD")}).value();return c===void 0?-1:c};static getNearestSessionPage=function(a){a.get("day")<a.daysInMonth()&&(a=a.endOf("month")),console.log(`%cSearch in history session cache NEAREST cached data for id: ${a.format("DD/MM/YYYY")}`,q);let d=cc.default.Cfg.dbase;if(!d.has(D.tbl_name).value()){throw Error(`DB ${D.db_name} NOT FOUND`);return-1}let c=+a.format("YYYYMMDD"),b=d.get(D.tbl_name).value().map(g=>+g.id-c);const f=g=>Math.min(...g);let l=f(b)+c;return console.log(`%cNearest data in history session cache is data with id: ${a.format("DD/MM/YYYY")}`,q),b=d.get(D.tbl_name).find({id:l}).value(),b===void 0?-1:b};static getSameOrNearestSessionPage=function(a){let d=D.getSessionPage(a);return d===-1&&(d=D.getNearestSessionPage(a)),d};static delete=function(a=null,d=null){let c=cc.default.Cfg.dbase;typeof a==="string"&&(a=a.format("YYYY-MM-DD")),typeof d==="string"&&(d=d.format("YYYY-MM-DD"));if(a===null&&d==null){c.get(D.tbl_name).remove().write(),console.log("%cWanna suppress ALL History from DB",q);return}if(d==null){c.get(D.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isBefore(d),"day"}).write();return}if(a==null){c.get(D.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isAfter(a,"day")}).write();return}c.get(D.tbl_name).remove(function(b){return dayjs(b.id,"YYYYMMDD").isBetween(a,d,"day","[]")}).write()};static addOrUpdateSessionPage=function(a=1,d=dayjs("1970-10-06")){D.getSessionPage(d)==-1?D.addSessionPage(a,d):D.updateSessionPage(a,d)};static updateSessionPage=function(a=1,d=dayjs("1970-10-06")){let c=cc.default.Cfg.dbase,b=D.getSessionPage(d);if(b==-1){throw Error("session page not found in history");return-1}c.get(D.tbl_name).find({id:+d.format("YYYYMMDD")}).assign({page:a}).write()};static addSessionPage=function(a=1,d=dayjs("1970-10-06")){let c=cc.default.Cfg.dbase;c.get(D.tbl_name).push(JSON.parse(JSON.stringify({id:+d.format("YYYYMMDD"),page:a}))).write()}}var ta=D;const hc=_(V());class jb{static detail_bill="truc";static getListDetailBill=function(a,d){let c=hc.default.Cfg.dbase,b=c.get(N.tbl_name).filter(e=>dayjs(e.when).isSameOrBefore(d,"day")&&dayjs(e.when).isSameOrAfter(a,"day")).sortBy(function(e){return dayjs(e.when).valueOf()}).value();var f=[0,ba,ca,da,ea,fa,ga];let l=0;for(var g in b){if(b[g].lvl>f.length-1)throw Error("ERROR PRICE ARRAY MUST BE UPDATED IN LISTS.JS");var i=b[g].isFunded===!0?f[b[g].lvl]:f[b[g].lvl]*.5,m=0,k=!0;Q.isInOldMode(dayjs(b[g].when))?b[g].status===M?m=i:(b[g].status===O||b[g].status===P||b[g].status===S)&&(m=i*.5):(k=!1,b[g].status===M?m=i:(b[g].status===O||b[g].status===P)&&(m=i*.5)),l+=m,b[g].iPu=i,b[g].oldMode=k,b[g].iCumul=l,b[g].iFPu=m}return b};static getListStatistic=function(a,d){let c=a,b=[],f=[];for(var l=performance.now();c.isSameOrBefore(d,"day");){let i=c.endOf("month");b.push(Accounting.calculateBill(c,i)),c=c.add(1,"month")}var g=performance.now();console.log("%cComputed data between the two dates in"+(g-l)+" milliseconds.",F),f[1][1]=666}}var Ba=jb;var ya=function(a,d){let c=[[0,1,2,3,4,5,5],[5,1,2,3,4,5,5],[4,5,1,2,3,4,4],[3,4,5,1,2,3,3],[2,3,4,5,1,2,2],[1,2,3,4,5,1,1],[0,1,2,3,4,5,0]];return Math.trunc(d.diff(a,"days")/7)*5+c[a.day()][d.day()]};class kb{static addFooter=async function(a,d,c={}){const{degrees:b,PDFDocument:f,rgb:l,StandardFonts:g}=PDFLib,i=a.getPageCount(),m="8".repeat(i),k=await a.embedFont(g.TimesRoman),e=12,n=k.widthOfTextAtSize(`page ${m} / ${m}`,e),o=10,B=10,z=1,s=l(0/255,0/255,0/255),y=l(253/255,246/255,227/255),w=5,u=5,r=3,x=3,C=!0;a.getPages().forEach((t,G)=>{if(!(C===!0&&G==0)){const{width:h,height:j}=t.getSize(),v=e+2*z+r+x;t.moveTo(o+w,e+x),t.setFont(k),t.setFontSize(e),t.setFontColor(l(1,0,0)),d!==void 0&&t.drawText(`${d}`),t.drawText(`page ${G+1} / ${i}`,{x:h-n-u}),t.drawRectangle({x:o,y:10,width:h-(o+B),height:v,color:y,opacity:.6,borderColor:s,borderWidth:z})}})}}var Ka=kb;const Jb=_(V());class $a{static export=function(){return console.log("%cWanna export DBASE",q),JSON.stringify(Jb.default.Cfg.dbase.getState())};static import=function(a){return console.log(`%cWanna import ${a} in DBASE`,q),console.log("%c !!!!!! TYPE NOT CHECKED BE CARREFULL",q),Jb.default.Cfg.dbase.setState(JSON.parse(a)).write()}}var za=$a;var La=async function(){var a="";a+="<style>div.about_content {background-color: #fed9ff;/*width: 600px;*/height: var(--heigth, 80%);overflow-x: hidden;overflow-y: auto;text-align: left;padding: 20px;}</style>",a+='<div class="about_content" style="--heigth: 600px;">',a+='<div class="about_content__wrapper">';const d=await ua.XHR({method:"GET",url:"https://raw.githubusercontent.com/StephaneTy-Pro/OC-Mentors-AccountAddon/master/README.md",responseType:"text/html",headers:{"User-Agent":"Mozilla/5.0"}});var c=d.responseText,b=new showdown.Converter(),f=b.makeHtml(c);a+=f,a+="</div>",a+="</div>",Swal.fire({title:`<strong>A propos de ${qa}</strong>`,icon:"info",html:a,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},ma=function(){var a="table.crud-list tbody",d=document.querySelector(a),c=!1;if(d.querySelector("[type=checkbox]")===null){for(const o of d.children){var b=Z(o.children[0]),f=document.createElement("input");f.type="checkbox",f.name="name",f.value=b,f.id="id",c=N.exists(b),c===!0&&(f.checked=!0);var l=document.createElement("td");l.style="text-align: center",l.appendChild(f),o.appendChild(l)}a="table.crud-list thead tr";var g=document.querySelector(a);f=document.createElement("input"),f.type="checkbox",f.name="name",f.value="value",f.id="id",f.onclick=function(){document.querySelectorAll("tbody input[type=checkbox]").forEach(o=>o.checked=!o.checked)},f.style="visibility: hidden;";var i=document.createElement("label");i.innerText="in DB",i.style="display:block;",i.onMouseOver="this.style.cursor=pointer;",i.onMouseOut="this.style.cursor=auto;",i.appendChild(f),l=document.createElement("td"),l.style="text-align: center",l.appendChild(i),g.appendChild(l)}else{for(var m=d.querySelectorAll("[type=checkbox]"),k=m.length,e=new Array(k);k--;e[k]=m[k]);for(var n in e)c=N.exists(e[n].value),c===!0?e[n].checked=!0:e[n].checked=!1}},Ma=async function(){var[a,d]=await ia(dayjs().startOf("month"),dayjs().endOf("month"));let c=Ba.getListDetailBill(a,d),b="";b+="<table>",b+="<thead>",b+="<tr><th>Quand</th><th>Qui</th><th>Financé ?</th><th>Ancien Mode ?</th><th>PU HT</th><th>Statut</th><th>PU (corrigé) HT</th><th>Cumul</th></tr>",b+="<thead>",b+="<tbody>";var f=0;for(let l=0;l<c.length;l+=1)b+="<tr>",b+=`<td>${dayjs(c[l].when).format("DD/MM/YYYY à HH:mm:ss")}</td><td>${c[l].who_name}</td><td>${c[l].isFunded===!0?"Oui":"Non"}</td><td>${c[l].oldMode===!0?"Oui":"Non"}</td><td>${c[l].iPu}</td><td>${c[l].status}</td><td>${c[l].iFPu}</td><td>${c[l].iCumul}€</td>`,b+="</tr>";b+="</tbody>",b+="</table>",Swal.fire({title:`<strong>Liste détaillées des sessions du ${a.format("DD/MM/YYYY")} au ${d.format("DD/MM/YYYY")}</strong>`,icon:"info",html:b,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:l=>{var g=l.querySelector("table"),i=new simpleDatatables.DataTable(g)}})},Na=async function(){for(var a="table.crud-list tbody input:checked",d=document.querySelectorAll(a),c=0;c<d.length;c+=1){var b=d[c].parentElement.parentElement,f=N.parseTable(b);await N.add(f)}pa(`Collecte des sessions cochées
terminée`)},Oa=async function(){var[a,d]=await ia(dayjs().startOf("month"),dayjs().endOf("month"));let c=0,b=GM_config.get("maxfetchpg"),f=!0;var l={};let g=[],i=1,m=ta.getSameOrNearestSessionPage(d);for(m!==void 0&&m.page>i&&(i=m.page);f;){if(c>b){console.warn("%cEMERGENCY EXIT LOOP",ja);break}l=await ab(a,d,i,g),l.length>0&&dayjs(l[l.length-1].when).isSameOrBefore(a)===!0&&(f=!1),i+=1,c+=1}for(var k in l){if(dayjs(l[k].when).isBefore(a,"day")===!0){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions
Collecte terminée`,showConfirmButton:!1,timer:1500});break}if(dayjs(l[k].when).isAfter(d,"day")===!0)continue;dayjs(l[k].when).isBetween(a,d,"day","[]")&&await N.add(l[k])}ma(),pa("Collecte automatique terminée")},ab=async function(a,d,c=1,b=[]){Swal.fire({position:"top-end",icon:"info",toast:!0,title:`Collecte des sessions de l'historique
du `+a.format("DD/MM/YYYY")+" au "+d.format("DD/MM/YYYY")+`
page : `+c+`
cela peut prendre du temps...`,showConfirmButton:!1,timer:3e3});let f=await sa(`https://openclassrooms.com/fr/mentorship/dashboard/mentorship-sessions-history?page=${c}`,"table.crud-list tbody");if(f===null)throw new Error("Something went wrong .... try to navigate forward and backward or click some buttons to change url");let l=Aa(f),g=Aa(f,-1);if(l.get("month")!=g.get("month")){let e=g.endOf("month");ta.addOrUpdateSessionPage(c,e)}if(g.isAfter(d,"day")===!0)return console.log(`%cOptimization: oldest (last) data from page are at :${g.format("DD/MM/YYYY")}, don't analyze what was before end date of extraction ${d.format("DD/MM/YYYY")}`,q),b;for(var i=0;i<f.children.length;i+=1){var m=f.children[i],k=N.parseTable(m);b.push(k)}return b},Pa=function(){const{degrees:a,PDFDocument:d,rgb:c,StandardFonts:b}=PDFLib;async function f(){const i="https://pdf-lib.js.org/assets/with_update_sections.pdf",m=await fetch(i).then(y=>y.arrayBuffer()),k=await d.load(m),e=await k.embedFont(b.Helvetica),n=k.getPages(),o=n[0],{width:B,height:z}=o.getSize();o.drawText("This text was added with JavaScript!",{x:5,y:z/2+300,size:50,font:e,color:c(.95,.1,.1),rotate:a(-45)});const s=await k.save();download(s,"pdf-lib_modification_example.pdf","application/pdf")}async function l(){const i=await d.create(),m=await i.embedFont(b.TimesRoman),k=i.addPage(),{width:e,height:n}=k.getSize(),o=30;k.drawText("Creating PDFs in JavaScript is awesome!",{x:50,y:n-4*o,size:o,font:m,color:c(0,.53,.71)});const B=await i.save();download(B,"pdf-lib_modification_example.pdf","application/pdf")}async function g(){var[i,m]=await ia(dayjs().startOf("month"),dayjs().endOf("month"));let k=Ba.getListDetailBill(i,m);const e=await d.create(),n=await e.embedFont(b.TimesRoman),o=e.addPage(),{width:B,height:z}=o.getSize(),s=30;o.drawText(`Prestations en détail

 du ${i.format("DD/MM/YYYY")} au ${m.format("DD/MM/YYYY")}`,{x:50,y:z/2-s,size:s,font:n,color:c(116/255,81/255,235/255)});let y=12,w=1.25,u=e.addPage();u.setFontSize(y),u.line_space=w,u.font=n;let r=1,x=20,C=w*y+x,t=z/2;const G=function(E){const H="LOrEm ipsum DOLor sit aMet, conSEc/tetUr 25 porttitor. ";return E*1.0925*(n.widthOfTextAtSize(H,y)/H.length)};let h=[0,G(18),G(36),G(18),G(5),G(8),G(5),G(7)],j=o.lineHeight,v=25;for(let E=1;E<k.length;E+=1){t=z-w*y*r,t<C&&(r=1,u=e.addPage(),u.font=n,u.setFontSize(y),u.line_space=w,t=z-w*y*r);if(r===1){let I=["","Quand","Qui","Quoi","PU","Statut","Puf","Montant"],L=v;u.moveTo(L,t);for(let K=1;K<I.length;K+=1)u.drawText(I[K],{x:L}),L+=h[K];r+=1,t=z-w*y*r}let H=v;u.drawText(dayjs(k[E].when).format("DD/MM/YYYY à HH:mm"),{font:n,size:y,y:t,x:H,lineHeight:j}),H+=h[1],u.drawText(k[E].who_name.trim(),{font:n,size:y,y:t,x:H,lineHeight:j}),H+=h[2],u.drawText(`${k[E].type} ${k[E].isFunded===!0?"F.":"AF"} (${k[E].lvl})`,{font:n,size:y,y:t,x:H,lineHeight:j}),H+=h[3],u.drawText(k[E].iPu.toString(),{font:n,size:y,y:t,x:H,lineHeight:j}),H+=h[4];let A=k[E].status;k[E].status==="étudiant absent"&&(A="absent"),u.drawText(A,{font:n,size:y,y:t,x:H,lineHeight:j}),H+=h[5],u.drawText(k[E].iFPu.toString(),{font:n,size:y,y:t,x:H,lineHeight:j}),H+=h[6],u.drawText(k[E].iCumul.toString(),{font:n,size:y,y:t,x:H,lineHeight:j}),r+=1}Ka.addFooter(e,"Généré avec Facturier version 1.01");const p=await e.save();download(p,`prestations_facturees_detail_${i.format("YYYYMMDD")}-${m.format("YYYYMMDD")}.pdf`,"application/pdf")}g()},Qa=async function(){GM_addStyle('.formgrid{font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", Helvetica, Arial, sans-serif;}'),GM_addStyle(".swal2-styled[type=button]{background-color:#3085d6;border-radius:.75em;color:#fff;font-size:1.0625em;border-left-color:#3085d6;border-right-color:#3085d6;display:inline-block}.formgrid{display:grid;grid-template-columns:1fr 1em 1fr;grid-gap:.3em .6em;grid-auto-flow:dense;align-items:center}input,output,textarea,select,button{grid-column:2 / 4;width:auto;margin:0}legend{font-size:1.2em;width:100%;border-bottom:1px dotted #99c}fieldset{max-width:40em;padding:4px;margin:2em auto;border:0 none}");let a="";a+="<legend>Que voulez vous faire ?</legend>",a+="<fieldset>",a+='<div class="formgrid">',a+='Epurer<button id="answer1" data-action="raz" class="swal2-styled" type="button">RAZ</button>',a+='Exporter<button id="answer2" data-action="export" class="swal2-styled" type="button">Exporter</button>',a+='Importer<button id="answer3" data-action="import" class="swal2-styled" type="button">Importer</button>',a+="</fieldset>",a+="</div>";const{value:d}=await Swal.fire({title:"Gestion de la base de donnée",html:a,focusConfirm:!1,preConfirm:()=>[document.getElementById("answer1").value,document.getElementById("answer2").value],onOpen:c=>{c.querySelector(".formgrid").addEventListener("click",function(b){const f=function(i){i.target.matches('button[data-action="raz"]')&&(Swal.close(),db());return},l=function(i){i.target.matches('button[data-action="export"]')&&(Swal.close(),bb());return},g=function(i){i.target.matches('button[data-action="import"]')&&(Swal.close(),cb());return};f(b),l(b),g(b)}),console.log("%conOpen popup","color:coral")},onClose:c=>{c.querySelector(".formgrid").removeEventListener("click"),console.log("%conClose popup","color:coral")}});d&&Swal.fire(JSON.stringify(d))},bb=async function(){let a=za.export();console.log(`%cWanna export : ${a}`,q);let d=dayjs(),c="";c+=`<a id="download" href="data:text/plain;charset=utf-8,${encodeURIComponent(a)}" download="export_${d.format("YYYYMMDD")}.json" style="display:none"></a>`,c+=`<a id="download" href="data:text/plain;charset=utf-8,${encodeURIComponent(a)}" download="export_${d.format("YYYYMMDD")}.json">export_${d.format("YYYYMMDD")}.json</a>`,Swal.fire({title:"Export de la base de donnée",html:c,focusConfirm:!1,onOpen:b=>{b.querySelector("#download").click()},onClose:b=>{}})},cb=async function(){console.log("%cWanna import DATABASE",q);const{value:a}=await Swal.fire({title:"Selection de la sauvegarde (json)",input:"file",inputAttributes:{accept:".json","aria-label":"Upload your database"}});if(a){const d=new FileReader();d.onload=c=>{za.import(c.target.result),ma(),pa("Import terminé")},d.readAsText(a)}},db=async function(){GM_addStyle(".form_addon {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}"),GM_addStyle(".form_addon input {background: #fff;border: 1px solid #9c9c9c;}"),GM_addStyle(".form_addon button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}"),GM_addStyle(".form_addon button:hover {background: gold;}"),GM_addStyle(".form_addon label {padding: 0.5em 0.5em 0.5em 0;}"),GM_addStyle(".form_addon input {padding: 0.7em;margin-bottom: 0.5rem;}"),GM_addStyle(".form_addon input:focus {outline: 3px solid gold;}"),GM_addStyle("@media (min-width: 400px) {.form_addon {grid-template-columns: 200px 1fr;grid-gap: 16px;} .form_addon label {text-align: right;grid-column: 1 / 2;} .form_addon input, .form_addon button {grid-column: 2 / 3;}}");var a="";a+='<form id="RAZ" class="form_addon" action="">',a+='<label for="students" class="cbox">Etudiants</label>',a+='<input id="students" type="checkbox" value="del_students_true" checked>',a+='<label for="sessions" class="cbox">Sessions</label>',a+='<input id="sessions" type="checkbox" value="del_sessions_true" checked>',a+='<label for="archives" class="cbox">Archives : factures</label>',a+='<input id="archives" type="checkbox" value="del_archives_true" checked>',a+='<label for="history_cache" class="cbox">Signet historique</label>',a+='<input id="history_cache" type="checkbox" value="del_history_cache_true" checked>',a+='<label for="radio1">filtrer la date</label>',a+='<input type="radio" id="radio1" name="date_filter" value="false" checked>',a+='<label for="radio2">ne pas filtrer</label>',a+='<input type="radio" id="radio2" name="date_filter" value="true">',a+='<label for="dtFrom" class="date">Date de début</label>',a+='<input id="dtFrom" type="date" max="2030-12-31" min="2010-12-31">',a+='<label for="dtTo" class="date">Date de fin</label>',a+='<input id="dtTo" type="date" max="2030-12-31" min="2010-12-31">',a+="<!-- Switch -->",a+='<input type="checkbox" class="switch" name="s1" id="s1">',a+='<label for="s1">Switch</label>',a+="</form>";const{value:d}=await Swal.fire({title:"<strong>RAZ des données</strong>",icon:"info",html:a,showCloseButton:!0,focusConfirm:!1,position:"top-start",grow:"row",footer:"Choisissez ce que vous allez supprimer de la base de donnée",preConfirm:()=>{let m=document.getElementsByName("date_filter"),k="notfound";for(var e in m)m[e].checked===!0&&(k=m[e].value);return console.log(document.getElementById("s1")),[document.getElementById("students").checked,document.getElementById("sessions").checked,document.getElementById("archives").checked,document.getElementById("history_cache").checked,document.getElementById("dtFrom").disabled===!0?null:document.getElementById("dtFrom").value,document.getElementById("dtTo").disabled===!0?null:document.getElementById("dtTo").value,k]},onOpen:m=>{m.querySelector("#radio1").addEventListener("change",function(){console.log(document.getElementById("radio1").checked);let k=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!k,document.getElementById("dtTo").disabled=!k}),m.querySelector("#radio2").addEventListener("change",function(){let k=document.getElementById("radio1").checked;document.getElementById("dtFrom").disabled=!k,document.getElementById("dtTo").disabled=!k}),m.querySelector("#dtFrom").addEventListener("change",function(){document.getElementById("dtTo").value=dayjs(document.getElementById("dtFrom").value).endOf("month").format("YYYY-MM-DD")})},onClose:m=>{m.querySelector("#radio1").removeEventListener("change"),m.querySelector("#radio2").removeEventListener("change"),m.querySelector("#dtFrom").removeEventListener("change")}});let c=d[0],b=d[1],f=d[2],l=d[3];console.log(`wanna raz students ? ${c}, wanna raz sessions ? ${b}, wanna raz archives ? ${f}`);let g=d[4]?dayjs(d[4]):null,i=d[5]?dayjs(d[5]):null;c===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des étudiants",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),T.delete(g,i)),b===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des sessions",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),N.delete(g,i),ma()),f===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base des archives (financières)",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),ha.delete(g,i)),l===!0&&(setTimeout(function(){Toastify({text:"Suppression de la base du cache des historique de session",gravity:"top",position:"right",close:!0,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}).showToast()},500),ta.delete(g,i))},Ra=async function(){var a="";a+="<style>",a+="form {display: grid;padding: 1em;background: #f9f9f9;border: 1px solid #c1c1c1;margin: 2rem auto 0 auto;max-width: 600px;padding: 1em;}",a+="form input {background: #fff;border: 1px solid #9c9c9c;}",a+="form button {background: lightgrey;padding: 0.7em;width: 100%;border: 0;}",a+="form button:hover {background: gold;}",a+="form label {padding: 0.5em 0.5em 0.5em 0;}",a+="form input {padding: 0.7em;margin-bottom: 0.5rem;}",a+="form input:focus {outline: 3px solid gold;}",a+="@media (min-width: 400px) {form {grid-template-columns: 200px 1fr;grid-gap: 16px;}label {text-align: right;grid-column: 1 / 2;}input,button {grid-column: 2 / 3;}}",a+="</style>",a+='<form class="form1" action="">',a+='<label for="dd" class="date">Date de début</label>',a+='<input id="dd" type="date" max="2030-12-31" min="2010-12-31">',a+='<label for="df" class="date">Date de fin</label>',a+='<input id="df" type="date" max="2030-12-31" min="2010-12-31">',a+="</form>";var[d,c]=await ia(dayjs().startOf("month"),dayjs().endOf("month")),b=xa.calculateBill(d,c);Q.isInOldMode(d)?eb(d,c,b):fb(d,c,b)},eb=function(a,d,c){var b="",f=null,l=0,g=0,i=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],m=c[0].max_level;b+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",b+='<div class="wrapper">',b+="<table>",b+="<caption>Sessions de mentorat</caption>",b+="<thead>",b+="<tr>",b+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>";for(var k in i){b+="<tr>",b+="<td>"+i[k][1]+"</td>",f=c[i[k][0]].sessions;let r=f.number[0],x=f.number[4],C=r*f.pu[0],t=x*f.pu[4];l+=r+x,g+=C+t,b+=`<td>${r+x}</td><td>${(f.pu[0]+f.pu[4])/2}</td><td>${C+t}€</td>`,b+="</tr>"}b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${l}</td><td></td><td>${g}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>";var e=l,n=g;l=0,g=0,b+="<table>",b+="<caption>Sessions de mentorat (NoShow)</caption>",b+="<thead>",b+="<tr>",b+='<th>Type</th><th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',b+="</tr>",b+="</thead>",b+="<tbody>";for(k in i){b+="<tr>",b+="<td>"+i[k][1]+"</td>",f=c[i[k][0]].sessions;let r=f.number[2]+f.number[3],x=f.number[6]+f.number[7],C=r*(f.pu[2]+f.pu[3])/2,t=x*(f.pu[6]+f.pu[7])/2;l+=r+x,g+=C+t,b+=`<td>${r+x}</td><td>${(f.pu[2]+f.pu[3]+f.pu[6]+f.pu[7])/4}</td><td>${C+t}€</td>`,b+="</tr>"}b+="</tbody>",b+="<tfoot>",b+="<tr>",b+="<td>Total</td>",b+=`<td>${l}</td><td></td><td>${g}€</td>`,b+="</tr>",b+="<tr>",b+="</tr>",b+="</tfoot>",b+="</table>",e+=l,n+=g;for(var o=0,B=0,z=0,s=0,y=0,w=1;w<=m;){o+=c[w].sessions.number[1],o+=c[w].sessions.number[5];for(let r in[...Array(8).keys()]){let x=c[w].sessions.number[r];B+=x,z+=x*c[w].sessions.pu[r],x=c[w].defenses.number[r],s+=x,y+=x*c[w].defenses.pu[r]}w+=1}let u=c[0].errors[0].total_errors;B+=u,b+=`<p>Ces ${B} session(s) se répartissent en ${e-l} session(s) de mentorat (${n-g}€)`,b+=`, ${l} NoShows (${g}€)`,u==0?b+=`et ${o} session(s) annulée(s) (${0}€) </p>`:b+=`, ${o} session(s) annulée(s) (${0}€) ainsi que ${u} session(s) en anomalie (cf 1.)`,b+=`<br >Sur le total de ${B} session(s) (${z}€) `,b+=`vous avez réalisé ${s} soutenance(s) (${y}€)</p>`;if(u>0){let r=c[0].errors[0];b+=`(1) Attention, il y a ${u} session(s) qui présente(nt) une anomalie c'est peut être normal : exemple un étudiant qui n'a plus de parcours associé au moment de la collecte de session`,b+=", pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${r.total_errors} erreurs relevées , notez qu'il y a ${r.total_filtered} ennregistrements filtrés(lvl,...)  sur ${r.total} enregistrements dans la période, le total des erreurs devrait donc être de ${r.control} erreurs`),console.warn("détail"),console.warn(`${c[0].errors[1].data.length} erreurs de type ${c[0].errors[1].type} data are`,c[0].errors[1].data),console.warn(`${c[0].errors[2].data.length} erreurs de type ${c[0].errors[2].type} data are`,c[0].errors[2].data),console.warn(`${c[0].errors[3].data.length} erreurs de type ${c[0].errors[3].type} data are`,c[0].errors[3].data)}b+=`<p>Soit un total général à facturer de ${z}€`,Swal.fire({title:`<strong>Liste des formations tarifées du ${a.format("DD/MM/YYYY")} au ${d.format("DD/MM/YYYY")}</strong>`,html:b,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},fb=function(a,d,c){console.log("enter computation bill");var b=performance.now(),f="",l=null,g=0,i=0,m=0,k=0,e=[[4,"Groupe"],[1,"Niveau 1"],[2,"Niveau 2"],[3,"Niveau 3"]],n=c[0].max_level;f+="<style>.wrapper{  display: grid;grid-gap: 10px;grid-template-column: 1fr 1fr;}</style>",f+='<div class="wrapper">',f+="<table>",f+="<caption>Sessions de mentorat (dont soutenances)</caption>",f+="<thead>",f+="<tr>",f+='<th rowspan="2">Type</th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th>',f+="</tr>",f+="<tr>",f+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+="</tr>",f+="</thead>",f+="<tbody>";for(var o=1;o<=n;){f+="<tr>",f+=`<td> Niveau ${o}</td>`;let A=c[o].sessions,I=c[o].defenses,L=A.number[0],K=A.number[4],$=L*A.pu[0],aa=K*A.pu[4];g+=L,i+=K,m+=$,k+=aa,f+=`<td>${L} (${I.number[0]})</td><td>${A.pu[0]}</td><td>${$}€</td>`,f+=`<td>${K} (${I.number[4]})</td><td>${A.pu[4]}</td><td>${aa}€</td>`,f+=`<td>${L+K} (${I.number[0]+I.number[4]})</td><td>${$+aa}€</td>`,f+="</tr>",o+=1}var B=performance.now();console.log("%cCalculate first array"+(B-b)+" milliseconds.",F),f+="</tbody>",f+="<tfoot>",f+="<tr>",f+="<td>Total</td>",f+=`<td>${g}</td><td></td><td>${m}€</td>`,f+=`<td>${i}</td><td></td><td>${k}€</td>`,f+=`<td>${g+i}</td><td>${m+k}€</td>`,f+="</tr>",f+="<tr>",f+="</tr>",f+="</tfoot>",f+="</table>";var z=g+i,s=m+k;for(g=0,i=0,m=0,k=0,f+="<table>",f+="<caption>Sessions de mentorat :NoShow (dont soutenances)</caption>",f+="<thead>",f+="<tr>",f+='<th rowspan="2"></th><th colspan="3" scope="colgroup">Financés</th> <th colspan="3" scope="colgroup">Autofinancés</th><th colspan="2" scope="colgroup">Ensemble</th>',f+="</tr>",f+="<tr>",f+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+='<th><abbr title="nombre">nb</abbr></th><th>PU(<abbr title="hors taxes">HT</abbr>)</th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+='<th><abbr title="nombre">nb</abbr></th><th>Total(<abbr title="hors taxes">HT</abbr>)</th>',f+="</tr>",f+="</thead>",f+="<tbody>",o=1;o<=n;){f+="<tr>",f+=`<td> Niveau ${o}</td>`;let A=c[o].sessions,I=c[o].defenses,L=A.number[3],K=A.number[7],$=L*A.pu[3],aa=K*A.pu[7];g+=L,i+=K,m+=$,k+=aa,f+=`<td>${L} (${I.number[3]})</td><td>${A.pu[3]}</td><td>${$}€</td>`,f+=`<td>${K} (${I.number[7]})</td><td>${A.pu[7]}</td><td>${aa}€</td>`,f+=`<td>${L+K}</td><td>${$+aa}€</td>`,f+="</tr>",o+=1}f+="</tbody>",f+="<tfoot>",f+="<tr>",f+="<td>Total</td>",f+=`<td>${g}</td><td></td><td>${m}€</td>`,f+=`<td>${i}</td><td></td><td>${k}€</td>`,f+=`<td>${g+i}</td><td>${m+k}€</td>`,f+="</tr>",f+="<tr>",f+="</tr>",f+="</tfoot>",f+="</table>";var y=performance.now();console.log("%cCalculate second html table took "+(y-B)+" milliseconds.",F),z+=g+i,s+=m+k;var w=0,u=0,r=0,x=0,C=0;for(o=1;o<=n;){w+=c[o].sessions.number[1],w+=c[o].sessions.number[2],w+=c[o].sessions.number[5],w+=c[o].sessions.number[6];for(let A in[...Array(8).keys()]){let I=c[o].sessions.number[A];u+=I,r+=I*c[o].sessions.pu[A],I=c[o].defenses.number[A],x+=I,C+=I*c[o].defenses.pu[A]}o+=1}let t=c[0].errors[0].total_errors;u+=t,f+=`<p>Ces ${u} session(s) se répartissent en ${z-g-i} session(s) de mentorat (${s-m-k}€)`,f+=`, ${g+i} NoShows (${m+k}€)`,t==0?f+=`et ${w} session(s) annulée(s) (${0}€)`:f+=`, ${w} session(s) annulée(s) (${0}€) ainsi que ${t} session(s) en anomalie (cf 1.)`,f+=`<br>Sur le total de ${u} session(s) (${r}€) `,f+=`vous avez réalisé ${x} soutenance(s) (${C}€)</p>`;if(t>0){let A=c[0].errors[0];f+=`(1) Attention, il y a ${t} session(s) qui présente(nt) une anomalie c'est peut être normal : exemple un étudiant qui n'a plus de parcours associé au moment de la collecte de session`,f+=", pour plus d'information regarder du côté de la console (en 'warn')</p>",console.warn("Sessions en anomalie"),console.warn(`il y a ${A.total_errors} erreurs relevées , notez qu'il y a ${A.total_filtered} ennregistrements filtrés(lvl,...)  sur ${A.total} enregistrements dans la période, le total des erreurs devrait donc être de ${A.control} erreurs`),console.warn("détail"),console.warn(`${c[0].errors[1].data.length} erreurs de type ${c[0].errors[1].type} data are`,c[0].errors[1].data),console.warn(`${c[0].errors[2].data.length} erreurs de type ${c[0].errors[2].type} data are`,c[0].errors[2].data),console.warn(`${c[0].errors[3].data.length} erreurs de type ${c[0].errors[3].type} data are`,c[0].errors[3].data)}var G=performance.now();console.log("%cCalculate bottom remark + errors took "+(G-y)+" milliseconds.",F);var h=0;let j="",v="";for(var p in c[0].bonus)c[0].bonus[p].sessions>=1?(h+=30,j+=c[0].bonus[p].who_name+","):v+=c[0].bonus[p].who_name+",";f+=`<p>Calcul du forfait "autofinancé". Vous sont affectés ${c[0].bonus.length} étudiants financés, parmi ceux ci, ${h/30} étudiant(s) avaient au moins une session programmée (${j.slice(0,-1)})`,h/30!==c[0].bonus.length&&(f+=`, (${c[0].bonus.length-h/30}) étudiant(s) (${v.slice(0,-1)}) n'ont pas eu de sessions`),f+=`, le forfait est donc de ${h}€</p>`,f+=`<p>Soit un total général à facturer de ${r+h}€`;var E=performance.now();console.log("%cCalculate AF took "+(E-G)+" milliseconds.",F);var H=performance.now();console.log("%cCalculate html table took "+(E-b)+" milliseconds.",F),Swal.fire({title:`<strong>Liste des formations tarifées du ${a.format("DD/MM/YYYY")} au ${d.format("DD/MM/YYYY")}</strong>`,html:f,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen"})},Sa=async function(){var[a,d]=await ia(dayjs().startOf("month"),dayjs().endOf("month"),!1);let c=a,b=[];for(var f=performance.now();c.isSameOrBefore(d,"day");){let h=c.endOf("month");b.push(xa.calculateBill(c,h)),c=c.add(1,"month")}var l=performance.now();console.log("%cComputed data between the two dates in"+(l-f)+" milliseconds.",F);var g="",i=d.get("month")-a.get("month");g+="<table>",g+="<thead>",g+="<tr><th>Origine</th>";for(var m=0;m<=i;){let h=a.add(m,"month");g+=`<th>${h.format("MMMM")}</th>`,m+=1}g+="<th>Total</th><th>Moyenne</th></tr>",g+="</thdead>",g+="<tbody>",g+="<tr>",g+=`<td colspan=${i} style="text-align:left;">Sessions</td></tr>`,g+="<tr>",g+="<td>Sessions (Mt)</td>";let k=0,e=0,n=0,o=[],B=[],z=[],s=[],y=[],w=[],u=[];for(c=a;e<=i;){let h=1;o[e]=0,B[e]=0,z[e]=0,y[e]=0,w[e]=0,u[e]=0;let j=b[e][0].max_level;for(;h<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)n+=b[e][h].sessions.number[p]*b[e][h].sessions.pu[p],o[e]+=b[e][h].sessions.number[p],B[e]+=b[e][h].defenses.number[p],z[e]+=b[e][h].sessions.number[p]-b[e][h].defenses.number[p],Q.isInOldMode(c)?[1,5].includes(p)&&(y[e]+=b[e][h].sessions.number[p],w[e]+=b[e][h].defenses.number[p],u[e]+=b[e][h].sessions.number[p]-b[e][h].defenses.number[p]):[1,2,5,6].includes(p)&&(y[e]+=b[e][h].sessions.number[p],w[e]+=b[e][h].defenses.number[p],u[e]+=b[e][h].sessions.number[p]-b[e][h].defenses.number[p]);h+=1}g+=`<td>${n}</td>`,s[e]=n,k+=n,n=0,e+=1,c=c.add(1,"month")}for(g+=`<td>${k}</td><td>${(k/(i+1)).toFixed(2)}</td>`,g+="</tr>",g+="<tr>",g+="<td>Sessions (Nb)</td>",k=0,e=0,n=0;e<=i;)g+=`<td>${o[e]-y[e]}(${o[e]})</td>`,k+=o[e],e+=1;for(g+=`<td>${k}</td><td>${(k/(i+1)).toFixed(2)}</td>`,g+="</tr>",g+="<tr>",g+="<td>Sessions (PU)</td>",k=0,e=0,n=0;e<=i;)g+=`<td>${(s[e]/(o[e]-y[e])).toFixed(2)}</td>`,k+=n,n=0,e+=1;for(g+=`<td>${k.toFixed(2)}</td><td>n/a</td>`,g+="</tr>",g+="<tr>",g+=`<td colspan=${i} style="text-align:left;">Mentorat</td></tr>`,g+="<tr>",g+="<td>Mentorat (Mt)</td>",e=0,n=0,s=[];e<=i;){let h=1,j=b[e][0].max_level;for(;h<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)n+=b[e][h].sessions.number[p]*b[e][h].sessions.pu[p]-b[e][h].defenses.number[p]*b[e][h].defenses.pu[p],s[e]=n;h+=1}g+=`<td>${n}</td>`,e+=1,n=0}for(g+="<tr>",g+="<tr>",g+="<td>Mentorat (Nb)</td>",k=0,e=0,n=0,o=[];e<=i;)g+=`<td>${z[e]-u[e]}(${z[e]})</td>`,k+=n,n=0,e+=1;for(g+=`<td>${k}</td><td>${(k/(i+1)).toFixed(2)}</td>`,g+="</tr>",g+="<td>Mentorat (PU)</td>",e=0;e<=i;)g+=`<td>${(s[e]/(z[e]-u[e])).toFixed(2)}</td>`,s[e]=n,k+=n,n=0,e+=1;for(g+=`<td>${k}</td><td>${(k/(i+1)).toFixed(2)}</td>`,g+="</tr>",g+="<tr>",g+=`<td colspan=${i} style="text-align:left;">Soutenances</td></tr>`,g+="<tr>",g+="<td>Soutenances (Mt)</td>",k=0,e=0,n=0,o=[],s=[];e<=i;){let h=1;o[e]=0;let j=b[e][0].max_level;for(;h<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)n+=b[e][h].defenses.number[p]*b[e][h].defenses.pu[p],o[e]+=b[e][h].defenses.number[p];h+=1}g+=`<td>${n}</td>`,s[e]=n,k+=n,n=0,e+=1}for(g+=`<td>${k}</td><td>${(k/(i+1)).toFixed(2)}</td>`,g+="</tr>",g+="<tr>",g+="<td>Soutenances (Nb)</td>",k=0,e=0,n=0;e<=i;)g+=`<td>${o[e]-w[e]}(${o[e]})</td>`,k+=o[e],e+=1;for(g+=`<td>${k}</td><td>${(k/(i+1)).toFixed(2)}</td>`,g+="</tr>",g+="<tr>",g+="<td>Soutenances (PU)</td>",k=0,e=0,n=0;e<=i;)g+=`<td>${(s[e]/(o[e]-w[e])).toFixed(2)}</td>`,k+=n,n=0,e+=1;g+=`<td>${k.toFixed(2)}</td><td>n/a</td>`,g+="</tr>",g+=`<td colspan=${i} style="text-align:left;">Bonus</td></tr>`,g+="<tr>",g+="<td>Bonus AF</td>",e=0,n=0;let r=[];for(;e<=i;){let h=b[e][0].bonus;r[e]=0;for(let j=0;j<h.length;j+=1)n+=h[j].sessions>0?30:0;g+=`<td>${n}</td>`,r[e]=n,n=0,e+=1}g+="</tr>",g+="<tr>",g+=`<td colspan=${i} style="text-align:left;">TJM</td></tr>`,g+="<tr>",g+="<td>Nb Jrs</td>",e=0;var x=[];k=0,c=a,s=[],c=a.clone();let C=c.clone().endOf("month"),t=[];for(;e<=i;)C.isAfter(d,"day")&&(C=d.clone()),g+=`<td>${ya(c,C)} jrs</td>`,t[e]=ya(c,C),c=c.add(1,"month"),C=C.add(1,"month"),e+=1;for(g+="</tr>",g+="<tr>",g+="<td>TJM</td>",e=0;e<=i;){n=0;let h=1;s[e]=0,x[e]=0;let j=b[e][0].max_level;for(;h<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)s[e]+=b[e][h].sessions.number[p]*b[e][h].sessions.pu[p];h+=1}g+=`<td>${(s[e]/t[e]).toFixed(2)} €</td>`,e+=1}for(g+="</tr>",g+="<tr>",g+="<td>THM (théorique)</td>",e=0,x=[],k=0,c=a,s=[];e<=i;){n=0;let h=1;s[e]=0,x[e]=0;let j=b[e][0].max_level;for(;h<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)s[e]+=b[e][h].sessions.number[p]*b[e][h].sessions.pu[p],Q.isInOldMode(c)?n+=(b[e][h].sessions.number[p]-b[e][h].defenses.number[p])*(45/60):([4,5,6,7].includes(p)&&(n+=(b[e][h].sessions.number[p]-b[e][h].defenses.number[p])*(30/60)),[0,1,2,3].includes(p)&&(n+=(b[e][h].sessions.number[p]-b[e][h].defenses.number[p])*(45/60))),n+=b[e][h].defenses.number[p]*(45/60);h+=1}console.log(`%cMontant mensuel : ${s[e]} + bonus ${r[e]}/ Nb heures ${n} = $((aAmInMonth[_m]+aAmBoInMonth[_m])/iTotal).toFixed(2)`,q),g+=`<td>${((s[e]+r[e])/n).toFixed(2)} €</td>`,k+=n,x[e]=n,n=0,e+=1,c=c.add(1,"month")}for(g+="</tr>",g+="<tr>",g+="<td>Nb heures</td>",k=0,e=0,n=0;e<=i;)g+=`<td>${x[e].toFixed(2)} h</td>`,k+=n,n=0,e+=1;for(g+=`<td>${k.toFixed(2)}</td><td>n/a</td>`,g+="</tr>",g+="<tr>",g+="<td>THM (person.)</td>",e=0,x=[],k=0,c=a,s=[];e<=i;){n=0;let h=1;s[e]=0,x[e]=0;let j=b[e][0].max_level;for(;h<j;){let v=[...Array(8).keys()];for(let p=0;p<v.length;p+=1)s[e]+=b[e][h].sessions.number[p]*b[e][h].sessions.pu[p],Q.isInOldMode(c)?n+=(b[e][h].sessions.number[p]-b[e][h].defenses.number[p])*(GM_config.get("nbHrsfM")/60):([4,5,6,7].includes(p)&&(n+=(b[e][h].sessions.number[p]-b[e][h].defenses.number[p])*(GM_config.get("nbHrsAfM")/60)),[0,1,2,3].includes(p)&&(n+=(b[e][h].sessions.number[p]-b[e][h].defenses.number[p])*(GM_config.get("nbHrsfM")/60))),n+=b[e][h].defenses.number[p]*(GM_config.get("nbHrsD")/60);h+=1}console.log(`montant mensuel : ${s[e]} + bonus ${r[e]}/ Nb heures ${n} = $((aAmInMonth[_m]+aAmBoInMonth[_m])/iTotal).toFixed(2)`),g+=`<td>${((s[e]+r[e])/n).toFixed(2)} €</td>`,k+=n,x[e]=n,n=0,e+=1,c=c.add(1,"month")}for(g+="</tr>",g+="<tr>",g+="<td>Nb heures</td>",k=0,e=0,n=0;e<=i;)g+=`<td>${x[e].toFixed(2)} h</td>`,k+=n,n=0,e+=1;g+=`<td>${k.toFixed(2)}</td><td>n/a</td>`,g+="</tr>",g+="</tbody>",g+="<tfoot>",g+"",g+="</tfoot>",g+="</table>";var G=performance.now();console.log("%cTime to show table :"+(G-l)+" milliseconds.",F),Swal.fire({title:`<strong>Statistiques du ${a.format("DD/MM/YYYY")} au ${d.format("DD/MM/YYYY")}</strong>`,icon:"info",html:g,showCloseButton:!0,focusConfirm:!1,position:"center-start",grow:"fullscreen",onOpen:h=>{}})};class R{static init=function(){console.log("%cin initUI",q),R.build();var a=new Draggabilly(".draggable",{handle:".handle"});lb.start("animation-target")};static build=function(){console.log("%c in buildUI","background-color:green;color:white"),GM_addStyle(".flex > * { margin: 2px 1px; }"),GM_addStyle(".flex > :first-child { margin-left: 0; }"),GM_addStyle(".flex > :last-child { margin-right: 0; }"),GM_addStyle(".panel {display: flex; justify-content: center;z-index:999}"),GM_addStyle(".menuBar {border-top: 1px solid; padding: 10px; font-size: 1rem; pointer-events: inherit;position: relative;top:0px;  flex-flow: row wrap;/*align-content: space-between;justify-content: space-between;*/}"),GM_addStyle(".draggable {background: transparent;border-radius: 10px;padding: 20px;}"),GM_addStyle(".draggable.is-pointer-down {background: #09F;}"),GM_addStyle(".draggable.is-dragging { opacity: 0.7; }"),GM_addStyle(".handle {background: #555;background: hsla(0, 0%, 0%, 0.4);width: 20px;height: 20px; border-radius: 10px;}"),GM_addStyle(".flex > :nth-last-child(2) {page-break-after: always; /* CSS 2.1 syntax */break-after: always; /* New syntax */}"),GM_addStyle("#animation-target {width: 10px;height: 5px;background-color:coral;border-radius: 25%;}");var a=document.createElement("div"),d=document.createElement("div");d.classList.add("handle"),a.appendChild(d),a.classList.add("panel","menuBar","flex","draggable"),document.body.appendFirst(a),R.addButton("collectChecked",Na,{},a),R.addButton("CollectAuto",Oa,{},a),R.addButton("showBill",Ra,{},a),R.addButton("billInDetails",Ma,{},a),R.addButton("PDF",Pa,{},a),R.addButton("SList",T.showList,{},a),R.addButton("statistics",Sa,{},a),R.addButton("Database",Qa,{},a),R.addButton("about",La,{},a);var c=document.createElement("div");c.id="animation-target",a.appendChild(c)};static addButton=function(a,d,c,b){b=b||document.body,c=c||{position:"absolute",bottom:"7%",left:"4%","z-index":3};let f=document.createElement("button"),l=f.style;return f.classList.add("button--primary","button"),b.appendChild(f),f.innerHTML=a,f.onclick=d,Object.keys(c).forEach(g=>l[g]=c[g]),f}}class lb{static start=function(a){const d=document.getElementById(a),c=i=>d.style.transform=`translateX(${i}px)`;let b=0;const f=7,l=i=>{c(b),b+=f,b>100?requestAnimationFrame(g):requestAnimationFrame(l)},g=i=>{c(b),b-=f,b<-100?requestAnimationFrame(l):requestAnimationFrame(g)};requestAnimationFrame(l)}}var Va=R;const gb="#OCAddonsCfg {background-color: lightblue;} #OCAddonsCfg .reset_holder {float: left; position: relative; bottom: -1em;} #OCAddonsCfg .saveclose_buttons {margin: .7em;}",hb="height: 16.7em; width: 30em; border: 1px solid; border-radius: 3px; position: fixed; z-index: 999;",Ta={id:"OCAddonsCfg",title:"Configuration du module",fields:{nbHrsAfM:{section:["Statistiques","paramètres"],label:"Nombre de minutes pour une session AF",labelPos:"left",type:"input",default:30},nbHrsfM:{label:"Nombre de minutes pour une session financée",labelPos:"left",type:"input",default:45},nbHrsD:{label:"Nombre de minutes pour une session de soutenance",labelPos:"left",type:"input",default:45},maxfetchpg:{section:["Application","optimisation"],label:"Maximum de page recherchées dans l'historique",labelPos:"left",type:"input",default:1e3},datacachelifetime:{label:"Temps de conservation des données dans le cache (en ms)",labelPos:"left",type:"input",default:12e4},checksessionalreadyexists:{section:["Application","Base de donnée"],label:"sessions: vérifier existence avant insertion",labelPos:"left",type:"checkbox",default:!0},sizeofcontentlist:{section:["Interface","thème"],label:"taille de la police des listes",labelPos:"left",type:"input",default:"1em;"},use_custom_css:{label:"utiliser des styles personnalisés",labelPos:"left",type:"checkbox",default:!1},custom_css_url:{label:"url de la feuille de style (si plusieurs les séparer par des virgules)",labelPos:"left",type:"input",default:""},custom_css_data:{label:"saisir ici le code css à injecter directement dans la page",title:"Je me demande bien à quoi sert le titre",labelPos:"left",type:"input",default:""},alwaysaddcbox:{section:["Interface","gadget"],label:"Toujours ajouter les checkbox sur l'interface",labelPos:"left",type:"checkbox",default:!0},hackheaderzindex:{label:"changer le zindex du bandeau haut",labelPos:"left",type:"checkbox",default:!0},support:{section:["","Support"],label:"StephaneTy-Pro.github.io",title:"more info on https://github.com/StephaneTy-Pro",type:"button",click:()=>{GM_openInTab("https://github.com/StephaneTy-Pro/OC-Mentors-AccountAddon",{active:!0,insert:!0,setParent:!0})}}},css:gb,events:{save:function(){GM_config.close()}}};var Ua=function(){GM_config.open(),OCAddonsCfg.style=hb};V();})();
//# sourceMappingURL=billing.min.js.map
